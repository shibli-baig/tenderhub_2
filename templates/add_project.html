{% extends "base.html" %}

{% block title %}Add New Project - TenderHub{% endblock %}

{% block content %}
<section class="section">
    <div class="section-header">
        <div>
            <span class="chip chip--neutral">Project intake</span>
            <h1 class="section-title">Register a completed project</h1>
            <p class="section-subtitle">Capture milestones, services rendered, and document evidence to build a reusable credentials library for your bids.</p>
        </div>
        <div class="panel-actions">
            <a href="/projects" class="btn btn-outline">Back to projects</a>
        </div>
    </div>
    <div class="panel panel--compact">
        <div class="progress-track">
            <div class="progress-track__bar" id="progressBar"></div>
        </div>
        <p class="panel-subtitle mt-3">Progress updates as you complete sections. Required fields are marked with <span class="text-danger">*</span>.</p>
    </div>
</section>

<section class="section section--surface">
    <form id="projectForm" method="post" action="/add_project" enctype="multipart/form-data" class="form-stack">

        <article class="surface-card">
            <div class="section-header" style="margin-bottom: var(--space-4);">
                <div>
                    <h2 class="surface-card__title">Project overview</h2>
                    <p class="panel-subtitle">Core information that powers matching and credential exports.</p>
                </div>
            </div>
            <div class="form-grid two-col">
                <div class="form-group">
                    <label for="project_name" class="form-label">Project name <span class="text-danger">*</span></label>
                    <input type="text" id="project_name" name="project_name" required placeholder="e.g., Urban Water Supply Modernisation">
                </div>
                <div class="form-group">
                    <label for="client_name" class="form-label">Client / Authority</label>
                    <input type="text" id="client_name" name="client_name" placeholder="e.g., Delhi Jal Board">
                </div>
                <div class="form-group">
                    <label for="financing_authority" class="form-label">Financing Authority</label>
                    <input type="text" id="financing_authority" name="financing_authority" placeholder="Comma separated authority names">
                </div>
                <div class="form-group">
                    <label for="sector" class="form-label">Sector</label>
                    <select id="sector" name="sector">
                        <option value="">Select sector</option>
                        {% if user_industry_sectors %}
                            {% for sector in user_industry_sectors %}
                            <option value="{{ sector }}">{{ sector }}</option>
                            {% endfor %}
                        {% else %}
                            <!-- Fallback to all sectors if user hasn't set their industry sectors -->
                            {% for option in [
                                'Information Technology & Software',
                                'Engineering & Technical Services',
                                'Construction & Infrastructure',
                                'Healthcare & Medical Services',
                                'Education & Training',
                                'Transportation & Logistics',
                                'Defense & Security',
                                'Financial Services & Banking',
                                'Manufacturing & Production',
                                'Energy & Utilities',
                                'Agriculture & Food Processing',
                                'Telecommunications',
                                'Media & Entertainment',
                                'Retail & E-commerce',
                                'Real Estate & Property',
                                'Legal & Consulting Services',
                                'Research & Development',
                                'Environmental Services',
                                'Tourism & Hospitality',
                                'Automotive & Transportation',
                                'Aerospace & Aviation',
                                'Biotechnology & Pharmaceuticals',
                                'Mining & Minerals',
                                'Textiles & Apparel',
                                'Sports & Recreation',
                                'Non-Profit & NGO',
                                'Government & Public Sector',
                                'Water Resources',
                                'Water Supply',
                                'Urban Infrastructure',
                                'Rural Infrastructure',
                                'Forest',
                                'Other'
                            ] %}
                            <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="sub_sector" class="form-label">Sub-sector</label>
                    <select id="sub_sector" name="sub_sector" disabled>
                        <option value="">Select sub-sector</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="consultancy_fee" class="form-label">Consultancy fee (₹)</label>
                    <input type="number" id="consultancy_fee" name="consultancy_fee" placeholder="e.g., 25000000">
                </div>
                <div class="form-group">
                    <label for="project_cost" class="form-label">Project cost (₹)</label>
                    <input type="number" id="project_cost" name="project_cost" placeholder="Overall project value">
                </div>
            </div>
            <div class="form-group">
                <label for="project_description" class="form-label">Project description</label>
                <textarea id="project_description" name="project_description" rows="4" placeholder="Summarise the scope, objectives, scale, and outcomes."></textarea>
            </div>
        </article>

        <article class="surface-card">
            <div class="section-header" style="margin-bottom: var(--space-4);">
                <div>
                    <h2 class="surface-card__title">Timeline & geography</h2>
                    <p class="panel-subtitle">Key dates and locations strengthen eligibility scoring.</p>
                </div>
            </div>
            <div class="form-grid three-col">
                <div class="form-group">
                    <label for="start_date" class="form-label">Start date</label>
                    <input type="date" id="start_date" name="start_date">
                </div>
                <div class="form-group">
                    <label for="end_date" class="form-label">Completion date</label>
                    <input type="date" id="end_date" name="end_date" max="{{ now().strftime('%Y-%m-%d') }}">
                    <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">Cannot be in the future</small>
                </div>
                <div class="form-group">
                    <label for="project_duration" class="form-label">Duration (months)</label>
                    <input type="number" id="project_duration" name="project_duration_months" readonly placeholder="Auto calculated">
                </div>
            </div>
            <div class="d-flex align-center gap-3 mt-3">
                <label class="form-label" for="ongoing" style="margin-bottom:0;">Still ongoing?</label>
                <input type="checkbox" id="ongoing" name="ongoing">
            </div>
            <div class="form-grid two-col mt-4">
                <div class="form-group">
                    <label for="country" class="form-label">Country</label>
                    <input type="text" id="country" name="country" placeholder="e.g., India">
                </div>
                <div class="form-group">
                    <label for="states" class="form-label">States covered</label>
                    <input type="text" id="states" name="states" placeholder="Comma separated">
                </div>
                <div class="form-group">
                    <label for="cities" class="form-label">Cities covered</label>
                    <input type="text" id="cities" name="cities" placeholder="Comma separated">
                </div>
                <div class="form-group">
                    <label for="jv_partner" class="form-label">JV partner</label>
                    <input type="text" id="jv_partner" name="jv_partner" placeholder="If applicable">
                </div>
            </div>
        </article>

        <article class="surface-card">
            <div class="section-header" style="margin-bottom: var(--space-4);">
                <div>
                    <h2 class="surface-card__title">Services delivered</h2>
                    <p class="panel-subtitle">Highlight competencies showcased in this project.</p>
                </div>
            </div>
            <div class="form-grid two-col">
                <div class="form-group">
                    <label for="design_engineering" class="form-label">Design & engineering</label>
                    <textarea id="design_engineering" name="services[design_engineering]" rows="3" placeholder="Detail design deliverables"></textarea>
                </div>
                <div class="form-group">
                    <label for="dpr_feasibility" class="form-label">DPR & feasibility</label>
                    <textarea id="dpr_feasibility" name="services[dpr_feasibility]" rows="3" placeholder="DPR, techno-economic studies, impact assessments"></textarea>
                </div>
                <div class="form-group">
                    <label for="gis_data" class="form-label">GIS & data services</label>
                    <textarea id="gis_data" name="services[gis_data]" rows="3" placeholder="Mapping, analytics, spatial databases"></textarea>
                </div>
                <div class="form-group">
                    <label for="pmc" class="form-label">Project management consultancy</label>
                    <textarea id="pmc" name="services[pmc]" rows="3" placeholder="Planning, monitoring, supervision"></textarea>
                </div>
                <div class="form-group">
                    <label for="pmu" class="form-label">Project management unit (PMU)</label>
                    <textarea id="pmu" name="services[pmu]" rows="3" placeholder="Implementation support, capacity building"></textarea>
                </div>
                <div class="form-group">
                    <label for="advisory_capacity" class="form-label">Advisory & capacity building</label>
                    <textarea id="advisory_capacity" name="services[advisory_capacity]" rows="3" placeholder="Training, policy advisory, stakeholder engagement"></textarea>
                </div>
            </div>
        </article>

        <article class="surface-card">
            <div class="section-header" style="margin-bottom: var(--space-4);">
                <div>
                    <h2 class="surface-card__title">Supporting documents</h2>
                    <p class="panel-subtitle">Attach evidence required for credential packs and audits.</p>
                </div>
            </div>
            <div class="form-grid two-col">
                <div class="form-group">
                    <label for="tender_documents" class="form-label">Tender documents</label>
                    <input type="file" id="tender_documents" name="documents[tender_documents][]" class="form-control-file" multiple accept=".pdf,.doc,.docx">
                    <span class="form-hint">EOIs, RFPs, corrigenda, pre-bid minutes, BoQ</span>
                </div>
                <div class="form-group">
                    <label for="technical_proposal" class="form-label">Technical proposal</label>
                    <input type="file" id="technical_proposal" name="documents[technical_proposal][]" class="form-control-file" multiple accept=".pdf,.doc,.docx">
                    <span class="form-hint">Uploaded proposal submitted to authority</span>
                </div>
                <div class="form-group">
                    <label for="work_order" class="form-label">Work order</label>
                    <input type="file" id="work_order" name="documents[work_order][]" class="form-control-file" multiple accept=".pdf,.doc,.docx">
                    <span class="form-hint">Proof of award or contract issuance</span>
                </div>
                <div class="form-group">
                    <label for="financial_proposal" class="form-label">Financial proposal</label>
                    <input type="file" id="financial_proposal" name="documents[financial_proposal][]" class="form-control-file" multiple accept=".pdf,.doc,.docx">
                    <span class="form-hint">Pricing submission provided during bidding</span>
                </div>
                <div class="form-group">
                    <label for="invoices_receipts" class="form-label">Invoices & receipts</label>
                    <input type="file" id="invoices_receipts" name="documents[invoices_receipts][]" class="form-control-file" multiple accept=".pdf,.doc,.docx,.jpg,.png">
                    <span class="form-hint">Milestone invoices and client acknowledgements</span>
                </div>
                <div class="form-group">
                    <label for="deliverables" class="form-label">Deliverables</label>
                    <input type="file" id="deliverables" name="documents[deliverables][]" class="form-control-file" multiple accept=".pdf,.doc,.docx,.zip">
                    <span class="form-hint">Reports, designs, and other submitted outputs</span>
                </div>
                <div class="form-group">
                    <label for="completion_certificate" class="form-label">Completion certificate</label>
                    <input type="file" id="completion_certificate" name="documents[completion_certificate][]" class="form-control-file" multiple accept=".pdf,.doc,.docx">
                    <span class="form-hint">Final sign-off documentation</span>
                </div>
                <div class="form-group">
                    <label for="other_documents" class="form-label">Other supporting documents</label>
                    <input type="file" id="other_documents" name="documents[other_documents][]" class="form-control-file" multiple accept=".pdf,.doc,.docx,.jpg,.png,.zip">
                    <span class="form-hint">Anything else that reinforces credentials</span>
                </div>
            </div>
        </article>

        <div class="panel" style="text-align: center;">
            <div class="panel-actions" style="justify-content: center;">
                <button type="submit" class="btn btn-primary btn-lg">Submit project</button>
                <a href="/projects" class="btn btn-outline btn-lg">Cancel</a>
            </div>
        </div>
    </form>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const sectorSelect = document.getElementById('sector');
    const subSectorSelect = document.getElementById('sub_sector');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const ongoingCheckbox = document.getElementById('ongoing');
    const durationInput = document.getElementById('project_duration');
    const form = document.getElementById('projectForm');
    const progressBar = document.getElementById('progressBar');

    // Build sub-sectors map from user's sectors data
    const subSectors = {};
    {% if user_sectors_data %}
        {% for sector_obj in user_sectors_data %}
            subSectors['{{ sector_obj.sector }}'] = {{ sector_obj.subsectors|tojson }};
        {% endfor %}
    {% endif %}

    sectorSelect.addEventListener('change', () => {
        const options = subSectors[sectorSelect.value] || [];
        subSectorSelect.innerHTML = '<option value="">Select sub-sector</option>';
        if (options.length) {
            options.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                subSectorSelect.appendChild(option);
            });
            subSectorSelect.disabled = false;
        } else {
            subSectorSelect.disabled = true;
        }
    });

    function calculateDuration() {
        const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
        const endDate = ongoingCheckbox.checked ? new Date() : (endDateInput.value ? new Date(endDateInput.value) : null);

        if (startDate && endDate && startDate <= endDate) {
            const diffTime = Math.abs(endDate - startDate);
            const diffMonths = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 30.44));
            durationInput.value = diffMonths;
        } else {
            durationInput.value = '';
        }
    }

    ongoingCheckbox.addEventListener('change', () => {
        if (ongoingCheckbox.checked) {
            endDateInput.value = '';
            endDateInput.disabled = true;
        } else {
            endDateInput.disabled = false;
        }
        calculateDuration();
    });

    startDateInput.addEventListener('change', calculateDuration);
    endDateInput.addEventListener('change', calculateDuration);

    // Validate end date is not in the future
    endDateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to start of day for comparison

        if (selectedDate > today) {
            alert('Project completion date cannot be in the future. Please select today\'s date or earlier.');
            this.value = ''; // Clear the invalid date
        }
    });

    function updateProgressBar() {
        if (!progressBar) return;
        const fields = Array.from(form.querySelectorAll('input:not([type="hidden"]):not([type="checkbox"]):not([type="file"]), select, textarea'))
            .filter(el => !el.disabled);
        const filled = fields.filter(el => el.value && el.value.trim() !== '').length;
        const ratio = fields.length ? Math.round((filled / fields.length) * 100) : 0;
        progressBar.style.width = `${ratio}%`;
    }

    form.addEventListener('input', updateProgressBar);
    form.addEventListener('change', updateProgressBar);
    updateProgressBar();

    form.addEventListener('submit', event => {
        const requiredFields = [document.getElementById('project_name')];
        let firstInvalid = null;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                if (!firstInvalid) firstInvalid = field;
            } else {
                field.classList.remove('is-invalid');
            }
        });

        if (firstInvalid) {
            event.preventDefault();
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalid.focus();
        }
    });
});
</script>
{% endblock %}
