{% extends "base.html" %}

{# SEO Meta Tags - Dynamic based on tender data #}
{% set tender_title = tender.title if tender else 'Tender Details' %}
{% set tender_description = (tender.summary[:155] + '...' if tender and tender.summary and tender.summary|length > 155 else (tender.summary if tender and tender.summary else 'Government tender details and information')) %}
{% set tender_keywords = (tender.category + ', ' + tender.state + ', ' + tender.authority if tender and tender.category and tender.state and tender.authority else 'government tender, public procurement, bidding') %}
{% set seo_meta = {
    'title': tender_title + ' - ' + (tender.authority if tender and tender.authority else 'Government Tender') + ' - BidSuite',
    'description': tender_description,
    'keywords': tender_keywords,
    'url': request.url.scheme + '://' + request.url.netloc + request.url.path,
    'image': request.url.scheme + '://' + request.url.netloc + '/static/images/og-default.jpg',
    'published_time': tender.published_at.isoformat() if tender and tender.published_at else None,
    'modified_time': tender.updated_at.isoformat() if tender and tender.updated_at else None
} %}

{# Breadcrumbs #}
{% set breadcrumb_items = [
    {'name': 'Home', 'url': '/'},
    {'name': 'Tenders', 'url': '/procurement'},
    {'name': tender_title[:50] + ('...' if tender_title|length > 50 else ''), 'url': request.url.path}
] %}

{% block extra_head %}
<style>
    .certificate-matching-modal__dialog {
        width: 90vw;
        height: 90vh;
        max-width: 1400px;
        max-height: 900px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(99, 102, 241, 0.25);
    }

    .certificate-matching-modal__body {
        flex: 1;
        display: grid;
        grid-template-columns: minmax(320px, 420px) 1fr;
        gap: 1.5rem;
        padding: 1.75rem 2rem 2rem 2rem;
        overflow: hidden;
    }

    .certificate-matching-sidebar,
    .certificate-matching-main {
        height: 100%;
        overflow-y: auto;
    }

    .cm-section {
        background: #fff;
        border: 1px solid rgba(226, 232, 240, 0.9);
        border-radius: 12px;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.25rem;
        box-shadow: 0 10px 35px rgba(15, 23, 42, 0.05);
    }

    .cm-section h4 {
        margin: 0 0 0.35rem;
        font-size: 1rem;
        font-weight: 600;
        color: #0f172a;
    }

    .cm-section p {
        margin: 0;
        color: #64748b;
        font-size: 0.92rem;
    }

    .cm-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .cm-status-badge[data-status="completed"] {
        background: rgba(16, 185, 129, 0.12);
        color: #065f46;
    }

    .cm-status-badge[data-status="processing"] {
        background: rgba(249, 115, 22, 0.15);
        color: #9a3412;
    }

    .cm-status-badge[data-status="failed"] {
        background: rgba(239, 68, 68, 0.16);
        color: #b91c1c;
    }

    .cm-progress {
        margin-top: 1rem;
    }

    .cm-progress-bar {
        width: 100%;
        height: 8px;
        border-radius: 999px;
        background: rgba(226, 232, 240, 0.8);
        overflow: hidden;
    }

    .cm-progress-bar__fill {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #8b5cf6);
        width: 0%;
        transition: width 0.3s ease;
    }

    .cm-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .cm-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
    }

    .cm-summary-card {
        border: 1px solid rgba(226, 232, 240, 0.9);
        border-radius: 12px;
        padding: 0.85rem 1rem;
        text-align: center;
    }

    .cm-summary-label {
        font-size: 0.85rem;
        color: #64748b;
        display: block;
        margin-bottom: 0.15rem;
    }

    .cm-summary-value {
        font-size: 1.35rem;
        font-weight: 700;
        color: #0f172a;
    }

    .cm-table {
        width: 100%;
        border-collapse: collapse;
    }

    .cm-table thead {
        background: rgba(226, 232, 240, 0.55);
    }

.cm-table th,
.cm-table td {
    padding: 0.85rem;
    text-align: left;
    border-bottom: 1px solid rgba(226, 232, 240, 0.9);
    vertical-align: top;
}

/* AI Criteria Table - Two-Row Structure */
.ai-criteria-table tbody tr.criteria-main {
    border-bottom: none;
}

.ai-criteria-table tbody tr.criteria-main td {
    padding-bottom: 0.5rem;
    border-bottom: none;
}

.ai-criteria-table tbody tr.criteria-description {
    border-bottom: 1px solid rgba(226, 232, 240, 0.9);
}

.ai-criteria-table tbody tr.criteria-description td {
    padding-top: 0;
    padding-bottom: 0.85rem;
    border-bottom: 1px solid rgba(226, 232, 240, 0.9);
}

.ai-criteria-description-content {
    background: rgba(248, 250, 252, 0.6);
    padding: 0.75rem 1rem;
    border-radius: 12px;
    border-left: 3px solid #3b82f6;
    font-size: 0.85rem;
    line-height: 1.6;
    color: #475569;
}

.cm-gap-toggle {
    border: none;
    background: transparent;
    color: #4c1d95;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    cursor: pointer;
}

.cm-gap-toggle svg {
    transition: transform 0.2s ease;
}

.cm-gap-toggle[data-expanded="true"] svg {
    transform: rotate(180deg);
}

.cm-gap-content {
    margin-top: 0.45rem;
    padding: 0.65rem 0.75rem;
    border-radius: 12px;
    background: #f8fafc;
    border: 1px solid rgba(148, 163, 184, 0.35);
}

.cm-gap-content[hidden] {
    display: none;
}

    .cm-score-chip {
        padding: 0.2rem 0.65rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.82rem;
    }

    .cm-score-chip[data-tone="high"] {
        background: rgba(16, 185, 129, 0.15);
        color: #065f46;
    }

    .cm-score-chip[data-tone="mid"] {
        background: rgba(251, 191, 36, 0.18);
        color: #92400e;
    }

    .cm-score-chip[data-tone="low"] {
        background: rgba(239, 68, 68, 0.16);
        color: #b91c1c;
    }

    .cm-gap-list,
    .cm-factor-list {
        margin: 0;
        padding-left: 1rem;
        color: #475569;
        font-size: 0.9rem;
    }

    .cm-empty {
        text-align: center;
        padding: 2rem 1rem;
        color: #94a3b8;
        border: 1px dashed rgba(148, 163, 184, 0.65);
        border-radius: 12px;
    }

    .cm-filter-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-bottom: 1rem;
    }

    .cm-select {
        border: 1px solid rgba(203, 213, 225, 0.9);
        border-radius: 12px;
        padding: 0.45rem 0.75rem;
        font-size: 0.9rem;
        background: #fff;
    }

    .cm-mode-toggle {
        width: clamp(210px, 18vw, 240px);
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .cm-mode-slider {
        position: relative;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        padding: 0.2rem;
        border-radius: 999px;
        background: linear-gradient(120deg, rgba(79, 70, 229, 0.18), rgba(236, 72, 153, 0.15));
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.18);
        width: 100%;
        isolation: isolate;
    }

    .cm-mode-option {
        border: none;
        background: transparent;
        color: rgba(71, 85, 105, 0.8);
        font-size: 0.78rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        padding: 0.5rem 0.75rem;
        border-radius: 999px;
        cursor: pointer;
        min-width: 0;
        text-align: center;
        z-index: 1;
        transition: color 0.2s ease;
    }

    .cm-mode-option.is-active {
        color: #0f172a;
    }

    .cm-mode-option:focus-visible {
        outline: 2px solid rgba(99, 102, 241, 0.5);
        outline-offset: 2px;
    }

    .cm-mode-thumb {
        position: absolute;
        top: 0.2rem;
        left: 0.2rem;
        width: calc(50% - 0.4rem);
        height: calc(100% - 0.4rem);
        background: #ffffff;
        border-radius: 999px;
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.25);
        transition: transform 0.25s ease;
        transform: translateX(0);
        z-index: 0;
    }

    .cm-mode-slider[data-mode="ai"] .cm-mode-thumb {
        transform: translateX(100%);
    }

    .cm-method-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.12);
        color: #4c1d95;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    /* ============ Certificate Intelligence Modal Styles ============ */

    /* Modal Overlay and Container */
    .cert-intel-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .cert-intel-modal-content {
        background: white;
        width: 95%;
        max-width: 1400px;
        height: 90vh;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
        overflow: hidden;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .cert-intel-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 32px;
        border-bottom: 1px solid #e2e8f0;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
    }

    .cert-intel-modal-header h2 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    .cert-intel-modal-close {
        background: #f1f5f9;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 24px;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .cert-intel-modal-close:hover {
        background: #e2e8f0;
        color: #334155;
        transform: rotate(90deg);
    }

    .cert-intel-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
    }

    /* Certificate Mode Navigation */
    .cert-mode-nav {
        display: flex;
        gap: 16px;
        margin-bottom: 40px;
        padding: 8px;
        background: linear-gradient(135deg, rgba(248, 250, 252, 0.8) 0%, rgba(241, 245, 249, 0.8) 100%);
        border-radius: 12px;
        border: 1px solid rgba(99, 102, 241, 0.08);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .cert-mode-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 16px 24px;
        background: transparent;
        border: 2px solid transparent;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 15px;
        color: #64748b;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        outline: none;
    }

    .cert-mode-btn:hover:not(.cert-mode-btn--active) {
        background: rgba(255, 255, 255, 0.6);
        color: #334155;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }

    .cert-mode-btn--active {
        background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
        color: #1e293b;
        border-color: rgba(99, 102, 241, 0.2);
        box-shadow:
            0 4px 16px rgba(99, 102, 241, 0.12),
            0 0 0 1px rgba(99, 102, 241, 0.08);
    }

    .cert-mode-icon {
        font-size: 20px;
        transition: transform 0.3s ease;
    }

    .cert-mode-btn--active .cert-mode-icon {
        transform: scale(1.1);
    }

    .cert-mode-label {
        white-space: nowrap;
        letter-spacing: 0.2px;
    }

    /* Certificate Mode Content */
    .cert-mode-content {
        animation: fadeInContent 0.4s ease;
    }

    @keyframes fadeInContent {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ============ Keyword Search Mode Styles ============ */

    /* Certificate Search Wrapper */
    .cert-search-wrapper {
        max-width: 1400px;
        margin: 0 auto 40px;
    }

    .cert-search-box {
        display: flex;
        align-items: stretch;
        gap: 10px;
        background: #ffffff;
        border-radius: 12px;
        border: 2px solid #e5e7eb;
        box-shadow: 0 8px 30px rgba(99, 102, 241, 0.1);
        padding: 6px;
        transition: all 0.3s;
    }

    .cert-search-box:focus-within {
        border-color: #6366f1;
        box-shadow: 0 10px 40px rgba(99, 102, 241, 0.18);
    }

    .cert-search-input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 16px;
        padding: 14px 20px;
        color: #1a1a1a;
        outline: none;
        font-family: inherit;
    }

    .cert-search-input::placeholder {
        color: #9ca3af;
    }

    .cert-search-button {
        padding: 14px 32px;
        background: linear-gradient(135deg, #6366f1, #4338ca);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
        box-shadow: 0 6px 16px rgba(79, 70, 229, 0.25);
    }

    .cert-search-button:hover {
        background: linear-gradient(135deg, #4f46e5, #3730a3);
        transform: translateY(-2px);
        box-shadow: 0 10px 24px rgba(79, 70, 229, 0.35);
    }

    .cert-search-button--show-all {
        background: transparent;
        color: #6366f1;
        border: 1px solid rgba(99, 102, 241, 0.35);
        box-shadow: none;
    }

    .cert-search-button--show-all:hover {
        background: rgba(99, 102, 241, 0.1);
    }

    /* Search Stats */
    .cert-search-stats {
        max-width: 1400px;
        margin: 0 auto 28px;
        text-align: center;
        padding: 12px 20px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(14, 165, 233, 0.08));
        border-radius: 12px;
        border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .cert-search-stats p {
        font-size: 15px;
        color: #374151;
        font-weight: 600;
        margin: 0;
    }

    .cert-search-stats strong {
        color: #6366f1;
        font-size: 20px;
        font-weight: 800;
    }

    /* Loading */
    .cert-loading {
        text-align: center;
        padding: 64px 20px;
    }

    .cert-spinner {
        width: 48px;
        height: 48px;
        margin: 0 auto 20px;
        border: 4px solid rgba(99, 102, 241, 0.1);
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: certSpin 0.8s linear infinite;
    }

    @keyframes certSpin {
        to { transform: rotate(360deg); }
    }

    .cert-loading-text {
        font-size: 16px;
        color: #6b7280;
        font-weight: 600;
    }

    /* No Results */
    .cert-no-results {
        max-width: 1400px;
        margin: 0 auto;
        text-align: center;
        padding: 64px 28px;
        background: #ffffff;
        border-radius: 12px;
        border: 2px dashed rgba(148, 163, 184, 0.3);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    .cert-no-results-icon {
        font-size: 64px;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .cert-no-results h3 {
        font-size: 24px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 10px;
    }

    .cert-no-results p {
        font-size: 15px;
        color: #6b7280;
        margin-bottom: 24px;
    }

    /* Certificate Cards List */
    .cert-cards-grid {
        max-width: 1400px;
        margin: 24px auto 0;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* Certificate Card */
    .cert-material-card {
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 20px 40px rgba(99, 102, 241, 0.08);
        padding: 1.75rem;
        display: grid;
        gap: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .cert-material-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 24px 48px rgba(99, 102, 241, 0.15);
        border-color: rgba(99, 102, 241, 0.3);
    }

    /* Card Header Section */
    .cert-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }

    .cert-card-title-block {
        flex: 1;
    }

    .cert-card-title {
        margin: 0;
        font-size: 1.35rem;
        font-weight: 700;
        color: #1a1a1a;
        line-height: 1.4;
    }

    .cert-card-subtitle {
        margin: 0.3rem 0 0;
        color: #6b7280;
        font-size: 0.95rem;
    }

    .cert-card-status {
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.12);
        color: #6366f1;
        font-weight: 600;
        letter-spacing: 0.08em;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    /* Divider */
    .cert-card-divider {
        border-top: 1px dashed #e5e7eb;
        margin: 0.5rem 0;
    }

    /* Info Grid with Pills */
    .cert-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
    }

    .cert-pill {
        padding: 0.75rem 1rem;
        background: rgba(99, 102, 241, 0.04);
        border-radius: 12px;
        border: 1px solid rgba(99, 102, 241, 0.1);
        transition: all 0.2s ease;
    }

    .cert-pill:hover {
        background: rgba(99, 102, 241, 0.08);
        border-color: rgba(99, 102, 241, 0.2);
    }

    .cert-pill-label {
        display: block;
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.25rem;
        font-weight: 600;
    }

    .cert-pill-value {
        display: block;
        font-size: 1rem;
        font-weight: 700;
        color: #1a1a1a;
    }

    /* Services Section */
    .cert-services {
        margin-top: 0.5rem;
    }

    .cert-services-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #6b7280;
        font-weight: 700;
        margin-bottom: 0.75rem;
    }

    .cert-services-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .cert-service-tag {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 0.4rem 0.85rem;
        font-weight: 600;
        font-size: 0.85rem;
        color: #6b7280;
        background: #f8f9fa;
        transition: all 0.2s ease;
    }

    .cert-service-tag:hover {
        border-color: #6366f1;
        color: #6366f1;
    }

    /* Card Footer */
    .cert-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
    }

    .cert-card-chips {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        flex: 1;
    }

    .cert-chip {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 0.4rem 0.85rem;
        font-weight: 600;
        font-size: 0.85rem;
        color: #6b7280;
        background: #f8f9fa;
        transition: all 0.2s ease;
    }

    .cert-chip:hover {
        border-color: #6366f1;
        color: #6366f1;
    }

    .cert-card-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .cert-action-btn {
        border: none;
        border-radius: 12px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        background: linear-gradient(135deg, #6366f1, #4338ca);
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .cert-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
    }

    /* Highlight */
    .cert-highlight {
        background: linear-gradient(120deg, rgba(251, 191, 36, 0.4), rgba(251, 191, 36, 0.2));
        color: #1a1a1a;
        padding: 0.1em 0.3em;
        border-radius: 12px;
        font-weight: 700;
    }

    /* ============ Certificate Attachment Section ============ */

    /* Certificate Attachment Section */
    .cert-attachment-section {
        padding: 1rem;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%);
        border-top: 1px solid rgba(99, 102, 241, 0.1);
        margin-top: 0.75rem;
    }

    .cert-attachment-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .cert-attachment-icon {
        font-size: 1rem;
    }

    .cert-attachment-title {
        font-size: 0.813rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .cert-attached-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.2);
        border-radius: 8px;
        margin-bottom: 0.75rem;
    }

    .cert-attached-badge {
        font-size: 0.75rem;
        font-weight: 600;
        color: #16a34a;
    }

    .cert-view-attachments-btn {
        padding: 0.25rem 0.75rem;
        background: transparent;
        color: #6366f1;
        border: 1px solid #6366f1;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .cert-view-attachments-btn:hover {
        background: #6366f1;
        color: white;
    }

    .cert-attachment-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .cert-tender-dropdown {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.813rem;
        background: #ffffff;
        color: #1a1a1a;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .cert-tender-dropdown:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .cert-attach-btn {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.813rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .cert-attach-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .cert-attach-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .cert-attach-fav-btn {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.85rem;
        white-space: nowrap;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    }

    .cert-attach-fav-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .cert-attach-fav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .cert-attachment-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    /* Attachments Modal */
    .cert-attachments-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(4px);
    }

    .cert-attachments-modal-content {
        background: #ffffff;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .cert-attachments-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .cert-attachments-modal-header h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a1a1a;
    }

    .cert-attachments-modal-header button {
        background: none;
        border: none;
        font-size: 2rem;
        color: #6b7280;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
    }

    .cert-attachments-modal-body {
        padding: 1.5rem;
        max-height: calc(80vh - 100px);
        overflow-y: auto;
    }

    .cert-no-attachments {
        text-align: center;
        color: #6b7280;
        padding: 2rem;
    }

    .cert-attachments-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .cert-attachment-item {
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #f8f9fa;
    }

    .cert-attachment-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .cert-attachment-item-header h4 {
        font-size: 1rem;
        font-weight: 600;
        color: #1a1a1a;
        flex: 1;
        margin-right: 1rem;
    }

    .cert-detach-btn {
        padding: 0.375rem 0.75rem;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .cert-detach-btn:hover {
        background: #dc2626;
        transform: translateY(-1px);
    }

    .cert-attachment-item-authority {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
    }

    .cert-attachment-item-meta {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-bottom: 0.5rem;
    }

    .cert-attachment-item-notes {
        font-size: 0.813rem;
        color: #6b7280;
        font-style: italic;
        padding: 0.5rem;
        background: rgba(99, 102, 241, 0.05);
        border-left: 3px solid #6366f1;
        border-radius: 4px;
        margin-top: 0.5rem;
    }

    /* Notification Toast */
    .cert-notification {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10001;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
    }

    .cert-notification-show {
        transform: translateY(0);
        opacity: 1;
    }

    .cert-notification-success {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }

    .cert-notification-error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .cert-notification-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .cert-notification-info {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    }

    /* ============ Manual Clause Mode Styles ============ */

    /* Filters Panel */
    .manual-filters-panel {
        background: linear-gradient(135deg, rgba(248, 250, 252, 0.95) 0%, rgba(241, 245, 249, 0.95) 100%);
        border-radius: 12px;
        padding: 32px;
        margin-bottom: 32px;
        border: 1px solid rgba(99, 102, 241, 0.12);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
    }

    .manual-filters-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 28px;
        padding-bottom: 20px;
        border-bottom: 2px solid rgba(99, 102, 241, 0.15);
    }

    .manual-filters-header h3 {
        font-size: 1.375rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
        letter-spacing: -0.3px;
    }

    .filter-toggle-btn {
        background: transparent;
        border: none;
        color: #6366f1;
        font-size: 22px;
        cursor: pointer;
        padding: 6px 10px;
        transition: all 0.3s ease;
        border-radius: 12px;
    }

    .filter-toggle-btn:hover {
        transform: scale(1.1);
        background: rgba(99, 102, 241, 0.08);
    }

    .manual-filters-content {
        animation: fadeIn 0.4s ease;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
        position: relative;
        z-index: 0;
    }

    /* Filter Section Headers */
    .filter-section-header {
        grid-column: 1 / -1;
        font-size: 13px;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        margin-bottom: -16px;
        padding-bottom: 12px;
        border-bottom: 2px solid rgba(99, 102, 241, 0.12);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-section-header::before {
        content: '';
        width: 4px;
        height: 16px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-radius: 2px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: rgba(255, 255, 255, 0.7);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid rgba(226, 232, 240, 0.8);
        transition: all 0.3s ease;
        margin-bottom: 0;
        position: relative;
        z-index: 1;
    }

    .filter-group:has(.choices.is-open) {
        z-index: 1000;
    }

    .filter-group:hover {
        background: white;
        border-color: rgba(99, 102, 241, 0.25);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.08);
        transform: translateY(-2px);
    }

    .filter-group--range {
        grid-column: span 1;
    }

    .filter-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
        color: #334155;
        margin-bottom: 6px;
    }

    .filter-label::before {
        content: attr(data-icon);
        font-size: 16px;
        opacity: 0.8;
    }

    .filter-select {
        width: 100%;
        min-height: 46px;
    }

    .manual-filters-content .filter-group .choices__inner {
        margin-bottom: 0;
        padding-bottom: 8px;
    }

    .manual-filters-content .filter-group .choices__list--multiple {
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .manual-filters-content .filter-group .choices__input {
        margin-bottom: 0;
    }

    /* Date Input Wrapper */
    .date-input-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .date-range-input {
        width: 100%;
        padding: 12px 16px 12px 40px;
        border: 1.5px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        color: #334155;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .date-range-input::placeholder {
        color: #94a3b8;
    }

    .date-range-input:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .date-range-input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.12);
    }

    /* Calendar icon for date inputs */
    .date-input-wrapper::before {
        content: 'ðŸ“…';
        position: absolute;
        left: 14px;
        top: 12px;
        font-size: 16px;
        pointer-events: none;
        z-index: 1;
    }

    /* Flatpickr Calendar z-index */
    .flatpickr-calendar {
        z-index: 1001 !important;
    }

    /* Custom Choices.js Styling for Manual Filters */
    .manual-filters-content .choices {
        margin-bottom: 0;
        position: relative;
    }

    .manual-filters-content .filter-group .choices {
        margin-bottom: 0;
    }

    .manual-filters-content .choices.is-open {
        z-index: 1001;
        position: relative;
    }

    .manual-filters-content .filter-group:has(.choices.is-open) {
        z-index: 1000;
    }

    .manual-filters-content .choices__inner {
        background: white;
        border: 1.5px solid #e2e8f0;
        border-radius: 12px;
        min-height: 46px;
        padding: 8px 12px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .manual-filters-content .choices__inner:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .manual-filters-content .choices.is-focused .choices__inner {
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.12);
    }

    .manual-filters-content .choices__list--multiple .choices__item {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border: none;
        border-radius: 12px;
        padding: 6px 12px;
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .manual-filters-content .choices__list--dropdown {
        border: 1.5px solid #e2e8f0;
        border-radius: 12px;
        margin-top: 4px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        z-index: 1002 !important;
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        background: white !important;
        max-height: 300px;
        overflow-y: auto;
    }

    .manual-filters-content .choices__list--dropdown.is-active {
        display: block !important;
    }

    .manual-filters-content .choices__list--dropdown .choices__item--selectable {
        padding: 12px 16px;
        font-size: 14px;
    }

    .manual-filters-content .choices__list--dropdown .choices__item--selectable.is-highlighted {
        background: rgba(99, 102, 241, 0.1);
        color: #1e293b;
    }

    .manual-filters-content .choices__input {
        background: transparent;
        font-size: 14px;
        color: #334155;
        padding: 4px 0;
    }

    .manual-filters-content .choices__input::placeholder {
        color: #94a3b8;
    }

    .manual-filters-content .choices__button {
        background: rgba(255, 255, 255, 0.3);
        border: none;
        border-radius: 12px;
        padding: 2px 6px;
        margin-left: 6px;
        opacity: 0.8;
        transition: opacity 0.2s ease;
    }

    .manual-filters-content .choices__button:hover {
        opacity: 1;
    }

    /* Range Slider Styling */
    .range-slider {
        margin: 20px 0 16px 0;
    }

    /* Custom noUiSlider styling */
    .manual-filters-content .noUi-target {
        background: #e2e8f0;
        border: none;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
        border-radius: 12px;
        height: 8px;
    }

    .manual-filters-content .noUi-connect {
        background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
    }

    .manual-filters-content .noUi-handle {
        background: white;
        border: 3px solid #6366f1;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        width: 20px;
        height: 20px;
        top: -7px;
        cursor: grab;
    }

    .manual-filters-content .noUi-handle:active {
        cursor: grabbing;
        transform: scale(1.1);
    }

    .manual-filters-content .noUi-handle::before,
    .manual-filters-content .noUi-handle::after {
        display: none;
    }

    .manual-filters-content .noUi-tooltip {
        background: #1e293b;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 4px 8px;
        font-size: 12px;
        font-weight: 600;
    }

    .range-values {
        display: flex;
        justify-content: space-between;
        margin-top: 12px;
    }

    .range-value {
        font-size: 13px;
        font-weight: 600;
        color: #64748b;
        padding: 4px 10px;
        background: rgba(99, 102, 241, 0.08);
        border-radius: 12px;
    }

    .filter-actions {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid rgba(99, 102, 241, 0.1);
    }

    .btn-secondary {
        background: white;
        color: #64748b;
        border: 2px solid #e2e8f0;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        color: #475569;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Results Section */
    .manual-results-section {
        animation: fadeInUp 0.5s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .manual-results-summary {
        margin-bottom: 24px;
        padding: 16px 20px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        border-radius: 12px;
        border-left: 4px solid #6366f1;
    }

    .results-text {
        font-size: 1rem;
        color: #475569;
        margin: 0;
    }

    .results-text strong {
        color: #1e293b;
        font-weight: 700;
    }

    /* Results Grid */
    .manual-results-grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    /* Certificate Card */
    .manual-cert-card {
        position: relative;
        background: white;
        border-radius: 12px;
        padding: 24px;
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .manual-cert-card:hover {
        border-color: #6366f1;
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.12);
        transform: translateY(-2px);
    }

    /* Loading States */
    .manual-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
    }

    .manual-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(99, 102, 241, 0.1);
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .manual-loading-text {
        margin-top: 16px;
        font-size: 1rem;
        color: #64748b;
        font-weight: 500;
    }

    /* No Results State */
    .manual-no-results {
        text-align: center;
        padding: 60px 20px;
    }

    .manual-no-results-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .manual-no-results h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 8px 0;
    }

    .manual-no-results p {
        font-size: 1rem;
        color: #64748b;
        margin: 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .cert-intel-modal-content {
            width: 98%;
            height: 95vh;
            border-radius: 12px;
        }

        .cert-intel-modal-header {
            padding: 16px 20px;
        }

        .cert-intel-modal-header h2 {
            font-size: 1.375rem;
        }

        .cert-intel-modal-body {
            padding: 20px;
        }

        .cert-mode-nav {
            flex-direction: column;
            gap: 8px;
            padding: 6px;
        }

        .cert-mode-btn {
            padding: 14px 20px;
            font-size: 14px;
        }

        .cert-mode-icon {
            font-size: 18px;
        }

        .cert-search-box {
            flex-direction: column;
        }

        .cert-search-button {
            width: 100%;
        }

        .cert-material-card {
            padding: 1.25rem;
        }

        .cert-card-header {
            flex-direction: column;
        }

        .cert-card-grid {
            grid-template-columns: 1fr;
        }

        .cert-card-footer {
            flex-direction: column;
            align-items: flex-start;
        }

        .cert-card-actions {
            width: 100%;
        }

        .cert-action-btn {
            width: 100%;
        }

        .filter-grid {
            grid-template-columns: 1fr;
        }
    }

    /* ============ AI-Powered Certificate Matching Styles ============ */

    /* AI Filter Section */
    .ai-filter-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 32px;
        border-radius: 12px;
        margin-bottom: 32px;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
    }

    .ai-section-header {
        text-align: center;
        margin-bottom: 24px;
    }

    .ai-section-title {
        font-size: 24px;
        font-weight: 700;
        color: white;
        margin: 0 0 8px 0;
    }

    .ai-section-subtitle {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.9);
        margin: 0;
    }

    .ai-input-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    .ai-text-input-wrapper,
    .ai-image-upload-wrapper {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .ai-input-label {
        font-size: 14px;
        font-weight: 600;
        color: white;
    }

    .ai-text-area {
        width: 100%;
        padding: 16px;
        border-radius: 12px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.15);
        color: white;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        transition: all 0.3s ease;
    }

    .ai-text-area::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .ai-text-area:focus {
        outline: none;
        border-color: white;
        background: rgba(255, 255, 255, 0.2);
    }

    .btn-upload-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: transparent;
        color: white;
        border: none;
        padding: 20px 24px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        gap: 16px;
        min-height: auto;
        width: 100%;
    }

    .btn-upload-icon:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
    }

    .upload-icon-circle {
        width: 64px;
        height: 64px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .btn-upload-icon:hover .upload-icon-circle {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.05);
    }

    .upload-icon-circle svg {
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        width: 32px;
        height: 32px;
    }

    .upload-icon-text {
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 0.3px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
    }

    .upload-icon-subtext {
        font-size: 13px;
        font-weight: 400;
        opacity: 0.85;
        color: rgba(255, 255, 255, 0.75);
    }

    .image-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        margin-top: 12px;
    }

    .image-preview-item {
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 8px;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .image-preview-item img {
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: 12px;
    }

    .image-preview-name {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.8);
        text-align: center;
        margin-top: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .ai-actions {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
    }

    .btn-ai-primary {
        background: white;
        color: #667eea;
        padding: 14px 32px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-ai-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .btn-ai-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .ai-status {
        display: flex;
        align-items: center;
        gap: 12px;
        color: white;
        font-size: 14px;
        font-weight: 600;
    }

    /* AI Preview Modal */
    .ai-preview-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    }

    .ai-preview-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
    }

    .ai-preview-content {
        position: relative;
        background: white;
        border-radius: 12px;
        padding: 40px;
        max-width: 800px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
        z-index: 1;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-preview-header {
        text-align: center;
        margin-bottom: 32px;
        position: relative;
    }

    .ai-preview-header h3 {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    .ai-preview-close {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #f1f5f9;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 20px;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .ai-preview-close:hover {
        background: #e2e8f0;
        color: #334155;
        transform: rotate(90deg);
    }

    .ai-preview-grid {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 32px;
    }

    .ai-preview-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    /* Keyword Display Styles */
    .keyword-display-section {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.03) 0%, rgba(139, 92, 246, 0.03) 100%);
        padding: 24px;
        border-radius: 12px;
        margin-top: 24px;
        margin-bottom: 24px;
        border: 1px solid rgba(99, 102, 241, 0.1);
    }

    .keyword-section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 16px 0;
    }

    .keyword-chips-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
    }

    .keyword-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px 8px 16px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
        transition: all 0.2s ease;
    }

    .keyword-chip:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .keyword-chip-text {
        flex: 1;
    }

    .keyword-chip-remove {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        line-height: 1;
        padding: 0;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .keyword-chip-remove:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .keyword-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .add-keyword-container {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        align-items: center;
    }

    .new-keyword-input {
        flex: 1;
        padding: 8px 12px;
        border: 2px solid rgba(99, 102, 241, 0.2);
        border-radius: 12px;
        font-size: 0.875rem;
        transition: border-color 0.2s ease;
    }

    .new-keyword-input:focus {
        outline: none;
        border-color: #6366f1;
    }

    .update-results-container {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 16px;
        padding: 12px 16px;
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
        border-radius: 12px;
        border-left: 4px solid #ffc107;
    }

    .update-hint {
        font-size: 0.875rem;
        color: #856404;
        font-weight: 500;
    }

    .keyword-expansion-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid rgba(99, 102, 241, 0.1);
    }

    .keyword-expansion-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .keyword-expansion-item {
        background: white;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid rgba(99, 102, 241, 0.1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .keyword-expansion-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        margin-bottom: 12px;
    }

    .keyword-expansion-keyword {
        font-weight: 600;
        color: #6366f1;
        font-size: 0.9375rem;
    }

    .keyword-expansion-toggle {
        background: none;
        border: none;
        color: #6366f1;
        cursor: pointer;
        font-size: 0.875rem;
        padding: 4px 8px;
        border-radius: 12px;
        transition: background 0.2s ease;
    }

    .keyword-expansion-toggle:hover {
        background: rgba(99, 102, 241, 0.1);
    }

    .keyword-variants {
        display: none;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
    }

    .keyword-variants.expanded {
        display: flex;
    }

    .keyword-variant-chip {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
        border-radius: 12px;
        font-size: 0.8125rem;
        font-weight: 500;
    }

    /* Results Summary and Filter Buttons */
    .manual-results-summary {
        margin-bottom: 24px;
        padding: 16px 20px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        border-radius: 12px;
        border-left: 4px solid #6366f1;
    }

    .results-header {
        margin-bottom: 0;
    }

    .results-text {
        font-size: 1rem;
        color: #475569;
        margin: 0;
    }

    .results-text strong {
        color: #1e293b;
        font-weight: 700;
    }

    .keyword-filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid rgba(99, 102, 241, 0.1);
    }

    .keyword-filter-btn {
        padding: 8px 16px;
        background: white;
        border: 2px solid rgba(99, 102, 241, 0.2);
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6366f1;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .keyword-filter-btn:hover {
        background: rgba(99, 102, 241, 0.05);
        border-color: rgba(99, 102, 241, 0.4);
        transform: translateY(-1px);
    }

    .keyword-filter-btn--active {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-color: #6366f1;
        color: white;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .keyword-filter-btn--active:hover {
        background: linear-gradient(135deg, #5855eb 0%, #7c3aed 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    /* Compliance Badges */
    .compliance-badge {
        position: absolute;
        top: 16px;
        right: 16px;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 13px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .compliance-badge--perfect {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .compliance-badge--high {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
    }

    .compliance-badge--medium {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .compliance-badge--low {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .compliance-icon {
        font-size: 14px;
    }

    .compliance-text {
        font-size: 13px;
        letter-spacing: 0.3px;
    }

    /* Matched Keywords in Certificate Cards */
    .cert-matched-keywords {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px dashed #e2e8f0;
    }

    .matched-label {
        font-weight: 600;
        color: #64748b;
        font-size: 13px;
        margin-right: 8px;
        display: block;
        margin-bottom: 8px;
    }

    .matched-keyword-chip {
        display: inline-block;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        color: #6366f1;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        margin: 4px 4px 4px 0;
        border: 1px solid rgba(99, 102, 241, 0.2);
    }

    /* Responsive Design for AI Components */
    @media (max-width: 768px) {
        .ai-input-container {
            grid-template-columns: 1fr;
        }

        .ai-filter-section {
            padding: 24px 20px;
        }

        .ai-section-title {
            font-size: 20px;
        }

        .keyword-filter-buttons {
            gap: 6px;
        }

        .keyword-filter-btn {
            font-size: 0.8125rem;
            padding: 6px 12px;
        }
    }

    /* Toast Animations */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }

    /* ============ Pagination Styles ============ */
    .modal-pagination {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--surface-elevated);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .pagination-info {
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .pagination-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--surface-card);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .pagination-btn:hover:not(:disabled) {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        transform: translateY(-1px);
    }

    .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .pagination-btn svg {
        width: 16px;
        height: 16px;
    }

    .pagination-numbers {
        display: flex;
        gap: 0.25rem;
    }

    .pagination-page-btn {
        min-width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        background: var(--surface-card);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .pagination-page-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .pagination-page-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        font-weight: 600;
    }

    .pagination-ellipsis {
        padding: 0.5rem;
        color: var(--text-muted);
        user-select: none;
    }

    @media (max-width: 768px) {
        .pagination-controls {
            gap: 0.25rem;
        }

        .pagination-btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.8125rem;
        }

        .pagination-page-btn {
            min-width: 32px;
            height: 32px;
            font-size: 0.8125rem;
        }
    }

    /* ============ End Pagination Styles ============ */

    /* Load More Button Styles */
    .manual-load-more {
        text-align: center;
        padding: 20px 0;
        margin-top: 16px;
    }

    .manual-load-more .btn-outline {
        padding: 12px 32px;
        background: white;
        color: #6366f1;
        border: 2px solid #6366f1;
        border-radius: 12px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
    }

    .manual-load-more .btn-outline:hover {
        background: #6366f1;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    }

    /* AI Success Button Styles */
    .btn-ai-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 14px 32px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-ai-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    .btn-ai-success:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* AI Preview Modal Enhanced Styles */
    .ai-preview-title {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 8px 0;
    }

    .ai-preview-subtitle {
        font-size: 14px;
        color: #64748b;
        margin: 0;
        line-height: 1.6;
    }

    .ai-close-btn {
        position: absolute;
        top: 0;
        right: 0;
        background: #f1f5f9;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 20px;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .ai-close-btn:hover {
        background: #e2e8f0;
        color: #334155;
        transform: rotate(90deg);
    }

    .preview-filter-grid {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 32px;
    }

    /* ============ End AI-Powered Certificate Matching Styles ============ */

    /* ============ End Certificate Intelligence Modal Styles ============ */
</style>
{% endblock %}

{% block title %}{{ tender.title }} - BidSuite{% endblock %}

{% block content %}
<section class="section">
    {% if is_expired %}
    <div class="alert alert-error mb-4">
        <strong>âš ï¸ Tender Expired:</strong> This tender's deadline has passed and it has been removed from your favorites/shortlist. No further action is possible.
    </div>
    {% endif %}

    <div class="surface-card tender-hero">
        <div class="tender-hero__header">
            <div>
                <button onclick="window.history.back()" class="tender-action-btn" title="Back to previous page" style="margin-bottom: 0.75rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <h1 class="section-title tender-hero__title">{{ tender.title }}</h1>
                <p class="tender-hero__subtitle">Review the key facts before deciding your pursuit strategy.</p>
            </div>
        </div>

        <!-- Action Icons Row -->
        <div class="tender-hero__actions">
            {% if current_user or current_employee %}
            <!-- Hide favorite button for awarded tenders -->
            {% if not is_awarded %}
            <div class="action-btn-wrapper">
                <button
                    id="favoriteBtn"
                    type="button"
                    class="tender-action-btn{% if is_favorited %} favorited{% endif %}{% if is_shortlisted or is_rejected %} disabled{% endif %}"
                    onclick="toggleFavorite('{{ tender.id }}')"
                    {% if is_shortlisted or is_rejected %}disabled{% endif %}
                    data-tooltip="{% if is_shortlisted %}Already shortlisted for active pursuit{% elif is_rejected %}Marked as rejected{% elif is_favorited %}Remove from favorites{% else %}Add to favorites for quick access{% endif %}">
                    {% if is_shortlisted %}
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {% elif is_rejected %}
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {% elif is_favorited %}
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
                    </svg>
                    {% else %}
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    {% endif %}
                </button>
                <span class="action-btn-label">{% if is_shortlisted %}Shortlisted{% elif is_rejected %}Rejected{% elif is_favorited %}Favorited{% else %}Favorite{% endif %}</span>
            </div>
            {% endif %}
            <div class="action-btn-wrapper">
                <button onclick="toggleDocumentsPanel()" class="tender-action-btn" id="documentsBtn" data-tooltip="View and download tender documents">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <span class="action-btn-label">Documents</span>
            </div>
            <div class="action-btn-wrapper">
                <button onclick="openScreenshotsViewer()" class="tender-action-btn" data-tooltip="View full-page screenshots of tender notice">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
                        <polyline points="21 15 16 10 5 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <span class="action-btn-label">Screenshots</span>
            </div>
            <div class="action-btn-wrapper">
                <button
                    id="reminderBtn"
                    type="button"
                    class="tender-action-btn"
                    onclick="addReminder()"
                    data-tooltip="Set a custom reminder for important dates or deadlines">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <span class="action-btn-label">Reminder</span>
            </div>
            {% endif %}
        </div>

        <div class="tender-highlight-grid">
            {% if tender.estimated_value %}
            <article class="tender-highlight">
                <span class="tender-highlight__label">Estimated value</span>
                <span class="tender-highlight__value">â‚¹{{ tender.estimated_value|indian_currency }}</span>
                <span class="tender-highlight__hint">Budgeted project value</span>
            </article>
            {% endif %}
            <article class="tender-highlight">
                <span class="tender-highlight__label">Deadline</span>
                <span class="tender-highlight__value">
                    {% if tender.deadline %}
                        {{ tender.deadline.strftime('%B %d, %Y') }}
                        <small>{{ tender.deadline.strftime('%I:%M %p') }}</small>
                    {% else %}
                        Not published
                    {% endif %}
                </span>
                <span class="tender-highlight__hint">Submission window</span>
            </article>
            {% if tender.category %}
            <article class="tender-highlight">
                <span class="tender-highlight__label">Category</span>
                <span class="tender-highlight__value">{{ tender.category }}</span>
                <span class="tender-highlight__hint">Tender classification</span>
            </article>
            {% endif %}
        </div>

        {% if tender.tags %}
        <div class="tender-tag-strip">
            {% for tag in tender.tags %}
            <span class="badge badge--muted">{{ tag }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</section>

<section class="section matching-intel-section">
    <div class="panel matching-intel-panel">
        <div class="panel-header">
            <div>
                <h2 class="surface-card__title">Matching Intelligence</h2>
                <p class="panel-subtitle">Gauge your readiness across key review lanes before moving forward.</p>
            </div>
        </div>
        <div class="matching-card-grid">
            <!-- Card 1: Technical Matching with Completion Certificates -->
            <button type="button" class="matching-card" onclick="openCertificateMatchingModal()">
                <div class="matching-card__icon matching-card__icon--technical">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14 2v6h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 3L2 9l10 6 10-6-10-6z" fill="currentColor" opacity="0.3" transform="translate(0, 6) scale(0.5)"/>
                        <circle cx="12" cy="14" r="2.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        <path d="M12 16.5v1.5M10.5 12.5l-1-1M13.5 12.5l1-1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 class="matching-card__title">AI Based Certificate Matching</h3>
                <p class="matching-card__body">AI will extract PQ Clauses and find relevant certificates. (~ 80% accuracy)</p>
                <span class="matching-card__cta">Click to proceed</span>
            </button>

            <!-- Card 2: Manual Certificate Matching -->
            <button type="button" class="matching-card" onclick="openCertificateIntelligenceModal()">
                <div class="matching-card__icon matching-card__icon--company">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 21h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M5 21V7l8-4v18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13 21V9l6 3v9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 11h2M7 15h2M15 15h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <circle cx="16" cy="12" r="1" fill="currentColor"/>
                    </svg>
                </div>
                <h3 class="matching-card__title">Manual Certificate Matching</h3>
                <p class="matching-card__body">Find certificates using keywords or clauses manually.</p>
                <span class="matching-card__cta">Click to proceed</span>

            </button>
        </div>
    </div>
</section>

{# Breadcrumb Navigation #}
{% include 'components/breadcrumbs.html' %}

<section class="section">
    <div class="panel panel-collapsible" data-collapsible>
        <div class="panel-header">
            <div>
                <h2 class="surface-card__title">Snapshot</h2>
                <p class="panel-subtitle">Key identifiers you need while registering interest.</p>
            </div>
            <button
                type="button"
                class="panel-collapsible__toggle"
                data-collapsible-toggle
                aria-expanded="false"
                aria-controls="snapshotContent"
                aria-label="Expand snapshot">
                <span class="panel-collapsible__icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9" stroke-linecap="round" stroke-linejoin="round"></polyline>
                    </svg>
                </span>
            </button>
        </div>

        <div id="snapshotContent" class="panel-collapsible__content" data-collapsible-content>
            <div class="tender-meta-grid">
                {% if tender.tender_id %}
                <article class="tender-meta-card">
                    <span class="tender-meta-card__label">Tender ID</span>
                    <span class="tender-meta-card__value">{{ tender.tender_id }}</span>
                </article>
                {% endif %}
                {% if tender.authority %}
                <article class="tender-meta-card">
                    <span class="tender-meta-card__label">Authority</span>
                    <span class="tender-meta-card__value">{{ tender.authority }}</span>
                </article>
                {% endif %}
                <article class="tender-meta-card">
                    <span class="tender-meta-card__label">State</span>
                    <span class="tender-meta-card__value">{{ tender.state or 'Unknown' }}</span>
                </article>
                <article class="tender-meta-card">
                    <span class="tender-meta-card__label">Source</span>
                    <span class="tender-meta-card__value">{{ tender.source or 'Not specified' }}</span>
                </article>
                {% if tender.tender_reference_number %}
                <article class="tender-meta-card">
                    <span class="tender-meta-card__label">Reference #</span>
                    <span class="tender-meta-card__value">{{ tender.tender_reference_number }}</span>
                </article>
                {% endif %}
                {% if tender.organisation_chain %}
                <article class="tender-meta-card">
                    <span class="tender-meta-card__label">Organisation chain</span>
                    <span class="tender-meta-card__value">{{ tender.organisation_chain }}</span>
                </article>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<section class="section">
    <div class="panel panel-collapsible" data-collapsible>
        <div class="panel-header">
            <div>
                <h2 class="surface-card__title">Basic details</h2>
                <p class="panel-subtitle">Commercials and submission requirements shared by the authority.</p>
            </div>
            <button
                type="button"
                class="panel-collapsible__toggle"
                data-collapsible-toggle
                aria-expanded="false"
                aria-controls="basicDetailsContent"
                aria-label="Expand basic details">
                <span class="panel-collapsible__icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9" stroke-linecap="round" stroke-linejoin="round"></polyline>
                    </svg>
                </span>
            </button>
        </div>

        <div id="basicDetailsContent" class="panel-collapsible__content" data-collapsible-content>
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="detail-label">Tender type</span>
                    <span class="detail-value">{{ tender.tender_type or 'N/A' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Form of contract</span>
                    <span class="detail-value">{{ tender.form_of_contract or 'N/A' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">No. of covers</span>
                    <span class="detail-value">{{ tender.no_of_covers or 'N/A' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Payment mode</span>
                    <span class="detail-value">{{ tender.payment_mode or 'N/A' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Bid submission start</span>
                    <span class="detail-value">{{ tender.bid_submission_start|default('Not published') }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Bid submission end</span>
                    <span class="detail-value">{{ tender.bid_submission_end|default('Not published') }}</span>
                </div>
            </div>
        </div>
    </div>
</section>

{% if tender.work_item_details %}
<section class="section">
    <div class="panel panel-collapsible" data-collapsible>
        <div class="panel-header">
            <div>
                <h2 class="surface-card__title">Work item details</h2>
                <p class="panel-subtitle">Scope, milestones and location of the execution.</p>
            </div>
            <button
                type="button"
                class="panel-collapsible__toggle"
                data-collapsible-toggle
                aria-expanded="false"
                aria-controls="workItemDetailsContent"
                aria-label="Expand work item details">
                <span class="panel-collapsible__icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9" stroke-linecap="round" stroke-linejoin="round"></polyline>
                    </svg>
                </span>
            </button>
        </div>

        <div id="workItemDetailsContent" class="panel-collapsible__content" data-collapsible-content>
            {% if tender.work_item_details.get('Work Description') %}
            <article class="tender-description-block">
                <h3>Description</h3>
                <p>{{ tender.work_item_details['Work Description'] }}</p>
            </article>
            {% endif %}

            <div class="detail-grid">
                {% for key, value in tender.work_item_details.items() %}
                    {% if key not in ['Work Description', 'Title'] and value %}
                    <div class="detail-item">
                        <span class="detail-label">{{ key }}</span>
                        <span class="detail-value">{{ value }}</span>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</section>
{% endif %}

{% if tender.critical_dates %}
<section class="section">
    <div class="panel panel-collapsible" data-collapsible>
        <div class="panel-header">
            <div>
                <h2 class="surface-card__title">Critical dates</h2>
                <p class="panel-subtitle">Track every milestone communicated by the issuer.</p>
            </div>
            <button
                type="button"
                class="panel-collapsible__toggle"
                data-collapsible-toggle
                aria-expanded="false"
                aria-controls="criticalDatesContent"
                aria-label="Expand critical dates">
                <span class="panel-collapsible__icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9" stroke-linecap="round" stroke-linejoin="round"></polyline>
                    </svg>
                </span>
            </button>
        </div>

        <div id="criticalDatesContent" class="panel-collapsible__content" data-collapsible-content>
            <div class="detail-grid">
                {% for key, value in tender.critical_dates.items() %}
                    {% if value %}
                    <div class="detail-item">
                        <span class="detail-label">{{ key }}</span>
                        <span class="detail-value">{{ value }}</span>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</section>
{% endif %}

{% if tender.emd_fee_details or tender.tender_fee_details %}
<section class="section">
    <div class="panel panel-collapsible" data-collapsible>
        <div class="panel-header">
            <div>
                <h2 class="surface-card__title">Fee details</h2>
                <p class="panel-subtitle">Earnest money, document fee and other commercial notes.</p>
            </div>
            <button
                type="button"
                class="panel-collapsible__toggle"
                data-collapsible-toggle
                aria-expanded="false"
                aria-controls="feeDetailsContent"
                aria-label="Expand fee details">
                <span class="panel-collapsible__icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9" stroke-linecap="round" stroke-linejoin="round"></polyline>
                    </svg>
                </span>
            </button>
        </div>

        <div id="feeDetailsContent" class="panel-collapsible__content" data-collapsible-content>
            {% if tender.emd_fee_details %}
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.95rem; font-weight: 600; color: #1e293b; margin-bottom: 0.75rem;">EMD Fee Details</h3>
                <div class="detail-grid">
                    {% for key, value in tender.emd_fee_details.items() %}
                        {% if value %}
                        <div class="detail-item">
                            <span class="detail-label">{{ key }}</span>
                            <span class="detail-value">{{ value }}</span>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if tender.tender_fee_details %}
            <div>
                <h3 style="font-size: 0.95rem; font-weight: 600; color: #1e293b; margin-bottom: 0.75rem;">Tender Fee Details</h3>
                <div class="detail-grid">
                    {% for key, value in tender.tender_fee_details.items() %}
                        {% if value %}
                        <div class="detail-item">
                            <span class="detail-label">{{ key }}</span>
                            <span class="detail-value">{{ value }}</span>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</section>
{% endif %}

<!-- Matching Modal -->
<div class="modal matching-modal" id="matchingModal" aria-hidden="true" role="dialog" style="display: none;">
    <div class="modal__overlay" onclick="closeMatchingModal()"></div>
    <div class="modal__dialog matching-modal__dialog">
        <header class="modal__header">
            <h2 class="modal__title" id="matchingModalTitle">Matching Preview</h2>
            <button type="button" class="modal__close" onclick="closeMatchingModal()">&times;</button>
        </header>
        <div class="modal__body matching-modal__body">
            <div class="matching-modal__badge" id="matchingModalBadge">Technical Matching</div>
            <h3 class="matching-modal__headline">New Feature Coming</h3>
            <p class="matching-modal__copy">
                We are crafting deep intelligence to help you qualify tenders faster. Check back soon for data-driven recommendations.
            </p>
        </div>
        <footer class="modal__footer matching-modal__footer">
            <button type="button" class="btn btn-primary" onclick="closeMatchingModal()">Got it</button>
        </footer>
    </div>
</div>

<div class="modal certificate-matching-modal" id="certificateMatchingModal" aria-hidden="true" role="dialog" style="display: none;">
    <div class="modal__overlay" onclick="closeCertificateMatchingModal()"></div>
    <div class="modal__dialog certificate-matching-modal__dialog">
        <header class="modal__header" style="align-items: flex-start;">
            <div>
                <h2 class="modal__title">Smart AI Insights</h2>
                <p class="panel-subtitle" id="aiInsightsSubtitle">Extract PQ and Eligibility criteria from tender documents using AI.</p>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: flex-start;">
                <button type="button" class="btn btn-outline" onclick="downloadInsightsReport()" disabled id="aiDownloadBtn">Download Report</button>
                <button type="button" class="btn btn-primary" id="aiExtractBtn" onclick="extractAIInsights()">Extract AI Insights</button>
            </div>
        </header>
        <div class="certificate-matching-modal__body">
            <aside class="certificate-matching-sidebar">
                <!-- Document Info Card -->
                <div class="cm-section" style="padding: 1rem 1.25rem; margin-bottom: 1rem;">
                    <h4 style="margin:0 0 0.5rem;font-size:0.95rem;">Document Selection</h4>
                    <div id="aiDocumentInfo">
                        <div style="margin-bottom:0.75rem;">
                            <label for="aiDocumentSelect" style="display:block;color:#475569;font-size:0.85rem;margin-bottom:0.25rem;">
                                <strong>Select PDF Document:</strong>
                            </label>
                            <select id="aiDocumentSelect" class="cm-select" style="width:100%;padding:0.5rem;font-size:0.85rem;border:1px solid #cbd5e1;border-radius:12px;background:#fff;">
                                <option value="">Loading documents...</option>
                            </select>
                            <small id="aiDocSelectHelp" style="display:block;margin-top:0.25rem;color:#64748b;font-size:0.75rem;">Choose which PDF to analyze</small>
                        </div>
                        <p style="color:#64748b;font-size:0.85rem;margin:0.25rem 0;">
                            <strong style="display:block;margin-bottom:0.125rem;">Last Analyzed:</strong>
                            <span id="aiDocFilename" style="display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:0.8rem;" title="">Not extracted yet</span>
                        </p>
                        <p style="color:#64748b;font-size:0.85rem;margin:0.25rem 0;">
                            <strong>Pages:</strong> <span id="aiDocPages">-</span>
                        </p>
                        <p style="color:#64748b;font-size:0.85rem;margin:0.25rem 0;">
                            <strong>Extraction Model:</strong> GPT-4o
                        </p>
                    </div>
                </div>

                <!-- Extraction Status Card -->
                <div class="cm-section" style="padding: 1rem 1.25rem; margin-bottom: 1rem;">
                    <h4 style="margin:0 0 0.5rem;font-size:0.95rem;">Extraction Status</h4>
                    <div style="display:flex;align-items:center;gap:0.5rem;margin:0 0 0.5rem;">
                        <span class="cm-status-badge" id="aiStatusBadge" data-status="not_started">Not Started</span>
                        <small id="aiCriteriaCount" style="font-size:0.8rem;">0 criteria extracted</small>
                    </div>
                    <div class="cm-progress">
                        <div class="cm-progress-bar">
                            <div class="cm-progress-bar__fill" id="aiProgressFill"></div>
                        </div>
                        <small id="aiProgressCopy" style="display:block;margin-top:0.3rem;color:#475569;font-size:0.8rem;">Click "Extract AI Insights" to begin.</small>
                    </div>
                </div>

                <!-- Quick Stats Card -->
                <div class="cm-section" style="padding: 1rem 1.25rem; margin-bottom: 1rem;">
                    <h4 style="margin:0 0 0.5rem;font-size:0.95rem;">Quick Stats</h4>
                    <ul style="padding-left:0;margin:0;list-style:none;color:#475569;font-size:0.85rem;line-height:1.8;">
                        <li style="display:flex;justify-content:space-between;">
                            <span>PQ Criteria:</span>
                            <strong id="aiPQCount">0</strong>
                        </li>
                        <li style="display:flex;justify-content:space-between;">
                            <span>Eligibility Criteria:</span>
                            <strong id="aiEligibilityCount">0</strong>
                        </li>
                        <li style="display:flex;justify-content:space-between;">
                            <span>Mandatory:</span>
                            <strong id="aiMandatoryCount">0</strong>
                        </li>
                        <li style="display:flex;justify-content:space-between;">
                            <span>Optional:</span>
                            <strong id="aiOptionalCount">0</strong>
                        </li>
                    </ul>
                </div>
            </aside>
            <section class="certificate-matching-main">
                <!-- Category Filter -->
                <div class="cm-section" style="margin-bottom: 1rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h4 style="margin:0 0 0.25rem;">Extracted Criteria</h4>
                            <p id="aiCriteriaSummary" style="margin:0;font-size:0.9rem;color:#64748b;">Extract insights to view criteria</p>
                        </div>
                        <div class="cm-filter-bar">
                            <label for="aiCategoryFilter" style="font-size:0.85rem;color:#475569;">Category</label>
                            <select id="aiCategoryFilter" class="cm-select" onchange="filterAICriteria()">
                                <option value="">All Criteria</option>
                                <option value="pq">PQ Criteria</option>
                                <option value="eligibility">Eligibility Criteria</option>
                            </select>
                            <label for="aiTypeFilter" style="font-size:0.85rem;color:#475569;margin-left:0.75rem;">Type</label>
                            <select id="aiTypeFilter" class="cm-select" onchange="filterAICriteria()">
                                <option value="">All Types</option>
                                <option value="financial">Financial</option>
                                <option value="technical">Technical</option>
                                <option value="experience">Experience</option>
                                <option value="registration">Registration</option>
                                <option value="certification">Certification</option>
                                <option value="legal">Legal</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Raw GPT Response Card (Collapsible) -->
                <div class="cm-section" id="aiRawResponseSection" style="margin-bottom: 1rem; display: none;">
                    <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:0.75rem 1rem;background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0;" onclick="toggleRawGPTResponse()">
                        <h4 style="margin:0;font-size:0.9rem;color:#475569;">
                            <svg id="aiRawResponseIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;vertical-align:middle;margin-right:0.5rem;transition:transform 0.2s;">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                            Raw GPT-4o Response (JSON)
                        </h4>
                        <small style="color:#64748b;font-size:0.75rem;">Click to expand/collapse</small>
                    </div>
                    <div id="aiRawResponseContent" style="display:none;margin-top:0.5rem;max-height:400px;overflow:auto;background:#1e293b;color:#e2e8f0;padding:1rem;border-radius:12px;font-family:monospace;font-size:0.8rem;line-height:1.6;white-space:pre-wrap;word-wrap:break-word;">
                        <code id="aiRawResponseText">No raw response available</code>
                    </div>
                </div>

                <!-- Criteria Table -->
                <div class="cm-section" style="flex:1;display:flex;flex-direction:column;">
                    <div style="flex:1;overflow:auto;">
                        <table class="cm-table ai-criteria-table">
                            <thead>
                                <tr>
                                    <th style="width:10%;">Category</th>
                                    <th style="width:13%;">Type</th>
                                    <th style="width:32%;">Title</th>
                                    <th style="width:18%;">Value</th>
                                    <th style="width:12%;">Mandatory</th>
                                    <th style="width:8%;">Page</th>
                                    <th style="width:7%;"></th>
                                </tr>
                            </thead>
                            <tbody id="aiCriteriaBody">
                                <tr><td colspan="7"><div class="cm-empty">Extract insights to view criteria details.</div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
        <footer class="modal__footer" style="justify-content: space-between; gap: 0.75rem;">
            <button type="button" class="btn btn-primary" id="matchCertificatesBtn" onclick="matchTechnicalExperienceCertificates()" style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); display: none;">
                ðŸŽ¯ Match Certificates
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeCertificateMatchingModal()">Close</button>
        </footer>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const collapsiblePanels = document.querySelectorAll('[data-collapsible]');

    collapsiblePanels.forEach((panel) => {
        const toggleBtn = panel.querySelector('[data-collapsible-toggle]');
        const content = panel.querySelector('[data-collapsible-content]');

        if (!toggleBtn || !content) {
            return;
        }

        content.hidden = true;
        panel.classList.add('is-collapsed');
        toggleBtn.setAttribute('aria-expanded', 'false');

        toggleBtn.addEventListener('click', () => {
            const isCollapsed = panel.classList.toggle('is-collapsed');
            content.hidden = isCollapsed;
            toggleBtn.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
        });
    });
});
</script>

<script>
const certificateMatchingTenderId = '{{ tender.id }}';
let isCurrentTenderFavorited = {{ 'true' if is_favorited else 'false' }};
const isBDEmployee = {{ 'true' if current_employee and current_employee.is_bd else 'false' }};
let cmMatches = [];
let cmStatusPoll = null;
const cmMethodBadgeEl = document.getElementById('cmMethodBadge');
const cmModeToggle = document.getElementById('cmModeToggle');
const cmModeSlider = cmModeToggle?.querySelector('.cm-mode-slider');
const cmMatchModeInput = document.getElementById('cmMatchMode');

// ============================================================================
// SMART AI INSIGHTS - Variables and Functions (defined early)
// ============================================================================

let aiInsightsTenderId = certificateMatchingTenderId;  // Use the tender ID
let aiInsightsData = null;
let aiInsightsStatusInterval = null;
let availablePDFDocuments = [];

// ============================================================================
// MODAL AI-POWERED CERTIFICATE MATCHING - State Variables
// ============================================================================

let modalAllKeywordResults = [];
let modalAllKeywords = [];
let modalCurrentKeywordFilter = 'combined';
let modalOriginalKeywords = [];
let modalModifiedKeywords = [];
let modalKeywordsModified = false;
let modalAiUploadedImages = [];

// ============================================================================
// CERTIFICATE SEARCH PAGINATION - State Variables
// ============================================================================

let currentCertPage = 1;
let currentCertQuery = '';
let currentCertTotalPages = 1;
let currentCertTotal = 0;

function openAIInsightsModal() {
    const tenderId = certificateMatchingTenderId;
    if (!tenderId) {
        alert('No tender selected');
        return;
    }

    aiInsightsTenderId = tenderId;
    const modal = document.getElementById('certificateMatchingModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');

        // Initialize match button visibility (hidden until criteria loaded)
        const matchBtn = document.getElementById('matchCertificatesBtn');
        if (matchBtn) matchBtn.style.display = 'none';

        // Load available PDF documents
        loadAvailablePDFs();

        // Load existing insights if available
        loadAIInsights();
    }
}

async function loadAvailablePDFs() {
    try {
        const response = await fetch(`/api/tenders/${aiInsightsTenderId}/pdf-documents`);
        if (!response.ok) throw new Error('Failed to load PDF documents');

        const data = await response.json();
        availablePDFDocuments = data.documents || [];

        const select = document.getElementById('aiDocumentSelect');
        if (availablePDFDocuments.length === 0) {
            select.innerHTML = '<option value="">No PDF documents found</option>';
            select.disabled = true;
        } else {
            select.innerHTML = availablePDFDocuments.map((doc, index) => {
                const label = `${doc.filename} (${doc.file_size_mb} MB)`;
                return `<option value="${doc.id}" ${index === 0 ? 'selected' : ''}>${label}</option>`;
            }).join('');
            select.disabled = false;
        }
    } catch (error) {
        console.error('Failed to load PDF documents:', error);
        const select = document.getElementById('aiDocumentSelect');
        select.innerHTML = '<option value="">Error loading documents</option>';
        select.disabled = true;
    }
}

function toggleRawGPTResponse() {
    const content = document.getElementById('aiRawResponseContent');
    const icon = document.getElementById('aiRawResponseIcon');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(90deg)';
    } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

function closeAIInsightsModal() {
    const modal = document.getElementById('certificateMatchingModal');
    if (modal) {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
    }

    // Clear polling
    if (aiInsightsStatusInterval) {
        clearInterval(aiInsightsStatusInterval);
        aiInsightsStatusInterval = null;
    }
}

async function loadAIInsights() {
    try {
        const response = await fetch(`/api/tenders/${aiInsightsTenderId}/insights-status`);
        if (!response.ok) throw new Error('Failed to load insights status');

        const data = await response.json();
        updateAIInsightsUI(data);

        // If completed, load criteria
        if (data.status === 'completed') {
            await loadAICriteria();
        }

    } catch (error) {
        console.error('Failed to load insights:', error);
    }
}

async function extractAIInsights(force = false) {
    const btn = document.getElementById('aiExtractBtn');
    if (!btn) return;

    // Get selected document ID
    const select = document.getElementById('aiDocumentSelect');
    const documentId = select.value;

    if (!documentId) {
        alert('Please select a PDF document to analyze');
        return;
    }

    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Extracting...';

    document.getElementById('aiProgressCopy').textContent = 'Starting AI extraction with GPT-4o...';
    document.getElementById('aiStatusBadge').setAttribute('data-status', 'processing');
    document.getElementById('aiStatusBadge').textContent = 'Processing';

    try {
        let url = `/api/tenders/${aiInsightsTenderId}/extract-insights?document_id=${documentId}`;
        if (force) {
            url += '&force=true';
        }
        const response = await fetch(url, { method: 'POST' });

        if (!response.ok) {
            const text = await response.text();
            throw new Error(text || 'Extraction failed');
        }

        const result = await response.json();

        if (result.status === 'completed') {
            document.getElementById('aiProgressCopy').textContent = 'Extraction complete!';
            await loadAIInsights();
        } else if (result.status === 'processing') {
            document.getElementById('aiProgressCopy').textContent = 'Extraction in progress...';
            startAIInsightsPolling();
        }

    } catch (error) {
        console.error('Extraction failed:', error);
        alert('Failed to extract insights: ' + error.message);
        document.getElementById('aiStatusBadge').setAttribute('data-status', 'failed');
        document.getElementById('aiStatusBadge').textContent = 'Failed';
        document.getElementById('aiProgressCopy').textContent = 'Extraction failed. Please try again.';
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

function startAIInsightsPolling() {
    if (aiInsightsStatusInterval) {
        clearInterval(aiInsightsStatusInterval);
    }

    aiInsightsStatusInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/tenders/${aiInsightsTenderId}/insights-status`);
            if (!response.ok) throw new Error('Status check failed');

            const data = await response.json();
            updateAIInsightsUI(data);

            if (data.status === 'completed') {
                clearInterval(aiInsightsStatusInterval);
                aiInsightsStatusInterval = null;
                await loadAICriteria();
            } else if (data.status === 'failed') {
                clearInterval(aiInsightsStatusInterval);
                aiInsightsStatusInterval = null;
            }

        } catch (error) {
            console.error('Status polling failed:', error);
        }
    }, 3000);
}

function updateAIInsightsUI(data) {
    const statusBadge = document.getElementById('aiStatusBadge');
    const statusMap = {
        'not_started': 'Not Started',
        'processing': 'Processing',
        'completed': 'Completed',
        'failed': 'Failed'
    };
    statusBadge.setAttribute('data-status', data.status);
    statusBadge.textContent = statusMap[data.status] || data.status;

    const totalCriteria = data.total_criteria || 0;
    document.getElementById('aiCriteriaCount').textContent = `${totalCriteria} criteria extracted`;

    if (data.document_filename) {
        const filenameElement = document.getElementById('aiDocFilename');
        filenameElement.textContent = data.document_filename;
        filenameElement.setAttribute('title', data.document_filename);
    }
    if (data.document_page_count) {
        document.getElementById('aiDocPages').textContent = data.document_page_count;
    }

    document.getElementById('aiPQCount').textContent = data.total_pq_criteria || 0;
    document.getElementById('aiEligibilityCount').textContent = data.total_eligibility_criteria || 0;
    document.getElementById('aiMandatoryCount').textContent = data.mandatory_count || 0;
    document.getElementById('aiOptionalCount').textContent = data.optional_count || 0;

    const progressFill = document.getElementById('aiProgressFill');
    if (data.status === 'completed') {
        progressFill.style.width = '100%';
        document.getElementById('aiProgressCopy').textContent = `Extracted ${totalCriteria} criteria successfully.`;
        document.getElementById('aiDownloadBtn').disabled = false;
    } else if (data.status === 'processing') {
        progressFill.style.width = '50%';
        document.getElementById('aiProgressCopy').textContent = 'AI is analyzing the document...';
    } else if (data.status === 'failed') {
        progressFill.style.width = '0%';
        document.getElementById('aiProgressCopy').textContent = data.error || 'Extraction failed.';
    }
}

async function loadAICriteria() {
    try {
        const response = await fetch(`/api/tenders/${aiInsightsTenderId}/insights-criteria`);
        if (!response.ok) throw new Error('Failed to load criteria');

        const data = await response.json();
        aiInsightsData = data;

        document.getElementById('aiCriteriaSummary').textContent =
            `${data.total_criteria} criteria extracted from tender document`;

        renderAICriteria(data.criteria);

        // Display raw GPT response if available
        if (data.raw_gpt_response) {
            const rawResponseSection = document.getElementById('aiRawResponseSection');
            const rawResponseText = document.getElementById('aiRawResponseText');

            rawResponseSection.style.display = 'block';

            // Format JSON for better readability
            try {
                const parsedResponse = JSON.parse(data.raw_gpt_response);
                rawResponseText.textContent = JSON.stringify(parsedResponse, null, 2);
            } catch (e) {
                // If not valid JSON, display as-is
                rawResponseText.textContent = data.raw_gpt_response;
            }
        } else {
            // Hide raw response section if no data
            document.getElementById('aiRawResponseSection').style.display = 'none';
        }

    } catch (error) {
        console.error('Failed to load criteria:', error);
    }
}

function renderAICriteria(criteria) {
    const tbody = document.getElementById('aiCriteriaBody');

    if (!criteria || criteria.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7"><div class="cm-empty">No criteria extracted yet.</div></td></tr>';
        // Hide match button when no criteria
        const matchBtn = document.getElementById('matchCertificatesBtn');
        if (matchBtn) matchBtn.style.display = 'none';
        return;
    }

    tbody.innerHTML = criteria.map(c => `
        <!-- Main row with all fields except description -->
        <tr class="criteria-main">
            <td>
                <span class="cm-badge cm-badge--${c.category === 'pq' ? 'blue' : 'purple'}">
                    ${c.category === 'pq' ? 'PQ' : 'Eligibility'}
                </span>
            </td>
            <td>
                <span class="cm-type-badge" data-type="${c.type || 'other'}">
                    ${(c.type || 'other').charAt(0).toUpperCase() + (c.type || 'other').slice(1)}
                </span>
            </td>
            <td style="font-size:0.85rem;font-weight:500;">${escapeHtml(c.title || 'Untitled')}</td>
            <td style="font-size:0.85rem;">${escapeHtml(c.value || '-')}</td>
            <td style="text-align:center;">
                ${c.is_mandatory ?
                    '<span style="color:#059669;">âœ“ Yes</span>' :
                    '<span style="color:#64748b;">No</span>'
                }
            </td>
            <td style="text-align:center;font-size:0.85rem;color:#64748b;">
                ${c.page_reference ? c.page_reference.replace('Page ', '') : '-'}
            </td>
            <td></td>
        </tr>
        <!-- Description row spanning all columns -->
        <tr class="criteria-description">
            <td colspan="7">
                <div class="ai-criteria-description-content">
                    <strong style="color:#1e293b;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:0.35rem;">Description</strong>
                    ${escapeHtml(c.description || 'No description provided')}
                </div>
            </td>
        </tr>
    `).join('');
    
    // Show/hide match button based on Technical/Experience criteria presence
    const hasTechnicalOrExperience = criteria.some(c => {
        const type = (c.type || '').toLowerCase();
        return type === 'technical' || type === 'experience';
    });
    
    const matchBtn = document.getElementById('matchCertificatesBtn');
    if (matchBtn) {
        matchBtn.style.display = hasTechnicalOrExperience ? 'inline-flex' : 'none';
    }
}

function filterAICriteria() {
    if (!aiInsightsData || !aiInsightsData.criteria) return;

    const categoryFilter = document.getElementById('aiCategoryFilter').value;
    const typeFilter = document.getElementById('aiTypeFilter').value;

    let filtered = aiInsightsData.criteria;

    if (categoryFilter) {
        filtered = filtered.filter(c => c.category === categoryFilter);
    }

    if (typeFilter) {
        filtered = filtered.filter(c => c.type === typeFilter);
    }

    renderAICriteria(filtered);
}

async function downloadInsightsReport() {
    try {
        const response = await fetch(`/api/tenders/${aiInsightsTenderId}/insights-download`);
        if (!response.ok) throw new Error('Download failed');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tender_${aiInsightsTenderId}_insights.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

    } catch (error) {
        console.error('Download failed:', error);
        alert('Failed to download report');
    }
}

/**
 * Extract descriptions from Technical and Experience type clauses,
 * concatenate them, and transfer to Manual Certificate Matching modal
 */
async function matchTechnicalExperienceCertificates() {
    try {
        // Step 1: Validate that criteria data exists
        if (!aiInsightsData || !aiInsightsData.criteria || aiInsightsData.criteria.length === 0) {
            showToast('âš ï¸ No criteria extracted yet. Please extract AI insights first.', 'warning');
            return;
        }

        // Step 2: Filter criteria for Technical and Experience types
        const relevantCriteria = aiInsightsData.criteria.filter(c => {
            const type = (c.type || '').toLowerCase();
            return type === 'technical' || type === 'experience';
        });

        // Step 3: Check if any relevant criteria were found
        if (relevantCriteria.length === 0) {
            showToast('â„¹ï¸ No Technical or Experience clauses found in the extracted criteria.', 'info');
            return;
        }

        // Step 4: Extract and concatenate descriptions
        const descriptions = relevantCriteria
            .map(c => c.description)
            .filter(desc => desc && desc.trim() !== '')
            .map(desc => desc.trim());

        if (descriptions.length === 0) {
            showToast('âš ï¸ No descriptions found for Technical or Experience clauses.', 'warning');
            return;
        }

        const concatenatedText = descriptions.join('\n\n---\n\n');

        // Step 5: Close current modal
        closeCertificateMatchingModal();

        // Step 6: Open Certificate Intelligence Modal
        openCertificateIntelligenceModal();

        // Step 7: Switch to Manual Clause mode
        setTimeout(() => {
            switchModalCertMode('manual-clause');

            // Step 8: Populate the textarea with concatenated text
            const textarea = document.getElementById('modalAiClauseText');
            if (textarea) {
                textarea.value = concatenatedText;
                
                // Optional: Add a visual feedback
                textarea.style.borderColor = '#10b981';
                textarea.style.borderWidth = '2px';
                setTimeout(() => {
                    textarea.style.borderColor = '';
                    textarea.style.borderWidth = '';
                }, 2000);
            }

            // Step 9: Automatically click the Extract Keywords & Search button
            setTimeout(() => {
                const extractBtn = document.getElementById('modalAiExtractBtn');
                if (extractBtn) {
                    extractBtn.click();
                    showToast(`âœ… Processing ${relevantCriteria.length} Technical/Experience clause(s)`, 'success');
                }
            }, 500);
        }, 300);

    } catch (error) {
        console.error('Error matching certificates:', error);
        showToast('âŒ An error occurred while matching certificates. Please try again.', 'error');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Export AI Insights functions to window
window.openAIInsightsModal = openAIInsightsModal;
window.closeAIInsightsModal = closeAIInsightsModal;
window.extractAIInsights = extractAIInsights;
window.filterAICriteria = filterAICriteria;
window.downloadInsightsReport = downloadInsightsReport;


if (cmModeSlider) {
    cmModeSlider.querySelectorAll('[data-mode]').forEach((btn) => {
        btn.addEventListener('click', () => setMatchingMode(btn.dataset.mode, { user: true }));
    });
}

const normalizeMatchingMode = (mode) => (mode === 'ai' ? 'ai' : 'keyword');

function setMatchingMode(mode, options = {}) {
    const normalized = normalizeMatchingMode(mode);
    if (cmMatchModeInput) {
        cmMatchModeInput.value = normalized;
    }
    if (cmModeToggle) {
        if (options.user) {
            cmModeToggle.dataset.userOverride = 'true';
        }
        cmModeToggle.dataset.mode = normalized;
    }
    if (cmModeSlider) {
        cmModeSlider.dataset.mode = normalized;
        cmModeSlider.querySelectorAll('[data-mode]').forEach((btn) => {
            const isActive = btn.dataset.mode === normalized;
            btn.classList.toggle('is-active', isActive);
            btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
    }
}

function setMethodBadge(mode) {
    if (!cmMethodBadgeEl) return;
    const normalized = normalizeMatchingMode(mode);
    const isAI = normalized === 'ai';
    cmMethodBadgeEl.textContent = isAI ? 'AI (beta)' : 'Keyword';
    cmMethodBadgeEl.dataset.mode = normalized;
    cmMethodBadgeEl.title = isAI
        ? 'AI mode uses GPT for semantic scoring across your repository.'
        : 'Keyword mode uses deterministic scoring across all certificates.';
}

function primeModeSelect(mode) {
    if (!cmModeToggle || cmModeToggle.dataset.userOverride === 'true') return;
    setMatchingMode(mode);
}

setMatchingMode(cmMatchModeInput?.value || 'keyword');

function formatMethodMeta(mode) {
    const normalized = normalizeMatchingMode(mode);
    return normalized === 'ai'
        ? 'AI mode â€¢ GPT scoring'
        : 'Keyword mode';
}

const cmEscape = (value) => {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
};

function stopEligibilityPolling() {
    if (cmStatusPoll) {
        clearInterval(cmStatusPoll);
        cmStatusPoll = null;
    }
}

function startEligibilityPolling() {
    stopEligibilityPolling();
    loadEligibilityStatus();
    cmStatusPoll = setInterval(loadEligibilityStatus, 4000);
}

function openCertificateMatchingModal() {
    // Redirect to new AI Insights modal
    openAIInsightsModal();
}

function closeCertificateMatchingModal() {
    // Redirect to new AI Insights modal close
    closeAIInsightsModal();
}

// Export certificate matching redirect functions to window
window.openCertificateMatchingModal = openCertificateMatchingModal;
window.closeCertificateMatchingModal = closeCertificateMatchingModal;

function showMatchingSkeleton() {
    document.getElementById('cmSummaryMessage').textContent = 'Loading latest runâ€¦';
    document.getElementById('cmTotalCertificates').textContent = '0';
    document.getElementById('cmMatchedCertificates').textContent = '0';
    document.getElementById('cmBestScore').textContent = '0';
    document.getElementById('cmCoverage').textContent = '0%';
    document.getElementById('cmMatchesMeta').textContent = 'Fetching previous matchesâ€¦';
    document.getElementById('cmMatchesBody').innerHTML = '<tr><td colspan="5"><div class="cm-empty">Loading resultsâ€¦</div></td></tr>';
    document.getElementById('cmDownloadBtn').disabled = true;
    setMethodBadge('keyword');
    primeModeSelect('keyword');
}

async function loadMatchingSummary() {
    try {
        const response = await fetch(`/api/tenders/${certificateMatchingTenderId}/matching-summary`);
        if (!response.ok) throw new Error('Unable to fetch matching summary');
        const data = await response.json();
        renderMatchingSummary(data);
    } catch (error) {
        console.error('Failed to load summary', error);
        document.getElementById('cmSummaryMessage').textContent = 'Could not load previous matches.';
        document.getElementById('cmMatchesBody').innerHTML = '<tr><td colspan="5"><div class="cm-empty">Try running the matcher again.</div></td></tr>';
    }
}

function renderMatchingSummary(data) {
    const matches = Array.isArray(data.matches) ? data.matches : [];
    cmMatches = matches;
    const total = data.total_certificates_considered ?? 0;
    const matched = data.matched_certificates ?? matches.length;
    const bestScore = data.best_score ?? (matches.length ? matches[0].score : 0);
    const coverage = total ? `${Math.round((matched / total) * 100)}%` : '0%';
    const method = normalizeMatchingMode(data.matching_method);
    const hasRun = Boolean(data.match_id);
    setMethodBadge(method);
    primeModeSelect(method);
    const readyMessage = method === 'ai'
        ? `AI scoring reviewed ${total} certificate${total === 1 ? '' : 's'}.`
        : `Keyword scoring reviewed ${total} certificate${total === 1 ? '' : 's'}.`;
    const idleMessage = method === 'ai'
        ? 'AI mode reviews every completed certificate with GPT-based reasoning.'
        : 'Keyword mode reviews every completed certificate.';

    document.getElementById('cmSummaryMessage').textContent = hasRun
        ? (matches.length
            ? `Latest run ready. ${readyMessage}`
            : `Latest run finished with no qualifying certificates. ${readyMessage}`)
        : `Run the matcher to get started. ${idleMessage}`;
    document.getElementById('cmTotalCertificates').textContent = total;
    document.getElementById('cmMatchedCertificates').textContent = matched;
    document.getElementById('cmBestScore').textContent = bestScore;
    document.getElementById('cmCoverage').textContent = coverage;
    const timestamp = data.created_at ? new Date(data.created_at) : null;
    const matchesLabel = matches.length
        ? `${matches.length} match${matches.length === 1 ? '' : 'es'}`
        : hasRun ? 'No matches found' : 'No runs yet';
    const metaParts = [matchesLabel, formatMethodMeta(method)];
    if (timestamp && !Number.isNaN(timestamp.getTime())) {
        const formatted = timestamp.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        metaParts.push(`Ran ${formatted}`);
    }
    document.getElementById('cmMatchesMeta').textContent = metaParts.join(' â€¢ ');
    document.getElementById('cmDownloadBtn').disabled = matches.length === 0;
    filterCertificateMatches();
}

function renderMatchTable(matchList) {
    const body = document.getElementById('cmMatchesBody');
    if (!body) return;
    if (!matchList.length) {
        body.innerHTML = '<tr><td colspan="5"><div class="cm-empty">No certificates met this filter.</div></td></tr>';
        return;
    }
    body.innerHTML = matchList.map((match, index) => {
        const tone = match.score >= 80 ? 'high' : match.score >= 65 ? 'mid' : 'low';
        const factors = (match.matching_factors || []).map(f => `<li>${cmEscape(f)}</li>`).join('') || '<li>No highlights recorded</li>';
        const gaps = (match.gaps || []).map(g => `<li>${cmEscape(g)}</li>`).join('') || '<li>No gaps detected</li>';
        const client = cmEscape(match.client_name || 'Client not specified');
        const location = cmEscape(match.location || 'Location not provided');
        const title = cmEscape(match.project_name || 'Certificate');
        const rowId = `cmGapRow${index}`;
        return `
            <tr class="cm-match-row" data-gap-row="${rowId}">
                <td>${title}</td>
                <td>${client}<br/><small style="color:#94a3b8;">${location}</small></td>
                <td><span class="cm-score-chip" data-tone="${tone}">${match.score}</span></td>
                <td><ul class="cm-factor-list">${factors}</ul></td>
                <td>
                    <button type="button" class="cm-gap-toggle" data-gap-toggle="${rowId}" aria-expanded="false">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 9l6 6 6-6"></path>
                        </svg>
                        Gaps
                    </button>
                    <div class="cm-gap-content" id="${rowId}" hidden>
                        <ul class="cm-gap-list">${gaps}</ul>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    attachGapToggleHandlers();
}

function filterCertificateMatches() {
    const threshold = document.getElementById('cmScoreFilter')?.value || 'all';
    if (!cmMatches.length) {
        document.getElementById('cmMatchesBody').innerHTML = '<tr><td colspan="5"><div class="cm-empty">Run the matcher to view ranked certificates.</div></td></tr>';
        return;
    }
    if (threshold === 'all') {
        renderMatchTable(cmMatches);
        return;
    }
    const minScore = Number(threshold);
    renderMatchTable(cmMatches.filter(match => match.score >= minScore));
}

function attachGapToggleHandlers() {
    const buttons = document.querySelectorAll('[data-gap-toggle]');
    buttons.forEach((btn) => {
        btn.removeEventListener('click', handleGapToggle);
        btn.addEventListener('click', handleGapToggle);
    });
}

function handleGapToggle(event) {
    const button = event.currentTarget;
    const targetId = button.getAttribute('data-gap-toggle');
    const content = document.getElementById(targetId);
    if (!content) return;
    const isExpanded = button.getAttribute('aria-expanded') === 'true';
    button.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
    button.dataset.expanded = isExpanded ? 'false' : 'true';
    if (isExpanded) {
        content.setAttribute('hidden', 'hidden');
    } else {
        content.removeAttribute('hidden');
    }
}


async function loadEligibilityStatus() {
    try {
        const response = await fetch(`/api/tenders/${certificateMatchingTenderId}/eligibility-status`);
        if (!response.ok) throw new Error('Unable to fetch status');
        const data = await response.json();
        updateEligibilityUI(data);
        if (['completed', 'failed', 'not_started'].includes(data.status || '')) {
            stopEligibilityPolling();
        }
    } catch (error) {
        console.error('Failed to load eligibility status', error);
    }
}

function updateEligibilityUI(status) {
    const badge = document.getElementById('cmStatusBadge');
    const criteria = document.getElementById('cmCriteriaCount');
    const progressFill = document.getElementById('cmProgressFill');
    const progressCopy = document.getElementById('cmProgressCopy');
    if (!badge || !criteria || !progressFill || !progressCopy) return;

    badge.dataset.status = status.status || 'not_started';
    badge.textContent = (status.status || 'not_started').replace('_', ' ').replace(/\w/g, l => l.toUpperCase());
    criteria.textContent = `${status.total_criteria_found || 0} criteria extracted`;

    const processed = status.progress?.processed_pages ?? 0;
    const totalPages = status.progress?.total_pages ?? 0;
    const percent = status.progress?.percentage ?? (totalPages ? Math.round((processed / totalPages) * 1000) / 10 : 0);
    progressFill.style.width = `${percent}%`;
    let copy = `Progress: ${percent}% (${processed}/${totalPages || 'â€¦'} pages)`;
    if (status.status === 'completed') {
        copy = `Completed with ${status.total_criteria_found || 0} criteria.`;
        // Load and display criteria when analysis is completed
        loadExtractedCriteria();
    } else if (status.status === 'failed') {
        copy = `Analysis failed. ${status.error || 'Please retry.'}`;
    }
    progressCopy.textContent = copy;
}

async function startTenderAnalysis(force = false) {
    const url = new URL(`/api/tenders/${certificateMatchingTenderId}/analyze-eligibility`, window.location.origin);
    if (force) url.searchParams.set('force', 'true');
    try {
        const response = await fetch(url, { method: 'POST' });
        if (!response.ok) {
            const text = await response.text();
            throw new Error(text || 'Failed to queue analysis');
        }
        document.getElementById('cmProgressCopy').textContent = 'Tender queued for analysis. We will update progress shortly.';
        startEligibilityPolling();
    } catch (error) {
        console.error('Failed to start analysis', error);
        alert('Unable to start analysis. Please try again.');
    }
}

async function runCertificateMatching() {
    const btn = document.getElementById('cmRunMatchingBtn');
    if (!btn) return;
    btn.disabled = true;
    const originalText = btn.textContent;
    const mode = normalizeMatchingMode(cmMatchModeInput?.value || 'keyword');
    btn.textContent = mode === 'ai' ? 'Running AIâ€¦' : 'Matchingâ€¦';
    const loadingCopy = mode === 'ai'
        ? 'AI mode is reviewing your certificates with GPTâ€¦'
        : 'Matching certificates to this tenderâ€¦';
    document.getElementById('cmSummaryMessage').textContent = loadingCopy;
    document.getElementById('cmMatchesBody').innerHTML = `<tr><td colspan="5"><div class="cm-empty">${loadingCopy}</div></td></tr>`;

    try {
        const response = await fetch(`/api/tenders/${certificateMatchingTenderId}/match-certificates`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ mode })
        });
        if (!response.ok) {
            const text = await response.text();
            throw new Error(text || 'Matching failed');
        }
        const data = await response.json();
        renderMatchingSummary(data);
    } catch (error) {
        console.error('Certificate matching failed', error);
        document.getElementById('cmSummaryMessage').textContent = 'Certificate matching failed. Please try again.';
        document.getElementById('cmMatchesBody').innerHTML = '<tr><td colspan="5"><div class="cm-empty">An error occurred while matching.</div></td></tr>';
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
        loadMatchingSummary();
    }
}

function downloadMatchingReport() {
    if (!cmMatches.length) {
        alert('Run the matcher first to download a report.');
        return;
    }
    alert('Report downloads will be available in the next milestone.');
}

// Store extracted criteria globally for filtering
let allExtractedCriteria = [];

async function loadExtractedCriteria() {
    try {
        const response = await fetch(`/api/tenders/${certificateMatchingTenderId}/eligibility-criteria`);
        if (!response.ok) throw new Error('Unable to fetch criteria');
        const data = await response.json();

        allExtractedCriteria = data.criteria || [];
        const section = document.getElementById('cmExtractedCriteriaSection');

        if (allExtractedCriteria.length > 0) {
            section.style.display = 'block';
            renderExtractedCriteria(allExtractedCriteria);
        } else {
            section.style.display = 'none';
        }
    } catch (error) {
        console.error('Failed to load extracted criteria', error);
        const section = document.getElementById('cmExtractedCriteriaSection');
        section.style.display = 'none';
    }
}

function renderExtractedCriteria(criteria) {
    const container = document.getElementById('cmCriteriaList');
    if (!container) return;

    if (criteria.length === 0) {
        container.innerHTML = '<p style="color:#94a3b8;text-align:center;padding:1rem;">No criteria match the selected filter.</p>';
        return;
    }

    const categoryColors = {
        experience: '#3b82f6',
        financial: '#10b981',
        technical: '#8b5cf6',
        location: '#f59e0b',
        authority: '#ef4444',
        metrics: '#06b6d4',
        services: '#ec4899',
        scope_of_work: '#6366f1',
        other: '#64748b'
    };

    const html = criteria.map((criterion, idx) => {
        const category = criterion.category || 'other';
        const color = categoryColors[category] || '#64748b';
        const requirements = criterion.requirements || {};
        const reqText = Object.keys(requirements).length > 0
            ? `<div style="margin-top:0.4rem;padding:0.4rem 0.5rem;background:#f1f5f9;border-radius: 12px;font-size:0.75rem;">
                <strong style="font-size:0.7rem;">Requirements:</strong> ${JSON.stringify(requirements, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;')}
               </div>`
            : '';

        return `
            <div style="margin-bottom:0.65rem;padding:0.6rem;border-left:3px solid ${color};background:#f8fafc;border-radius: 12px;">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.35rem;">
                    <span style="font-size:0.7rem;text-transform:uppercase;font-weight:600;color:${color};">${category.replace('_', ' ')}</span>
                    <span style="font-size:0.7rem;color:#94a3b8;white-space:nowrap;margin-left:0.5rem;">
                        ${criterion.type || 'mandatory'} | P${criterion.page_number || 1} | ${Math.round((criterion.confidence || 0) * 100)}%
                    </span>
                </div>
                <div style="color:#334155;line-height:1.4;font-size:0.85rem;">${criterion.text || 'No text available'}</div>
                ${reqText}
                ${criterion.keywords && criterion.keywords.length > 0
                    ? `<div style="margin-top:0.4rem;">
                        <strong style="font-size:0.7rem;color:#64748b;">Keywords:</strong>
                        ${criterion.keywords.map(kw => `<span style="display:inline-block;margin:0.15rem 0.25rem 0.15rem 0;padding:0.15rem 0.4rem;background:#e2e8f0;border-radius: 12px;font-size:0.7rem;color:#475569;">${kw}</span>`).join('')}
                       </div>`
                    : ''
                }
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

function filterExtractedCriteria() {
    const filter = document.getElementById('cmCategoryFilter');
    if (!filter) return;

    const selectedCategory = filter.value;
    const filtered = selectedCategory
        ? allExtractedCriteria.filter(c => c.category === selectedCategory)
        : allExtractedCriteria;

    renderExtractedCriteria(filtered);
}

window.startTenderAnalysis = startTenderAnalysis;
window.runCertificateMatching = runCertificateMatching;
window.filterCertificateMatches = filterCertificateMatches;
window.downloadMatchingReport = downloadMatchingReport;
window.filterExtractedCriteria = filterExtractedCriteria;

</script>




<!-- Shortlist/Reject Action Section (only show if favorited and not yet shortlisted/rejected) -->
{% if current_user %}
<section class="section" id="actionSection" style="display: {% if is_favorited and not is_shortlisted and not is_rejected %}block{% else %}none{% endif %};">
    <div class="panel" style="text-align: center;">
        <div class="panel-header" style="text-align: center;">
            <div style="width: 100%;">
                <h2 class="surface-card__title">Take Action on This Tender</h2>
                <p class="panel-subtitle">Shortlist this tender to track your bidding progress, or reject it with a reason.</p>
            </div>
        </div>
        <div class="panel-actions" style="justify-content: center; gap: 1rem; margin-top: 1.5rem;">
            <button type="button" class="btn btn-primary btn-lg" onclick="handleShortlist('{{ tender.id }}')">âœ“ Shortlist Tender</button>
            <button type="button" class="btn btn-outline btn-lg" onclick="handleReject('{{ tender.id }}')">âœ— Reject Tender</button>
        </div>
    </div>
</section>
{% endif %}

<!-- Reason Modal for Shortlist/Reject -->
<div class="modal" id="reasonModal" aria-hidden="true" role="dialog" style="display: none;">
    <div class="modal__overlay" onclick="closeReasonModal()"></div>
    <div class="modal__dialog">
        <header class="modal__header">
            <h2 class="modal__title" id="modalTitle">Provide Reason</h2>
            <button type="button" class="modal__close" onclick="closeReasonModal()">Ã—</button>
        </header>
        <div class="modal__body">
            <div class="form-group">
                <label for="reasonText" class="form-label">Reason</label>
                <textarea id="reasonText" class="form-control" rows="4" placeholder="Please explain your decision..."></textarea>
            </div>
        </div>
        <footer class="modal__footer">
            <button type="button" class="btn btn-secondary" onclick="closeReasonModal()">Cancel</button>
            <button type="button" class="btn btn-primary" id="submitReasonBtn" onclick="submitReason()">Submit</button>
        </footer>
    </div>
</div>


<!-- Reminder Modal -->
<div id="reminderModal" class="reminder-modal" style="display: none;">
    <div class="reminder-modal-overlay" onclick="closeReminderModal()"></div>
    <div class="reminder-modal-content">
        <div class="reminder-modal-header">
            <h3>Set Reminder</h3>
            <button type="button" class="reminder-modal-close" onclick="closeReminderModal()">&times;</button>
        </div>
        <div class="reminder-modal-body">
            <form id="reminderForm" onsubmit="saveReminder(event)">
                <div class="form-group">
                    <label for="reminderDate">Select Date</label>
                    <input type="date" id="reminderDate" name="reminderDate" class="form-input" required>
                </div>

                <div class="form-group">
                    <label>Select Time</label>
                    <div class="time-picker">
                        <select id="reminderHour" name="reminderHour" class="form-input time-select" required>
                            <option value="">HH</option>
                            <option value="00">00</option>
                            <option value="01">01</option>
                            <option value="02">02</option>
                            <option value="03">03</option>
                            <option value="04">04</option>
                            <option value="05">05</option>
                            <option value="06">06</option>
                            <option value="07">07</option>
                            <option value="08">08</option>
                            <option value="09">09</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                        </select>
                        <span class="time-separator">:</span>
                        <select id="reminderMinute" name="reminderMinute" class="form-input time-select" required>
                            <option value="">MM</option>
                            <option value="00">00</option>
                            <option value="05">05</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                            <option value="25">25</option>
                            <option value="30">30</option>
                            <option value="35">35</option>
                            <option value="40">40</option>
                            <option value="45">45</option>
                            <option value="50">50</option>
                            <option value="55">55</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="reminderNote">Note (Optional)</label>
                    <textarea id="reminderNote" name="reminderNote" class="form-input" rows="3" placeholder="Add a note for this reminder..."></textarea>
                </div>

                <div class="reminder-modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeReminderModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Set Reminder</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Certificate Intelligence Modal -->
<div id="certIntelligenceModal" class="cert-intel-modal" style="display: none;">
    <div class="cert-intel-modal-overlay" onclick="closeCertificateIntelligenceModal()"></div>
    <div class="cert-intel-modal-content">
        <!-- Modal Header -->
        <div class="cert-intel-modal-header">
            <h2 class="cert-intel-title">ðŸ” Certificate Intelligence</h2>
            <button type="button" class="cert-intel-close-btn" onclick="closeCertificateIntelligenceModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>

        <!-- Sub-Navigation for Certificate Modes -->
        <div class="cert-mode-nav">
            <button type="button"
                    class="cert-mode-btn cert-mode-btn--active"
                    id="modalSearchModeBtn"
                    onclick="switchModalCertMode('search')"
                    data-mode="search">
                <span class="cert-mode-icon">ðŸ”</span>
                <span class="cert-mode-label">Keyword Search</span>
            </button>
            <button type="button"
                    class="cert-mode-btn"
                    id="modalManualClauseModeBtn"
                    onclick="switchModalCertMode('manual-clause')"
                    data-mode="manual-clause">
                <span class="cert-mode-icon">ðŸ“</span>
                <span class="cert-mode-label">Manual Clause</span>
            </button>
        </div>

        <!-- Modal Body with Scrollable Content -->
        <div class="cert-intel-modal-body">

            <!-- MODE 1: Keyword Search Section -->
            <div class="cert-mode-content" id="modalCertSearchSection">
                <!-- Search Box -->
                <div class="cert-search-wrapper">
                    <div class="cert-search-box">
                        <input
                            type="text"
                            id="modalCertSearchInput"
                            class="cert-search-input"
                            placeholder="Type to search certificates..."
                            autocomplete="off"
                        />
                        <button type="button" id="modalCertSearchButton" class="cert-search-button" onclick="performModalCertSearch()">
                            Search
                        </button>
                        <button type="button" id="modalCertShowAllButton" class="cert-search-button cert-search-button--show-all" onclick="showAllModalCerts()">
                            Show All
                        </button>
                    </div>
                </div>

                <!-- Search Stats -->
                <div id="modalCertSearchStats" class="cert-search-stats" style="display: none;">
                    <p>Found <strong id="modalCertResultCount">0</strong> certificate(s)</p>
                </div>

                <!-- Loading Spinner -->
                <div id="modalCertLoadingSpinner" class="cert-loading" style="display: none;">
                    <div class="cert-spinner"></div>
                    <div class="cert-loading-text">Searching certificates...</div>
                </div>

                <!-- No Results -->
                <div id="modalCertNoResults" class="cert-no-results" style="display: none;">
                    <div class="cert-no-results-icon">ðŸ“‹</div>
                    <h3>No certificates found</h3>
                    <p>Try different keywords or check if you have uploaded any certificates yet.</p>
                </div>

                <!-- Results Grid -->
                <div id="modalCertResultsGrid" class="cert-cards-grid"></div>

                <!-- Pagination Controls -->
                <div id="modalCertPagination" class="modal-pagination" style="display: none;">
                    <div class="pagination-info">
                        <span id="modalCertPaginationInfo">Showing 0 of 0</span>
                    </div>
                    <div class="pagination-controls">
                        <button type="button" id="modalCertPrevBtn" class="pagination-btn" onclick="goToModalCertPage('prev')" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            Previous
                        </button>
                        <div id="modalCertPageNumbers" class="pagination-numbers"></div>
                        <button type="button" id="modalCertNextBtn" class="pagination-btn" onclick="goToModalCertPage('next')" disabled>
                            Next
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <!-- END MODE 1: Keyword Search Section -->

            <!-- MODE 2: Manual Clause Section -->
            <div class="cert-mode-content" id="modalCertManualClauseSection" style="display: none;">
                <!-- Hero Section -->
                <div class="manual-clause-hero">
                    <h3 class="manual-clause-title">ðŸ“ Certificate Intelligence</h3>
                    <p class="manual-clause-subtitle">Find matching certificates from your repository using AI-powered analysis</p>
                </div>

                <!-- AI-Powered Filter Section -->
                <div class="ai-filter-section">
                    <div class="ai-section-header">
                        <h4 class="ai-section-title">ðŸ¤– AI-Powered Keyword Extraction</h4>
                        <p class="ai-section-subtitle">Paste tender clause text or upload images, and AI will intelligently extract and match relevant keywords</p>
                    </div>

                    <div class="ai-input-container">
                        <!-- Text Input -->
                        <div class="ai-text-input-wrapper">
                            <label class="ai-input-label">ðŸ“ Paste Tender Clauses or Requirements</label>
                            <textarea id="modalAiClauseText" class="ai-text-area" rows="6" placeholder="Paste tender requirements, eligibility criteria, or technical specifications...
Example: 'Consultancy services for water supply infrastructure in Delhi NCR region. Minimum 5 years experience required...'"></textarea>
                        </div>

                        <!-- Image Upload -->
                        <div class="ai-image-upload-wrapper">
                            <label class="ai-input-label">ðŸ“· Upload Tender Document Images (Max 5)</label>
                            <input type="file" id="modalAiClauseImages" multiple accept="image/*" style="display: none;">
                            <button type="button" id="modalAiUploadBtn" class="btn-upload-icon">
                                <div class="upload-icon-circle">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                </div>
                                <div class="upload-icon-text">Choose Images</div>
                                <div class="upload-icon-subtext">Up to 5 images</div>
                            </button>
                            <div id="modalAiImagePreview" class="image-preview-grid"></div>
                        </div>
                    </div>

                    <div class="ai-actions">
                        <button type="button" id="modalAiExtractBtn" class="btn btn-ai-primary">
                            âœ¨ Extract Keywords & Search
                        </button>
                        <div id="modalAiProcessingStatus" class="ai-status" style="display: none;">
                            <div class="spinner"></div>
                            <span id="modalAiProcessingText">Analyzing with AI...</span>
                        </div>
                    </div>
                </div>

                <!-- Keyword Display Section -->
                <div id="modalKeywordDisplaySection" class="keyword-display-section" style="display: none;">
                    <div class="keyword-header-row">
                        <h4 class="keyword-section-title">ðŸ“‹ Extracted Keywords</h4>
                        <button type="button" id="modalAddKeywordBtn" class="btn btn-sm btn-outline" onclick="showModalAddKeywordInput()">
                            + Add Keyword
                        </button>
                    </div>
                    <div id="modalKeywordChipsContainer" class="keyword-chips-container"></div>
                    <div id="modalAddKeywordInputContainer" class="add-keyword-container" style="display: none;">
                        <input type="text" id="modalNewKeywordInput" class="new-keyword-input" placeholder="Enter new keyword..." onkeydown="handleModalNewKeywordKeydown(event)">
                        <button type="button" class="btn btn-sm btn-primary" onclick="addModalNewKeyword()">Add</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="hideModalAddKeywordInput()">Cancel</button>
                    </div>
                    <div id="modalUpdateResultsContainer" class="update-results-container" style="display: none;">
                        <button type="button" id="modalUpdateResultsBtn" class="btn btn-primary" onclick="updateModalResultsWithModifiedKeywords()">
                            ðŸ”„ Update Results
                        </button>
                        <span class="update-hint">Keywords have been modified. Click to update search results.</span>
                    </div>

                    <div id="modalKeywordExpansionSection" class="keyword-expansion-section" style="display: none;">
                        <h4 class="keyword-section-title">ðŸ” Expanded Variants</h4>
                        <div id="modalKeywordExpansionContainer" class="keyword-expansion-container"></div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="modalManualResultsSection" class="manual-results-section" style="display: none;">
                    <!-- Results Summary -->
                    <div class="manual-results-summary">
                        <p class="results-text">
                            Found <strong id="modalManualResultCount">0</strong> certificates |
                            Keywords Searched: <strong id="modalKeywordCount">0</strong>
                        </p>

                        <!-- Keyword Filter Buttons -->
                        <div id="modalKeywordFilterButtons" class="keyword-filter-buttons" style="display: none;">
                            <button type="button" class="keyword-filter-btn keyword-filter-btn--active" data-keyword="combined" onclick="filterModalResultsByKeyword('combined')">
                                Combined
                            </button>
                        </div>
                    </div>

                    <!-- Results Grid -->
                    <div id="modalManualResultsGrid" class="manual-results-grid"></div>

                    <!-- Load More (Future Enhancement) -->
                    <div id="modalManualLoadMore" class="manual-load-more" style="display: none;">
                        <button type="button" id="modalManualLoadMoreBtn" class="btn btn-outline">
                            Load More...
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="modalManualLoadingSpinner" class="manual-loading" style="display: none;">
                    <div class="manual-spinner"></div>
                    <div class="manual-loading-text">Searching certificates...</div>
                </div>

                <!-- No Results State -->
                <div id="modalManualNoResults" class="manual-no-results" style="display: none;">
                    <div class="manual-no-results-icon">ðŸ“‹</div>
                    <h3>No certificates found</h3>
                    <p>No certificates match your filter criteria. Try adjusting your filters.</p>
                </div>
            </div>
            <!-- END MODE 2: Manual Clause Section -->

        </div>
    </div>

    <!-- AI Filter Preview Modal -->
    <div id="modalAiFilterPreviewModal" class="ai-preview-modal" style="display: none;">
        <div class="ai-preview-overlay" onclick="closeModalAiPreview()"></div>
        <div class="ai-preview-content">
            <div class="ai-preview-header">
                <h4 class="ai-preview-title">ðŸŽ¯ AI-Extracted Tender Requirements</h4>
                <p class="ai-preview-subtitle">Review and edit the conditions extracted from your tender document. Click chips to edit or remove.</p>
                <button type="button" class="ai-close-btn" onclick="closeModalAiPreview()">âœ•</button>
            </div>

            <div id="modalAiFilterPreviewGrid" class="preview-filter-grid">
                <!-- Dynamic filter chips will be rendered here by JavaScript -->
            </div>

            <div class="ai-preview-actions">
                <button type="button" id="modalAiApplyFiltersBtn" class="btn btn-ai-success">
                    âœ“ Apply These Filters
                </button>
                <button type="button" id="modalAiCancelFiltersBtn" class="btn btn-secondary" onclick="closeModalAiPreview()">
                    âœ— Cancel
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
{{ super() | default('') }}
<style>
/* Custom Tooltip Styles for Action Buttons */
.tender-action-btn {
    position: relative;
    overflow: visible;
}

.tender-hero__actions .tender-action-btn.disabled,
.tender-hero__actions .tender-action-btn:disabled {
    pointer-events: auto;
}

.tender-action-btn[data-tooltip] {
    --tooltip-bg: rgba(15, 23, 42, 0.95);
    --tooltip-text: #f8fafc;
    --tooltip-border: rgba(100, 116, 139, 0.45);
    --tooltip-shadow: 0 18px 36px rgba(15, 23, 42, 0.35);
}

.tender-action-btn[data-tooltip]::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 14px);
    left: 50%;
    transform: translate(-50%, 10px);
    background: var(--tooltip-bg);
    color: var(--tooltip-text);
    padding: 0.55rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    line-height: 1.45;
    text-align: center;
    min-width: 160px;
    max-width: 240px;
    width: max-content;
    box-shadow: var(--tooltip-shadow);
    border: 1px solid var(--tooltip-border);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.18s ease, transform 0.18s ease;
    z-index: 40;
    letter-spacing: 0.01em;
    white-space: normal;
    overflow-wrap: anywhere;
}

.tender-action-btn[data-tooltip]::before {
    content: '';
    position: absolute;
    bottom: calc(100% + 4px);
    left: 50%;
    background: none;
    transform: translate(-50%, 8px) scale(0.9);
    border-width: 7px 7px 0 7px;
    border-style: solid;
    border-color: var(--tooltip-bg) transparent transparent transparent;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.18s ease, transform 0.18s ease;
    z-index: 39;
}

.tender-action-btn[data-tooltip]:hover::after,
.tender-action-btn[data-tooltip]:focus-visible::after,
.tender-action-btn[data-tooltip]:hover::before,
.tender-action-btn[data-tooltip]:focus-visible::before {
    opacity: 1;
    visibility: visible;
}

.tender-action-btn[data-tooltip]:hover::after,
.tender-action-btn[data-tooltip]:focus-visible::after {
    transform: translate(-50%, 0);
}

.tender-action-btn[data-tooltip]:hover::before,
.tender-action-btn[data-tooltip]:focus-visible::before {
    transform: translate(-50%, 0) scale(1);
}

.tender-action-btn[data-tooltip]:focus-visible {
    outline: 2px solid rgba(99, 102, 241, 0.55);
    outline-offset: 3px;
}

.tender-action-btn.disabled[data-tooltip]:hover::after,
.tender-action-btn.disabled[data-tooltip]:focus-visible::after {
    background: rgba(55, 65, 81, 0.95);
    border-color: rgba(100, 116, 139, 0.3);
}

.tender-action-btn.disabled[data-tooltip]:hover::before,
.tender-action-btn.disabled[data-tooltip]:focus-visible::before {
    border-color: rgba(55, 65, 81, 0.95) transparent transparent transparent;
}

/* Action Button Wrapper and Label Styles */
.action-btn-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
}

.action-btn-label {
    font-size: 0.6875rem;
    font-weight: 500;
    color: var(--text-secondary, #6b7280);
    text-align: center;
    line-height: 1.2;
    letter-spacing: 0.01em;
    max-width: 70px;
    word-wrap: break-word;
    transition: color 0.2s ease;
}

.action-btn-wrapper:hover .action-btn-label {
    color: var(--text-primary, #374151);
}

.action-btn-wrapper .tender-action-btn.favorited + .action-btn-label {
    color: var(--warning, #f59e0b);
    font-weight: 600;
}

.action-btn-wrapper .tender-action-btn.disabled + .action-btn-label {
    opacity: 0.5;
}

/* Adjust tender-hero__actions to accommodate labels */
.tender-hero__actions {
    gap: 16px !important;
    padding: 16px 0 !important;
}

@media (max-width: 640px) {
    .tender-action-btn[data-tooltip]::after {
        bottom: auto;
        top: calc(100% + 16px);
        transform: translate(-50%, -10px);
    }

    .tender-action-btn[data-tooltip]::before {
        bottom: auto;
        top: calc(100% + 4px);
        transform: translate(-50%, -8px) scale(0.9);
        border-width: 0 7px 7px 7px;
        border-color: transparent transparent var(--tooltip-bg) transparent;
    }

    .tender-action-btn[data-tooltip]:hover::after,
    .tender-action-btn[data-tooltip]:focus-visible::after {
        transform: translate(-50%, 0);
    }

    .tender-action-btn[data-tooltip]:hover::before,
    .tender-action-btn[data-tooltip]:focus-visible::before {
        transform: translate(-50%, 0) scale(1);
    }

    /* Mobile responsive adjustments for button labels */
    .tender-hero__actions {
        gap: 12px !important;
        padding: 12px 0 !important;
    }

    .action-btn-label {
        font-size: 0.625rem;
        max-width: 60px;
    }
}

@media (hover: none) {
    .tender-action-btn[data-tooltip]:active::after,
    .tender-action-btn[data-tooltip]:active::before {
        opacity: 1;
        visibility: visible;
    }

    .tender-action-btn[data-tooltip]:active::after {
        transform: translate(-50%, 0);
    }

    .tender-action-btn[data-tooltip]:active::before {
        transform: translate(-50%, 0) scale(1);
    }
}

@media (prefers-reduced-motion: reduce) {
    .tender-action-btn[data-tooltip]::after,
    .tender-action-btn[data-tooltip]::before {
    transition: none;
}
}

/* Matching Intelligence Section */
.matching-intel-section .panel {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.06) 0%, rgba(129, 140, 248, 0.03) 100%);
    border: 1px solid rgba(129, 140, 248, 0.15);
    box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
}

.matching-card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
    margin-top: 1.75rem;
}

.matching-card {
    position: relative;
    border: none;
    border-radius: 12px;
    padding: 1.75rem;
    background: white;
    cursor: pointer;
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    box-shadow: 0 12px 30px rgba(79, 70, 229, 0.12);
    transition: transform 0.18s ease, box-shadow 0.18s ease;
    color: var(--text-color);
}

.matching-card::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border: 1px solid transparent;
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.35), rgba(129, 140, 248, 0.25)) border-box;
    -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
}

.matching-card:hover,
.matching-card:focus-visible {
    transform: translateY(-6px);
    box-shadow: 0 20px 40px rgba(79, 70, 229, 0.18);
}

.matching-card:focus-visible {
    outline: none;
}

.matching-card--placeholder {
    cursor: default;
}

.matching-card--placeholder:hover,
.matching-card--placeholder:focus-visible {
    transform: none;
    box-shadow: 0 12px 30px rgba(79, 70, 229, 0.12);
}

.matching-card--placeholder .matching-card__cta {
    color: var(--text-muted);
}

.matching-card__icon {
    width: 52px;
    height: 52px;
    border-radius: 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    box-shadow: 0 16px 30px rgba(99, 102, 241, 0.3);
}

.matching-card__icon--certificate {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.matching-card__icon--technical {
    background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
    box-shadow: 0 16px 30px rgba(14, 165, 233, 0.28);
}

.matching-card__icon--company {
    background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
    box-shadow: 0 16px 30px rgba(139, 92, 246, 0.28);
}

.matching-card__icon--financial {
    background: linear-gradient(135deg, #22c55e 0%, #14b8a6 100%);
    box-shadow: 0 16px 30px rgba(34, 197, 94, 0.28);
}

.matching-card__icon--legal {
    background: linear-gradient(135deg, #f97316 0%, #f43f5e 100%);
    box-shadow: 0 16px 30px rgba(249, 115, 22, 0.28);
}

.matching-card__title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: var(--text-color);
}

.matching-card__body {
    margin: 0;
    color: var(--text-muted);
    line-height: 1.6;
    min-height: 3.75rem;
}

.matching-card__cta {
    margin-top: auto;
    font-weight: 600;
    color: var(--primary-color);
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    letter-spacing: 0.01em;
}

.matching-card__cta::after {
    content: 'â†’';
    font-size: 1rem;
    transition: transform 0.18s ease;
}

.matching-card:hover .matching-card__cta::after,
.matching-card:focus-visible .matching-card__cta::after {
    transform: translateX(4px);
}

/* Matching Modal Styles */
.matching-modal__dialog {
    max-width: 440px;
    border: 1px solid rgba(99, 102, 241, 0.2);
    overflow: hidden;
}

.matching-modal__body {
    text-align: center;
    padding: 2.25rem 2.5rem 1.75rem 2.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.matching-modal__badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(79, 70, 229, 0.12);
    color: #4338ca;
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    text-transform: uppercase;
}

.matching-modal__headline {
    margin: 0;
    font-size: 1.65rem;
    font-weight: 700;
    color: var(--text-color);
}

.matching-modal__copy {
    margin: 0;
    color: var(--text-muted);
    line-height: 1.65;
}

.matching-modal__footer {
    display: flex;
    justify-content: center;
    padding: 1.5rem 2.5rem 2.25rem 2.5rem;
}

body.dark-mode .matching-intel-section .panel {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(14, 165, 233, 0.08) 100%);
    border-color: rgba(99, 102, 241, 0.25);
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.45);
}

body.dark-mode .matching-card {
    background: rgba(17, 24, 39, 0.95);
    color: #e5e7eb;
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.45);
}

body.dark-mode .matching-card__title {
    color: #f9fafb;
}

body.dark-mode .matching-card__body {
    color: #cbd5f5;
}

body.dark-mode .matching-card__cta {
    color: #a5b4fc;
}

body.dark-mode .matching-modal__dialog {
    background: #111827;
    border-color: rgba(129, 140, 248, 0.35);
}

body.dark-mode .matching-modal__badge {
    background: rgba(129, 140, 248, 0.15);
    color: #c7d2fe;
}

body.dark-mode .matching-modal__headline {
    color: #e5e7eb;
}

body.dark-mode .matching-modal__copy {
    color: #cbd5f5;
}

@media (max-width: 768px) {
    .matching-card-grid {
        grid-template-columns: 1fr;
    }

    .matching-card {
        padding: 1.5rem;
    }

    .matching-modal__body {
        padding: 2rem 1.75rem 1.5rem 1.75rem;
    }

    .matching-modal__footer {
        padding: 1.25rem 1.75rem 1.75rem 1.75rem;
    }
}

/* Reminder Modal Styles */
.reminder-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2500;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease;
}

.reminder-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(8px);
}

.reminder-modal-content {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 480px;
    position: relative;
    z-index: 2501;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.3s ease;
}

.reminder-modal-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.reminder-modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    letter-spacing: -0.02em;
}

.reminder-modal-close {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 1.5rem;
    cursor: pointer;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    padding: 0;
}

.reminder-modal-close:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.05);
}

.reminder-modal-body {
    padding: 2rem;
    overflow-y: auto;
    max-height: 70vh;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #1f2937;
    font-size: 0.95rem;
}

.form-group .form-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.2s ease;
}

.form-group .form-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.time-picker {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.time-select {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.time-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.time-separator {
    font-size: 1.5rem;
    font-weight: 700;
    color: #6b7280;
}

.reminder-modal-footer {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    padding-top: 1rem;
}

/* Dark mode support */
body.dark-mode .reminder-modal-content {
    background: #1f2937;
}

body.dark-mode .form-group label {
    color: #f9fafb;
}

body.dark-mode .form-group .form-input,
body.dark-mode .time-select {
    background: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

body.dark-mode .form-group .form-input:focus,
body.dark-mode .time-select:focus {
    border-color: #667eea;
    background: #374151;
}

body.dark-mode .time-separator {
    color: #9ca3af;
}

/* Responsive */
@media (max-width: 768px) {
    .reminder-modal-content {
        width: 95%;
        max-width: none;
    }

    .reminder-modal-header,
    .reminder-modal-body {
        padding: 1.25rem;
    }
}


/* Documents Summary Cards Styles */
.documents-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.document-summary-card {
    display: flex;
    gap: 1.25rem;
    padding: 1.5rem;
    background: var(--surface, white);
    border: 1px solid var(--border, #e5e7eb);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.document-summary-card:hover {
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
    border-color: rgba(99, 102, 241, 0.3);
    transform: translateY(-2px);
}

.document-summary-icon {
    flex-shrink: 0;
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
    border-radius: 12px;
    color: #6366f1;
}

.document-summary-content {
    flex: 1;
    min-width: 0;
}

.document-summary-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-color, #1f2937);
    margin: 0 0 0.5rem 0;
}

.document-summary-count {
    font-size: 0.875rem;
    color: var(--text-secondary, #6b7280);
    margin: 0 0 1rem 0;
    font-weight: 500;
}

.document-summary-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.document-summary-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-color, #374151);
    padding: 0.375rem 0;
}

.document-summary-item svg {
    flex-shrink: 0;
    color: #10b981;
}

.document-summary-item span {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.documents-action-bar {
    display: flex;
    justify-content: center;
    padding: 1rem 0 0 0;
    border-top: 1px solid var(--border, #e5e7eb);
}

.btn-view-all-documents {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 2rem;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.btn-view-all-documents:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
}

.btn-view-all-documents:active {
    transform: translateY(0);
}

.btn-view-all-documents svg:first-child {
    flex-shrink: 0;
}

.btn-view-all-documents svg:last-child {
    flex-shrink: 0;
    transition: transform 0.3s ease;
}

.btn-view-all-documents:hover svg:last-child {
    transform: translateX(4px);
}

/* Dark Mode for Documents Summary */
body.dark-mode .document-summary-card {
    background: #1a1f2e;
    border-color: rgba(99, 102, 241, 0.2);
}

body.dark-mode .document-summary-card:hover {
    border-color: rgba(99, 102, 241, 0.4);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
}

body.dark-mode .document-summary-icon {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
    color: #818cf8;
}

body.dark-mode .document-summary-title {
    color: #e5e7eb;
}

body.dark-mode .document-summary-count {
    color: #9ca3af;
}

body.dark-mode .document-summary-item {
    color: #d1d5db;
}

body.dark-mode .document-summary-item svg {
    color: #34d399;
}

body.dark-mode .documents-action-bar {
    border-top-color: rgba(99, 102, 241, 0.2);
}

body.dark-mode .btn-view-all-documents {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
}

body.dark-mode .btn-view-all-documents:hover {
    box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
}

@media (max-width: 768px) {
    .documents-summary-grid {
        grid-template-columns: 1fr;
    }

    .document-summary-card {
        flex-direction: column;
        align-items: flex-start;
    }

    .document-summary-icon {
        width: 56px;
        height: 56px;
    }

    .btn-view-all-documents {
        width: 100%;
        justify-content: center;
    }
}

/* Documents Panel Styles */
.documents-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 400px;
    height: 100%;
    background: var(--surface, white);
    box-shadow: -4px 0 12px rgba(0,0,0,0.15);
    z-index: 9998;
    overflow-y: auto;
    display: none;
}

.documents-panel-content {
    padding: 24px;
}

.documents-list-message {
    color: var(--text-secondary);
    text-align: center;
    padding: 40px 20px;
}

.documents-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.documents-panel-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color);
}

.documents-panel-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: var(--text-secondary);
}

.documents-panel-close:hover {
    color: var(--text-color);
}

.document-item {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    background: var(--surface);
}

.document-item-content {
    display: flex;
    align-items: start;
    gap: 12px;
}

.document-item-icon {
    flex-shrink: 0;
    color: var(--text-secondary);
}

.document-item-details {
    flex: 1;
    min-width: 0;
}

.document-item-filename {
    margin: 0 0 4px 0;
    font-size: 0.9rem;
    font-weight: 600;
    word-wrap: break-word;
    color: var(--text-color);
}

.document-item-meta {
    margin: 0 0 8px 0;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.document-item-actions {
    display: flex;
    gap: 8px;
}

/* Dark Mode for Documents Panel */
body.dark-mode .documents-panel {
    background: #1a1f2e;
    box-shadow: -4px 0 12px rgba(0,0,0,0.5);
}

body.dark-mode .documents-panel-content {
    background: #1a1f2e;
}

body.dark-mode .documents-panel-title {
    color: #e5e7eb;
}

body.dark-mode .documents-panel-close {
    color: #9ca3af;
}

body.dark-mode .documents-panel-close:hover {
    color: #e5e7eb;
}

body.dark-mode .documents-list-message {
    color: #9ca3af;
}

body.dark-mode .document-item {
    background: #0f1419;
    border-color: rgba(99, 102, 241, 0.2);
}

body.dark-mode .document-item:hover {
    border-color: rgba(99, 102, 241, 0.4);
}

body.dark-mode .document-item-filename {
    color: #e5e7eb;
}

body.dark-mode .document-item-meta {
    color: #9ca3af;
}

body.dark-mode .document-item-icon {
    color: #9ca3af;
}

body.dark-mode #documents-list {
    background: transparent;
}

@media (max-width: 768px) {
    .documents-panel {
        width: 100%;
    }
}

/* Excel Viewer Modal Styles */
.excel-viewer-modal {
    background: var(--surface, white);
    color: var(--text-color, #1f2937);
    transition: background-color 0.2s, color 0.2s;
}

.excel-viewer-header {
    background: var(--surface, white);
    border-bottom: 1px solid var(--border, #e5e7eb);
}

.excel-viewer-body {
    background: var(--background, #f9fafb);
    flex: 1;
    overflow: auto;
    padding: 1.5rem;
}

#excel-loading {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary, #6b7280);
    font-size: 1.125rem;
}

#excel-error {
    text-align: center;
    padding: 3rem;
    color: var(--error, #dc2626);
    font-size: 1rem;
}

#excel-content {
    overflow-x: auto;
    overflow-y: auto;
    background: var(--surface, white);
    border-radius: 12px;
    padding: 1rem;
    max-height: calc(100vh - 250px);
}

#excel-content::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}

#excel-content::-webkit-scrollbar-track {
    background: var(--background, #f9fafb);
    border-radius: 12px;
}

#excel-content::-webkit-scrollbar-thumb {
    background: var(--border, #d1d5db);
    border-radius: 12px;
}

#excel-content::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary, #9ca3af);
}

#excel-sheet-tabs {
    display: flex;
    gap: 0.5rem;
    margin-left: 1rem;
    flex: 1;
    overflow-x: auto;
}

.excel-sheet-tab {
    padding: 0.5rem 1rem;
    border: none;
    background: transparent;
    color: var(--text-secondary, #6b7280);
    cursor: pointer;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.2s;
}

.excel-sheet-tab:hover {
    background: var(--hover-bg, rgba(99, 102, 241, 0.1));
    color: var(--primary, #6366f1);
}

.excel-sheet-tab.active {
    background: var(--primary, #6366f1);
    color: white;
}

#excel-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

#excel-table th,
#excel-table td {
    border: 1px solid var(--border, #e5e7eb);
    padding: 0.5rem 0.75rem;
    text-align: left;
    color: var(--text-color, #1f2937);
    background: var(--surface, white);
}

#excel-table th {
    background: var(--surface-darker, #f3f4f6);
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
}

#excel-table tr:hover td {
    background: var(--hover-bg, rgba(99, 102, 241, 0.05));
}

/* Dark Mode Support for Excel Viewer */
body.dark-mode .excel-viewer-modal {
    background: #1a1f2e;
    color: #e5e7eb;
}

body.dark-mode .excel-viewer-header {
    background: #1a1f2e;
    border-bottom-color: rgba(99, 102, 241, 0.2);
}

body.dark-mode .excel-viewer-body {
    background: #0f1419;
}

body.dark-mode #excel-loading {
    color: #9ca3af;
}

body.dark-mode #excel-error {
    color: #ef4444;
}

body.dark-mode #excel-content {
    background: #0f1419;
}

body.dark-mode #excel-content::-webkit-scrollbar-track {
    background: #0f1419;
}

body.dark-mode #excel-content::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.3);
}

body.dark-mode #excel-content::-webkit-scrollbar-thumb:hover {
    background: rgba(99, 102, 241, 0.5);
}

body.dark-mode .excel-sheet-tab {
    color: #9ca3af;
}

body.dark-mode .excel-sheet-tab:hover {
    background: rgba(99, 102, 241, 0.2);
    color: #818cf8;
}

body.dark-mode .excel-sheet-tab.active {
    background: #6366f1;
    color: white;
}

body.dark-mode #excel-table th,
body.dark-mode #excel-table td {
    border-color: rgba(99, 102, 241, 0.3) !important;
    color: #e5e7eb !important;
    background: #1a1f2e !important;
}

body.dark-mode #excel-table th {
    background: #0f1419 !important;
    color: #ffffff !important;
    border-bottom: 2px solid rgba(99, 102, 241, 0.5) !important;
}

body.dark-mode #excel-table tr:hover td {
    background: rgba(99, 102, 241, 0.15) !important;
}
</style>
<script>
// Matching Intelligence Modal Functions
window.openMatchingModal = function(matchType) {
    const modal = document.getElementById('matchingModal');
    if (!modal) return;

    const badge = document.getElementById('matchingModalBadge');
    const title = document.getElementById('matchingModalTitle');

    if (badge) badge.textContent = matchType;
    if (title) title.textContent = matchType;

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

};

window.closeMatchingModal = function() {
    const modal = document.getElementById('matchingModal');
    if (!modal) return;

    modal.style.display = 'none';
    document.body.style.overflow = '';

};


// ============================================================
// NEW ACTION BUTTON FUNCTIONS
// ============================================================


function addReminder() {
    const reminderModal = document.getElementById('reminderModal');
    const dateInput = document.getElementById('reminderDate');

    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;

    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    dateInput.value = tomorrow.toISOString().split('T')[0];

    // Set default time to 9:00 AM
    document.getElementById('reminderHour').value = '09';
    document.getElementById('reminderMinute').value = '00';

    // Clear note
    document.getElementById('reminderNote').value = '';

    // Show modal
    reminderModal.style.display = 'flex';
}

function closeReminderModal() {
    const reminderModal = document.getElementById('reminderModal');
    reminderModal.style.display = 'none';
}

async function saveReminder(event) {
    event.preventDefault();

    const tenderId = '{{ tender.id }}';
    const tenderTitle = '{{ tender.title }}';
    const date = document.getElementById('reminderDate').value;
    const hour = document.getElementById('reminderHour').value;
    const minute = document.getElementById('reminderMinute').value;
    const note = document.getElementById('reminderNote').value;

    // Validate inputs
    if (!date || !hour || !minute) {
        alert('Please fill in all required fields');
        return;
    }

    // Create datetime string
    const reminderDatetime = `${date}T${hour}:${minute}:00`;

    // Check if reminder is in the past
    const reminderTime = new Date(reminderDatetime);
    const now = new Date();
    if (reminderTime <= now) {
        alert('Reminder time must be in the future');
        return;
    }

    try {
        const response = await fetch('/api/reminders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                tender_id: tenderId,
                tender_title: tenderTitle,
                reminder_datetime: reminderDatetime,
                note: note
            })
        });

        const data = await response.json();

        if (response.ok) {
            alert('Reminder set successfully!');
            closeReminderModal();

            // Reload calendar if exists to show new reminder
            if (typeof refreshCalendar === 'function') {
                refreshCalendar();
            }
        } else {
            alert('Error setting reminder: ' + (data.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving reminder:', error);
        alert('Failed to set reminder. Please try again.');
    }
}

// ============================================================

// Keep the original award tender function for reuse later (as requested by user)
function awardTender(tenderId) {
    const awardBtn = document.getElementById('awardTenderBtn');
    if (!awardBtn || awardBtn.disabled) { return; }

    if (awardBtn.classList.contains('is-awarded')) { return; }

    if (!confirm('Mark this tender as awarded? This will make it available for employee task assignment.')) {
        return;
    }

    const originalText = awardBtn.textContent;
    awardBtn.disabled = true;
    awardBtn.textContent = 'Processingâ€¦';

    fetch(`/api/tender/${tenderId}/award`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(async response => {
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            throw new Error(payload.detail || 'Failed to update tender status');
        }
        return payload;
    })
    .then(payload => {
        awardBtn.classList.add('is-awarded');
        awardBtn.textContent = 'âœ… Tender awarded';

        // Build notification message with project info
        let message = payload.message || 'Tender marked as awarded';
        if (payload.project_created && payload.project_id) {
            message += `\n\nA new project "${payload.project_name}" has been automatically created in your Past Projects. You can edit it to complete any missing details.`;
        }

        if (typeof showNotification === 'function') {
            showNotification(message);
        } else {
            alert(message);
        }
        setTimeout(() => window.location.reload(), 1500);
    })
    .catch(error => {
        console.error('Award tender error:', error);
        if (typeof showNotification === 'function') {
            showNotification(error.message || 'Error awarding tender', 'error');
        } else {
            alert(error.message || 'Error awarding tender');
        }
        awardBtn.disabled = false;
        awardBtn.textContent = originalText;
    });
}

// Favorite Toggle Function
function toggleFavorite(tenderId) {
    const favoriteBtn = document.getElementById('favoriteBtn');
    if (!favoriteBtn || favoriteBtn.disabled) return;

    const isFavorited = favoriteBtn.classList.contains('favorited');
    const endpoint = `/api/favorites/${tenderId}`;
    const method = isFavorited ? 'DELETE' : 'POST';

    const originalHTML = favoriteBtn.innerHTML;
    favoriteBtn.disabled = true;

    // For POST requests, we need to send FormData (empty notes)
    let fetchOptions = {
        method: method,
        headers: method === 'DELETE' ? { 'Content-Type': 'application/json' } : {}
    };

    if (method === 'POST') {
        const formData = new FormData();
        formData.append('notes', '');
        fetchOptions.body = formData;
    }

    fetch(endpoint, fetchOptions)
    .then(response => response.json())
    .then(data => {
        if (data.message || data.success) {
            // Update button state
            if (isFavorited) {
                favoriteBtn.classList.remove('favorited');
                favoriteBtn.title = 'Add to favorites';
                // Change to outline star
                favoriteBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" stroke="currentColor" stroke-width="2"/>
                </svg>`;
                // Hide action section when unfavorited
                const actionSection = document.getElementById('actionSection');
                if (actionSection) actionSection.style.display = 'none';
            } else {
                favoriteBtn.classList.add('favorited');
                favoriteBtn.title = 'Favorited';
                // Change to filled star
                favoriteBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
                </svg>`;
                // Show action section when favorited
                const actionSection = document.getElementById('actionSection');
                if (actionSection) actionSection.style.display = 'block';
            }
            favoriteBtn.disabled = false;
        } else {
            alert('Error: ' + (data.detail || data.error || 'Unable to update favorite status'));
            favoriteBtn.disabled = false;
            favoriteBtn.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating favorite status. Please try again.');
        favoriteBtn.disabled = false;
        favoriteBtn.innerHTML = originalHTML;
    });
}

// Shortlist/Reject Functions
let currentTenderId = '{{ tender.id }}';
let currentAction = ''; // 'shortlist' or 'reject'

function handleShortlist(tenderId) {
    currentTenderId = tenderId;
    currentAction = 'shortlist';
    document.getElementById('modalTitle').textContent = 'Shortlist Tender - Provide Reason';
    openReasonModal();
}

function handleReject(tenderId) {
    currentTenderId = tenderId;
    currentAction = 'reject';
    document.getElementById('modalTitle').textContent = 'Reject Tender - Provide Reason';
    openReasonModal();
}

function openReasonModal() {
    const modal = document.getElementById('reasonModal');
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    document.getElementById('reasonText').value = '';
    document.getElementById('reasonText').focus();
    document.body.style.overflow = 'hidden';

    // Hide AI chat button
    document.getElementById('aiChatBtn')?.classList.add('ai-chat-floating-btn--hidden');
}

function closeReasonModal() {
    const modal = document.getElementById('reasonModal');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    currentTenderId = '';
    currentAction = '';
    document.body.style.overflow = '';

    // Show AI chat button
    document.getElementById('aiChatBtn')?.classList.remove('ai-chat-floating-btn--hidden');
}

function submitReason() {
    const reason = document.getElementById('reasonText').value.trim();

    if (!reason) {
        alert('Please provide a reason for your decision.');
        return;
    }

    if (!currentTenderId || !currentAction) {
        alert('Error: Missing tender information.');
        return;
    }

    const endpoint = currentAction === 'shortlist'
        ? '/api/tenders/shortlist'
        : '/api/tenders/reject';

    const formData = new FormData();
    formData.append('tender_id', currentTenderId);
    formData.append('reason', reason);

    // Disable submit button
    const submitBtn = document.getElementById('submitReasonBtn');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';

    fetch(endpoint, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.message || data.success) {
            closeReasonModal();

            // Update favorite button to show shortlisted/rejected state
            const favoriteBtn = document.getElementById('favoriteBtn');
            if (favoriteBtn) {
                favoriteBtn.disabled = true;
                favoriteBtn.classList.add('disabled');
                if (currentAction === 'shortlist') {
                    favoriteBtn.textContent = 'âœ“ Shortlisted';
                } else {
                    favoriteBtn.textContent = 'âœ— Rejected';
                }
            }

            // Hide action section
            document.getElementById('actionSection').style.display = 'none';

            // Show success message
            alert(data.message || 'Operation completed successfully!');
        } else {
            alert('Error: ' + (data.detail || data.error || 'Unable to complete operation'));
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Unexpected error. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
}

// Handle ESC key to close modals
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAiChatModal();
        closeReasonModal();
        closePDFViewer();
    }
});

// ============================================================
// DOCUMENTS PANEL FUNCTIONALITY
// ============================================================

let documentsLoaded = false;

async function toggleDocumentsPanel() {
    const panel = document.getElementById('documents-panel');
    const isVisible = panel.style.display === 'block';

    if (isVisible) {
        panel.style.display = 'none';
    } else {
        panel.style.display = 'block';
        if (!documentsLoaded) {
            await loadDocumentsList();
        }
    }
}

async function loadDocumentsList() {
    const listContainer = document.getElementById('documents-list');
    listContainer.innerHTML = '<p class="documents-list-message">Loading documents...</p>';

    try {
        const response = await fetch(`/api/tender/{{ tender.id }}/documents`);
        const data = await response.json();

        if (!data.success || data.count === 0) {
            listContainer.innerHTML = '<p class="documents-list-message">No documents available</p>';
            return;
        }

        let html = '';
        data.documents.forEach((doc, index) => {
            const sizeInMB = (doc.file_size / (1024 * 1024)).toFixed(2);
            const isPDF = doc.document_type === 'pdf' || doc.filename.toLowerCase().endsWith('.pdf');
            const isExcel = doc.document_type === 'excel' || doc.filename.toLowerCase().endsWith('.xls') || doc.filename.toLowerCase().endsWith('.xlsx');

            // For PDFs and Excel files: Show both View and Download buttons
            // For other files: Show only Download button
            const buttons = (isPDF || isExcel)
                ? `<button onclick="openDocumentInViewer(${doc.id}, '${doc.document_type}', '${doc.filename}')" class="btn btn-primary btn-sm" style="flex: 1;">
                       View
                   </button>
                   <button onclick="downloadDocument(${doc.id}, '${doc.filename}')" class="btn btn-outline btn-sm" style="flex: 1;">
                       Download
                   </button>`
                : `<button onclick="downloadDocument(${doc.id}, '${doc.filename}')" class="btn btn-primary btn-sm" style="flex: 1;">
                       Download
                   </button>`;

            html += `
                <div class="document-item">
                    <div class="document-item-content">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="document-item-icon">
                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <div class="document-item-details">
                            <h4 class="document-item-filename">${doc.filename}</h4>
                            <p class="document-item-meta">${sizeInMB} MB â€¢ ${doc.document_type.toUpperCase()}</p>
                            <div class="document-item-actions">
                                ${buttons}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        listContainer.innerHTML = html;
        documentsLoaded = true;

    } catch (error) {
        console.error('Error loading documents:', error);
        listContainer.innerHTML = '<p class="documents-list-message" style="color: var(--error, #dc2626);">Error loading documents</p>';
    }
}

function openDocumentInViewer(documentId, documentType, filename) {
    // Open document in new browser tab
    // Browser will handle PDF viewing natively, and Excel files will open or download based on browser capabilities
    const documentUrl = `/api/tender/document/${documentId}`;
    window.open(documentUrl, '_blank');
}

function downloadDocument(documentId, filename) {
    // Trigger download
    const link = document.createElement('a');
    link.href = `/api/tender/document/${documentId}`;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ============================================================
// Excel Viewer Functions
// ============================================================

let currentWorkbook = null;
let currentSheetName = null;

async function openExcelViewer(documentId, filename) {
    const modal = document.getElementById('excel-viewer-modal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Set filename
    document.getElementById('excel-filename').textContent = filename || 'Excel Document';

    // Load Excel file
    await loadExcel(documentId);
}

function closeExcelViewer() {
    const modal = document.getElementById('excel-viewer-modal');
    modal.style.display = 'none';
    document.body.style.overflow = '';

    // Clear content
    document.getElementById('excel-content').innerHTML = '';
    document.getElementById('excel-sheet-tabs').innerHTML = '';
    currentWorkbook = null;
    currentSheetName = null;
}

async function loadExcel(documentId) {
    const loadingEl = document.getElementById('excel-loading');
    const errorEl = document.getElementById('excel-error');
    const contentEl = document.getElementById('excel-content');

    try {
        loadingEl.style.display = 'flex';
        errorEl.style.display = 'none';
        contentEl.style.display = 'none';

        // Fetch the Excel file
        const response = await fetch(`/api/tender/document/${documentId}`);
        if (!response.ok) {
            throw new Error('Failed to fetch Excel file');
        }

        const arrayBuffer = await response.arrayBuffer();

        // Parse Excel file using SheetJS
        currentWorkbook = XLSX.read(arrayBuffer, { type: 'array' });

        if (!currentWorkbook || !currentWorkbook.SheetNames || currentWorkbook.SheetNames.length === 0) {
            throw new Error('Invalid Excel file or no sheets found');
        }

        // Create sheet tabs
        createSheetTabs();

        // Display first sheet
        displaySheet(currentWorkbook.SheetNames[0]);

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';

    } catch (error) {
        console.error('Error loading Excel:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        document.getElementById('excel-error-message').textContent = error.message || 'Failed to load Excel file';
    }
}

function createSheetTabs() {
    const tabsContainer = document.getElementById('excel-sheet-tabs');
    tabsContainer.innerHTML = '';

    currentWorkbook.SheetNames.forEach((sheetName, index) => {
        const tab = document.createElement('button');
        tab.textContent = sheetName;
        tab.className = 'excel-sheet-tab';
        tab.onclick = () => displaySheet(sheetName);

        if (index === 0) {
            tab.classList.add('active');
        }

        tabsContainer.appendChild(tab);
    });
}

function displaySheet(sheetName) {
    currentSheetName = sheetName;
    const sheet = currentWorkbook.Sheets[sheetName];

    // Update active tab
    document.querySelectorAll('.excel-sheet-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent === sheetName);
    });

    // Convert sheet to JSON to process it
    const range = XLSX.utils.decode_range(sheet['!ref']);

    // Find non-empty columns
    const nonEmptyColumns = new Set();
    for (let R = range.s.r; R <= range.e.r; R++) {
        for (let C = range.s.c; C <= range.e.c; C++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            const cell = sheet[cellAddress];
            if (cell && cell.v !== undefined && cell.v !== null && cell.v !== '') {
                nonEmptyColumns.add(C);
            }
        }
    }

    // Convert to sorted array
    const activeColumns = Array.from(nonEmptyColumns).sort((a, b) => a - b);

    if (activeColumns.length === 0) {
        document.getElementById('excel-content').innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--text-secondary);">No data found in this sheet</p>';
        return;
    }

    // Calculate column widths based on content
    const columnWidths = new Map();
    activeColumns.forEach(C => {
        let maxWidth = 100; // minimum width
        for (let R = range.s.r; R <= range.e.r; R++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            const cell = sheet[cellAddress];
            if (cell && cell.v !== undefined) {
                const cellValue = String(cell.v);
                const width = Math.min(Math.max(cellValue.length * 8 + 20, 100), 400); // min 100px, max 400px
                maxWidth = Math.max(maxWidth, width);
            }
        }
        columnWidths.set(C, maxWidth);
    });

    // Build HTML table manually with only non-empty columns
    let tableHtml = '<table id="excel-table" style="border-collapse: collapse; width: max-content; font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif; font-size: 0.875rem;">';

    for (let R = range.s.r; R <= range.e.r; R++) {
        // Check if row has any content
        let rowHasContent = false;
        for (const C of activeColumns) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            const cell = sheet[cellAddress];
            if (cell && cell.v !== undefined && cell.v !== null && cell.v !== '') {
                rowHasContent = true;
                break;
            }
        }

        if (!rowHasContent && R > range.s.r + 10) continue; // Skip empty rows after first 10

        tableHtml += '<tr>';

        for (const C of activeColumns) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            const cell = sheet[cellAddress];
            const cellValue = cell && cell.v !== undefined ? String(cell.v) : '';
            const width = columnWidths.get(C);

            const isHeader = R === range.s.r;
            const tag = isHeader ? 'th' : 'td';

            let style = `border: 1px solid #e5e7eb; padding: 0.75rem 1rem; width: ${width}px; max-width: ${width}px; min-width: ${width}px; word-wrap: break-word; vertical-align: top;`;

            if (isHeader) {
                style += ' background: #f3f4f6; font-weight: 600; position: sticky; top: 0; z-index: 10;';
            }

            // Check if cell value is a number
            const isNumber = !isNaN(cellValue) && cellValue !== '';
            if (isNumber && !isHeader) {
                style += ' text-align: right;';
            } else {
                style += ' text-align: left;';
            }

            tableHtml += `<${tag} style="${style}">${cellValue}</${tag}>`;
        }

        tableHtml += '</tr>';
    }

    tableHtml += '</table>';

    document.getElementById('excel-content').innerHTML = tableHtml;

    // Apply additional styling
    styleExcelTable();
}

function styleExcelTable() {
    const table = document.getElementById('excel-table');
    if (!table) return;

    // Add hover effect to rows
    const rows = table.querySelectorAll('tr');
    rows.forEach((row, index) => {
        if (index === 0) return; // Skip header

        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'var(--hover-bg, rgba(99, 102, 241, 0.05))';
        });

        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });

    // Make header sticky and add shadow
    const headers = table.querySelectorAll('th');
    headers.forEach(header => {
        header.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
    });
}

// ============================================================
// PDF VIEWER FUNCTIONALITY
// ============================================================

let pdfDoc = null;
let scale = 1.5;
let currentVisiblePage = 1;

function openPDFViewer() {
    const modal = document.getElementById('pdf-viewer-modal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Load PDF after modal is open
    setTimeout(() => loadPDF(), 100);
}

function closePDFViewer() {
    const modal = document.getElementById('pdf-viewer-modal');
    modal.classList.remove('active');
    document.body.style.overflow = '';

    // Clear all canvases
    const container = document.getElementById('pdf-pages-container');
    if (container) {
        container.innerHTML = '';
    }

    // Clear PDF
    if (pdfDoc) {
        pdfDoc.destroy();
        pdfDoc = null;
    }
    currentVisiblePage = 1;
    scale = 1.5;
}

async function loadPDF(customUrl = null) {
    const tenderId = '{{ tender.id }}';
    const loadingEl = document.getElementById('pdf-loading');
    const errorEl = document.getElementById('pdf-error');
    const containerEl = document.getElementById('pdf-pages-container');

    // Use custom URL if provided, otherwise use default tender document URL
    const url = customUrl || `/api/tender/${tenderId}/document`;

    console.log('Loading PDF from:', url);

    try {
        loadingEl.style.display = 'flex';
        errorEl.style.display = 'none';
        containerEl.style.display = 'none';

        // Load PDF using PDF.js
        console.log('Fetching PDF from:', url);

        const loadingTask = pdfjsLib.getDocument(url);
        pdfDoc = await loadingTask.promise;

        console.log('PDF loaded successfully. Pages:', pdfDoc.numPages);
        document.getElementById('page-count').textContent = pdfDoc.numPages;

        loadingEl.style.display = 'none';
        containerEl.style.display = 'flex';

        // Render all pages
        await renderAllPages();

    } catch (error) {
        console.error('Error loading PDF:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'flex';
        const errorText = errorEl.querySelector('p');
        if (errorText) {
            errorText.textContent = error.message || 'Error loading document';
        }
    }
}

async function renderAllPages() {
    const container = document.getElementById('pdf-pages-container');
    container.innerHTML = '';

    for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
        const page = await pdfDoc.getPage(pageNum);

        // Create canvas for this page
        const canvas = document.createElement('canvas');
        canvas.className = 'pdf-page-canvas';
        canvas.dataset.pageNumber = pageNum;

        const ctx = canvas.getContext('2d');
        const viewport = page.getViewport({scale: scale});

        canvas.height = viewport.height;
        canvas.width = viewport.width;

        container.appendChild(canvas);

        // Render the page
        const renderContext = {
            canvasContext: ctx,
            viewport: viewport
        };

        await page.render(renderContext).promise;
        console.log('Rendered page', pageNum);
    }

    // Setup scroll listener to track current page
    setupScrollTracking();
}

function setupScrollTracking() {
    const content = document.querySelector('.pdf-viewer-content');

    content.addEventListener('scroll', function() {
        const canvases = document.querySelectorAll('.pdf-page-canvas');
        const contentRect = content.getBoundingClientRect();
        const contentCenter = contentRect.top + contentRect.height / 2;

        canvases.forEach(canvas => {
            const canvasRect = canvas.getBoundingClientRect();
            const canvasCenter = canvasRect.top + canvasRect.height / 2;

            // Check if canvas center is in viewport
            if (canvasCenter >= contentRect.top && canvasCenter <= contentRect.bottom) {
                currentVisiblePage = parseInt(canvas.dataset.pageNumber);
                document.getElementById('page-num').textContent = currentVisiblePage;
            }
        });
    });
}

async function onZoomIn() {
    scale += 0.25;
    document.querySelector('.pdf-zoom-controls .pdf-btn:nth-child(2)').textContent = Math.round(scale * 100) + '%';
    await renderAllPages();
}

async function onZoomOut() {
    if (scale <= 0.5) return;
    scale -= 0.25;
    document.querySelector('.pdf-zoom-controls .pdf-btn:nth-child(2)').textContent = Math.round(scale * 100) + '%';
    await renderAllPages();
}

async function onZoomReset() {
    scale = 1.5;
    document.querySelector('.pdf-zoom-controls .pdf-btn:nth-child(2)').textContent = '100%';
    await renderAllPages();
}

function downloadPDF() {
    const tenderId = '{{ tender.id }}';
    const url = `/api/tender/${tenderId}/document`;
    const link = document.createElement('a');
    link.href = url;
    link.download = `tender_${tenderId}.pdf`;
    link.click();
}

function searchInPDF() {
    const searchTerm = document.getElementById('pdf-search-input').value.trim();
    if (!searchTerm) return;

    // This is a basic implementation - for full text search, you'd need to extract text from PDF
    alert(`Search functionality: "${searchTerm}" - Full implementation requires text extraction`);
}

function printPDF() {
    window.print();
}

// Close modal when clicking on backdrop
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('pdf-viewer-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            // Only close if clicking the backdrop, not the modal content
            if (e.target === modal) {
                closePDFViewer();
            }
        });
    }
});

</script>

<!-- Documents Panel -->
<div id="documents-panel" class="documents-panel" style="display: none;">
    <div class="documents-panel-content">
        <div class="documents-panel-header">
            <h2 class="documents-panel-title">Documents</h2>
            <button onclick="toggleDocumentsPanel()" class="documents-panel-close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <div id="documents-list">
            <p class="documents-list-message">Loading documents...</p>
        </div>
    </div>
</div>

<!-- PDF Viewer Modal -->
<div id="pdf-viewer-modal">
    <div class="pdf-viewer-modal">
        <div class="pdf-viewer-header">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Tender Document Viewer
            </h2>
            <button onclick="closePDFViewer()" class="modal-close-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>

        <div class="pdf-toolbar">
            <div class="pdf-page-info">
                Page <span id="page-num">1</span> of <span id="page-count">--</span>
            </div>

            <div class="pdf-zoom-controls">
                <button onclick="onZoomOut()" title="Zoom out" class="pdf-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>

                <button onclick="onZoomReset()" title="Reset zoom" class="pdf-btn">
                    100%
                </button>

                <button onclick="onZoomIn()" title="Zoom in" class="pdf-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>

            <div class="pdf-actions">
                <button onclick="downloadPDF()" title="Download" class="pdf-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>

                <button onclick="printPDF()" title="Print" class="pdf-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M6 9V2H18V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M6 18H4C3.46957 18 2.96086 17.7893 2.58579 17.4142C2.21071 17.0391 2 16.5304 2 16V11C2 10.4696 2.21071 9.96086 2.58579 9.58579C2.96086 9.21071 3.46957 9 4 9H20C20.5304 9 21.0391 9.21071 21.4142 9.58579C21.7893 9.96086 22 10.4696 22 11V16C22 16.5304 21.7893 17.0391 21.4142 17.4142C21.0391 17.7893 20.5304 18 20 18H18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M18 14H6V22H18V14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="pdf-viewer-content">
            <div id="pdf-loading" class="pdf-loading">
                <div class="loading-spinner"></div>
                <p>Loading document...</p>
            </div>

            <div id="pdf-error" class="pdf-error" style="display: none;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <p>No document available</p>
            </div>

            <div id="pdf-pages-container" class="pdf-pages-container" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- Excel Viewer Modal -->
<div id="excel-viewer-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 9999; align-items: center; justify-content: center;">
    <div class="excel-viewer-modal" style="width: 95%; height: 95%; max-width: 1600px; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
        <div class="excel-viewer-header" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem;">
            <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8 13h2m-2 4h2m4-4h2m-2 4h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span id="excel-filename">Excel Document</span>
            </h2>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="excel-sheet-tabs">
                    <!-- Sheet tabs will be added here dynamically -->
                </div>
                <button onclick="closeExcelViewer()" style="background: none; border: none; cursor: pointer; padding: 0.5rem; color: var(--text-secondary, #6b7280); display: flex; align-items: center; justify-content: center; border-radius: 12px; transition: all 0.2s;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="excel-viewer-body">
            <div id="excel-loading" style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; gap: 1rem;">
                <div style="width: 48px; height: 48px; border: 4px solid #6366f1; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p>Loading Excel file...</p>
            </div>

            <div id="excel-error" style="display: none;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto 1rem; display: block;">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 8v4m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <p id="excel-error-message" style="font-size: 1.1rem; margin: 0;">Failed to load Excel file</p>
            </div>

            <div id="excel-content" style="display: none;">
                <!-- Excel content will be rendered here -->
            </div>
        </div>
    </div>
</div>

<!-- Screenshots Viewer Modal -->
<div id="screenshots-viewer-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 9999; align-items: center; justify-content: center;">
    <div class="pdf-viewer-modal" style="width: 90%; height: 90%; max-width: 1400px; background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
        <div class="pdf-viewer-header">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
                    <polyline points="21 15 16 10 5 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Tender Screenshots
            </h2>
            <button onclick="closeScreenshotsViewer()" class="modal-close-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>

        <div class="pdf-toolbar">
            <div class="pdf-page-info">
                Screenshot <span id="screenshot-num">1</span> of <span id="screenshot-count">--</span>
            </div>

            <div class="pdf-zoom-controls">
                <button onclick="onScreenshotZoomOut()" title="Zoom out" class="pdf-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>

                <button onclick="onScreenshotZoomReset()" title="Reset zoom" class="pdf-btn">
                    100%
                </button>

                <button onclick="onScreenshotZoomIn()" title="Zoom in" class="pdf-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>

            <div class="pdf-actions">
                <button onclick="previousScreenshot()" title="Previous" class="pdf-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>

                <button onclick="nextScreenshot()" title="Next" class="pdf-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="pdf-viewer-content">
            <div id="screenshots-loading" class="pdf-loading">
                <div class="loading-spinner"></div>
                <p>Loading screenshots...</p>
            </div>

            <div id="screenshots-error" class="pdf-error" style="display: none;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <p>No screenshots available</p>
            </div>

            <div id="screenshots-container" class="pdf-pages-container" style="display: none;">
                <img id="screenshot-image" src="" alt="Screenshot" style="max-width: 100%; height: auto; display: block; margin: 0 auto;">
            </div>
        </div>
    </div>
</div>

<script>
// Screenshots Viewer Functions
let screenshots = [];
let currentScreenshotIndex = 0;
let screenshotZoomLevel = 1.0;

async function openScreenshotsViewer() {
    const modal = document.getElementById('screenshots-viewer-modal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Load screenshots after modal is open
    setTimeout(() => loadScreenshots(), 100);
}

function closeScreenshotsViewer() {
    const modal = document.getElementById('screenshots-viewer-modal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
    screenshots = [];
    currentScreenshotIndex = 0;
    screenshotZoomLevel = 1.0;
}

async function loadScreenshots() {
    const tenderId = '{{ tender.id }}';
    const loadingEl = document.getElementById('screenshots-loading');
    const errorEl = document.getElementById('screenshots-error');
    const containerEl = document.getElementById('screenshots-container');

    console.log('Loading screenshots for tender:', tenderId);

    try {
        loadingEl.style.display = 'flex';
        errorEl.style.display = 'none';
        containerEl.style.display = 'none';

        const url = `/api/tender/${tenderId}/screenshots`;
        console.log('Fetching screenshots from:', url);

        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('No screenshots available');
        }

        const data = await response.json();
        screenshots = data.screenshots;

        if (!screenshots || screenshots.length === 0) {
            throw new Error('No screenshots available');
        }

        console.log('Screenshots loaded successfully. Count:', screenshots.length);
        document.getElementById('screenshot-count').textContent = screenshots.length;

        loadingEl.style.display = 'none';
        containerEl.style.display = 'flex';

        // Display first screenshot
        currentScreenshotIndex = 0;
        displayScreenshot();

    } catch (error) {
        console.error('Error loading screenshots:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'flex';
        const errorText = errorEl.querySelector('p');
        if (errorText) {
            errorText.textContent = error.message || 'Error loading screenshots';
        }
    }
}

function displayScreenshot() {
    if (!screenshots || screenshots.length === 0) return;

    const img = document.getElementById('screenshot-image');
    const screenshot = screenshots[currentScreenshotIndex];

    img.src = screenshot.url;
    img.style.transform = `scale(${screenshotZoomLevel})`;
    document.getElementById('screenshot-num').textContent = currentScreenshotIndex + 1;
}

function previousScreenshot() {
    if (currentScreenshotIndex > 0) {
        currentScreenshotIndex--;
        displayScreenshot();
    }
}

function nextScreenshot() {
    if (currentScreenshotIndex < screenshots.length - 1) {
        currentScreenshotIndex++;
        displayScreenshot();
    }
}

function onScreenshotZoomIn() {
    screenshotZoomLevel = Math.min(screenshotZoomLevel + 0.25, 3.0);
    displayScreenshot();
}

function onScreenshotZoomOut() {
    screenshotZoomLevel = Math.max(screenshotZoomLevel - 0.25, 0.5);
    displayScreenshot();
}

function onScreenshotZoomReset() {
    screenshotZoomLevel = 1.0;
    displayScreenshot();
}
</script>

<!-- Load PDF.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<!-- Load SheetJS library for Excel viewing -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<!-- External Libraries for Certificate Intelligence Modal -->
<!-- Choices.js for multi-select dropdowns -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/scripts/choices.min.js"></script>

<!-- noUiSlider for range sliders -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

<!-- Flatpickr for date pickers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

<!-- Certificate Intelligence Modal JavaScript -->
<script>
// ============ Certificate Intelligence Modal Functions ============

// Global state for certificate modal
let currentModalCertMode = 'search'; // 'search' or 'manual-clause'

/**
 * Open the Certificate Intelligence Modal
 */
function openCertificateIntelligenceModal() {
    const modal = document.getElementById('certIntelligenceModal');
    if (modal) {
        modal.style.display = 'flex';
        // Initialize to search mode by default
        switchModalCertMode('search');
    }
}

/**
 * Close the Certificate Intelligence Modal
 */
function closeCertificateIntelligenceModal() {
    const modal = document.getElementById('certIntelligenceModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

/**
 * Switch between certificate modes (Keyword Search and Manual Clause)
 * @param {string} mode - 'search' or 'manual-clause'
 */
function switchModalCertMode(mode) {
    console.log('switchModalCertMode called with:', mode);

    currentModalCertMode = mode;

    // Hide all mode contents
    const searchContent = document.getElementById('modalCertSearchSection');
    const manualContent = document.getElementById('modalCertManualClauseSection');

    if (searchContent) searchContent.style.display = 'none';
    if (manualContent) manualContent.style.display = 'none';

    // Remove active class from all mode buttons
    const searchBtn = document.getElementById('modalSearchModeBtn');
    const manualBtn = document.getElementById('modalManualClauseModeBtn');

    if (searchBtn) searchBtn.classList.remove('cert-mode-btn--active');
    if (manualBtn) manualBtn.classList.remove('cert-mode-btn--active');

    // Show selected mode content and activate button
    if (mode === 'search') {
        if (searchContent) searchContent.style.display = 'block';
        if (searchBtn) searchBtn.classList.add('cert-mode-btn--active');
    } else if (mode === 'manual-clause') {
        if (manualContent) manualContent.style.display = 'block';
        if (manualBtn) manualBtn.classList.add('cert-mode-btn--active');

        // Initialize AI filter section for keyword extraction workflow
        // No manual filters needed - using AI keyword extraction only
        initModalAIFilterSection();
    }
}

// ============ Keyword Search Mode Functions ============

/**
 * Perform certificate keyword search
 */
function performModalCertSearch(page = 1) {
    const searchInput = document.getElementById('modalCertSearchInput');
    const query = searchInput ? searchInput.value.trim() : '';

    if (!query) {
        alert('Please enter a search query');
        return;
    }

    // Store current query and page
    currentCertQuery = query;
    currentCertPage = page;

    // Show loading state
    showModalCertLoading();

    // Make API call to search certificates with pagination
    fetch('/api/certificates/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            page: page,
            per_page: 30
        })
    })
    .then(response => response.json())
    .then(data => {
        hideModalCertLoading();
        currentCertTotalPages = data.total_pages || 1;
        currentCertTotal = data.total || 0;
        displayModalCertResults(data.certificates || data.results || [], query);
        updateModalCertPagination(data);
    })
    .catch(error => {
        console.error('Error searching certificates:', error);
        hideModalCertLoading();
        showModalCertError('Failed to search certificates. Please try again.');
    });
}

/**
 * Show all certificates (no filter)
 */
function showAllModalCerts(page = 1) {
    // Store current state
    currentCertQuery = '';
    currentCertPage = page;

    // Show loading state
    showModalCertLoading();

    // Make API call to get all certificates with pagination
    fetch('/api/certificates/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            query: '',
            page: page,
            per_page: 30
        })
    })
    .then(response => response.json())
    .then(data => {
        hideModalCertLoading();
        currentCertTotalPages = data.total_pages || 1;
        currentCertTotal = data.total || 0;
        displayModalCertResults(data.certificates || data.results || [], '');
        updateModalCertPagination(data);
    })
    .catch(error => {
        console.error('Error fetching certificates:', error);
        hideModalCertLoading();
        showModalCertError('Failed to load certificates. Please try again.');
    });
}

/**
 * Show loading state in search mode
 */
function showModalCertLoading() {
    const resultsContainer = document.getElementById('modalCertResultsGrid');
    if (resultsContainer) {
        resultsContainer.innerHTML = `
            <div class="cert-loading">
                <div class="cert-spinner"></div>
                <p class="cert-loading-text">Searching certificates...</p>
            </div>
        `;
    }
}

/**
 * Hide loading state in search mode
 */
function hideModalCertLoading() {
    // Loading will be replaced by results or error message
}

/**
 * Display certificate search results
 */
function displayModalCertResults(results, query) {
    const resultsContainer = document.getElementById('modalCertResultsGrid');
    const statsContainer = document.getElementById('modalCertSearchStats');

    if (!resultsContainer) return;

    // Show stats
    if (statsContainer) {
        if (results && results.length > 0) {
            statsContainer.style.display = 'block';
            statsContainer.innerHTML = `
                <p>Found <strong>${results.length}</strong> matching certificate${results.length !== 1 ? 's' : ''}${query ? ' for "' + query + '"' : ''}</p>
            `;
        } else {
            statsContainer.style.display = 'none';
        }
    }

    // Show results or no results message
    if (!results || results.length === 0) {
        resultsContainer.innerHTML = `
            <div class="cert-no-results">
                <div class="cert-no-results-icon">ðŸ“‹</div>
                <h3>No certificates found</h3>
                <p>${query ? 'Try adjusting your search query' : 'No certificates available'}</p>
            </div>
        `;
        return;
    }

    // Display results as cards
    const cardsHTML = results.map(cert => createModalCertCard(cert, query)).join('');
    resultsContainer.innerHTML = cardsHTML;
}

/**
 * Create a certificate card HTML
 */
function createModalCertCard(cert, query) {
    // Helper function to highlight search terms
    const highlight = (text, query) => {
        if (!query || !text) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<span class="cert-highlight">$1</span>');
    };

    return `
        <div class="cert-material-card">
            <div class="cert-card-header">
                <div class="cert-card-title-block">
                    <h3 class="cert-card-title">${highlight(cert.project_name || 'Untitled Project', query)}</h3>
                    <p class="cert-card-subtitle">${highlight(cert.client_name || 'Unknown Client', query)}</p>
                </div>
                <span class="cert-card-status">CERTIFICATE</span>
            </div>

            <div class="cert-card-divider"></div>

            <div class="cert-card-grid">
                ${cert.location ? `
                <div class="cert-pill">
                    <span class="cert-pill-label">Location</span>
                    <span class="cert-pill-value">${cert.location}</span>
                </div>
                ` : ''}
                ${cert.project_value ? `
                <div class="cert-pill">
                    <span class="cert-pill-label">Project Value</span>
                    <span class="cert-pill-value">â‚¹${(cert.project_value / 10000000).toFixed(2)}Cr</span>
                </div>
                ` : ''}
                ${cert.consultancy_fee ? `
                <div class="cert-pill">
                    <span class="cert-pill-label">Consultancy Fee</span>
                    <span class="cert-pill-value">â‚¹${(cert.consultancy_fee / 100000).toFixed(2)}L</span>
                </div>
                ` : ''}
                ${cert.completion_date ? `
                <div class="cert-pill">
                    <span class="cert-pill-label">Completion Date</span>
                    <span class="cert-pill-value">${new Date(cert.completion_date).toLocaleDateString()}</span>
                </div>
                ` : ''}
            </div>

            ${cert.services && cert.services.length > 0 ? `
            <div class="cert-services">
                <div class="cert-services-title">Services</div>
                <div class="cert-services-tags">
                    ${cert.services.map(service => `<span class="cert-service-tag">${service}</span>`).join('')}
                </div>
            </div>
            ` : ''}

            <!-- Attachment Section -->
            <div class="cert-attachment-section">
                <div class="cert-attachment-header">
                    <span class="cert-attachment-icon">ðŸ”—</span>
                    <span class="cert-attachment-title">Attach to Tender</span>
                </div>

                ${cert.attached_tenders_count > 0 ? `
                    <div class="cert-attached-info">
                        <span class="cert-attached-badge">âœ“ Attached to ${cert.attached_tenders_count} tender(s)</span>
                        <button type="button"
                                class="cert-view-attachments-btn"
                                onclick="event.stopPropagation(); modalCertViewAttachments('${cert.id}')">
                            View
                        </button>
                    </div>
                ` : ''}

                <div class="cert-attachment-controls" data-cert-id="${cert.id}">
                    <select class="cert-tender-dropdown"
                            id="modal-tender-dropdown-${cert.id}"
                            onclick="event.stopPropagation()">
                        <option value="">Select a tender...</option>
                    </select>
                    <button type="button"
                            class="cert-attach-btn"
                            onclick="event.stopPropagation(); modalCertAttachToTender('${cert.id}')"
                            disabled>
                        Attach
                    </button>
                    ${!isCurrentTenderFavorited ? `
                    <button type="button"
                            class="cert-attach-fav-btn"
                            onclick="event.stopPropagation(); modalCertAttachAndFavoriteCurrentTender('${cert.id}')">
                        Attach & Favourite
                    </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

/**
 * Show error message in search mode
 */
function showModalCertError(message) {
    const resultsContainer = document.getElementById('modalCertResultsGrid');
    if (resultsContainer) {
        resultsContainer.innerHTML = `
            <div class="cert-no-results">
                <div class="cert-no-results-icon">âš ï¸</div>
                <h3>Error</h3>
                <p>${message}</p>
            </div>
        `;
    }
}

// ============ Manual Clause Mode Functions ============

// Global variables for manual filters
let modalManualFiltersInitialized = false;
let modalChoicesInstances = {};
let modalFeeSlider = null;
let modalValueSlider = null;
let modalDatePicker = null;

/**
 * Initialize manual filters (Choices.js, noUiSlider, Flatpickr)
 */
function initializeModalManualFilters() {
    console.log('Initializing modal manual filters...');

    // Initialize Choices.js for multi-select dropdowns
    const filterSelects = [
        'modalManualFilterClients',
        'modalManualFilterLocations',
        'modalManualFilterServices',
        'modalManualFilterSectors',
        'modalManualFilterSubSectors',
        'modalManualFilterFundingAgencies'
    ];

    filterSelects.forEach(id => {
        const element = document.getElementById(id);
        if (element && !modalChoicesInstances[id]) {
            modalChoicesInstances[id] = new Choices(element, {
                removeItemButton: true,
                searchEnabled: true,
                searchChoices: true,
                placeholder: true,
                placeholderValue: 'Select options...',
                noChoicesText: 'No options available',
                itemSelectText: 'Click to select',
            });
        }
    });

    // Initialize noUiSlider for fee range
    const feeSliderElement = document.getElementById('modalManualFeeSlider');
    if (feeSliderElement && !modalFeeSlider) {
        modalFeeSlider = noUiSlider.create(feeSliderElement, {
            start: [0, 500],
            connect: true,
            range: {
                'min': 0,
                'max': 500
            },
            step: 10,
            tooltips: [
                { to: value => 'â‚¹' + value.toFixed(0) + 'L' },
                { to: value => 'â‚¹' + value.toFixed(0) + 'L' }
            ]
        });

        modalFeeSlider.on('update', function(values) {
            document.getElementById('modalManualFeeMin').textContent = 'â‚¹' + parseInt(values[0]) + 'L';
            document.getElementById('modalManualFeeMax').textContent = 'â‚¹' + parseInt(values[1]) + 'L';
        });
    }

    // Initialize noUiSlider for project value range
    const valueSliderElement = document.getElementById('modalManualProjectValueSlider');
    if (valueSliderElement && !modalValueSlider) {
        modalValueSlider = noUiSlider.create(valueSliderElement, {
            start: [0, 1000],
            connect: true,
            range: {
                'min': 0,
                'max': 1000
            },
            step: 50,
            tooltips: [
                { to: value => 'â‚¹' + value.toFixed(0) + 'Cr' },
                { to: value => 'â‚¹' + value.toFixed(0) + 'Cr' }
            ]
        });

        modalValueSlider.on('update', function(values) {
            document.getElementById('modalManualProjectValueMin').textContent = 'â‚¹' + parseInt(values[0]) + 'Cr';
            document.getElementById('modalManualProjectValueMax').textContent = 'â‚¹' + parseInt(values[1]) + 'Cr';
        });
    }

    // Initialize Flatpickr for start date
    const startDateInput = document.getElementById('modalManualCompletionStartDate');
    if (startDateInput && !window.modalStartDatePicker) {
        window.modalStartDatePicker = flatpickr(startDateInput, {
            dateFormat: 'Y-m-d',
            placeholder: 'Start date...'
        });
    }

    // Initialize Flatpickr for end date
    const endDateInput = document.getElementById('modalManualCompletionEndDate');
    if (endDateInput && !window.modalEndDatePicker) {
        window.modalEndDatePicker = flatpickr(endDateInput, {
            dateFormat: 'Y-m-d',
            placeholder: 'End date...'
        });
    }

    // Fetch filter options from API
    fetchModalFilterOptions();

    modalManualFiltersInitialized = true;
}

/**
 * Fetch filter options from API
 */
function fetchModalFilterOptions() {
    fetch('/api/certificates/filter-options')
        .then(response => response.json())
        .then(data => {
            console.log('Filter options:', data);

            // Populate dropdowns with options
            if (data.clients && modalChoicesInstances['modalManualFilterClients']) {
                modalChoicesInstances['modalManualFilterClients'].setChoices(
                    data.clients.map(client => ({ value: client, label: client })),
                    'value',
                    'label',
                    true
                );
            }

            if (data.locations && modalChoicesInstances['modalManualFilterLocations']) {
                modalChoicesInstances['modalManualFilterLocations'].setChoices(
                    data.locations.map(loc => ({ value: loc, label: loc })),
                    'value',
                    'label',
                    true
                );
            }

            if (data.services && modalChoicesInstances['modalManualFilterServices']) {
                modalChoicesInstances['modalManualFilterServices'].setChoices(
                    data.services.map(service => ({ value: service, label: service })),
                    'value',
                    'label',
                    true
                );
            }

            if (data.sectors && modalChoicesInstances['modalManualFilterSectors']) {
                modalChoicesInstances['modalManualFilterSectors'].setChoices(
                    data.sectors.map(sector => ({ value: sector, label: sector })),
                    'value',
                    'label',
                    true
                );
            }

            if (data.sub_sectors && modalChoicesInstances['modalManualFilterSubSectors']) {
                modalChoicesInstances['modalManualFilterSubSectors'].setChoices(
                    data.sub_sectors.map(sub => ({ value: sub, label: sub })),
                    'value',
                    'label',
                    true
                );
            }

            if (data.funding_agencies && modalChoicesInstances['modalManualFilterFundingAgencies']) {
                modalChoicesInstances['modalManualFilterFundingAgencies'].setChoices(
                    data.funding_agencies.map(agency => ({ value: agency, label: agency })),
                    'value',
                    'label',
                    true
                );
            }
        })
        .catch(error => {
            console.error('Error fetching filter options:', error);
        });
}

/**
 * Clear all manual filters
 */
function clearModalManualFilters() {
    // Clear all Choices.js selections
    Object.values(modalChoicesInstances).forEach(instance => {
        if (instance) {
            instance.removeActiveItems();
        }
    });

    // Reset sliders
    if (modalFeeSlider) {
        modalFeeSlider.set([0, 500]);
    }
    if (modalValueSlider) {
        modalValueSlider.set([0, 1000]);
    }

    // Clear date pickers
    if (window.modalStartDatePicker) {
        window.modalStartDatePicker.clear();
    }
    if (window.modalEndDatePicker) {
        window.modalEndDatePicker.clear();
    }

    // Clear results
    const resultsContainer = document.getElementById('modalManualResultsGrid');
    if (resultsContainer) {
        resultsContainer.innerHTML = '';
    }
}

/**
 * Apply manual filters and search
 */
function applyModalManualFilters() {
    // Collect filter values
    const filters = {
        clients: modalChoicesInstances['modalManualFilterClients'] ?
            modalChoicesInstances['modalManualFilterClients'].getValue(true) : [],
        locations: modalChoicesInstances['modalManualFilterLocations'] ?
            modalChoicesInstances['modalManualFilterLocations'].getValue(true) : [],
        services: modalChoicesInstances['modalManualFilterServices'] ?
            modalChoicesInstances['modalManualFilterServices'].getValue(true) : [],
        sectors: modalChoicesInstances['modalManualFilterSectors'] ?
            modalChoicesInstances['modalManualFilterSectors'].getValue(true) : [],
        sub_sectors: modalChoicesInstances['modalManualFilterSubSectors'] ?
            modalChoicesInstances['modalManualFilterSubSectors'].getValue(true) : [],
        funding_agencies: modalChoicesInstances['modalManualFilterFundingAgencies'] ?
            modalChoicesInstances['modalManualFilterFundingAgencies'].getValue(true) : [],
        fee_range: modalFeeSlider ? modalFeeSlider.get() : [0, 500],
        value_range: modalValueSlider ? modalValueSlider.get() : [0, 1000],
        start_date: window.modalStartDatePicker ? window.modalStartDatePicker.selectedDates[0] : null,
        end_date: window.modalEndDatePicker ? window.modalEndDatePicker.selectedDates[0] : null
    };

    console.log('Applying filters:', filters);

    // Show loading state
    showModalManualLoading();

    // Make API call with filters
    fetch('/api/certificates/manual-clause/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filters)
    })
    .then(response => response.json())
    .then(data => {
        hideModalManualLoading();
        displayModalManualResults(data.results);
    })
    .catch(error => {
        console.error('Error applying filters:', error);
        hideModalManualLoading();
        showModalManualError('Failed to apply filters. Please try again.');
    });
}

/**
 * Show loading state in manual mode
 */
function showModalManualLoading() {
    const resultsContainer = document.getElementById('modalManualResultsGrid');
    if (resultsContainer) {
        resultsContainer.innerHTML = `
            <div class="manual-loading">
                <div class="manual-spinner"></div>
                <p class="manual-loading-text">Searching certificates...</p>
            </div>
        `;
    }
}

/**
 * Hide loading state in manual mode
 */
function hideModalManualLoading() {
    // Loading will be replaced by results or error message
}

/**
 * Display manual filter results (supports both regular and AI keyword search)
 */
function displayModalManualResults(results, summary = null, filterKeyword = null) {
    const resultsContainer = document.getElementById('modalManualResultsGrid');

    if (!resultsContainer) return;

    // Check if this is AI keyword search (results have match_count and certificate property)
    const isKeywordSearch = results && results.length > 0 && results[0].hasOwnProperty('certificate');

    if (!results || results.length === 0) {
        resultsContainer.innerHTML = `
            <div class="manual-no-results">
                <div class="manual-no-results-icon">ðŸ“‹</div>
                <h3>No matching certificates</h3>
                <p>Try adjusting your filters to see more results</p>
            </div>
        `;

        // Hide results section for keyword search
        if (filterKeyword !== null) {
            document.getElementById('modalManualResultsSection').style.display = 'none';
        }
        return;
    }

    if (isKeywordSearch) {
        // AI Keyword Search Mode - filter and display with badges
        let filteredResults = results;

        if (filterKeyword === 'combined') {
            // Combined: Show only certificates that match ALL keywords
            filteredResults = results.filter(result => {
                const matchCount = result.match_count || 0;
                const totalKeywords = result.total_keywords || 0;
                return matchCount === totalKeywords && totalKeywords > 0;
            });
        } else if (filterKeyword) {
            // Individual keyword: Show certificates that match this specific keyword
            filteredResults = results.filter(result => {
                const matchedKeywords = result.matched_keywords || [];
                return matchedKeywords.includes(filterKeyword);
            });
        }

        if (filteredResults.length === 0) {
            const message = filterKeyword === 'combined'
                ? 'No certificates match all keywords. Try individual keyword filters.'
                : 'No certificates match this keyword filter.';
            resultsContainer.innerHTML = `<div class="no-results-message">${message}</div>`;
            return;
        }

        // Render keyword search results with badges
        resultsContainer.innerHTML = '';
        filteredResults.forEach(result => {
            const card = createModalManualCertCard(result.certificate, result);
            resultsContainer.appendChild(card);
        });
    } else {
        // Regular Filter Search Mode - simple display
        const resultsHTML = results.map(cert => createModalManualCertCard(cert)).join('');
        resultsContainer.innerHTML = resultsHTML;
    }
}

/**
 * Create a manual certificate card HTML (supports both regular and keyword search)
 */
function createModalManualCertCard(cert, result = null) {
    // Check if this is keyword search result (has match info)
    const isKeywordSearch = result && result.hasOwnProperty('match_count');

    if (isKeywordSearch) {
        // AI Keyword Search Card - with compliance badge
        const card = document.createElement('div');
        card.className = 'manual-cert-card';

        const matchCount = result.match_count || 0;
        const totalKeywords = result.total_keywords || 0;
        const matchedKeywords = result.matched_keywords || [];

        // Determine badge style
        const percentage = totalKeywords > 0 ? (matchCount / totalKeywords) * 100 : 0;
        let badgeClass = 'compliance-badge--low';
        if (percentage === 100) badgeClass = 'compliance-badge--perfect';
        else if (percentage >= 75) badgeClass = 'compliance-badge--high';
        else if (percentage >= 50) badgeClass = 'compliance-badge--medium';

        const icon = percentage === 100 ? 'âœ“' : percentage >= 50 ? 'âš ' : 'âœ—';

        const servicesHtml = cert.services_rendered && cert.services_rendered.length > 0
            ? `<span class="cert-detail">ðŸ”§ ${escapeModalHtml(Array.isArray(cert.services_rendered) ? cert.services_rendered.join(', ') : cert.services_rendered)}</span>`
            : '';

        const sectorsHtml = cert.sectors && cert.sectors.length > 0
            ? `<span class="cert-detail">ðŸ’¼ ${escapeModalHtml(Array.isArray(cert.sectors) ? cert.sectors.join(', ') : cert.sectors)}</span>`
            : '';

        const matchedKeywordsHtml = matchedKeywords.length > 0
            ? `<div class="cert-matched-keywords">
                <span class="matched-label">Matched Keywords:</span>
                ${matchedKeywords.map(kw => `<span class="matched-keyword-chip">${escapeModalHtml(kw)}</span>`).join('')}
            </div>`
            : '';

        card.innerHTML = `
            <div class="compliance-badge ${badgeClass}">
                <span class="compliance-icon">${icon}</span>
                <span class="compliance-text">${matchCount}/${totalKeywords} Keywords</span>
            </div>

            <div class="cert-card-content">
                <h3 class="cert-card-title">${escapeModalHtml(cert.project_name || 'Unnamed Project')}</h3>
                <p class="cert-card-client">Client: ${escapeModalHtml(cert.client_name || 'N/A')}</p>

                <div class="cert-card-details">
                    ${cert.location ? `<span class="cert-detail">ðŸ“ ${escapeModalHtml(cert.location)}</span>` : ''}
                    ${servicesHtml}
                    ${sectorsHtml}
                </div>

                <div class="cert-card-metrics">
                    ${cert.consultancy_fee_inr ? `<span class="cert-metric">ðŸ’° ${escapeModalHtml(cert.consultancy_fee_inr)}</span>` : ''}
                    ${cert.completion_date ? `<span class="cert-metric">ðŸ“… ${formatModalDate(cert.completion_date)}</span>` : ''}
                </div>

                ${matchedKeywordsHtml}
            </div>

            <div class="cert-card-actions">
                <button type="button" class="btn btn-sm btn-outline" onclick="viewCertificateDetails('${cert.id}')">
                    View Details â†’
                </button>
            </div>
        `;

        return card;
    } else {
        // Regular Filter Search Card - simple HTML string
        return `
            <div class="manual-cert-card">
                <h4 class="cert-card-title">${cert.project_name || 'Untitled Project'}</h4>
                <p class="cert-card-client">${cert.client_name || 'Unknown Client'}</p>

                <div class="cert-card-details">
                    ${cert.location ? `<span class="cert-detail">ðŸ“ ${cert.location}</span>` : ''}
                    ${cert.completion_date ? `<span class="cert-detail">ðŸ“… ${new Date(cert.completion_date).toLocaleDateString()}</span>` : ''}
                </div>

                <div class="cert-card-metrics">
                    ${cert.project_value ? `<span class="cert-metric">ðŸ’° â‚¹${(cert.project_value / 10000000).toFixed(2)}Cr</span>` : ''}
                    ${cert.consultancy_fee ? `<span class="cert-metric">ðŸ’µ â‚¹${(cert.consultancy_fee / 100000).toFixed(2)}L</span>` : ''}
                </div>

                ${cert.services && cert.services.length > 0 ? `
                <div class="cert-services">
                    <div class="cert-services-title">Services</div>
                    <div class="cert-services-tags">
                        ${cert.services.map(service => `<span class="cert-service-tag">${service}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }
}

/**
 * Show error message in manual mode
 */
function showModalManualError(message) {
    const resultsContainer = document.getElementById('modalManualResultsGrid');
    if (resultsContainer) {
        resultsContainer.innerHTML = `
            <div class="manual-no-results">
                <div class="manual-no-results-icon">âš ï¸</div>
                <h3>Error</h3>
                <p>${message}</p>
            </div>
        `;
    }
}

// ============ Event Listeners ============

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('certIntelligenceModal');
    if (modal && event.target === modal) {
        closeCertificateIntelligenceModal();
    }
});

// Allow Enter key to trigger search
document.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        const searchInput = document.getElementById('modalCertSearchInput');
        if (searchInput && document.activeElement === searchInput) {
            performModalCertSearch();
        }
    }
});

console.log('Certificate Intelligence Modal JavaScript loaded');

// ============================================================================
// MODAL AI-POWERED CERTIFICATE MATCHING - Main Functions
// ============================================================================

/**
 * Main AI extraction workflow for modal
 */
async function performModalKeywordBasedSearch() {
    const textInput = document.getElementById('modalAiClauseText');
    const text = textInput?.value?.trim();

    if (!text && modalAiUploadedImages.length === 0) {
        showToast('âš ï¸ Please provide text or upload images', 'warning');
        return;
    }

    try {
        // Step 1: Extract keywords
        updateModalAIProcessingText('Extracting keywords from clause...');
        showModalAIProcessing(true);
        hideModalKeywordDisplay();
        hideModalResults();

        console.log('ðŸ” Step 1: Extracting keywords...');
        const extractResponse = await fetch('/api/certificates/extract-keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: text || null,
                images: modalAiUploadedImages.length > 0 ? modalAiUploadedImages : null
            })
        });

        if (!extractResponse.ok) {
            const error = await extractResponse.json();
            throw new Error(error.detail || 'Keyword extraction failed');
        }

        const extractData = await extractResponse.json();
        const keywords = extractData.keywords || [];

        if (keywords.length === 0) {
            showToast('âš ï¸ No keywords could be extracted from the clause. Please try a different clause or provide more details.', 'warning');
            showModalAIProcessing(false);
            hideModalKeywordDisplay();
            return;
        }

        // Limit keywords if too many
        if (keywords.length > 30) {
            showToast(`âš ï¸ Too many keywords (${keywords.length}). Using first 30 keywords.`, 'warning');
            keywords.splice(30);
        }

        console.log(`âœ… Extracted ${keywords.length} keywords:`, keywords);
        displayModalKeywords(keywords);

        // Step 2: Expand keywords
        updateModalAIProcessingText('Expanding keywords with AI...');
        console.log('ðŸ” Step 2: Expanding keywords...');

        const expandResponse = await fetch('/api/certificates/expand-keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ keywords })
        });

        if (!expandResponse.ok) {
            const error = await expandResponse.json();
            throw new Error(error.detail || 'Keyword expansion failed');
        }

        const expandData = await expandResponse.json();
        const expandedVariants = expandData.expanded || {};

        console.log('âœ… Expanded keywords:', expandedVariants);

        // Check if expansion was successful
        if (Object.keys(expandedVariants).length === 0) {
            console.warn('âš ï¸ No keyword expansions received, using original keywords only');
            // Create default expansions (just the keyword itself)
            keywords.forEach(kw => {
                if (!expandedVariants[kw]) {
                    expandedVariants[kw] = [kw];
                }
            });
        }

        displayModalExpandedKeywords(expandedVariants);

        // Step 3: Search certificates
        updateModalAIProcessingText('Searching certificates...');
        console.log('ðŸ” Step 3: Searching certificates...');

        const searchResponse = await fetch('/api/certificates/search-by-keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                keywords: keywords,
                expanded_variants: expandedVariants
            })
        });

        if (!searchResponse.ok) {
            const error = await searchResponse.json();
            throw new Error(error.detail || 'Search failed');
        }

        const searchData = await searchResponse.json();
        console.log('âœ… Search complete:', searchData);

        // Store results and keywords for filtering
        modalAllKeywordResults = searchData.results || [];
        modalAllKeywords = keywords;
        modalCurrentKeywordFilter = 'combined';

        // Create keyword filter buttons
        createModalKeywordFilterButtons(keywords);

        // Display results (Combined shows only certificates matching ALL keywords)
        displayModalManualResults(modalAllKeywordResults, searchData.summary || {}, 'combined');

        // Update summary - count only certificates matching all keywords for Combined
        const combinedCount = modalAllKeywordResults.filter(result => {
            const matchCount = result.match_count || 0;
            const totalKeywords = result.total_keywords || 0;
            return matchCount === totalKeywords && totalKeywords > 0;
        }).length;
        document.getElementById('modalManualResultCount').textContent = combinedCount;
        document.getElementById('modalKeywordCount').textContent = keywords.length;

        // Show results section
        document.getElementById('modalManualResultsSection').style.display = 'block';
        
        // Hide no results message if there are results
        if (searchData.results && searchData.results.length > 0) {
            document.getElementById('modalManualNoResults').style.display = 'none';
        } else {
            document.getElementById('modalManualNoResults').style.display = 'block';
            document.getElementById('modalManualNoResults').querySelector('p').textContent = 
                'No certificates match the extracted keywords. Try a different clause.';
        }

        showModalAIProcessing(false);
        showToast(`âœ… Found ${searchData.results?.length || 0} matching certificates`, 'success');

    } catch (error) {
        console.error('âŒ Keyword-based search error:', error);

        // Handle specific error cases
        let errorMessage = error.message || 'Search failed';

        if (error.message.includes('rate limit') || error.message.includes('RateLimit')) {
            errorMessage = 'API rate limit reached. Please wait a moment and try again.';
        } else if (error.message.includes('timeout')) {
            errorMessage = 'Request timed out. Please try again with fewer keywords.';
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
            errorMessage = 'Network error. Please check your connection and try again.';
        }

        showToast(`âŒ ${errorMessage}`, 'error');
        showModalAIProcessing(false);
        hideModalKeywordDisplay();
        hideModalResults();
    }
}

/**
 * Show/hide AI processing status
 */
function showModalAIProcessing(show) {
    const status = document.getElementById('modalAiProcessingStatus');
    const btn = document.getElementById('modalAiExtractBtn');

    if (status) {
        status.style.display = show ? 'flex' : 'none';
    }

    if (btn) {
        btn.disabled = show;
        btn.style.opacity = show ? '0.6' : '1';
    }
}

/**
 * Update AI processing text
 */
function updateModalAIProcessingText(text) {
    const textElement = document.getElementById('modalAiProcessingText');
    if (textElement) {
        textElement.textContent = text;
    }
}

/**
 * Display extracted keywords with remove buttons
 */
function displayModalKeywords(keywords) {
    const section = document.getElementById('modalKeywordDisplaySection');
    const container = document.getElementById('modalKeywordChipsContainer');

    if (!section || !container) return;

    // Store original keywords and initialize modified keywords
    modalOriginalKeywords = [...keywords];
    modalModifiedKeywords = [...keywords];
    modalKeywordsModified = false;

    renderModalKeywordChips();

    // Hide update button initially
    document.getElementById('modalUpdateResultsContainer').style.display = 'none';

    section.style.display = 'block';
}

/**
 * Render keyword chips with remove buttons
 */
function renderModalKeywordChips() {
    const container = document.getElementById('modalKeywordChipsContainer');
    if (!container) return;

    container.innerHTML = '';

    modalModifiedKeywords.forEach((keyword, index) => {
        const chip = document.createElement('div');
        chip.className = 'keyword-chip';
        chip.dataset.keywordIndex = index;

        const keywordText = document.createElement('span');
        keywordText.className = 'keyword-chip-text';
        keywordText.textContent = keyword;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'keyword-chip-remove';
        removeBtn.innerHTML = 'Ã—';
        removeBtn.onclick = () => removeModalKeyword(index);
        removeBtn.title = 'Remove keyword';

        chip.appendChild(keywordText);
        chip.appendChild(removeBtn);
        container.appendChild(chip);
    });
}

/**
 * Remove a keyword
 */
function removeModalKeyword(index) {
    if (modalModifiedKeywords.length <= 1) {
        showToast('âš ï¸ At least one keyword is required', 'warning');
        return;
    }

    modalModifiedKeywords.splice(index, 1);
    modalKeywordsModified = true;

    renderModalKeywordChips();
    showModalUpdateResultsButton();
}

/**
 * Show add keyword input
 */
function showModalAddKeywordInput() {
    const container = document.getElementById('modalAddKeywordInputContainer');
    const input = document.getElementById('modalNewKeywordInput');
    if (container && input) {
        container.style.display = 'flex';
        input.focus();
    }
}

/**
 * Hide add keyword input
 */
function hideModalAddKeywordInput() {
    const container = document.getElementById('modalAddKeywordInputContainer');
    const input = document.getElementById('modalNewKeywordInput');
    if (container && input) {
        container.style.display = 'none';
        input.value = '';
    }
}

/**
 * Handle Enter key in new keyword input
 */
function handleModalNewKeywordKeydown(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        addModalNewKeyword();
    } else if (event.key === 'Escape') {
        hideModalAddKeywordInput();
    }
}

/**
 * Add a new keyword
 */
function addModalNewKeyword() {
    const input = document.getElementById('modalNewKeywordInput');
    if (!input) return;

    const newKeyword = input.value.trim();
    if (!newKeyword) {
        showToast('âš ï¸ Please enter a keyword', 'warning');
        return;
    }

    if (modalModifiedKeywords.includes(newKeyword)) {
        showToast('âš ï¸ This keyword already exists', 'warning');
        return;
    }

    modalModifiedKeywords.push(newKeyword);
    modalKeywordsModified = true;

    renderModalKeywordChips();
    hideModalAddKeywordInput();
    showModalUpdateResultsButton();
}

/**
 * Show update results button
 */
function showModalUpdateResultsButton() {
    const container = document.getElementById('modalUpdateResultsContainer');
    if (container) {
        container.style.display = 'flex';
    }
}

/**
 * Update results with modified keywords
 */
async function updateModalResultsWithModifiedKeywords() {
    if (modalModifiedKeywords.length === 0) {
        showToast('âš ï¸ At least one keyword is required', 'warning');
        return;
    }

    try {
        updateModalAIProcessingText('Updating results with modified keywords...');
        showModalAIProcessing(true);

        // Step 1: Expand modified keywords
        console.log('ðŸ”„ Expanding modified keywords...');
        const expandResponse = await fetch('/api/certificates/expand-keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ keywords: modalModifiedKeywords })
        });

        if (!expandResponse.ok) {
            const error = await expandResponse.json();
            throw new Error(error.detail || 'Keyword expansion failed');
        }

        const expandData = await expandResponse.json();
        const expandedVariants = expandData.expanded || {};

        // Create default expansions if needed
        modalModifiedKeywords.forEach(kw => {
            if (!expandedVariants[kw]) {
                expandedVariants[kw] = [kw];
            }
        });

        console.log('âœ… Expanded modified keywords:', expandedVariants);
        displayModalExpandedKeywords(expandedVariants);

        // Step 2: Search certificates with modified keywords
        updateModalAIProcessingText('Searching certificates...');
        console.log('ðŸ”„ Searching with modified keywords...');

        const searchResponse = await fetch('/api/certificates/search-by-keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                keywords: modalModifiedKeywords,
                expanded_variants: expandedVariants
            })
        });

        if (!searchResponse.ok) {
            const error = await searchResponse.json();
            throw new Error(error.detail || 'Search failed');
        }

        const searchData = await searchResponse.json();
        console.log('âœ… Search complete with modified keywords:', searchData);

        // Update stored data
        modalAllKeywordResults = searchData.results || [];
        modalAllKeywords = modalModifiedKeywords;
        modalCurrentKeywordFilter = 'combined';
        modalKeywordsModified = false;

        // Create keyword filter buttons with modified keywords
        createModalKeywordFilterButtons(modalModifiedKeywords);

        // Display results
        displayModalManualResults(modalAllKeywordResults, searchData.summary || {}, 'combined');

        // Update summary
        const combinedCount = modalAllKeywordResults.filter(result => {
            const matchCount = result.match_count || 0;
            const totalKeywords = result.total_keywords || 0;
            return matchCount === totalKeywords && totalKeywords > 0;
        }).length;
        document.getElementById('modalManualResultCount').textContent = combinedCount;
        document.getElementById('modalKeywordCount').textContent = modalModifiedKeywords.length;

        // Show results section
        document.getElementById('modalManualResultsSection').style.display = 'block';

        // Hide update button
        document.getElementById('modalUpdateResultsContainer').style.display = 'none';

        showModalAIProcessing(false);
        showToast(`âœ… Updated results with ${modalModifiedKeywords.length} keywords. Found ${searchData.results?.length || 0} certificates.`, 'success');

    } catch (error) {
        console.error('âŒ Error updating results:', error);
        showToast(`âŒ Failed to update results: ${error.message}`, 'error');
        showModalAIProcessing(false);
    }
}

/**
 * Display expanded keyword variants
 */
function displayModalExpandedKeywords(expandedVariants) {
    const section = document.getElementById('modalKeywordExpansionSection');
    const container = document.getElementById('modalKeywordExpansionContainer');

    if (!section || !container) return;

    container.innerHTML = '';

    Object.entries(expandedVariants).forEach(([keyword, variants]) => {
        if (!variants || variants.length === 0) return;

        const item = document.createElement('div');
        item.className = 'keyword-expansion-item';

        const header = document.createElement('div');
        header.className = 'keyword-expansion-header';

        const keywordSpan = document.createElement('span');
        keywordSpan.className = 'keyword-expansion-keyword';
        keywordSpan.textContent = keyword;

        const toggle = document.createElement('button');
        toggle.className = 'keyword-expansion-toggle';
        toggle.textContent = 'Show variants';
        toggle.onclick = () => {
            const variantsDiv = item.querySelector('.keyword-variants');
            const isExpanded = variantsDiv.classList.contains('expanded');
            variantsDiv.classList.toggle('expanded');
            toggle.textContent = isExpanded ? 'Show variants' : 'Hide variants';
        };

        header.appendChild(keywordSpan);
        header.appendChild(toggle);

        const variantsDiv = document.createElement('div');
        variantsDiv.className = 'keyword-variants';

        variants.forEach(variant => {
            const variantChip = document.createElement('span');
            variantChip.className = 'keyword-variant-chip';
            variantChip.textContent = variant;
            variantsDiv.appendChild(variantChip);
        });

        item.appendChild(header);
        item.appendChild(variantsDiv);
        container.appendChild(item);
    });

    section.style.display = 'block';
}

/**
 * Hide keyword display section
 */
function hideModalKeywordDisplay() {
    const section = document.getElementById('modalKeywordDisplaySection');
    if (section) {
        section.style.display = 'none';
    }
}

/**
 * Hide results section
 */
function hideModalResults() {
    const section = document.getElementById('modalManualResultsSection');
    if (section) {
        section.style.display = 'none';
    }
}

/**
 * Create keyword filter buttons
 */
function createModalKeywordFilterButtons(keywords) {
    const container = document.getElementById('modalKeywordFilterButtons');
    if (!container) return;

    // Clear existing buttons (except Combined)
    const combinedBtn = container.querySelector('[data-keyword="combined"]');
    container.innerHTML = '';

    // Add Combined button
    if (combinedBtn) {
        container.appendChild(combinedBtn);
    } else {
        const combined = document.createElement('button');
        combined.type = 'button';
        combined.className = 'keyword-filter-btn keyword-filter-btn--active';
        combined.dataset.keyword = 'combined';
        combined.textContent = 'Combined';
        combined.onclick = () => filterModalResultsByKeyword('combined');
        container.appendChild(combined);
    }

    // Add buttons for each keyword
    keywords.forEach(keyword => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'keyword-filter-btn';
        btn.dataset.keyword = keyword;
        btn.textContent = keyword;
        btn.onclick = () => filterModalResultsByKeyword(keyword);
        container.appendChild(btn);
    });

    // Show the container
    container.style.display = 'flex';
}

/**
 * Filter results by keyword
 */
function filterModalResultsByKeyword(keyword) {
    // Update active button
    const buttons = document.querySelectorAll('#modalKeywordFilterButtons .keyword-filter-btn');
    buttons.forEach(btn => {
        if (btn.dataset.keyword === keyword) {
            btn.classList.add('keyword-filter-btn--active');
        } else {
            btn.classList.remove('keyword-filter-btn--active');
        }
    });

    // Update current filter
    modalCurrentKeywordFilter = keyword;

    // Filter and display results
    displayModalManualResults(modalAllKeywordResults, {}, keyword);

    // Update result count
    let filteredCount;
    if (keyword === 'combined') {
        // Combined: Count only certificates that match ALL keywords
        filteredCount = modalAllKeywordResults.filter(result => {
            const matchCount = result.match_count || 0;
            const totalKeywords = result.total_keywords || 0;
            return matchCount === totalKeywords && totalKeywords > 0;
        }).length;
    } else {
        // Individual keyword: Count certificates that match this keyword
        filteredCount = modalAllKeywordResults.filter(result => {
            const matchedKeywords = result.matched_keywords || [];
            return matchedKeywords.includes(keyword);
        }).length;
    }
    document.getElementById('modalManualResultCount').textContent = filteredCount;
}

/**
 * Format date for display
 */
function formatModalDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
    } catch (e) {
        return dateString;
    }
}

/**
 * Format currency (simple version)
 */
function formatModalCurrency(value) {
    if (value >= 10000000) return (value / 10000000).toFixed(1) + 'Cr';
    if (value >= 100000) return (value / 100000).toFixed(1) + 'L';
    if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
    return value.toString();
}

/**
 * Escape HTML to prevent XSS
 */
function escapeModalHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

/**
 * Show toast notification
 */
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#6366f1'};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10001;
        font-size: 14px;
        font-weight: 600;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;

    document.body.appendChild(toast);

    // Remove after 4 seconds
    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

/**
 * View certificate details (placeholder)
 */
function viewCertificateDetails(certId) {
    // TODO: Implement certificate details modal or redirect
    console.log('View certificate:', certId);
    alert('Certificate details view coming soon!');
}

/**
 * Initialize AI filter section with event listeners
 */
function initModalAIFilterSection() {
    console.log('Initializing Modal AI filter section...');

    const uploadBtn = document.getElementById('modalAiUploadBtn');
    const fileInput = document.getElementById('modalAiClauseImages');
    const extractBtn = document.getElementById('modalAiExtractBtn');

    if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleModalAIImageUpload);
    }

    if (extractBtn) {
        extractBtn.addEventListener('click', performModalKeywordBasedSearch);
    }

    console.log('Modal AI filter section initialized');
}

/**
 * Handle image upload and create previews
 */
async function handleModalAIImageUpload(event) {
    const files = Array.from(event.target.files);
    const previewGrid = document.getElementById('modalAiImagePreview');

    if (!previewGrid) return;

    previewGrid.innerHTML = '';
    modalAiUploadedImages = [];

    // Limit to 5 images
    const filesToProcess = files.slice(0, 5);

    for (const file of filesToProcess) {
        try {
            const base64 = await fileToBase64(file);
            modalAiUploadedImages.push(base64);

            // Create preview thumbnail
            const preview = createModalImagePreview(file, base64);
            previewGrid.appendChild(preview);
        } catch (error) {
            console.error('Error processing image:', error);
        }
    }

    if (files.length > 5) {
        showToast('âš ï¸ Only first 5 images will be used', 'warning');
    }

    console.log(`Loaded ${modalAiUploadedImages.length} images`);
}

/**
 * Convert file to base64 string
 */
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const base64 = reader.result.split(',')[1]; // Remove data:image/... prefix
            resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

/**
 * Create image preview element
 */
function createModalImagePreview(file, base64) {
    const container = document.createElement('div');
    container.className = 'image-preview-item';

    const img = document.createElement('img');
    img.src = `data:image/jpeg;base64,${base64}`;
    img.alt = file.name;

    const name = document.createElement('div');
    name.className = 'image-preview-name';
    name.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;

    container.appendChild(img);
    container.appendChild(name);

    return container;
}

/**
 * Close AI preview modal
 */
function closeModalAiPreview() {
    const modal = document.getElementById('modalAiFilterPreviewModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Initialize modal AI filter section when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initModalAIFilterSection);
} else {
    initModalAIFilterSection();
}

// ============================================================================
// PAGINATION FUNCTIONS
// ============================================================================

/**
 * Update pagination controls
 */
function updateModalCertPagination(data) {
    const paginationEl = document.getElementById('modalCertPagination');
    const paginationInfo = document.getElementById('modalCertPaginationInfo');
    const prevBtn = document.getElementById('modalCertPrevBtn');
    const nextBtn = document.getElementById('modalCertNextBtn');
    const pageNumbers = document.getElementById('modalCertPageNumbers');

    if (!paginationEl || !data) return;

    const { page = 1, total = 0, per_page = 30, total_pages = 1, has_prev = false, has_next = false } = data;

    // Show/hide pagination based on whether there are multiple pages
    if (total_pages <= 1) {
        paginationEl.style.display = 'none';
        return;
    }

    paginationEl.style.display = 'flex';

    // Update info text
    const start = ((page - 1) * per_page) + 1;
    const end = Math.min(page * per_page, total);
    paginationInfo.textContent = `Showing ${start}-${end} of ${total} certificates`;

    // Update prev/next buttons
    prevBtn.disabled = !has_prev;
    nextBtn.disabled = !has_next;

    // Generate page number buttons
    pageNumbers.innerHTML = '';
    const maxButtons = 7;  // Show max 7 page buttons
    let startPage = Math.max(1, page - 3);
    let endPage = Math.min(total_pages, startPage + maxButtons - 1);

    // Adjust start if we're near the end
    if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
    }

    // Add first page + ellipsis if needed
    if (startPage > 1) {
        addPageButton(1);
        if (startPage > 2) {
            pageNumbers.innerHTML += '<span class="pagination-ellipsis">...</span>';
        }
    }

    // Add page buttons
    for (let i = startPage; i <= endPage; i++) {
        addPageButton(i, i === page);
    }

    // Add ellipsis + last page if needed
    if (endPage < total_pages) {
        if (endPage < total_pages - 1) {
            pageNumbers.innerHTML += '<span class="pagination-ellipsis">...</span>';
        }
        addPageButton(total_pages);
    }
}

/**
 * Add a page number button
 */
function addPageButton(pageNum, isActive = false) {
    const pageNumbers = document.getElementById('modalCertPageNumbers');
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'pagination-page-btn' + (isActive ? ' active' : '');
    btn.textContent = pageNum;
    btn.onclick = () => goToModalCertPage(pageNum);
    pageNumbers.appendChild(btn);
}

/**
 * Navigate to a specific page
 */
function goToModalCertPage(target) {
    let newPage;

    if (target === 'prev') {
        newPage = Math.max(1, currentCertPage - 1);
    } else if (target === 'next') {
        newPage = Math.min(currentCertTotalPages, currentCertPage + 1);
    } else {
        newPage = parseInt(target);
    }

    if (newPage === currentCertPage) return;

    // Re-run the search with the new page
    if (currentCertQuery) {
        performModalCertSearch(newPage);
    } else {
        showAllModalCerts(newPage);
    }

    // Scroll to top of results
    const resultsGrid = document.getElementById('modalCertResultsGrid');
    if (resultsGrid) {
        resultsGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// ============ End PAGINATION Functions ============

// ============================================================================
// CERTIFICATE-TENDER ATTACHMENT FUNCTIONS (MODAL)
// ============================================================================

let modalCachedFavoriteTenders = null;

/**
 * Load favorite tenders into all dropdowns in the modal
 */
async function modalCertLoadFavoriteTendersIntoDropdowns() {
    try {
        // Fetch favorites if not cached
        if (!modalCachedFavoriteTenders) {
            const response = await fetch('/api/favorites/list-for-attachment', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                throw new Error('Failed to load favorites');
            }

            const data = await response.json();
            modalCachedFavoriteTenders = data.favorites || [];
        }

        // Populate all dropdowns on the page
        const dropdowns = document.querySelectorAll('.cert-tender-dropdown');
        dropdowns.forEach(dropdown => {
            // Clear existing options except first
            dropdown.innerHTML = '<option value="">Select a tender...</option>';

            // Add favorite tenders
            if (modalCachedFavoriteTenders.length === 0) {
                dropdown.innerHTML = '<option value="">No favorited tenders available</option>';
                dropdown.disabled = true;
                return;
            }

            modalCachedFavoriteTenders.forEach(tender => {
                const option = document.createElement('option');
                option.value = tender.tender_id;

                // Format title (truncate if too long)
                let title = tender.title;
                if (title.length > 60) {
                    title = title.substring(0, 57) + '...';
                }

                // Add authority and deadline info
                const authority = tender.authority || 'Unknown Authority';
                const deadline = tender.deadline ? new Date(tender.deadline).toLocaleDateString() : 'No deadline';

                option.textContent = `${title} | ${authority} | ${deadline}`;
                dropdown.appendChild(option);
            });

            // Enable attach button when tender is selected
            dropdown.addEventListener('change', function() {
                const certId = dropdown.id.replace('modal-tender-dropdown-', '');
                const attachBtn = dropdown.parentElement.querySelector('.cert-attach-btn');
                const attachFavBtn = dropdown.parentElement.querySelector('.cert-attach-fav-btn');
                
                const isSelected = !!dropdown.value;
                if (attachBtn) attachBtn.disabled = !isSelected;
                if (attachFavBtn) attachFavBtn.disabled = !isSelected;
            });
        });

    } catch (error) {
        console.error('[MODAL CERT ATTACH] Error loading favorites:', error);
        modalCertShowNotification('Failed to load favorited tenders', 'error');
    }
}

/**
 * Attach certificate to selected tender (from modal)
 */
async function modalCertAttachToTender(certificateId) {
    const dropdown = document.getElementById(`modal-tender-dropdown-${certificateId}`);
    const tenderId = dropdown.value;

    if (!tenderId) {
        modalCertShowNotification('Please select a tender first', 'warning');
        return;
    }

    try {
        // Show loading state
        const attachBtn = dropdown.parentElement.querySelector('.cert-attach-btn');
        const originalText = attachBtn.textContent;
        attachBtn.textContent = 'Attaching...';
        attachBtn.disabled = true;

        // Make API call
        const formData = new FormData();
        formData.append('tender_id', tenderId);

        const response = await fetch(`/api/certificates/${certificateId}/attach-to-tender`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Attachment failed');
        }

        // Success
        modalCertShowNotification(`âœ“ Certificate attached to "${data.tender_title}"`, 'success');

        // Reset dropdown
        dropdown.value = '';
        attachBtn.disabled = true;

        // Refresh the certificate search to show updated attachment status
        if (currentCertQuery) {
            performModalCertSearch(currentCertPage);
        } else {
            showAllModalCerts(currentCertPage);
        }

    } catch (error) {
        console.error('[MODAL CERT ATTACH] Error attaching certificate:', error);
        modalCertShowNotification(error.message || 'Failed to attach certificate', 'error');

        // Reset button
        const attachBtn = dropdown.parentElement.querySelector('.cert-attach-btn');
        attachBtn.textContent = 'Attach';
        attachBtn.disabled = false;
    }
}

/**
 * Attach certificate to current tender AND mark tender as favorite (BD employees only)
 * @param {string} certificateId - The certificate ID to attach
 */
async function modalCertAttachAndFavorite(certificateId) {
    const dropdown = document.getElementById(`modal-tender-dropdown-${certificateId}`);
    const tenderId = dropdown.value;

    if (!tenderId) {
        modalCertShowNotification('Please select a tender first', 'warning');
        return;
    }

    // Get both buttons
    const attachFavBtn = dropdown.parentElement.querySelector('.cert-attach-fav-btn');
    const originalText = attachFavBtn ? attachFavBtn.textContent : 'Attach & Favourite';
    
    if (attachFavBtn) {
        attachFavBtn.textContent = 'Processing...';
        attachFavBtn.disabled = true;
    }

    try {
        // Step 1: Favorite the tender FIRST if it's the current tender and not already favorited
        // Backend requires tender to be favorited before attaching certificates
        let successMessage = 'Certificate attached successfully!';
        
        if (tenderId === currentTenderId && !isCurrentTenderFavorited) {
            const favoriteResponse = await fetch(`/api/favorites/${tenderId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: '' })
            });

            if (!favoriteResponse.ok) {
                const favoriteError = await favoriteResponse.json();
                throw new Error(favoriteError.detail || 'Failed to favorite tender');
            }
            
            // Update the favorite button UI on the page
            const favoriteBtn = document.getElementById('favoriteBtn');
            if (favoriteBtn) {
                favoriteBtn.classList.add('favorited');
                favoriteBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
                </svg>`;
            }
            
            // Update global flag
            isCurrentTenderFavorited = true;
            
            // Show action section
            const actionSection = document.getElementById('actionSection');
            if (actionSection) actionSection.style.display = 'block';
            
            successMessage = 'Certificate attached and tender favorited!';
        }

        // Step 2: Now attach the certificate (tender should be favorited at this point)
        const formData = new FormData();
        formData.append('tender_id', tenderId);
        
        const attachResponse = await fetch(`/api/certificates/${certificateId}/attach-to-tender`, {
            method: 'POST',
            body: formData
        });

        if (!attachResponse.ok) {
            const errorData = await attachResponse.json();
            throw new Error(errorData.detail || 'Failed to attach certificate');
        }

        // Show success message
        modalCertShowNotification(successMessage, 'success');

        // Update attached count badge
        const certCard = dropdown.closest('.manual-cert-card');
        if (certCard) {
            const badge = certCard.querySelector('.cert-attached-badge');
            if (badge) {
                const currentCount = parseInt(badge.textContent.match(/\d+/)[0] || 0);
                badge.textContent = `âœ“ Attached to ${currentCount + 1} tender(s)`;
            }
        }

        // Reset dropdown
        dropdown.value = '';
        
        // Disable both buttons
        if (attachFavBtn) attachFavBtn.disabled = true;
        const attachBtn = dropdown.parentElement.querySelector('.cert-attach-btn');
        if (attachBtn) attachBtn.disabled = true;

        // Refresh favorites cache
        modalCachedFavoriteTenders = null;
        await modalCertLoadFavoriteTendersIntoDropdowns();

    } catch (error) {
        console.error('[MODAL CERT ATTACH & FAV] Error:', error);
        modalCertShowNotification(error.message || 'Failed to attach certificate', 'error');

        // Reset button
        if (attachFavBtn) {
            attachFavBtn.textContent = originalText;
            attachFavBtn.disabled = false;
        }
    }
}

/**
 * Attach certificate to CURRENT tender AND mark it as favorite
 * This function directly uses the current tender being viewed, no dropdown selection needed
 * @param {string} certificateId - The certificate ID to attach
 */
async function modalCertAttachAndFavoriteCurrentTender(certificateId) {
    // Use the current tender ID directly
    const tenderId = currentTenderId;

    if (!tenderId) {
        modalCertShowNotification('Unable to identify current tender', 'error');
        return;
    }

    // Find the button for this certificate
    const certCard = document.querySelector(`[data-cert-id="${certificateId}"]`);
    let attachFavBtn = null;
    if (certCard) {
        attachFavBtn = certCard.querySelector('.cert-attach-fav-btn');
    }
    
    const originalText = 'Attach & Favourite';
    
    if (attachFavBtn) {
        attachFavBtn.textContent = 'Processing...';
        attachFavBtn.disabled = true;
    }

    try {
        // Step 1: Favorite the tender FIRST (if not already favorited)
        // Backend requires tender to be favorited before attaching certificates
        if (!isCurrentTenderFavorited) {
            const favoriteResponse = await fetch(`/api/favorites/${tenderId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: '' })
            });

            if (!favoriteResponse.ok) {
                const favoriteError = await favoriteResponse.json();
                throw new Error(favoriteError.detail || 'Failed to favorite tender');
            }
            
            // Update the favorite button UI on the page
            const favoriteBtn = document.getElementById('favoriteBtn');
            if (favoriteBtn) {
                favoriteBtn.classList.add('favorited');
                favoriteBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
                </svg>`;
            }
            
            // Update global flag
            isCurrentTenderFavorited = true;
            
            // Show action section
            const actionSection = document.getElementById('actionSection');
            if (actionSection) actionSection.style.display = 'block';
        }

        // Step 2: Now attach the certificate (tender is now favorited)
        const formData = new FormData();
        formData.append('tender_id', tenderId);
        
        const attachResponse = await fetch(`/api/certificates/${certificateId}/attach-to-tender`, {
            method: 'POST',
            body: formData
        });

        if (!attachResponse.ok) {
            const errorData = await attachResponse.json();
            throw new Error(errorData.detail || 'Failed to attach certificate');
        }

        // Both operations succeeded!
        modalCertShowNotification('Certificate attached and tender favorited!', 'success');
        
        // Hide all "Attach & Favourite" buttons since tender is now favorited
        const allAttachFavBtns = document.querySelectorAll('.cert-attach-fav-btn');
        allAttachFavBtns.forEach(btn => btn.style.display = 'none');

        // Update attached count badge
        if (certCard) {
            const badge = certCard.querySelector('.cert-attached-badge');
            if (badge) {
                const currentCount = parseInt(badge.textContent.match(/\d+/)?.[0] || 0);
                badge.textContent = `âœ“ Attached to ${currentCount + 1} tender(s)`;
            }
        }

        // Refresh favorites cache
        modalCachedFavoriteTenders = null;
        await modalCertLoadFavoriteTendersIntoDropdowns();

        // Reset button state
        if (attachFavBtn) {
            attachFavBtn.textContent = originalText;
            attachFavBtn.disabled = false;
        }

    } catch (error) {
        console.error('[MODAL CERT ATTACH & FAV CURRENT] Error:', error);
        modalCertShowNotification(error.message || 'Failed to attach certificate', 'error');

        // Reset button
        if (attachFavBtn) {
            attachFavBtn.textContent = originalText;
            attachFavBtn.disabled = false;
        }
    }
}

/**
 * View all attachments for a certificate (from modal)
 */
async function modalCertViewAttachments(certificateId) {
    try {
        const response = await fetch(`/api/certificates/${certificateId}/attached-tenders`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error('Failed to load attachments');
        }

        // Show modal with attachments
        modalCertShowAttachmentsModal(certificateId, data.attachments);

    } catch (error) {
        console.error('[MODAL CERT ATTACH] Error loading attachments:', error);
        modalCertShowNotification('Failed to load attachments', 'error');
    }
}

/**
 * Show modal with certificate attachments
 */
function modalCertShowAttachmentsModal(certificateId, attachments) {
    const modalHTML = `
        <div class="cert-attachments-modal-overlay" onclick="modalCertCloseAttachmentsModal()">
            <div class="cert-attachments-modal-content" onclick="event.stopPropagation()">
                <div class="cert-attachments-modal-header">
                    <h3>Attached Tenders</h3>
                    <button onclick="modalCertCloseAttachmentsModal()">Ã—</button>
                </div>
                <div class="cert-attachments-modal-body">
                    ${attachments.length === 0 ? `
                        <p class="cert-no-attachments">No tenders attached</p>
                    ` : `
                        <div class="cert-attachments-list">
                            ${attachments.map(att => `
                                <div class="cert-attachment-item">
                                    <div class="cert-attachment-item-header">
                                        <h4>${att.tender_title}</h4>
                                        <button class="cert-detach-btn"
                                                onclick="modalCertDetachFromTender('${certificateId}', '${att.tender_id}')">
                                            Detach
                                        </button>
                                    </div>
                                    <p class="cert-attachment-item-authority">${att.tender_authority || 'Unknown Authority'}</p>
                                    <p class="cert-attachment-item-meta">
                                        Attached on ${new Date(att.attached_at).toLocaleDateString()}
                                        ${att.tender_deadline ? ` | Deadline: ${new Date(att.tender_deadline).toLocaleDateString()}` : ''}
                                    </p>
                                    ${att.notes ? `<p class="cert-attachment-item-notes">${att.notes}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function modalCertCloseAttachmentsModal() {
    const modal = document.querySelector('.cert-attachments-modal-overlay');
    if (modal) {
        modal.remove();
    }
}

/**
 * Detach certificate from tender (from modal)
 */
async function modalCertDetachFromTender(certificateId, tenderId) {
    if (!confirm('Are you sure you want to detach this certificate from the tender?')) {
        return;
    }

    try {
        const response = await fetch(`/api/certificates/${certificateId}/detach-from-tender/${tenderId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Detachment failed');
        }

        modalCertShowNotification('Certificate detached successfully', 'success');
        modalCertCloseAttachmentsModal();

        // Refresh the certificate search
        if (currentCertQuery) {
            performModalCertSearch(currentCertPage);
        } else {
            showAllModalCerts(currentCertPage);
        }

    } catch (error) {
        console.error('[MODAL CERT DETACH] Error:', error);
        modalCertShowNotification(error.message || 'Failed to detach certificate', 'error');
    }
}

/**
 * Show notification toast (from modal)
 */
function modalCertShowNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `cert-notification cert-notification-${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('cert-notification-show');
    }, 10);

    setTimeout(() => {
        notification.classList.remove('cert-notification-show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Modify the original displayModalCertResults to load favorites after results are displayed
const originalDisplayModalCertResults = displayModalCertResults;
displayModalCertResults = function(...args) {
    originalDisplayModalCertResults.apply(this, args);
    // Load favorites into dropdowns after results are displayed
    setTimeout(modalCertLoadFavoriteTendersIntoDropdowns, 100);
};

// ============ End CERTIFICATE-TENDER ATTACHMENT Functions ============

// ============ End MODAL AI-POWERED CERTIFICATE MATCHING Functions ============

// ============ End Certificate Intelligence Modal Functions ============
</script>

{# Structured Data - Tender Detail Page #}
{% if tender %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "{{ tender.title|e }}",
    "description": "{{ (tender.summary[:500] if tender.summary else 'Government tender details')|e }}",
    "url": "{{ request.url.scheme }}://{{ request.url.netloc }}{{ request.url.path }}",
    {% if tender.published_at %}
    "datePublished": "{{ tender.published_at.isoformat() }}",
    {% endif %}
    {% if tender.updated_at %}
    "dateModified": "{{ tender.updated_at.isoformat() }}",
    {% endif %}
    "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "{{ request.url.scheme }}://{{ request.url.netloc }}/"
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": "Tenders",
                "item": "{{ request.url.scheme }}://{{ request.url.netloc }}/procurement"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": "{{ tender.title[:50]|e }}",
                "item": "{{ request.url.scheme }}://{{ request.url.netloc }}{{ request.url.path }}"
            }
        ]
    },
    "mainEntity": {
        "@type": "Product",
        "name": "{{ tender.title|e }}",
        "description": "{{ (tender.summary[:500] if tender.summary else 'Government tender')|e }}",
        {% if tender.authority %}
        "brand": {
            "@type": "Organization",
            "name": "{{ tender.authority|e }}"
        },
        {% endif %}
        {% if tender.category %}
        "category": "{{ tender.category|e }}",
        {% endif %}
        {% if tender.tender_value %}
        "offers": {
            "@type": "Offer",
            "price": "{{ tender.tender_value }}",
            "priceCurrency": "INR"
        },
        {% endif %}
        {% if tender.deadline %}
        "availabilityStarts": "{{ tender.deadline.isoformat() }}",
        {% endif %}
        {% if tender.state %}
        "areaServed": {
            "@type": "State",
            "name": "{{ tender.state|e }}"
        }
        {% endif %}
    }
}
</script>

{# Event Schema for Tender Deadline #}
{% if tender.deadline %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Event",
    "name": "{{ tender.title|e }} - Submission Deadline",
    "startDate": "{{ tender.deadline.isoformat() }}",
    "description": "Submission deadline for {{ tender.title|e }}",
    "url": "{{ request.url.scheme }}://{{ request.url.netloc }}{{ request.url.path }}",
    {% if tender.authority %}
    "organizer": {
        "@type": "Organization",
        "name": "{{ tender.authority|e }}"
    },
    {% endif %}
    {% if tender.state %}
    "location": {
        "@type": "Place",
        "name": "{{ tender.state|e }}"
    }
    {% endif %}
}
</script>
{% endif %}

{# Organization Schema for Tender Authority #}
{% if tender.authority %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "{{ tender.authority|e }}",
    {% if tender.state %}
    "address": {
        "@type": "PostalAddress",
        "addressRegion": "{{ tender.state|e }}"
    }
    {% endif %}
}
</script>
{% endif %}
{% endif %}

{% endblock %}
