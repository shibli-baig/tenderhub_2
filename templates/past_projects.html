{% extends "base.html" %}

{% block title %}My Projects - BidSuite{% endblock %}

{% block content %}

<!-- Test Mode Banner -->
{% if is_test_mode %}
<div style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    text-align: center;
    z-index: 9999;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    border-bottom: 2px solid rgba(255,255,255,0.2);
">
    üß™ TEST MODE ACTIVE - Navigation Restricted to This Page Only
</div>
<div style="margin-top: 48px;"></div>
{% endif %}

<!-- Vault Tab Navigation -->
<div class="vault-tabs">
    <button type="button"
            class="vault-tab vault-tab--active"
            id="projectVaultTab"
            onclick="switchVaultTab('project')"
            data-tab="project"
            role="tab"
            aria-selected="true"
            aria-controls="projectVaultContent">
        <span class="vault-tab__icon">üìä</span>
        <span class="vault-tab__label">Project Intelligence Vault</span>
    </button>
    <button type="button"
            class="vault-tab"
            id="certVaultTab"
            onclick="switchVaultTab('cert')"
            data-tab="cert"
            role="tab"
            aria-selected="false"
            aria-controls="certVaultContent">
        <span class="vault-tab__icon">üèÖ</span>
        <span class="vault-tab__label">Certificate Intelligence Vault</span>
    </button>
</div>

<!-- TAB 1: Project Intelligence Vault -->
<div class="vault-tab-content vault-tab-content--active" id="projectVaultContent" role="tabpanel" aria-labelledby="projectVaultTab">

<section class="section">
    <div class="section-header">
        <div>
            <span class="chip chip--neutral">Project portfolio</span>
            <h1 class="section-title">Project intelligence vault</h1>
            <p class="section-subtitle">Curate your execution history to unlock higher quality tender recommendations and credential packs.</p>
        </div>
        <div class="panel-actions upload-actions">
            <a href="/projects/upload/template" class="icon-btn icon-btn--outline" data-tooltip="Download sample template">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
            </a>
            <button type="button" class="icon-btn icon-btn--danger" onclick="openDeleteAllModal()" data-tooltip="Delete all projects">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            </button>
            <form id="uploadProjectsForm" method="post" action="/projects/upload" enctype="multipart/form-data" class="upload-actions__form">
                <input type="file" id="uploadExcelInput" name="excel_file" accept=".xlsx" class="sr-only" onchange="handleExcelFileSelected(event)">
                <button type="button" class="icon-btn icon-btn--primary" onclick="openUploadModal()" data-tooltip="Upload projects">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </button>
            </form>
            <a href="/add_project" class="icon-btn icon-btn--primary" data-tooltip="Add project">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            </a>
        </div>
    </div>
</section>

<!-- Upload Modal -->
<div id="uploadModal" class="upload-modal" style="display: none;">
    <div class="upload-modal-overlay" onclick="closeUploadModal()"></div>
    <div class="upload-modal-content">
        <div class="upload-modal-header">
            <h2>Upload Projects</h2>
            <button type="button" class="upload-modal-close" onclick="closeUploadModal()">&times;</button>
        </div>
        <div class="upload-modal-body">
            <p class="upload-modal-instructions">
                Please select an Excel file containing project details. You can add certificates later using the edit functionality.
            </p>

            <div class="upload-file-selector">
                <div class="upload-file-item">
                    <label class="upload-file-label">
                        <span class="upload-file-icon">üìä</span>
                        <span class="upload-file-text">Excel File (.xlsx)</span>
                        <button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('uploadExcelInput').click()">
                            Choose File
                        </button>
                    </label>
                    <div id="excelFileName" class="upload-file-name">No file selected</div>
                </div>
            </div>

            <div id="uploadError" class="upload-error" style="display: none;"></div>
        </div>
        <div class="upload-modal-footer">
            <button type="button" class="btn btn-outline" onclick="closeUploadModal()">Cancel</button>
            <button type="button" class="btn btn-outline" onclick="clearFileSelections()">Clear Selection</button>
            <button type="button" class="btn btn-primary" onclick="submitProjectUpload()" id="uploadSubmitBtn" disabled>Upload Projects</button>
        </div>
    </div>
</div>

<!-- Delete All Projects Modal -->
<div id="deleteAllModal" class="upload-modal" style="display: none;">
    <div class="upload-modal-overlay" onclick="closeDeleteAllModal()"></div>
    <div class="upload-modal-content">
        <div class="upload-modal-header">
            <h2>‚ö†Ô∏è Delete All Projects</h2>
            <button type="button" class="upload-modal-close" onclick="closeDeleteAllModal()">&times;</button>
        </div>
        <div class="upload-modal-body">
            <div class="delete-warning-box">
                <p class="delete-warning-title">üö® Warning: This action cannot be undone!</p>
                <p class="delete-warning-text">
                    You are about to permanently delete <strong>ALL</strong> your past projects from the system.
                    This will remove all project data, including:
                </p>
                <ul class="delete-warning-list">
                    <li>Project details and descriptions</li>
                    <li>Client information and financials</li>
                    <li>Project documents and attachments</li>
                    <li>Services and certificates</li>
                    <li>Location and timeline data</li>
                </ul>
                <p class="delete-warning-text">
                    This is useful when you want to start fresh and upload a new set of projects.
                </p>
            </div>

            <div class="delete-confirmation-section">
                <label for="deleteConfirmationInput" class="delete-confirmation-label">
                    To confirm deletion, type <strong class="delete-keyword">DELETE</strong> (all caps) below:
                </label>
                <input
                    type="text"
                    id="deleteConfirmationInput"
                    class="delete-confirmation-input"
                    placeholder="Type DELETE here"
                    oninput="validateDeleteConfirmation()"
                    autocomplete="off"
                />
                <div id="deleteConfirmationError" class="delete-confirmation-error" style="display: none;">
                    Please type DELETE exactly as shown (all capital letters)
                </div>
            </div>

            <div id="deleteError" class="upload-error" style="display: none;"></div>
        </div>
        <div class="upload-modal-footer">
            <button type="button" class="btn btn-outline" onclick="closeDeleteAllModal()">Cancel</button>
            <button
                type="button"
                class="btn btn-danger"
                onclick="confirmDeleteAllProjects()"
                id="deleteAllSubmitBtn"
                disabled
            >
                <span id="deleteAllBtnText">Delete All Projects</span>
                <span id="deleteAllBtnSpinner" style="display: none;">
                    <span class="spinner"></span> Deleting...
                </span>
            </button>
        </div>
    </div>
</div>

{% set upload_status = request.query_params.get('upload_status') %}
{% if upload_status %}
<section class="section section--surface">
    <div class="panel panel--compact upload-feedback {{ 'upload-feedback--success' if upload_status == 'success' else 'upload-feedback--error' }}">
        <p class="upload-feedback__title">
            {% if upload_status == 'success' %}
                Projects uploaded successfully.
            {% else %}
                There was a problem processing your upload.
            {% endif %}
        </p>
        <p class="upload-feedback__summary">
            {% set imported = request.query_params.get('imported', '0') %}
            {% set updated = request.query_params.get('updated', '0') %}
            {% set skipped = request.query_params.get('skipped', '0') %}
            {% set corrected = request.query_params.get('corrected', '0') %}
            {% set failed = request.query_params.get('failed', '0') %}
            {% set files_processed = request.query_params.get('files_processed', '0') %}
            {% set files_unmatched = request.query_params.get('files_unmatched', '0') %}
            Imported {{ imported }} project{{ 's' if imported|int != 1 else '' }}.
            {% if updated|int > 0 %}Updated {{ updated }} existing project{{ 's' if updated|int != 1 else '' }}.{% endif %}
            {% if corrected|int > 0 %}Auto-corrected {{ corrected }} row{{ 's' if corrected|int != 1 else '' }} (dates flipped).{% endif %}
            Skipped {{ skipped }} duplicate{{ 's' if skipped|int != 1 else '' }}.
            {% if failed|int > 0 %}
                Failed {{ failed }} row{{ 's' if failed|int != 1 else '' }}. {% if request.query_params.get('upload_message') %}{{ request.query_params.get('upload_message') }}{% endif %}
            {% endif %}
            {% if request.query_params.get('warning_message') %}
                <br><small style="color: #f59e0b;">‚ö†Ô∏è {{ request.query_params.get('warning_message') }}</small>
            {% endif %}
        </p>
    </div>
</section>
{% endif %}

<!-- Analytics Toggle -->
<section class="section">
    <div class="analytics-toggle-container">
        <label class="analytics-toggle-label">Sector Analytics:</label>
        <div class="analytics-toggle">
            <button type="button" class="analytics-toggle-btn analytics-toggle-btn--active" data-mode="value" onclick="switchAnalyticsMode('value')">
                <span class="analytics-toggle-icon">üí∞</span>
                <span>Value</span>
            </button>
            <button type="button" class="analytics-toggle-btn" data-mode="fee" onclick="switchAnalyticsMode('fee')">
                <span class="analytics-toggle-icon">üíµ</span>
                <span>Fee</span>
            </button>
        </div>
    </div>
</section>

<!-- Project Overview Cards -->
<section class="section">
    <div class="project-cards-grid">
        <!-- Total Projects Card -->
        <div class="project-overview-card project-overview-card--primary" id="allProjectsCard" style="cursor: pointer;">
            <div class="project-overview-card__header">
                <h3>Total Projects</h3>
                <div class="project-overview-card__icon">üìä</div>
            </div>
            <div class="project-overview-card__number">{{ total_project_count }}</div>
            <p class="project-overview-card__subtitle">Click to view all projects</p>
        </div>

        <!-- Industry Sector Cards -->
        {% for sector in user_industry_sectors %}
        <div class="project-overview-card project-overview-card--sector" data-sector="{{ sector }}" style="cursor: pointer;">
            <div class="project-overview-card__header">
                <h3>{{ sector }}</h3>
                <div class="project-overview-card__icon">üè¢</div>
            </div>
            <div class="project-overview-card__number" id="sector-count-{{ loop.index }}">
                <span class="loading">...</span>
            </div>

            <!-- Sector Analytics -->
            {% if (sector in sector_analytics and sector_analytics[sector]['count'] > 0) or (sector in sector_fee_analytics and sector_fee_analytics[sector]['count'] > 0) %}
            <div class="sector-analytics">
                <div class="analytics-row">
                    <div class="analytics-item analytics-item--total">
                        <div class="analytics-label">
                            <span class="analytics-icon analytics-icon-total">üí∞</span>
                            <span class="analytics-label-text">Total Value</span>
                        </div>
                        <div class="analytics-value analytics-value-data"
                             data-value-total="{{ "{:.1f}".format(sector_analytics[sector]['total_value'] / 10000000) if sector in sector_analytics else '0.0' }}"
                             data-fee-total="{{ "{:.1f}".format(sector_fee_analytics[sector]['total_fee'] / 10000000) if sector in sector_fee_analytics else '0.0' }}">
                            ‚Çπ {{ "{:.1f}".format(sector_analytics[sector]['total_value'] / 10000000) if sector in sector_analytics else '0.0' }} Cr
                        </div>
                    </div>
                    <div class="analytics-item analytics-item--avg">
                        <div class="analytics-label">
                            <span class="analytics-icon analytics-icon-avg">üìä</span>
                            <span class="analytics-label-text">Avg Value</span>
                        </div>
                        <div class="analytics-value analytics-value-data"
                             data-value-avg="{{ "{:.1f}".format(sector_analytics[sector]['average_value'] / 10000000) if sector in sector_analytics else '0.0' }}"
                             data-fee-avg="{{ "{:.1f}".format(sector_fee_analytics[sector]['average_fee'] / 10000000) if sector in sector_fee_analytics else '0.0' }}">
                            ‚Çπ {{ "{:.1f}".format(sector_analytics[sector]['average_value'] / 10000000) if sector in sector_analytics else '0.0' }} Cr
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <p class="project-overview-card__subtitle">Click to filter projects</p>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Advanced Search Section -->
<section class="section">
    <div class="panel" style="background: rgba(99, 102, 241, 0.03); border: 1px solid rgba(99, 102, 241, 0.1); border-radius: 12px; padding: 2rem; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.08);">
        <div class="panel-header">
            <div>
                <h2>Project Search</h2>
                <p class="panel-subtitle">Use comprehensive filters to find specific projects in your portfolio</p>
            </div>
        </div>

        <form method="get" action="{% if is_test_mode %}{{ test_base_url }}{% else %}/projects{% endif %}" class="advanced-search-form">
            {% if is_test_mode %}
            <input type="hidden" name="test_token" value="{{ test_token }}">
            {% endif %}
            <div class="form-grid">
                <!-- Row 1 -->
                <div class="form-group">
                    <label for="project_search" class="form-label">General Search</label>
                    <input type="text" id="project_search" name="search" value="{{ search }}"
                           placeholder="Project name, description, or client">
                </div>

                <div class="form-group">
                    <label for="project_name" class="form-label">Project Name</label>
                    <input type="text" id="project_name" name="project_name" value="{{ project_name }}"
                           placeholder="Specific project name">
                </div>

                <div class="form-group">
                    <label for="client" class="form-label">Client</label>
                    <select id="client" name="client">
                        <option value="">All clients</option>
                        {% for client_option in clients %}
                        <option value="{{ client_option }}" {% if client == client_option %}selected{% endif %}>{{ client_option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="sector_filter" class="form-label">Sector</label>
                    <select id="sector_filter" name="sector_filter">
                        <option value="">All sectors</option>
                        {% for sector_option in sectors %}
                        <option value="{{ sector_option }}" {% if sector_filter == sector_option %}selected{% endif %}>{{ sector_option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Row 2 -->
                <div class="form-group">
                    <label for="sub_sector" class="form-label">Sub Sector</label>
                    <select id="sub_sector" name="sub_sector">
                        <option value="">All sub sectors</option>
                        {% for sub_sector_option in sub_sectors %}
                        <option value="{{ sub_sector_option }}" {% if sub_sector == sub_sector_option %}selected{% endif %}>{{ sub_sector_option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="start_date" class="form-label">Start Date From</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date }}">
                </div>

                <div class="form-group">
                    <label for="end_date" class="form-label">End Date Until</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date }}">
                </div>

                <div class="form-group">
                    <label for="project_state" class="form-label">State</label>
                    <select id="project_state" name="state">
                        <option value="">All states</option>
                        {% for state_option in states %}
                        <option value="{{ state_option }}" {% if state == state_option %}selected{% endif %}>{{ state_option }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="panel-actions">
                <button type="submit" class="btn btn-primary">Search Projects</button>
                {% if search_performed %}
                    <a href="/projects" class="btn btn-outline">Clear All Filters</a>
                {% endif %}
            </div>
        </form>
    </div>
</section>

<!-- Projects Results Section -->
{% if search_performed %}
    {% if projects %}
    <section class="section section--surface">
        <div class="section-header">
            <div>
                <h2 class="section-title">Search Results ({{ total_projects }})</h2>
                <p class="section-subtitle">Projects matching your search criteria</p>
            </div>
        </div>

        <div class="project-cards-list">
            {% for project in projects %}
                <article class="project-card-new" data-project-id="{{ project.id }}" onclick="navigateToProject({{ project.id }})">
                    <!-- Header: Title + Client/Location + Status -->
                    <div class="project-card-new__header">
                        <div class="project-card-new__title-block">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <h2 class="project-card-new__title" style="margin: 0;">{{ project.project_name }}</h2>
                                {% if project.project_id %}
                                <span class="project-id-badge" style="
                                    display: inline-block;
                                    padding: 0.25rem 0.625rem;
                                    background: rgba(59, 130, 246, 0.1);
                                    color: #3b82f6;
                                    border: 1px solid rgba(59, 130, 246, 0.2);
                                    border-radius: 12px;
                                    font-size: 0.75rem;
                                    font-weight: 600;
                                    font-family: 'Courier New', monospace;
                                    letter-spacing: 0.5px;
                                ">{{ project.project_id }}</span>
                                {% endif %}
                            </div>
                            <p class="project-card-new__subtitle">
                                {% if project.client_name %}{{ project.client_name }}{% else %}Client not specified{% endif %}
                                {% if project.country and project.country != 'Unknown' %}
                                    ¬∑ {{ project.country }}
                                {% elif project.state and project.state != 'Unknown' %}
                                    ¬∑ {{ project.state }}
                                {% endif %}
                            </p>
                        </div>
                        <div class="project-card-new__header-right">
                            {% if project.is_auto_generated and project.completion_status == "incomplete" %}
                                <span class="project-card-new__status project-card-new__status--warning">INCOMPLETE</span>
                            {% elif project.end_date %}
                                <span class="project-card-new__status project-card-new__status--complete">COMPLETE</span>
                            {% elif project.start_date %}
                                <span class="project-card-new__status project-card-new__status--ongoing">ONGOING</span>
                            {% else %}
                                <span class="project-card-new__status">PLANNED</span>
                            {% endif %}
                            <!-- Last Edited Tag -->
                            {% set last_modified = project.updated_at if (project.updated_at and project.updated_at != project.created_at) else project.created_at %}
                            <div class="project-card-new__last-edited">
                                <span class="last-edited-label">Last edited:</span>
                                <span class="last-edited-date">{{ last_modified.strftime('%b %d, %Y') if last_modified else 'N/A' }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="project-card-new__divider"></div>

                    <!-- Info Grid: Pills with key data -->
                    <div class="project-card-new__grid">
                        <div class="project-pill">
                            <span class="project-pill__label">Start Date</span>
                            <strong class="project-pill__value">
                                {{ project.start_date.strftime('%b %d, %Y') if project.start_date else 'Not set' }}
                            </strong>
                        </div>
                        <div class="project-pill">
                            <span class="project-pill__label">End Date</span>
                            <strong class="project-pill__value">
                                {% if project.end_date %}
                                    {{ project.end_date.strftime('%b %d, %Y') }}
                                {% elif project.start_date %}
                                    Ongoing
                                {% else %}
                                    Not set
                                {% endif %}
                            </strong>
                        </div>
                        <div class="project-pill">
                            <span class="project-pill__label">Consultancy Fee</span>
                            <strong class="project-pill__value">
                                {% if project.consultancy_fee %}
                                    ‚Çπ{{ "{:,.0f}".format(project.consultancy_fee) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </strong>
                        </div>
                        <div class="project-pill">
                            <span class="project-pill__label">Sector</span>
                            <strong class="project-pill__value">{{ project.sector or 'N/A' }}</strong>
                        </div>
                    </div>

                    <!-- Footer: Chips + Actions -->
                    <div class="project-card-new__footer">
                        <div class="project-card-new__chips">
                            {% if project.sub_sector %}
                                <span class="project-chip">üè¢ {{ project.sub_sector }}</span>
                            {% endif %}

                            {% set financing_label = (project.financing_authority or '') %}
                            {% if financing_label and financing_label != 'Financing Not Required' and financing_label != '' %}
                                <span class="project-chip">üí∞ {{ financing_label }}</span>
                            {% endif %}

                            {% if project.state and project.state != 'Unknown' %}
                                <span class="project-chip">üìç {{ project.state }}</span>
                            {% endif %}
                        </div>
                        <div class="project-card-new__actions">
                            {% if not is_test_mode %}
                            <button type="button" class="project-btn project-btn--secondary" onclick="event.stopPropagation(); window.location.href='/edit_project/{{ project.id }}'">
                                ‚úèÔ∏è Edit
                            </button>
                            {% endif %}
                            <button type="button" class="project-btn project-btn--secondary" onclick="event.stopPropagation(); downloadProjectPDF({{ project.id }})">
                                üìÑ Download PDF
                            </button>
                            <button type="button" class="project-btn project-btn--primary" onclick="event.stopPropagation(); navigateToProject({{ project.id }})">
                                View Details ‚Üí
                            </button>
                        </div>
                    </div>
                </article>
            {% endfor %}
        </div>

        {% if total_pages > 1 %}
        <div class="panel panel--compact mb-0">
            <nav class="pagination-nav" aria-label="Project pagination">
                {% if has_prev %}
                    <a class="pagination-link" href="{% if is_test_mode %}{{ test_base_url }}?test_token={{ test_token }}&page={{ page - 1 }}{% for key, value in request.query_params.items() %}{% if key != 'page' and key != 'test_token' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% else %}/projects?page={{ page - 1 }}{% for key, value in request.query_params.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endif %}">¬´ Previous</a>
                {% else %}
                    <span class="pagination-link is-disabled">¬´ Previous</span>
                {% endif %}

                <span class="badge badge--muted">Page {{ page }} of {{ total_pages }}</span>

                {% if has_next %}
                    <a class="pagination-link" href="{% if is_test_mode %}{{ test_base_url }}?test_token={{ test_token }}&page={{ page + 1 }}{% for key, value in request.query_params.items() %}{% if key != 'page' and key != 'test_token' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% else %}/projects?page={{ page + 1 }}{% for key, value in request.query_params.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endif %}">Next ¬ª</a>
                {% else %}
                    <span class="pagination-link is-disabled">Next ¬ª</span>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </section>
    {% else %}
    <section class="section section--surface">
        <div class="empty-state">
            <h3>No matching projects found</h3>
            <p>Try adjusting your search criteria or clearing filters to view all projects.</p>
            <div class="d-flex justify-between gap-3" style="justify-content: center;">
                <a href="/projects" class="btn btn-outline">Clear filters</a>
                <a href="/add_project" class="btn btn-primary">Add project</a>
            </div>
        </div>
    </section>
    {% endif %}
{% else %}
<section class="section section--surface">
    <div class="empty-state">
        <h3>Use search above to find projects</h3>
        <p>Enter search criteria in the form above to display projects from your portfolio.</p>
    </div>
</section>
{% endif %}

</div>
<!-- END TAB 1: Project Intelligence Vault -->

<!-- TAB 2: Certificate Intelligence Vault -->
<div class="vault-tab-content" id="certVaultContent" role="tabpanel" aria-labelledby="certVaultTab" style="display: none;">
    <div class="cert-vault-wrapper">
        <!-- Hero Section -->
        <div class="cert-vault-hero">
            <h2 class="cert-vault-title">üîç Certificate Intelligence Vault</h2>
            <p class="cert-vault-subtitle">Search, match, and extract certificate data with advanced AI-powered tools</p>
        </div>

        <!-- Sub-Navigation for Certificate Modes -->
        <div class="cert-mode-nav">
            <button type="button"
                    class="cert-mode-btn cert-mode-btn--active"
                    id="searchModeBtn"
                    onclick="switchCertMode('search')"
                    data-mode="search">
                <span class="cert-mode-icon">üîç</span>
                <span class="cert-mode-label">Keyword Search</span>
            </button>
            <button type="button"
                    class="cert-mode-btn"
                    id="manualClauseModeBtn"
                    onclick="switchCertMode('manual-clause')"
                    data-mode="manual-clause">
                <span class="cert-mode-icon">üìù</span>
                <span class="cert-mode-label">Manual Clause</span>
            </button>
        </div>

        <!-- MODE 1: Search Section -->
        <div class="cert-mode-content" id="certSearchSection">
        <!-- Search Box -->
        <div class="cert-search-wrapper">
            <div class="cert-search-box">
                <input
                    type="text"
                    id="certSearchInput"
                    class="cert-search-input"
                    placeholder="Type to search certificates..."
                    autocomplete="off"
                />
                <button type="button" id="certSearchButton" class="cert-search-button">
                    Search
                </button>
                <button type="button" id="certShowAllButton" class="cert-search-button cert-search-button--show-all">
                    Show All
                </button>
            </div>
        </div>

        <!-- Filters Panel (Collapsible) -->
        <div id="certFiltersPanel" class="cert-filters-panel" style="display: none;">
            <div class="cert-filters-header">
                <h3>üéØ Refine Results</h3>
                <div class="cert-filters-actions">
                    <button type="button" id="certClearFiltersBtn" class="cert-filter-action-btn cert-clear-btn">
                        Clear All
                    </button>
                    <button type="button" id="certApplyFiltersBtn" class="cert-filter-action-btn cert-apply-btn">
                        Apply Filters
                    </button>
                    <button type="button" id="certToggleFiltersBtn" class="cert-filter-toggle-btn">
                        <span id="certToggleIcon">‚ñº</span>
                    </button>
                </div>
            </div>

            <div id="certFiltersContent" class="cert-filters-content">
                <div class="cert-filters-grid">
                    <!-- Client Names Filter -->
                    <div class="cert-filter-group">
                        <label class="cert-filter-label">Client Names</label>
                        <select id="certFilterClients" class="cert-filter-select" multiple>
                            <!-- Options populated dynamically -->
                        </select>
                    </div>

                    <!-- Locations Filter -->
                    <div class="cert-filter-group">
                        <label class="cert-filter-label">Locations</label>
                        <select id="certFilterLocations" class="cert-filter-select" multiple>
                            <!-- Options populated dynamically -->
                        </select>
                    </div>

                    <!-- Services Filter -->
                    <div class="cert-filter-group">
                        <label class="cert-filter-label">Services Rendered</label>
                        <select id="certFilterServices" class="cert-filter-select" multiple>
                            <!-- Options populated dynamically -->
                        </select>
                    </div>

                    <!-- Sectors Filter -->
                    <div class="cert-filter-group">
                        <label class="cert-filter-label">Sectors</label>
                        <select id="certFilterSectors" class="cert-filter-select" multiple>
                            <!-- Options populated dynamically -->
                        </select>
                    </div>

                    <!-- Sub-Sectors Filter -->
                    <div class="cert-filter-group">
                        <label class="cert-filter-label">Sub-Sectors</label>
                        <select id="certFilterSubSectors" class="cert-filter-select" multiple>
                            <!-- Options populated dynamically -->
                        </select>
                    </div>

                    <!-- Funding Agencies Filter -->
                    <div class="cert-filter-group">
                        <label class="cert-filter-label">Funding Agencies</label>
                        <select id="certFilterFundingAgencies" class="cert-filter-select" multiple>
                            <!-- Options populated dynamically -->
                        </select>
                    </div>

                    <!-- Consultancy Fee Range -->
                    <div class="cert-filter-group cert-range-group">
                        <label class="cert-filter-label">Consultancy Fee Range</label>
                        <div id="certFeeRangeSlider" class="cert-range-slider"></div>
                        <div class="cert-range-values">
                            <span id="certFeeRangeMin">‚Çπ0</span>
                            <span id="certFeeRangeMax">‚Çπ0</span>
                        </div>
                    </div>

                    <!-- Project Value Range -->
                    <div class="cert-filter-group cert-range-group">
                        <label class="cert-filter-label">Project Value Range</label>
                        <div id="certProjectValueSlider" class="cert-range-slider"></div>
                        <div class="cert-range-values">
                            <span id="certProjectValueMin">‚Çπ0</span>
                            <span id="certProjectValueMax">‚Çπ0</span>
                        </div>
                    </div>

                    <!-- Completion Start Date -->
                    <div class="cert-filter-group">
                        <label class="cert-filter-label">üìÖ Completion Start Date</label>
                        <input type="text" id="certCompletionStartDate" class="cert-date-range-input" placeholder="Select start date..." readonly>
                    </div>

                    <!-- Completion End Date -->
                    <div class="cert-filter-group">
                        <label class="cert-filter-label">üìÖ Completion End Date</label>
                        <input type="text" id="certCompletionEndDate" class="cert-date-range-input" placeholder="Select end date..." readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Stats -->
        <div id="certSearchStats" class="cert-search-stats" style="display: none;">
            <p>Found <strong id="certResultCount">0</strong> certificate(s)</p>
        </div>

        <!-- Loading Spinner -->
        <div id="certLoadingSpinner" class="cert-loading" style="display: none;">
            <div class="cert-spinner"></div>
            <div class="cert-loading-text">Searching certificates...</div>
        </div>

        <!-- No Results -->
        <div id="certNoResults" class="cert-no-results" style="display: none;">
            <div class="cert-no-results-icon">üìã</div>
            <h3>No certificates found</h3>
            <p>Try different keywords or check if you have uploaded any certificates yet.</p>
        </div>

        <!-- Results Grid -->
        <div id="certResultsGrid" class="cert-cards-grid"></div>
        
        <!-- Pagination Controls -->
        <div id="certPaginationContainer" class="cert-pagination-container" style="display: none;">
            <div class="cert-pagination-info">
                <span id="certPaginationInfo">Showing 1-30 of 0 certificates</span>
            </div>
            <div class="cert-pagination-controls">
                <button id="certFirstPageBtn" class="cert-pagination-btn" onclick="certGoToPage(1)" disabled>
                    ¬´ First
                </button>
                <button id="certPrevPageBtn" class="cert-pagination-btn" onclick="certGoToPage(certCurrentPage - 1)" disabled>
                    ‚Äπ Prev
                </button>
                <div class="cert-pagination-pages" id="certPaginationPages">
                    <!-- Page numbers will be inserted here -->
                </div>
                <button id="certNextPageBtn" class="cert-pagination-btn" onclick="certGoToPage(certCurrentPage + 1)" disabled>
                    Next ‚Ä∫
                </button>
                <button id="certLastPageBtn" class="cert-pagination-btn" onclick="certGoToPage(certTotalPages)" disabled>
                    Last ¬ª
                </button>
            </div>
        </div>
        </div>
        <!-- END MODE 1: Search Section -->

        <!-- MODE 2: Manual Clause Section -->
        <div class="cert-mode-content" id="certManualClauseSection" style="display: none;">
            <!-- Hero Section -->
            <div class="manual-clause-hero">
                <h3 class="manual-clause-title">üìù Manual Clause Certificate Matching</h3>
                <p class="manual-clause-subtitle">Apply multiple criteria to find certificates that match your tender requirements with cascading compliance levels</p>
            </div>

            <!-- Preset Management Bar -->
            <div class="preset-bar" style="display: none;">
                <select id="savedPresetsDropdown" class="preset-dropdown">
                    <option value="">üîñ Load Saved Preset...</option>
                </select>
                <button type="button" id="clearAllFiltersBtn" class="btn btn-secondary btn-sm">Clear All Filters</button>
                <button type="button" id="savePresetBtn" class="btn btn-outline btn-sm" style="display: none;">üíæ Save Preset</button>
            </div>

            <!-- Filters Panel (Collapsible) -->
            <div class="manual-filters-panel">
                <div class="manual-filters-header">
                    <h3>üéØ Filter Criteria</h3>
                    <button type="button" id="toggleManualFiltersBtn" class="filter-toggle-btn">
                        <span id="manualToggleIcon">‚ñº</span>
                    </button>
                </div>

                <div id="manualFiltersContent" class="manual-filters-content">
                    <!-- AI-Powered Filter Section -->
                    <div class="ai-filter-section">
                        <div class="ai-section-header">
                            <h4 class="ai-section-title">ü§ñ AI-Powered Filter Assistant</h4>
                            <p class="ai-section-subtitle">Paste tender clause text or upload images, and AI will intelligently extract and match relevant filters</p>
                        </div>

                        <div class="ai-input-container">
                            <!-- Text Input -->
                            <div class="ai-text-input-wrapper">
                                <label class="ai-input-label">üìù Paste Tender Clause Text</label>
                                <textarea id="aiClauseText" class="ai-text-area" rows="6" placeholder="Paste tender requirements, eligibility criteria, project details, or any clause text...
Example: 'Consultancy services for water supply infrastructure in Delhi NCR region. Minimum 5 years experience required...'"></textarea>
                            </div>

                            <!-- Image Upload -->
                            <div class="ai-image-upload-wrapper">
                                <label class="ai-input-label">üì∑ Upload Tender Document Images (Optional)</label>
                                <input type="file" id="aiClauseImages" multiple accept="image/*" style="display: none;">
                                <button type="button" id="aiUploadBtn" class="btn-upload-icon">
                                    <div class="upload-icon-circle">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="17 8 12 3 7 8"></polyline>
                                            <line x1="12" y1="3" x2="12" y2="15"></line>
                                        </svg>
                                    </div>
                                    <div class="upload-icon-text">Choose Images</div>
                                    <div class="upload-icon-subtext">Up to 5 images</div>
                                </button>
                                <div id="aiImagePreview" class="image-preview-grid"></div>
                            </div>
                        </div>

                        <div class="ai-actions">
                            <button type="button" id="aiExtractBtn" class="btn btn-ai-primary">
                                ‚ú® Extract Keywords & Search
                            </button>
                            <div id="aiProcessingStatus" class="ai-status" style="display: none;">
                                <div class="spinner"></div>
                                <span id="aiProcessingText">Analyzing with AI...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Keyword Display Section -->
                    <div id="keywordDisplaySection" class="keyword-display-section" style="display: none;">
                        <div class="keyword-header-row">
                            <h4 class="keyword-section-title">üìã Extracted Keywords</h4>
                            <button type="button" id="addKeywordBtn" class="btn btn-sm btn-outline" onclick="showAddKeywordInput()">
                                + Add Keyword
                            </button>
                        </div>
                        <div id="keywordChipsContainer" class="keyword-chips-container"></div>
                        <div id="addKeywordInputContainer" class="add-keyword-container" style="display: none;">
                            <input type="text" id="newKeywordInput" class="new-keyword-input" placeholder="Enter new keyword..." onkeydown="handleNewKeywordKeydown(event)">
                            <button type="button" class="btn btn-sm btn-primary" onclick="addNewKeyword()">Add</button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="hideAddKeywordInput()">Cancel</button>
                        </div>
                        <div id="updateResultsContainer" class="update-results-container" style="display: none;">
                            <button type="button" id="updateResultsBtn" class="btn btn-primary" onclick="updateResultsWithModifiedKeywords()">
                                üîÑ Update Results
                            </button>
                            <span class="update-hint">Keywords have been modified. Click to update search results.</span>
                        </div>
                        
                        <div id="keywordExpansionSection" class="keyword-expansion-section" style="display: none;">
                            <h4 class="keyword-section-title">üîç Expanded Variants</h4>
                            <div id="keywordExpansionContainer" class="keyword-expansion-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="manualResultsSection" class="manual-results-section" style="display: none;">
                <!-- Results Summary -->
                <div class="manual-results-summary">
                    <p class="results-text">
                        Found <strong id="manualResultCount">0</strong> certificates |
                        Keywords Searched: <strong id="keywordCount">0</strong>
                    </p>
                    
                    <!-- Keyword Filter Buttons -->
                    <div id="keywordFilterButtons" class="keyword-filter-buttons" style="display: none;">
                        <button type="button" class="keyword-filter-btn keyword-filter-btn--active" data-keyword="combined" onclick="filterResultsByKeyword('combined')">
                            Combined
                        </button>
                    </div>
                </div>

                <!-- Results Grid -->
                <div id="manualResultsGrid" class="manual-results-grid"></div>

                <!-- Load More (Future Enhancement) -->
                <div id="manualLoadMore" class="manual-load-more" style="display: none;">
                    <button type="button" id="manualLoadMoreBtn" class="btn btn-outline">
                        Load More...
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="manualLoadingSpinner" class="manual-loading" style="display: none;">
                <div class="manual-spinner"></div>
                <div class="manual-loading-text">Searching certificates...</div>
            </div>

            <!-- No Results State -->
            <div id="manualNoResults" class="manual-no-results" style="display: none;">
                <div class="manual-no-results-icon">üìã</div>
                <h3>No certificates found</h3>
                <p>No certificates match your filter criteria. Try adjusting your filters.</p>
            </div>

            <!-- AI Filter Preview Modal -->
            <div id="aiFilterPreviewModal" class="ai-preview-modal" style="display: none;">
                <div class="ai-preview-overlay" onclick="closeAIPreview()"></div>
                <div class="ai-preview-content">
                    <div class="ai-preview-header">
                        <h4 class="ai-preview-title">üéØ AI-Extracted Tender Requirements</h4>
                        <p class="ai-preview-subtitle">Review and edit the conditions extracted from your tender document. Click chips to edit or remove.</p>
                        <button type="button" class="ai-close-btn" onclick="closeAIPreview()">‚úï</button>
                    </div>

                    <div id="aiFilterPreviewGrid" class="preview-filter-grid">
                        <!-- Dynamic filter chips will be rendered here by JavaScript -->
                    </div>

                    <div class="ai-preview-actions">
                        <button type="button" id="aiApplyFiltersBtn" class="btn btn-ai-success">
                            ‚úì Apply These Filters
                        </button>
                        <button type="button" id="aiCancelFiltersBtn" class="btn btn-secondary" onclick="closeAIPreview()">
                            ‚úó Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- END MODE 3: Manual Clause Section -->

    </div>
</div>
<!-- END TAB 2: Certificate Intelligence Vault -->

{% endblock %}

{% block extra_scripts %}
<!-- External Libraries for Certificate Search -->
<!-- Choices.js for multi-select dropdowns -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/scripts/choices.min.js"></script>

<!-- noUiSlider for range sliders -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

<!-- Flatpickr for date range picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

<style>
/* ============ Vault Tab Navigation Styles ============ */

/* Vault Tab Navigation Container */
.vault-tabs {
    display: flex;
    gap: 8px;
    padding: 0 40px;
    background: transparent;
    position: relative;
    z-index: 10;
    margin-top: 32px;
    margin-bottom: 0;
    width: 100%;
}

/* Individual Tab Button */
.vault-tab {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 18px 40px;
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.6) 0%, rgba(241, 245, 249, 0.6) 100%);
    border: none;
    border-radius: 12px 12px 0 0;
    cursor: pointer;
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    font-weight: 600;
    font-size: 16px;
    color: #64748b;
    outline: none;
    flex: 1;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.04);
    backdrop-filter: blur(10px);
}

.vault-tab::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: transparent;
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
}

.vault-tab:hover:not(.vault-tab--active) {
    background: linear-gradient(135deg, rgba(241, 245, 249, 0.9) 0%, rgba(226, 232, 240, 0.9) 100%);
    color: #334155;
    transform: translateY(-3px);
    box-shadow: 0 -4px 16px rgba(99, 102, 241, 0.12);
}

/* Active Tab State */
.vault-tab--active {
    background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
    color: #1e293b;
    z-index: 3;
    box-shadow: 0 -6px 24px rgba(99, 102, 241, 0.15), 0 0 0 1px rgba(99, 102, 241, 0.1);
    transform: translateY(0);
}

.vault-tab--active::before {
    background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
}

/* Tab Icon */
.vault-tab__icon {
    font-size: 22px;
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    filter: grayscale(50%);
}

.vault-tab--active .vault-tab__icon {
    transform: scale(1.1);
    filter: grayscale(0%);
}

.vault-tab:hover .vault-tab__icon {
    filter: grayscale(0%);
}

/* Tab Label */
.vault-tab__label {
    white-space: nowrap;
    letter-spacing: 0.3px;
}

/* Tab Content Containers */
.vault-tab-content {
    background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
    border: none;
    border-radius: 0 12px 12px 12px;
    min-height: 500px;
    display: block;
    padding: 48px 30px;
    margin: 0;
    position: relative;
    box-shadow:
        0 20px 60px rgba(99, 102, 241, 0.08),
        0 8px 24px rgba(0, 0, 0, 0.04),
        0 0 0 1px rgba(99, 102, 241, 0.06);
}

.vault-tab-content--active {
    animation: contentFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes contentFadeIn {
    from {
        opacity: 0;
        transform: translateY(8px) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Certificate Vault Wrapper - Namespace container */
.cert-vault-wrapper {
    padding: 0;
}

.cert-vault-hero {
    text-align: center;
    margin-bottom: 48px;
    padding: 32px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.03) 0%, rgba(139, 92, 246, 0.03) 100%);
    border-radius: 12px;
}

.cert-vault-title {
    font-size: 2.25rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 16px 0;
    letter-spacing: -0.5px;
}

.cert-vault-subtitle {
    font-size: 1.125rem;
    color: #64748b;
    margin: 0;
    line-height: 1.6;
}

/* Certificate Mode Navigation */
.cert-mode-nav {
    display: flex;
    gap: 16px;
    margin-bottom: 40px;
    padding: 8px;
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.8) 0%, rgba(241, 245, 249, 0.8) 100%);
    border-radius: 12px;
    border: 1px solid rgba(99, 102, 241, 0.08);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.cert-mode-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 16px 24px;
    background: transparent;
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    color: #64748b;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    outline: none;
}

.cert-mode-btn:hover:not(.cert-mode-btn--active) {
    background: rgba(255, 255, 255, 0.6);
    color: #334155;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
}

.cert-mode-btn--active {
    background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
    color: #1e293b;
    border-color: rgba(99, 102, 241, 0.2);
    box-shadow:
        0 4px 16px rgba(99, 102, 241, 0.12),
        0 0 0 1px rgba(99, 102, 241, 0.08);
}

.cert-mode-icon {
    font-size: 20px;
    transition: transform 0.3s ease;
}

.cert-mode-btn--active .cert-mode-icon {
    transform: scale(1.1);
}

.cert-mode-label {
    white-space: nowrap;
    letter-spacing: 0.2px;
}

/* Certificate Mode Content */
.cert-mode-content {
    animation: fadeInContent 0.4s ease;
}

@keyframes fadeInContent {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Demo Content Styling */
.cert-demo-content {
    max-width: 700px;
    margin: 60px auto;
    text-align: center;
    padding: 48px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.02) 0%, rgba(139, 92, 246, 0.02) 100%);
    border-radius: 12px;
    border: 2px dashed rgba(99, 102, 241, 0.2);
}

.cert-demo-icon {
    font-size: 64px;
    margin-bottom: 24px;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0px);
    }
    50% {
        transform: translateY(-10px);
    }
}

.cert-demo-title {
    font-size: 1.875rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 16px 0;
    letter-spacing: -0.3px;
}

.cert-demo-description {
    font-size: 1.0625rem;
    color: #64748b;
    line-height: 1.7;
    margin: 0 0 32px 0;
}

.cert-demo-features {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 32px;
}

.cert-demo-feature {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 1rem;
    color: #475569;
}

.cert-demo-feature-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    border-radius: 50%;
    font-size: 12px;
    font-weight: 700;
}

.cert-demo-note {
    font-size: 0.9375rem;
    color: #94a3b8;
    font-style: italic;
    margin: 0;
    padding-top: 20px;
    border-top: 1px solid rgba(99, 102, 241, 0.1);
}

/* Responsive Design */
@media (max-width: 768px) {
    .vault-tabs {
        flex-direction: column;
        gap: 12px;
        padding: 24px;
        width: 100%;
    }

    .vault-tab {
        border-radius: 12px;
        flex: none;
        width: 100%;
        padding: 16px 24px;
    }

    .vault-tab::before {
        display: none;
    }

    .vault-tab--active {
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.15);
    }

    .vault-tab__label {
        font-size: 15px;
    }

    .vault-tab-content {
        border-radius: 12px;
        padding: 32px 18px;
    }

    .cert-vault-title {
        font-size: 1.75rem;
    }

    .cert-vault-subtitle {
        font-size: 1rem;
    }

    .cert-mode-nav {
        flex-direction: column;
        gap: 8px;
        padding: 6px;
    }

    .cert-mode-btn {
        padding: 14px 20px;
        font-size: 14px;
    }

    .cert-mode-icon {
        font-size: 18px;
    }

    .cert-demo-content {
        padding: 32px 24px;
        margin: 40px auto;
    }

    .cert-demo-icon {
        font-size: 48px;
    }

    .cert-demo-title {
        font-size: 1.5rem;
    }

    .cert-demo-description {
        font-size: 1rem;
    }
}

/* ============ End Vault Tab Navigation Styles ============ */

/* Icon button styles */
.icon-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 46px;
    height: 46px;
    border-radius: 50%;
    border: 1px solid;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    flex-shrink: 0;
}

.icon-btn--outline {
    background: #ffffff;
    border-color: #e2e8f0;
    color: #64748b;
}

.icon-btn--outline:hover {
    background: #f8fafc;
    border-color: #94a3b8;
    color: #334155;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.icon-btn--primary {
    background: #3b82f6;
    border-color: #3b82f6;
    color: #ffffff;
}

.icon-btn--primary:hover {
    background: #2563eb;
    border-color: #2563eb;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.icon-btn svg {
    display: block;
}

/* Custom tooltips */
.icon-btn {
    position: relative;
}

.icon-btn::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 12px);
    left: 50%;
    transform: translateX(-50%) translateY(-4px);
    background: #1e293b;
    color: #ffffff;
    padding: 0.5rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8125rem;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s ease;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.icon-btn::before {
    content: '';
    position: absolute;
    bottom: calc(100% + 4px);
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-top-color: #1e293b;
    opacity: 0;
    pointer-events: none;
    transition: all 0.2s ease;
    z-index: 1000;
}

.icon-btn:hover::after {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

.icon-btn:hover::before {
    opacity: 1;
}

.upload-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}

.upload-actions__form {
    margin: 0;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.upload-feedback {
    border-radius: 12px;
    border-left: 4px solid transparent;
    padding: 1rem 1.25rem;
}

.upload-feedback--success {
    border-color: #16a34a;
    background: #ecfdf5;
    color: #0f5132;
}

.upload-feedback--error {
    border-color: #dc2626;
    background: #fef2f2;
    color: #7f1d1d;
}

.upload-feedback__title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.upload-feedback__summary {
    margin: 0;
    font-size: 0.95rem;
}

/* Project Cards Grid */
.project-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    max-width: 100%;
}

/* Ensure exactly 4 cards per row on larger screens */
@media (min-width: 1200px) {
    .project-cards-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

/* Project Overview Cards */
.project-overview-card {
    background: #ffffff;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.project-overview-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0,0,0,0.15);
    border-color: #3b82f6;
}

.project-overview-card--primary {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    border-color: #3b82f6;
    box-shadow: 0 4px 16px rgba(59,130,246,0.3);
}

.project-overview-card--primary:hover {
    box-shadow: 0 12px 32px rgba(59,130,246,0.4);
    border-color: #1d4ed8;
}

.project-overview-card--sector {
    background: #f8fafc;
    border-color: #cbd5e1;
    color: #334155;
}

.project-overview-card--sector:hover {
    background: #f1f5f9;
    border-color: #3b82f6;
    color: #1e293b;
}

.project-overview-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.project-overview-card__header h3 {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0;
    color: inherit;
}

.project-overview-card__icon {
    font-size: 1.5rem;
    opacity: 0.8;
}

.project-overview-card__number {
    font-size: 2.5rem;
    font-weight: 700;
    color: inherit;
    margin-bottom: 0.5rem;
}

.project-overview-card__subtitle {
    font-size: 0.75rem;
    opacity: 0.8;
    margin: 0;
    color: inherit;
}

/* Analytics Toggle */
.analytics-toggle-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 1rem 0;
    margin-bottom: 0.5rem;
}

.analytics-toggle-label {
    font-size: 0.95rem;
    font-weight: 600;
    color: #64748b;
    margin: 0;
}

.analytics-toggle {
    display: flex;
    gap: 0.5rem;
    padding: 0.25rem;
    background: rgba(248, 250, 252, 0.8);
    border-radius: 12px;
    border: 1px solid rgba(99, 102, 241, 0.15);
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.08);
}

.analytics-toggle-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1.25rem;
    background: transparent;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    color: #64748b;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    outline: none;
}

.analytics-toggle-btn:hover {
    background: rgba(99, 102, 241, 0.08);
    color: #4f46e5;
    transform: translateY(-1px);
}

.analytics-toggle-btn--active {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.analytics-toggle-btn--active:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
}

.analytics-toggle-icon {
    font-size: 1rem;
    display: inline-block;
}

/* Sector Analytics */
.sector-analytics {
    margin: 0.75rem 0;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.analytics-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
}

.analytics-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.5rem;
    background: rgba(99, 102, 241, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(99, 102, 241, 0.1);
    transition: all 0.3s ease;
}

.analytics-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
    border-color: rgba(99, 102, 241, 0.3);
}

.analytics-item--total {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(34, 197, 94, 0.1) 100%);
    border-color: rgba(34, 197, 94, 0.2);
}

.analytics-item--total:hover {
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
}

.analytics-item--avg {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(59, 130, 246, 0.1) 100%);
    border-color: rgba(59, 130, 246, 0.2);
}

.analytics-item--avg:hover {
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.analytics-label {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.7rem;
    font-weight: 600;
    color: rgba(0, 0, 0, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.analytics-icon {
    font-size: 1rem;
}

.analytics-value {
    font-size: 0.95rem;
    font-weight: 700;
    color: #1e293b;
    line-height: 1.2;
    word-break: break-word;
}

/* Project Cards List (Tender-style) */
.project-cards-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.project-card-new {
    background: var(--card-bg, #ffffff);
    border-radius: 12px;
    border: 1px solid var(--card-border, #e5e7eb);
    box-shadow: 0 20px 40px rgba(99, 102, 241, 0.08);
    padding: 1.75rem;
    display: grid;
    gap: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.project-card-new:hover {
    transform: translateY(-4px);
    box-shadow: 0 24px 48px rgba(99, 102, 241, 0.15);
    border-color: rgba(99, 102, 241, 0.3);
}

/* Header Section */
.project-card-new__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
}

.project-card-new__title-block {
    flex: 1;
}

.project-card-new__header-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
}

.project-card-new__title {
    margin: 0;
    font-size: 1.35rem;
    font-weight: 700;
    color: var(--text-primary, #1a1a1a);
    line-height: 1.4;
}

.project-card-new__subtitle {
    margin: 0.3rem 0 0;
    color: var(--text-secondary, #6b7280);
    font-size: 0.95rem;
}

.project-card-new__status {
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    background: rgba(99, 102, 241, 0.12);
    color: var(--primary-color, #6366f1);
    font-weight: 600;
    letter-spacing: 0.08em;
    font-size: 0.85rem;
    white-space: nowrap;
}

.project-card-new__status--complete {
    background: rgba(34, 197, 94, 0.12);
    color: #16a34a;
}

.project-card-new__status--ongoing {
    background: rgba(59, 130, 246, 0.12);
    color: #2563eb;
}

.project-card-new__status--warning {
    background: rgba(234, 179, 8, 0.12);
    color: #ca8a04;
}

/* Last Edited Tag */
.project-card-new__last-edited {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.3rem 0.65rem;
    background: rgba(99, 102, 241, 0.08);
    border: 1px solid rgba(99, 102, 241, 0.15);
    border-radius: 12px;
    font-size: 0.75rem;
    color: var(--text-secondary, #6b7280);
    white-space: nowrap;
    pointer-events: none;
    backdrop-filter: blur(4px);
}

.last-edited-label {
    font-weight: 500;
    color: var(--text-muted, #9ca3af);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.7rem;
}

.last-edited-date {
    font-weight: 600;
    color: var(--text-primary, #4b5563);
}

/* Divider */
.project-card-new__divider {
    border-top: 1px dashed var(--card-border, #e5e7eb);
    margin: 0.5rem 0;
}

/* Info Grid with Pills */
.project-card-new__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
}

.project-pill {
    padding: 0.75rem 1rem;
    background: rgba(99, 102, 241, 0.04);
    border-radius: 12px;
    border: 1px solid rgba(99, 102, 241, 0.1);
    transition: all 0.2s ease;
}

.project-pill:hover {
    background: rgba(99, 102, 241, 0.08);
    border-color: rgba(99, 102, 241, 0.2);
}

.project-pill__label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary, #6b7280);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.25rem;
    font-weight: 600;
}

.project-pill__value {
    display: block;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary, #1a1a1a);
}

/* Summary */
.project-card-new__summary {
    color: var(--text-secondary, #6b7280);
    margin: 0.5rem 0;
    line-height: 1.6;
    font-size: 0.95rem;
}

/* Footer */
/* Project Details Section (Description & Scope) */
.project-details-section {
    margin: 1rem 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.project-detail-box {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.02) 0%, rgba(139, 92, 246, 0.02) 100%);
    border: 1px solid rgba(99, 102, 241, 0.15);
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.3s ease;
}

.project-detail-box:hover {
    border-color: rgba(99, 102, 241, 0.3);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.08);
}

.project-detail-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.project-detail-icon {
    font-size: 1.25rem;
}

.project-detail-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: #4338ca;
    margin: 0;
    letter-spacing: 0.3px;
}

.project-detail-content {
    position: relative;
}

.project-detail-text {
    font-size: 0.9rem;
    line-height: 1.6;
    color: #374151;
    white-space: pre-wrap;
    word-break: break-word;
}

.project-detail-text--preview {
    display: block;
}

.project-detail-text--full {
    display: none;
}

.project-detail-toggle {
    margin-top: 0.5rem;
    background: none;
    border: none;
    color: #6366f1;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    padding: 0.25rem 0;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.project-detail-toggle:hover {
    color: #4338ca;
    transform: translateX(2px);
}

.project-card-new__footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
}

.project-card-new__chips {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    flex: 1;
}

.project-chip {
    border: 1px solid var(--card-border, #e5e7eb);
    border-radius: 12px;
    padding: 0.4rem 0.85rem;
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-secondary, #6b7280);
    background: var(--surface-bg, #f8f9fa);
    transition: all 0.2s ease;
}

.project-chip:hover {
    border-color: var(--primary-color, #6366f1);
    color: var(--primary-color, #6366f1);
}

.project-card-new__actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.project-btn {
    border: none;
    border-radius: 12px;
    padding: 0.6rem 1.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.project-btn--primary {
    background: linear-gradient(135deg, #6366f1, #4338ca);
    color: white;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.project-btn--primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
}

.project-btn--secondary {
    background: white;
    color: var(--primary-color, #6366f1);
    border: 2px solid var(--primary-color, #6366f1);
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
}

.project-btn--secondary:hover {
    background: rgba(99, 102, 241, 0.05);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
}

/* Advanced Search Form */
.advanced-search-form .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

@media (min-width: 1200px) {
    .advanced-search-form .form-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.loading {
    opacity: 0.6;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
}

/* Upload Modal Styles */
.upload-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.upload-modal-content {
    position: relative;
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.upload-modal-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.upload-modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: #1e293b;
}

.upload-modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    color: #64748b;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    transition: all 0.2s;
}

.upload-modal-close:hover {
    background: #f1f5f9;
    color: #1e293b;
}

.upload-modal-body {
    padding: 2rem;
    overflow-y: auto;
    flex: 1;
}

.upload-modal-instructions {
    color: #64748b;
    margin-bottom: 2rem;
    line-height: 1.6;
}

.upload-file-selector {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.upload-file-item {
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.2s;
    background: #f8fafc;
}

.upload-file-item:hover {
    border-color: #3b82f6;
    background: #eff6ff;
}

.upload-file-label {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
    cursor: default;
}

.upload-file-icon {
    font-size: 2rem;
}

.upload-file-text {
    flex: 1;
    font-weight: 600;
    color: #1e293b;
}

.upload-file-name {
    color: #64748b;
    font-size: 0.875rem;
    padding-left: 3rem;
    font-style: italic;
}

.upload-file-name.has-file {
    color: #16a34a;
    font-style: normal;
    font-weight: 500;
}

.upload-error {
    margin-top: 1.5rem;
    padding: 1rem;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 12px;
    color: #991b1b;
    font-size: 0.875rem;
}

.upload-modal-footer {
    padding: 1.5rem 2rem;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
}

/* Delete All Projects Modal Specific Styles */
.delete-warning-box {
    background: #fef2f2;
    border: 2px solid #fecaca;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.delete-warning-title {
    color: #991b1b;
    font-weight: 700;
    font-size: 1.125rem;
    margin: 0 0 1rem 0;
}

.delete-warning-text {
    color: #7f1d1d;
    font-size: 0.9375rem;
    margin: 0 0 0.75rem 0;
    line-height: 1.6;
}

.delete-warning-list {
    list-style: disc;
    margin: 0.75rem 0 0.75rem 1.5rem;
    padding: 0;
}

.delete-warning-list li {
    color: #7f1d1d;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

.delete-confirmation-section {
    margin-bottom: 1.5rem;
}

.delete-confirmation-label {
    display: block;
    color: #1e293b;
    font-weight: 600;
    font-size: 0.9375rem;
    margin-bottom: 0.75rem;
}

.delete-keyword {
    color: #dc2626;
    background: #fee2e2;
    padding: 0.125rem 0.375rem;
    border-radius: 12px;
    font-family: 'Courier New', monospace;
    font-size: 1rem;
}

.delete-confirmation-input {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    font-family: 'Courier New', monospace;
    font-weight: 600;
    border: 2px solid #cbd5e1;
    border-radius: 12px;
    transition: all 0.2s;
    text-transform: uppercase;
}

.delete-confirmation-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.delete-confirmation-error {
    margin-top: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: #fee2e2;
    border: 1px solid #fecaca;
    border-radius: 12px;
    color: #991b1b;
    font-size: 0.875rem;
    font-weight: 500;
}

.btn-danger {
    background: #dc2626;
    color: white;
    border: 1px solid #dc2626;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-danger:hover:not(:disabled) {
    background: #b91c1c;
    border-color: #b91c1c;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.btn-danger:disabled {
    background: #cbd5e1;
    border-color: #cbd5e1;
    cursor: not-allowed;
    opacity: 0.6;
}

.icon-btn--danger {
    color: #dc2626;
    border-color: #fecaca;
    background: #fef2f2;
}

.icon-btn--danger:hover {
    background: #fee2e2;
    border-color: #fca5a5;
    color: #b91c1c;
}

.spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.text-warning {
    color: #ea580c;
    font-weight: 500;
}

/* Warning badge for incomplete projects */
.badge--warning {
    background: #fff7ed;
    color: #c2410c;
    border: 1px solid #fed7aa;
    font-weight: 600;
}

.badge--warning:hover {
    background: #ffedd5;
    border-color: #fdba74;
}

/* ============ Certificate Vault Styles ============ */

/* Certificate Search Wrapper */
.cert-search-wrapper {
    max-width: 1400px;
    margin: 0 auto 40px;
}

.cert-search-box {
    display: flex;
    align-items: stretch;
    gap: 10px;
    background: #ffffff;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    box-shadow: 0 8px 30px rgba(99, 102, 241, 0.1);
    padding: 6px;
    transition: all 0.3s;
}

.cert-search-box:focus-within {
    border-color: #6366f1;
    box-shadow: 0 10px 40px rgba(99, 102, 241, 0.18);
}

.cert-search-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 16px;
    padding: 14px 20px;
    color: #1a1a1a;
    outline: none;
    font-family: inherit;
}

.cert-search-input::placeholder {
    color: #9ca3af;
}

.cert-search-button {
    padding: 14px 32px;
    background: linear-gradient(135deg, #6366f1, #4338ca);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
    box-shadow: 0 6px 16px rgba(79, 70, 229, 0.25);
}

.cert-search-button:hover {
    background: linear-gradient(135deg, #4f46e5, #3730a3);
    transform: translateY(-2px);
    box-shadow: 0 10px 24px rgba(79, 70, 229, 0.35);
}

.cert-search-button--show-all {
    background: transparent;
    color: #6366f1;
    border: 1px solid rgba(99, 102, 241, 0.35);
    box-shadow: none;
}

.cert-search-button--show-all:hover {
    background: rgba(99, 102, 241, 0.1);
}

/* Search Stats */
.cert-search-stats {
    max-width: 1400px;
    margin: 0 auto 28px;
    text-align: center;
    padding: 12px 20px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(14, 165, 233, 0.08));
    border-radius: 12px;
    border: 1px solid rgba(99, 102, 241, 0.2);
}

.cert-search-stats p {
    font-size: 15px;
    color: #374151;
    font-weight: 600;
    margin: 0;
}

.cert-search-stats strong {
    color: #6366f1;
    font-size: 20px;
    font-weight: 800;
}

/* Loading */
.cert-loading {
    text-align: center;
    padding: 64px 20px;
}

.cert-spinner {
    width: 48px;
    height: 48px;
    margin: 0 auto 20px;
    border: 4px solid rgba(99, 102, 241, 0.1);
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: certSpin 0.8s linear infinite;
}

@keyframes certSpin {
    to { transform: rotate(360deg); }
}

.cert-loading-text {
    font-size: 16px;
    color: #6b7280;
    font-weight: 600;
}

/* No Results */
.cert-no-results {
    max-width: 1400px;
    margin: 0 auto;
    text-align: center;
    padding: 64px 28px;
    background: #ffffff;
    border-radius: 12px;
    border: 2px dashed rgba(148, 163, 184, 0.3);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
}

.cert-no-results-icon {
    font-size: 64px;
    margin-bottom: 12px;
    opacity: 0.5;
}

.cert-no-results h3 {
    font-size: 24px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 10px;
}

.cert-no-results p {
    font-size: 15px;
    color: #6b7280;
    margin-bottom: 24px;
}

/* Certificate Cards List - Horizontal Layout */
.cert-cards-grid {
    max-width: 1400px;
    margin: 24px auto 0;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* Pagination Controls */
.cert-pagination-container {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 1.5rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.cert-pagination-info {
    text-align: center;
    margin-bottom: 1rem;
    color: #64748b;
    font-size: 0.9rem;
    font-weight: 500;
}

.cert-pagination-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.cert-pagination-btn {
    padding: 0.6rem 1rem;
    border: 1px solid #e2e8f0;
    background: white;
    color: #475569;
    border-radius: 12px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.cert-pagination-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.25);
}

.cert-pagination-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    background: #f1f5f9;
}

.cert-pagination-pages {
    display: flex;
    gap: 0.35rem;
}

.cert-pagination-page {
    width: 40px;
    height: 40px;
    padding: 0;
    border: 1px solid #e2e8f0;
    background: white;
    color: #475569;
    border-radius: 12px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.cert-pagination-page:hover:not(:disabled):not(.active) {
    background: #f1f5f9;
    border-color: #cbd5e1;
}

.cert-pagination-page.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
}

@media (max-width: 640px) {
    .cert-pagination-controls {
        gap: 0.35rem;
    }
    
    .cert-pagination-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
    }
    
    .cert-pagination-page {
        width: 36px;
        height: 36px;
    }
}

/* Certificate Card - Horizontal Design */
.cert-material-card {
    background: #ffffff;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 20px 40px rgba(99, 102, 241, 0.08);
    padding: 1.75rem;
    display: grid;
    gap: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.cert-material-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 24px 48px rgba(99, 102, 241, 0.15);
    border-color: rgba(99, 102, 241, 0.3);
}

/* Card Header Section */
.cert-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
}

.cert-card-title-block {
    flex: 1;
}

.cert-card-title {
    margin: 0;
    font-size: 1.35rem;
    font-weight: 700;
    color: #1a1a1a;
    line-height: 1.4;
}

.cert-card-subtitle {
    margin: 0.3rem 0 0;
    color: #6b7280;
    font-size: 0.95rem;
}

.cert-card-status {
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    background: rgba(99, 102, 241, 0.12);
    color: #6366f1;
    font-weight: 600;
    letter-spacing: 0.08em;
    font-size: 0.85rem;
    white-space: nowrap;
}

/* Divider */
.cert-card-divider {
    border-top: 1px dashed #e5e7eb;
    margin: 0.5rem 0;
}

/* Info Grid with Pills */
.cert-card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
}

.cert-pill {
    padding: 0.75rem 1rem;
    background: rgba(99, 102, 241, 0.04);
    border-radius: 12px;
    border: 1px solid rgba(99, 102, 241, 0.1);
    transition: all 0.2s ease;
}

.cert-pill:hover {
    background: rgba(99, 102, 241, 0.08);
    border-color: rgba(99, 102, 241, 0.2);
}

.cert-pill-label {
    display: block;
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.25rem;
    font-weight: 600;
}

.cert-pill-value {
    display: block;
    font-size: 1rem;
    font-weight: 700;
    color: #1a1a1a;
}

/* Services Section */
.cert-services {
    margin-top: 0.5rem;
}

.cert-services-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #6b7280;
    font-weight: 700;
    margin-bottom: 0.75rem;
}

.cert-services-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.cert-service-tag {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 0.4rem 0.85rem;
    font-weight: 600;
    font-size: 0.85rem;
    color: #6b7280;
    background: #f8f9fa;
    transition: all 0.2s ease;
}

.cert-service-tag:hover {
    border-color: #6366f1;
    color: #6366f1;
}

/* Card Footer */
.cert-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
}

.cert-card-chips {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    flex: 1;
}

.cert-chip {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 0.4rem 0.85rem;
    font-weight: 600;
    font-size: 0.85rem;
    color: #6b7280;
    background: #f8f9fa;
    transition: all 0.2s ease;
}

.cert-chip:hover {
    border-color: #6366f1;
    color: #6366f1;
}

.cert-card-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.cert-action-btn {
    border: none;
    border-radius: 12px;
    padding: 0.6rem 1.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background: linear-gradient(135deg, #6366f1, #4338ca);
    color: white;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.cert-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
}

/* Highlight */
.cert-highlight {
    background: linear-gradient(120deg, rgba(251, 191, 36, 0.4), rgba(251, 191, 36, 0.2));
    color: #1a1a1a;
    padding: 0.1em 0.3em;
    border-radius: 12px;
    font-weight: 700;
}

/* Filters Panel */
.cert-filters-panel {
    max-width: 1400px;
    margin: 0 auto 32px;
    background: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(99, 102, 241, 0.1);
    overflow: hidden;
}

.cert-filters-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 28px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(14, 165, 233, 0.08));
    border-bottom: 1px solid rgba(99, 102, 241, 0.2);
}

.cert-filters-header h3 {
    font-size: 18px;
    font-weight: 800;
    color: #1a1a1a;
    margin: 0;
}

.cert-filters-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.cert-filter-action-btn {
    padding: 12px 24px;
    border-radius: 12px;
    border: none;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
}

.cert-clear-btn {
    background: transparent;
    color: #6366f1;
    border: 1px solid rgba(99, 102, 241, 0.35);
}

.cert-clear-btn:hover {
    background: rgba(99, 102, 241, 0.1);
    transform: translateY(-2px);
}

.cert-apply-btn {
    background: linear-gradient(135deg, #6366f1, #4338ca);
    color: white;
    box-shadow: 0 6px 16px rgba(79, 70, 229, 0.25);
}

.cert-apply-btn:hover {
    background: linear-gradient(135deg, #4f46e5, #3730a3);
    transform: translateY(-2px);
    box-shadow: 0 10px 24px rgba(79, 70, 229, 0.35);
}

.cert-filter-toggle-btn {
    padding: 10px 14px;
    background: rgba(99, 102, 241, 0.1);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.cert-filter-toggle-btn:hover {
    background: rgba(248, 250, 252, 0.8);
    transform: scale(1.05);
}

.cert-filter-toggle-btn #certToggleIcon {
    transition: transform 0.3s ease;
}

.cert-filter-toggle-btn.collapsed #certToggleIcon {
    transform: rotate(-90deg);
}

.cert-filters-content {
    padding: 32px 28px;
    max-height: 800px;
    overflow-y: auto;
    transition: all 0.3s ease;
}

.cert-filters-content.collapsed {
    max-height: 0;
    padding: 0 28px;
    overflow: hidden;
}

.cert-filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
}

.cert-filter-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: relative;
    overflow: visible;
}

.cert-filter-group:focus-within,
.cert-filter-group .choices.is-open {
    z-index: 50;
}

.cert-filter-group .choices.is-open .choices__list--dropdown {
    z-index: 100;
}

.cert-range-group {
    padding: 20px;
    background: rgba(248, 250, 252, 0.8);
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.15);
    z-index: 1;
}

.cert-filter-label {
    font-size: 14px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 12px;
}

.cert-filter-select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    background: #ffffff;
    color: #1a1a1a;
    font-size: 16px;
    transition: all 0.3s ease;
    min-height: 52px;
}

.cert-filter-select:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

.cert-range-slider {
    margin: 20px 0;
    min-height: 30px;
    padding: 10px 0;
    position: relative;
    z-index: 1;
}

.cert-range-values {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 16px;
    font-size: 14px;
    font-weight: 700;
    color: #6366f1;
}

.cert-date-range-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    background: #ffffff;
    color: #1a1a1a;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 52px;
    position: relative;
}

.cert-date-range-input:hover {
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
}

.cert-date-range-input:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

.cert-date-range-input::placeholder {
    color: #9ca3af;
}

/* Responsive */
@media (max-width: 768px) {
    .cert-vault-title {
        font-size: 1.75rem;
    }

    .cert-vault-subtitle {
        font-size: 1rem;
    }

    .cert-search-box {
        flex-direction: column;
    }

    .cert-search-button {
        width: 100%;
    }

    .cert-material-card {
        padding: 1.25rem;
    }

    .cert-card-header {
        flex-direction: column;
    }

    .cert-card-grid {
        grid-template-columns: 1fr;
    }

    .cert-card-footer {
        flex-direction: column;
        align-items: flex-start;
    }

    .cert-card-actions {
        width: 100%;
    }

    .cert-action-btn {
        width: 100%;
    }
}

/* ============ Manual Clause Styles ============ */

/* AI Filter Section */
.ai-filter-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 32px;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
}

.ai-section-header {
    text-align: center;
    margin-bottom: 24px;
}

.ai-section-title {
    font-size: 24px;
    font-weight: 700;
    color: white;
    margin: 0 0 8px 0;
}

.ai-section-subtitle {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
}

.ai-input-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
}

.ai-text-input-wrapper,
.ai-image-upload-wrapper {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ai-input-label {
    font-size: 14px;
    font-weight: 600;
    color: white;
}

.ai-text-area {
    width: 100%;
    padding: 16px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.15);
    color: white;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    transition: all 0.3s ease;
}

.ai-text-area::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.ai-text-area:focus {
    outline: none;
    border-color: white;
    background: rgba(255, 255, 255, 0.2);
}

.btn-upload-icon {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: transparent;
    color: white;
    border: none;
    padding: 20px 24px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    gap: 16px;
    min-height: auto;
    width: 100%;
}

.btn-upload-icon:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
}

.upload-icon-circle {
    width: 64px;
    height: 64px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.btn-upload-icon:hover .upload-icon-circle {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.05);
}

.upload-icon-circle svg {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    width: 32px;
    height: 32px;
}

.upload-icon-text {
    font-size: 16px;
    font-weight: 600;
    letter-spacing: 0.3px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
}

.upload-icon-subtext {
    font-size: 13px;
    font-weight: 400;
    opacity: 0.85;
    color: rgba(255, 255, 255, 0.75);
}

.image-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 12px;
    margin-top: 12px;
}

.image-preview-item {
    position: relative;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 8px;
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.image-preview-item img {
    width: 100%;
    height: 80px;
    object-fit: cover;
    border-radius: 12px;
}

.image-preview-name {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.8);
    text-align: center;
    margin-top: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.ai-actions {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
}

.btn-ai-primary {
    background: white;
    color: #667eea;
    padding: 14px 32px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-ai-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}

.btn-ai-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.ai-status {
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
    font-size: 14px;
    font-weight: 600;
}

.spinner {
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Section Divider */
.section-divider {
    text-align: center;
    margin: 32px 0;
    position: relative;
}

.section-divider::before,
.section-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: linear-gradient(to right, transparent, #e2e8f0, transparent);
}

.section-divider::before {
    left: 0;
}

.section-divider::after {
    right: 0;
}

.divider-text {
    background: white;
    padding: 0 16px;
    color: #64748b;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* AI Preview Modal */
.ai-preview-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

.ai-preview-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
}

.ai-preview-content {
    position: relative;
    background: white;
    border-radius: 12px;
    padding: 40px;
    max-width: 800px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
    z-index: 1;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.ai-preview-header {
    text-align: center;
    margin-bottom: 32px;
    position: relative;
}

.ai-preview-title {
    font-size: 28px;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 8px 0;
}

.ai-preview-subtitle {
    font-size: 14px;
    color: #64748b;
    margin: 0;
}

.ai-close-btn {
    position: absolute;
    top: 0;
    right: 0;
    background: #f1f5f9;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 20px;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s ease;
}

.ai-close-btn:hover {
    background: #e2e8f0;
    color: #334155;
    transform: rotate(90deg);
}

.preview-filter-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 32px;
}

.filter-preview-section {
    padding: 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    border-left: 4px solid #6366f1;
    transition: all 0.3s ease;
}

.filter-preview-section:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
}

.filter-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.filter-preview-title {
    font-size: 16px;
    font-weight: 700;
    color: #1e293b;
}

.confidence-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    color: #334155;
}

.filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.filter-chip {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3);
    transition: all 0.2s ease;
}

.filter-chip:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4);
}

.filter-chip-range {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

/* Editable Chip Styles */
.editable-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 8px 12px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3);
    transition: all 0.2s ease;
    position: relative;
}

.editable-chip:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4);
}

.chip-text {
    flex-grow: 1;
}

.chip-edit-btn, .chip-remove-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
}

.chip-edit-btn:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: scale(1.1);
}

.chip-remove-btn:hover {
    background: #ef4444;
    transform: scale(1.1);
}

.chip-editing {
    padding: 4px 8px;
}

.chip-edit-input {
    background: white;
    color: #1e293b;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 4px 8px;
    font-size: 14px;
    font-weight: 600;
    min-width: 100px;
    outline: none;
}

.chip-edit-input:focus {
    border-color: white;
}

.chip-save-btn {
    background: #10b981;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 4px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.chip-save-btn:hover {
    background: #059669;
}

.filter-section-header {
    font-size: 14px;
    font-weight: 700;
    color: #475569;
    margin: 20px 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 2px solid #e2e8f0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-section-content {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
}

.add-chip-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #f1f5f9;
    color: #64748b;
    padding: 8px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    border: 2px dashed #cbd5e1;
    cursor: pointer;
    transition: all 0.2s ease;
}

.add-chip-btn:hover {
    background: #e2e8f0;
    border-color: #94a3b8;
    color: #475569;
    transform: translateY(-1px);
}

.no-filters-message {
    text-align: center;
    padding: 40px;
    color: #64748b;
    font-size: 16px;
}

.ai-preview-actions {
    display: flex;
    justify-content: center;
    gap: 16px;
    padding-top: 24px;
    border-top: 1px solid #e2e8f0;
}

.btn-ai-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 14px 32px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-ai-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
}

/* Custom Value Styling in Choices.js */
.choices__item[data-custom-properties*="isCustom"] {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%) !important;
    border-color: #d97706 !important;
}

.choices__item[data-custom-properties*="isCustom"] .choices__button {
    border-left-color: rgba(255, 255, 255, 0.4) !important;
}

/* Custom value in dropdown list */
.choices__list--dropdown .choices__item[data-custom-properties*="isCustom"] {
    background: #fef3c7;
    color: #92400e;
    font-weight: 600;
}

.choices__list--dropdown .choices__item[data-custom-properties*="isCustom"]::before {
    content: '‚ú® ';
}

/* Responsive Design for AI Section */
@media (max-width: 768px) {
    .ai-input-container {
        grid-template-columns: 1fr;
    }

    .ai-preview-content {
        padding: 24px;
        max-width: 95%;
    }

    .ai-preview-title {
        font-size: 22px;
    }
}

/* Hero Section */
.manual-clause-hero {
    text-align: center;
    margin-bottom: 32px;
    padding: 24px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.03) 0%, rgba(139, 92, 246, 0.03) 100%);
    border-radius: 12px;
}

.manual-clause-title {
    font-size: 1.875rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 12px 0;
    letter-spacing: -0.3px;
}

.manual-clause-subtitle {
    font-size: 1.0625rem;
    color: #64748b;
    margin: 0;
    line-height: 1.6;
}

/* Preset Bar */
.preset-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
    padding: 16px;
    background: rgba(248, 250, 252, 0.6);
    border-radius: 12px;
    border: 1px solid rgba(99, 102, 241, 0.1);
}

.preset-dropdown {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    font-size: 14px;
    color: #334155;
    background: white;
    cursor: pointer;
}

/* Filters Panel */
.manual-filters-panel {
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.95) 0%, rgba(241, 245, 249, 0.95) 100%);
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 32px;
    border: 1px solid rgba(99, 102, 241, 0.12);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
}

.manual-filters-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(99, 102, 241, 0.15);
}

.manual-filters-header h3 {
    font-size: 1.375rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
    letter-spacing: -0.3px;
}

.filter-toggle-btn {
    background: transparent;
    border: none;
    color: #6366f1;
    font-size: 22px;
    cursor: pointer;
    padding: 6px 10px;
    transition: all 0.3s ease;
    border-radius: 12px;
}

.filter-toggle-btn:hover {
    transform: scale(1.1);
    background: rgba(99, 102, 241, 0.08);
}

.manual-filters-content {
    animation: fadeIn 0.4s ease;
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
    position: relative;
    z-index: 0;
}

/* Filter Section Headers */
.filter-section-header {
    grid-column: 1 / -1;
    font-size: 13px;
    font-weight: 700;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: -16px;
    padding-bottom: 12px;
    border-bottom: 2px solid rgba(99, 102, 241, 0.12);
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-section-header::before {
    content: '';
    width: 4px;
    height: 16px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-radius: 2px;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: rgba(255, 255, 255, 0.7);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid rgba(226, 232, 240, 0.8);
    transition: all 0.3s ease;
    margin-bottom: 0;
    position: relative;
    z-index: 1;
}

.filter-group:has(.choices.is-open) {
    z-index: 1000;
}

.filter-group:hover {
    background: white;
    border-color: rgba(99, 102, 241, 0.25);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.08);
    transform: translateY(-2px);
}

.filter-group--range {
    grid-column: span 1;
}

.filter-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 14px;
    color: #334155;
    margin-bottom: 6px;
}

.filter-label::before {
    content: attr(data-icon);
    font-size: 16px;
    opacity: 0.8;
}

.filter-select {
    width: 100%;
    min-height: 46px;
}

.manual-filters-content .filter-group .choices__inner {
    margin-bottom: 0;
    padding-bottom: 8px;
}

.manual-filters-content .filter-group .choices__list--multiple {
    margin-bottom: 0;
    padding-bottom: 0;
}

.manual-filters-content .filter-group .choices__input {
    margin-bottom: 0;
}

/* Date Input Wrapper */
.date-input-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.date-range-input {
    width: 100%;
    padding: 12px 16px 12px 40px;
    border: 1.5px solid #e2e8f0;
    border-radius: 12px;
    font-size: 14px;
    color: #334155;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.date-range-input::placeholder {
    color: #94a3b8;
}

.date-range-input:hover {
    border-color: #cbd5e1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.date-range-input:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.12);
}

/* Calendar icon for date inputs */
.date-input-wrapper::before {
    content: 'üìÖ';
    position: absolute;
    left: 14px;
    top: 12px;
    font-size: 16px;
    pointer-events: none;
    z-index: 1;
}

/* Date validation states */
.date-input-wrapper.has-error .date-range-input {
    border-color: #dc2626;
    background: #fef2f2;
}

.date-input-wrapper.has-success .date-range-input {
    border-color: #10b981;
    background: #f0fdf4;
}

.date-validation-message {
    font-size: 12px;
    color: #dc2626;
    margin-top: 4px;
    display: none;
    font-weight: 500;
}

.date-input-wrapper.has-error .date-validation-message {
    display: block;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-4px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Flatpickr Calendar z-index */
.flatpickr-calendar {
    z-index: 1001 !important;
}

/* Custom Choices.js Styling for Manual Filters */
.manual-filters-content .choices {
    margin-bottom: 0;
    position: relative;
}

.manual-filters-content .filter-group .choices {
    margin-bottom: 0;
}

.manual-filters-content .choices.is-open {
    z-index: 1001;
    position: relative;
}

.manual-filters-content .filter-group:has(.choices.is-open) {
    z-index: 1000;
}

.manual-filters-content .choices__inner {
    background: white;
    border: 1.5px solid #e2e8f0;
    border-radius: 12px;
    min-height: 46px;
    padding: 8px 12px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.manual-filters-content .choices__inner:hover {
    border-color: #cbd5e1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.manual-filters-content .choices.is-focused .choices__inner {
    border-color: #6366f1;
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.12);
}

.manual-filters-content .choices__list--multiple .choices__item {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border: none;
    border-radius: 12px;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 4px;
}

.manual-filters-content .choices__list--dropdown {
    border: 1.5px solid #e2e8f0;
    border-radius: 12px;
    margin-top: 4px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    z-index: 1002 !important;
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    background: white !important;
    max-height: 300px;
    overflow-y: auto;
}

.manual-filters-content .choices__list--dropdown.is-active {
    display: block !important;
}

.manual-filters-content .choices__list--dropdown .choices__item--selectable {
    padding: 12px 16px;
    font-size: 14px;
}

.manual-filters-content .choices__list--dropdown .choices__item--selectable.is-highlighted {
    background: rgba(99, 102, 241, 0.1);
    color: #1e293b;
}

.manual-filters-content .choices__input {
    background: transparent;
    font-size: 14px;
    color: #334155;
    padding: 4px 0;
}

.manual-filters-content .choices__input::placeholder {
    color: #94a3b8;
}

.manual-filters-content .choices__button {
    background: rgba(255, 255, 255, 0.3);
    border: none;
    border-radius: 12px;
    padding: 2px 6px;
    margin-left: 6px;
    opacity: 0.8;
    transition: opacity 0.2s ease;
}

.manual-filters-content .choices__button:hover {
    opacity: 1;
}

/* Range Slider Styling */
.range-slider {
    margin: 20px 0 16px 0;
}

/* Custom noUiSlider styling */
.manual-filters-content .noUi-target {
    background: #e2e8f0;
    border: none;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
    border-radius: 12px;
    height: 8px;
}

.manual-filters-content .noUi-connect {
    background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
}

.manual-filters-content .noUi-handle {
    background: white;
    border: 3px solid #6366f1;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    width: 20px;
    height: 20px;
    top: -7px;
    cursor: grab;
}

.manual-filters-content .noUi-handle:active {
    cursor: grabbing;
    transform: scale(1.1);
}

.manual-filters-content .noUi-handle::before,
.manual-filters-content .noUi-handle::after {
    display: none;
}

.manual-filters-content .noUi-tooltip {
    background: #1e293b;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 600;
}

.range-values {
    display: flex;
    justify-content: space-between;
    margin-top: 12px;
}

.range-value {
    font-size: 13px;
    font-weight: 600;
    color: #64748b;
    padding: 4px 10px;
    background: rgba(99, 102, 241, 0.08);
    border-radius: 12px;
}

.filter-actions {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid rgba(99, 102, 241, 0.1);
}

.btn-secondary {
    background: white;
    color: #64748b;
    border: 2px solid #e2e8f0;
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
    color: #475569;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Results Section */
.manual-results-section {
    animation: fadeInUp 0.5s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.manual-results-summary {
    margin-bottom: 24px;
    padding: 16px 20px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
    border-radius: 12px;
    border-left: 4px solid #6366f1;
}

.results-text {
    font-size: 1rem;
    color: #475569;
    margin: 0;
}

.results-text strong {
    color: #1e293b;
    font-weight: 700;
}

/* Keyword Filter Buttons */
.keyword-filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid rgba(99, 102, 241, 0.1);
}

.keyword-filter-btn {
    padding: 8px 16px;
    background: white;
    border: 2px solid rgba(99, 102, 241, 0.2);
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6366f1;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.keyword-filter-btn:hover {
    background: rgba(99, 102, 241, 0.05);
    border-color: rgba(99, 102, 241, 0.4);
    transform: translateY(-1px);
}

.keyword-filter-btn--active {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-color: #6366f1;
    color: white;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

.keyword-filter-btn--active:hover {
    background: linear-gradient(135deg, #5855eb 0%, #7c3aed 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
}

.no-results-message {
    text-align: center;
    padding: 40px 20px;
    color: #64748b;
    font-size: 1rem;
}

/* Results Grid */
.manual-results-grid {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Certificate Card */
.manual-cert-card {
    position: relative;
    background: white;
    border-radius: 12px;
    padding: 24px;
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.manual-cert-card:hover {
    border-color: #6366f1;
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.12);
    transform: translateY(-2px);
}

/* Compliance Badge */
.compliance-badge {
    position: absolute;
    top: 16px;
    right: 16px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 13px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.compliance-badge--perfect {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.compliance-badge--high {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

.compliance-badge--medium {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.compliance-badge--low {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.compliance-icon {
    font-size: 14px;
}

.compliance-text {
    font-size: 13px;
    letter-spacing: 0.3px;
}

/* Certificate Card Content */
.cert-card-content {
    margin-right: 120px;
}

.cert-card-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 8px 0;
    line-height: 1.4;
}

.cert-card-client {
    font-size: 0.9375rem;
    color: #64748b;
    margin: 0 0 16px 0;
}

.cert-card-details {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 12px;
}

.cert-detail {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    background: rgba(99, 102, 241, 0.08);
    border-radius: 12px;
    font-size: 13px;
    color: #475569;
}

.cert-card-metrics {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 12px;
}

.cert-metric {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    font-weight: 600;
    color: #1e293b;
}

/* Unmet Filters */
.cert-unmet-filters {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px dashed #e2e8f0;
}

.unmet-label {
    font-weight: 600;
    color: #64748b;
    font-size: 13px;
    margin-right: 8px;
}

.unmet-item {
    display: inline-block;
    background: #fef2f2;
    color: #dc2626;
    padding: 4px 10px;
    border-radius: 12px;
}

.cert-matched-keywords {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px dashed #e2e8f0;
}

.matched-label {
    font-weight: 600;
    color: #64748b;
    font-size: 13px;
    margin-right: 8px;
    display: block;
    margin-bottom: 8px;
}

.matched-keyword-chip {
    display: inline-block;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    color: #6366f1;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    margin: 4px 4px 4px 0;
    border: 1px solid rgba(99, 102, 241, 0.2);
    font-size: 12px;
    margin-right: 6px;
    margin-top: 4px;
}

/* Certificate Card Actions */
.cert-card-actions {
    margin-top: 16px;
    display: flex;
    gap: 10px;
}

/* Loading States */
.manual-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
}

.manual-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid rgba(99, 102, 241, 0.1);
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.manual-loading-text {
    margin-top: 16px;
    font-size: 1rem;
    color: #64748b;
    font-weight: 500;
}

/* No Results State */
.manual-no-results {
    text-align: center;
    padding: 60px 20px;
}

.manual-no-results-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.manual-no-results h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 8px 0;
}

.manual-no-results p {
    font-size: 1rem;
    color: #64748b;
    margin: 0;
}

/* Responsive Design */
@media (max-width: 768px) {
    .filter-grid {
        grid-template-columns: 1fr;
    }

    .cert-card-content {
        margin-right: 0;
        margin-bottom: 60px;
    }

    .compliance-badge {
        top: auto;
        bottom: 16px;
        right: 16px;
    }

    .manual-clause-title {
        font-size: 1.5rem;
    }

    .preset-bar {
        flex-direction: column;
        align-items: stretch;
    }
}

/* Keyword Display Styles */
.keyword-display-section {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.03) 0%, rgba(139, 92, 246, 0.03) 100%);
    padding: 24px;
    border-radius: 12px;
    margin-top: 24px;
    margin-bottom: 24px;
    border: 1px solid rgba(99, 102, 241, 0.1);
}

.keyword-section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 16px 0;
}

.keyword-chips-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
}

.keyword-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px 8px 16px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
    transition: all 0.2s ease;
}

.keyword-chip:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.keyword-chip-text {
    flex: 1;
}

.keyword-chip-remove {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    line-height: 1;
    padding: 0;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.keyword-chip-remove:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.keyword-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.add-keyword-container {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    align-items: center;
}

.new-keyword-input {
    flex: 1;
    padding: 8px 12px;
    border: 2px solid rgba(99, 102, 241, 0.2);
    border-radius: 12px;
    font-size: 0.875rem;
    transition: border-color 0.2s ease;
}

.new-keyword-input:focus {
    outline: none;
    border-color: #6366f1;
}

.update-results-container {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 16px;
    padding: 12px 16px;
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
    border-radius: 12px;
    border-left: 4px solid #ffc107;
}

.update-hint {
    font-size: 0.875rem;
    color: #856404;
    font-weight: 500;
}

.keyword-expansion-section {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid rgba(99, 102, 241, 0.1);
}

.keyword-expansion-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.keyword-expansion-item {
    background: white;
    padding: 16px;
    border-radius: 12px;
    border: 1px solid rgba(99, 102, 241, 0.1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.keyword-expansion-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    margin-bottom: 12px;
}

.keyword-expansion-keyword {
    font-weight: 600;
    color: #6366f1;
    font-size: 0.9375rem;
}

.keyword-expansion-toggle {
    background: none;
    border: none;
    color: #6366f1;
    cursor: pointer;
    font-size: 0.875rem;
    padding: 4px 8px;
    border-radius: 12px;
    transition: background 0.2s ease;
}

.keyword-expansion-toggle:hover {
    background: rgba(99, 102, 241, 0.1);
}

.keyword-variants {
    display: none;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}

.keyword-variants.expanded {
    display: flex;
}

.keyword-variant-chip {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    background: rgba(99, 102, 241, 0.1);
    color: #6366f1;
    border-radius: 12px;
    font-size: 0.8125rem;
    font-weight: 500;
}

/* ============ End Manual Clause Styles ============ */

/* ============================================================================ */
/* CERTIFICATE ATTACHMENT STYLES */
/* ============================================================================ */

/* Certificate Attachment Section */
.cert-attachment-section {
    padding: 1rem;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%);
    border-top: 1px solid rgba(99, 102, 241, 0.1);
    margin-top: 0.75rem;
}

.cert-attachment-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.cert-attachment-icon {
    font-size: 1rem;
}

.cert-attachment-title {
    font-size: 0.813rem;
    font-weight: 600;
    color: var(--text-primary);
}

.cert-attached-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 8px;
    margin-bottom: 0.75rem;
}

.cert-attached-badge {
    font-size: 0.75rem;
    font-weight: 600;
    color: #16a34a;
}

.cert-view-attachments-btn {
    padding: 0.25rem 0.75rem;
    background: transparent;
    color: #6366f1;
    border: 1px solid #6366f1;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.cert-view-attachments-btn:hover {
    background: #6366f1;
    color: white;
}

.cert-attachment-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.cert-tender-dropdown {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.813rem;
    background: var(--bg-primary);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
}

.cert-tender-dropdown:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.cert-attach-btn {
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.813rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.cert-attach-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.cert-attach-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Attachments Modal */
.cert-attachments-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.cert-attachments-modal-content {
    background: var(--bg-primary);
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.cert-attachments-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.cert-attachments-modal-header h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

.cert-attachments-modal-header button {
    background: none;
    border: none;
    font-size: 2rem;
    color: var(--text-secondary);
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
}

.cert-attachments-modal-body {
    padding: 1.5rem;
    max-height: calc(80vh - 100px);
    overflow-y: auto;
}

.cert-no-attachments {
    text-align: center;
    color: var(--text-secondary);
    padding: 2rem;
}

.cert-attachments-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.cert-attachment-item {
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--bg-secondary);
}

.cert-attachment-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.cert-attachment-item-header h4 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    flex: 1;
    margin-right: 1rem;
}

.cert-detach-btn {
    padding: 0.375rem 0.75rem;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.cert-detach-btn:hover {
    background: #dc2626;
    transform: translateY(-1px);
}

.cert-attachment-item-authority {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.cert-attachment-item-meta {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    margin-bottom: 0.5rem;
}

.cert-attachment-item-notes {
    font-size: 0.813rem;
    color: var(--text-secondary);
    font-style: italic;
    padding: 0.5rem;
    background: rgba(99, 102, 241, 0.05);
    border-left: 3px solid #6366f1;
    border-radius: 4px;
    margin-top: 0.5rem;
}

/* Notification Toast */
.cert-notification {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 10001;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
}

.cert-notification-show {
    transform: translateY(0);
    opacity: 1;
}

.cert-notification-success {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
}

.cert-notification-error {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.cert-notification-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.cert-notification-info {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
}

/* ============ End Certificate Attachment Styles ============ */

/* ============ End Certificate Vault Styles ============ */
</style>

<script>
// ============ Test Mode Configuration ============
const IS_TEST_MODE = {% if is_test_mode %}true{% else %}false{% endif %};
const TEST_TOKEN = "{{ test_token if is_test_mode else '' }}";
const TEST_BASE_URL = "{{ test_base_url if is_test_mode else '' }}";

// Helper function to build URLs based on mode
function buildURL(path, params = {}) {
    if (IS_TEST_MODE) {
        params.test_token = TEST_TOKEN;
        const queryString = new URLSearchParams(params).toString();
        return `${TEST_BASE_URL}${path}${queryString ? '?' + queryString : ''}`;
    } else {
        const queryString = new URLSearchParams(params).toString();
        return `${path}${queryString ? '?' + queryString : ''}`;
    }
}

// ============ Vault Tab Switching Functionality ============

// Current active vault tab
let currentVaultTab = 'project';

// Certificate tab initialization flag
let certTabInitialized = false;

/**
 * Switch between vault tabs (projects and certificates)
 * @param {string} tabName - 'projects' or 'certificates'
 */
function switchVaultTab(tabName) {
    console.log('switchVaultTab called with:', tabName);

    // Hide all tab contents
    const allContents = document.querySelectorAll('.vault-tab-content');
    console.log('Found tab contents:', allContents.length);
    allContents.forEach(content => {
        content.style.display = 'none';
        content.classList.remove('vault-tab-content--active');
        console.log('Hiding:', content.id);
    });

    // Remove active class and aria-selected from all tabs
    document.querySelectorAll('.vault-tab').forEach(tab => {
        tab.classList.remove('vault-tab--active');
        tab.setAttribute('aria-selected', 'false');
    });

    // Show selected tab content
    const targetContent = document.getElementById(tabName + 'VaultContent');
    console.log('Target content ID:', tabName + 'VaultContent');
    console.log('Target content element:', targetContent);

    if (targetContent) {
        targetContent.style.display = 'block';
        targetContent.classList.add('vault-tab-content--active');
        console.log('Showing content for:', tabName);
        console.log('Content display style:', targetContent.style.display);
    } else {
        console.error('Could not find target content!');
    }

    // Activate selected tab
    const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
    if (targetTab) {
        targetTab.classList.add('vault-tab--active');
        targetTab.setAttribute('aria-selected', 'true');
    }

    // Update current tab
    currentVaultTab = tabName;

    // Save tab preference to localStorage
    localStorage.setItem('activeVaultTab', tabName);

    // Initialize certificate tab on first switch
    if (tabName === 'cert' && !certTabInitialized) {
        initializeCertificateTab();
    }
}

// ============ Analytics Mode Switching Functionality ============

// Current active analytics mode (value or fee)
let currentAnalyticsMode = 'value';

/**
 * Switch between analytics modes (value, fee)
 * @param {string} mode - 'value' or 'fee'
 */
function switchAnalyticsMode(mode) {
    console.log('switchAnalyticsMode called with:', mode);

    if (mode !== 'value' && mode !== 'fee') {
        console.error('Invalid analytics mode:', mode);
        return;
    }

    currentAnalyticsMode = mode;

    // Update toggle buttons
    const allToggleBtns = document.querySelectorAll('.analytics-toggle-btn');
    allToggleBtns.forEach(btn => {
        btn.classList.remove('analytics-toggle-btn--active');
        if (btn.dataset.mode === mode) {
            btn.classList.add('analytics-toggle-btn--active');
        }
    });

    // Update all analytics displays
    const allAnalytics = document.querySelectorAll('.sector-analytics');
    allAnalytics.forEach(analyticsEl => {
        const totalValueEl = analyticsEl.querySelector('.analytics-item--total .analytics-value-data');
        const avgValueEl = analyticsEl.querySelector('.analytics-item--avg .analytics-value-data');
        const totalLabelEl = analyticsEl.querySelector('.analytics-item--total .analytics-label-text');
        const avgLabelEl = analyticsEl.querySelector('.analytics-item--avg .analytics-label-text');
        const totalIconEl = analyticsEl.querySelector('.analytics-item--total .analytics-icon-total');
        const avgIconEl = analyticsEl.querySelector('.analytics-item--avg .analytics-icon-avg');

        if (mode === 'value') {
            // Show value data
            if (totalValueEl) {
                const valueTotal = totalValueEl.dataset.valueTotal || '0.0';
                totalValueEl.textContent = `‚Çπ ${valueTotal} Cr`;
            }
            if (avgValueEl) {
                const valueAvg = avgValueEl.dataset.valueAvg || '0.0';
                avgValueEl.textContent = `‚Çπ ${valueAvg} Cr`;
            }
            if (totalLabelEl) totalLabelEl.textContent = 'Total Value';
            if (avgLabelEl) avgLabelEl.textContent = 'Avg Value';
            if (totalIconEl) totalIconEl.textContent = 'üí∞';
            if (avgIconEl) avgIconEl.textContent = 'üìä';
        } else {
            // Show fee data
            if (totalValueEl) {
                const feeTotal = totalValueEl.dataset.feeTotal || '0.0';
                totalValueEl.textContent = `‚Çπ ${feeTotal} Cr`;
            }
            if (avgValueEl) {
                const feeAvg = avgValueEl.dataset.feeAvg || '0.0';
                avgValueEl.textContent = `‚Çπ ${feeAvg} Cr`;
            }
            if (totalLabelEl) totalLabelEl.textContent = 'Total Fee';
            if (avgLabelEl) avgLabelEl.textContent = 'Avg Fee';
            if (totalIconEl) totalIconEl.textContent = 'üíµ';
            if (avgIconEl) avgIconEl.textContent = 'üí≥';
        }
    });

    // Save preference to localStorage
    localStorage.setItem('analyticsMode', mode);
    console.log('Analytics mode switched to:', mode);
}

// Restore analytics mode preference on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedAnalyticsMode = localStorage.getItem('analyticsMode');
    if (savedAnalyticsMode && ['value', 'fee'].includes(savedAnalyticsMode)) {
        switchAnalyticsMode(savedAnalyticsMode);
    }
});

// ============ Certificate Mode Switching Functionality ============

// Current active certificate mode
let currentCertMode = 'search';

/**
 * Switch between certificate modes (search, manual-clause)
 * @param {string} modeName - 'search' or 'manual-clause'
 */
function switchCertMode(modeName) {
    console.log('switchCertMode called with:', modeName);

    // Hide all certificate mode contents
    const allModeContents = document.querySelectorAll('.cert-mode-content');
    console.log('Found cert mode contents:', allModeContents.length);
    allModeContents.forEach(content => {
        content.style.display = 'none';
    });

    // Remove active class from all cert mode buttons
    document.querySelectorAll('.cert-mode-btn').forEach(btn => {
        btn.classList.remove('cert-mode-btn--active');
    });

    // Show selected mode content
    let targetContentId;
    let targetBtnId;

    switch(modeName) {
        case 'search':
            targetContentId = 'certSearchSection';
            targetBtnId = 'searchModeBtn';
            break;
        case 'manual-clause':
            targetContentId = 'certManualClauseSection';
            targetBtnId = 'manualClauseModeBtn';
            break;
        default:
            console.error('Invalid cert mode:', modeName);
            return;
    }

    const targetContent = document.getElementById(targetContentId);
    const targetBtn = document.getElementById(targetBtnId);

    if (targetContent) {
        targetContent.style.display = 'block';
        console.log('Showing cert mode content:', targetContentId);
    } else {
        console.error('Could not find target content:', targetContentId);
    }

    if (targetBtn) {
        targetBtn.classList.add('cert-mode-btn--active');
        console.log('Activated cert mode button:', targetBtnId);
    } else {
        console.error('Could not find target button:', targetBtnId);
    }

    // Update current mode
    currentCertMode = modeName;

    // Save mode preference to localStorage
    localStorage.setItem('activeCertMode', modeName);

    // Initialize Manual Clause functionality when that mode is selected
    if (modeName === 'manual-clause' && !manualClauseInitialized) {
        initManualClause();
    }
}

// Restore cert mode preference on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedCertMode = localStorage.getItem('activeCertMode');
    if (savedCertMode && ['search', 'manual-clause'].includes(savedCertMode)) {
        // Small delay to ensure DOM is fully ready
        setTimeout(() => {
            switchCertMode(savedCertMode);
        }, 100);
    }
});

// ============ Manual Clause Filtering Functionality ============

// State management for Manual Clause
let manualFilterOptions = null;
let manualChoicesInstances = {};
let manualSliderInstances = {};
let manualDatePickers = {};
let manualCurrentFilters = {};
let manualResults = [];
let manualClauseInitialized = false;
let manualDefaultRanges = {}; // Store default min/max for range sliders

// AI Filter State
let aiExtractedFilters = null;
let aiConfidenceScores = null;
let aiUploadedImages = [];

// Keyword-based search state
let allKeywordResults = []; // Store all results for filtering
let allKeywords = []; // Store all keywords for filter buttons
let currentKeywordFilter = 'combined'; // Current active filter
let originalKeywords = []; // Store original extracted keywords
let modifiedKeywords = []; // Store modified keywords
let keywordsModified = false; // Track if keywords have been modified

/**
 * Initialize Manual Clause functionality
 */
function initManualClause() {
    if (manualClauseInitialized) {
        console.log('Manual Clause already initialized');
        return;
    }

    console.log('Initializing Manual Clause functionality...');

    // Fetch filter options
    fetchManualFilterOptions();

    // Initialize event listeners
    const searchBtn = document.getElementById('manualSearchBtn');
    const clearBtn = document.getElementById('manualClearFilters');
    const toggleBtn = document.getElementById('toggleManualFiltersBtn');

    if (searchBtn) searchBtn.addEventListener('click', performManualSearch);
    if (clearBtn) clearBtn.addEventListener('click', clearAllManualFilters);
    if (toggleBtn) toggleBtn.addEventListener('click', toggleManualFilters);

    // Initialize AI filter section
    initAIFilterSection();

    manualClauseInitialized = true;
}

/**
 * Fetch all filter options from backend
 */
async function fetchManualFilterOptions() {
    try {
        console.log('Fetching manual clause filter options...');

        const response = await fetch('/api/certificates/manual-clause/filter-options');
        if (!response.ok) throw new Error('Failed to fetch filter options');

        manualFilterOptions = await response.json();
        console.log('Filter options loaded:', manualFilterOptions);

        // Initialize all filter inputs
        initManualFilterInputs();

    } catch (error) {
        console.error('Error fetching filter options:', error);
        alert('Failed to load filter options. Please refresh the page.');
    }
}

/**
 * Initialize all 12 filter inputs with Choices.js, noUiSlider, and Flatpickr
 */
function initManualFilterInputs() {
    console.log('Initializing manual filter inputs...');

    // Initialize multi-select dropdowns with Choices.js
    const multiSelectFilters = [
        { id: 'manualFilterClients', data: manualFilterOptions.clients || [] },
        { id: 'manualFilterLocations', data: manualFilterOptions.locations || [] },
        { id: 'manualFilterServices', data: manualFilterOptions.services || [] },
        { id: 'manualFilterSectors', data: manualFilterOptions.sectors || [] },
        { id: 'manualFilterSubSectors', data: manualFilterOptions.sub_sectors || [] },
        { id: 'manualFilterFundingAgencies', data: manualFilterOptions.funding_agencies || [] },
        { id: 'manualFilterRoles', data: manualFilterOptions.roles || [] },
        { id: 'manualFilterDurations', data: manualFilterOptions.durations || [] },
        { id: 'manualFilterCertNumbers', data: manualFilterOptions.certificate_numbers || [] }
    ];

    multiSelectFilters.forEach(filter => {
        const element = document.getElementById(filter.id);
        if (element && typeof Choices !== 'undefined') {
            manualChoicesInstances[filter.id] = new Choices(element, {
                removeItemButton: true,
                searchEnabled: true,
                searchPlaceholderValue: 'Type to search, add custom values, or paste comma-separated values...',
                noResultsText: 'Press Enter or comma to add as filter',
                itemSelectText: 'Click to select',
                addItems: true,  // Allow adding custom items
                addItemFilter: (value) => {
                    // Allow any non-empty string as custom value
                    return value && value.trim().length > 0;
                },
                choices: filter.data.map(item => ({
                    value: item,
                    label: item,
                    selected: false
                }))
            });
            
            // Add support for comma-separated values and Enter key
            const choicesInstance = manualChoicesInstances[filter.id];
            if (choicesInstance && choicesInstance.input) {
                const inputElement = choicesInstance.input.element;
                
                // Handle Enter key and comma key to add values
                inputElement.addEventListener('keydown', function(e) {
                    // Enter key or Comma key
                    if (e.key === 'Enter' || e.key === ',') {
                        e.preventDefault();
                        const inputValue = inputElement.value.trim();
                        
                        if (inputValue) {
                            // Check if it contains commas (multiple values)
                            if (inputValue.includes(',')) {
                                // Split by comma and add each value
                                const values = inputValue.split(',')
                                    .map(v => v.trim())
                                    .filter(v => v.length > 0);
                                
                                values.forEach(value => {
                                    if (value) {
                                        // Check if value already exists
                                        const existingValues = choicesInstance.getValue(true);
                                        if (!existingValues.includes(value)) {
                                            // Add as new item using addItem method
                                            choicesInstance.setChoiceByValue(value);
                                            // If that doesn't work, try adding it directly
                                            if (!choicesInstance.getValue(true).includes(value)) {
                                                choicesInstance._addItem({
                                                    value: value,
                                                    label: value
                                                });
                                                choicesInstance.setChoiceByValue(value);
                                            }
                                        }
                                    }
                                });
                                
                                // Clear input
                                inputElement.value = '';
                            } else {
                                // Single value - add it
                                const existingValues = choicesInstance.getValue(true);
                                if (!existingValues.includes(inputValue)) {
                                    // Add as new item using addItem method
                                    choicesInstance.setChoiceByValue(inputValue);
                                    // If that doesn't work, try adding it directly
                                    if (!choicesInstance.getValue(true).includes(inputValue)) {
                                        choicesInstance._addItem({
                                            value: inputValue,
                                            label: inputValue
                                        });
                                        choicesInstance.setChoiceByValue(inputValue);
                                    }
                                }
                                inputElement.value = '';
                            }
                        }
                    }
                });
                
                // Handle paste event to support pasting comma-separated values
                inputElement.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        const pastedValue = inputElement.value.trim();
                        if (pastedValue && pastedValue.includes(',')) {
                            e.preventDefault();
                            inputElement.value = ''; // Clear the input
                            
                            // Split and add all values
                            const values = pastedValue.split(',')
                                .map(v => v.trim())
                                .filter(v => v.length > 0);
                            
                            values.forEach(value => {
                                if (value) {
                                    const existingValues = choicesInstance.getValue(true);
                                    if (!existingValues.includes(value)) {
                                        // Add as new item using addItem method
                                        choicesInstance.setChoiceByValue(value);
                                        // If that doesn't work, try adding it directly
                                        if (!choicesInstance.getValue(true).includes(value)) {
                                            choicesInstance._addItem({
                                                value: value,
                                                label: value
                                            });
                                            choicesInstance.setChoiceByValue(value);
                                        }
                                    }
                                }
                            });
                        }
                    }, 10);
                });
            }
            
            // Force dropdown to always open below and ensure proper z-index
            // Note: choicesInstance is already defined above in the event listener section
            const choicesInstanceForZIndex = manualChoicesInstances[filter.id];
            if (choicesInstanceForZIndex && choicesInstanceForZIndex.containerOuter) {
                const containerOuter = choicesInstanceForZIndex.containerOuter.element;
                const filterGroup = containerOuter.closest('.filter-group');
                
                // Function to update dropdown position and z-index
                const updateDropdownPosition = () => {
                    setTimeout(() => {
                        const dropdown = containerOuter.querySelector('.choices__list--dropdown');
                        const isOpen = containerOuter.classList.contains('is-open');
                        
                        if (dropdown && isOpen) {
                            dropdown.style.top = '100%';
                            dropdown.style.bottom = 'auto';
                            dropdown.style.marginTop = '4px';
                            dropdown.style.zIndex = '1002';
                            if (filterGroup) {
                                filterGroup.style.zIndex = '1000';
                            }
                        } else if (filterGroup && !isOpen) {
                            // Reset z-index when dropdown closes
                            filterGroup.style.zIndex = '';
                        }
                    }, 10);
                };
                
                // Use MutationObserver to watch for class changes
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            updateDropdownPosition();
                        }
                    });
                });
                
                // Start observing the container for class changes
                observer.observe(containerOuter, {
                    attributes: true,
                    attributeFilter: ['class']
                });
                
                // Also handle click events as a fallback
                containerOuter.addEventListener('click', updateDropdownPosition);
                
                // Handle clicks outside to close dropdown
                document.addEventListener('click', function(e) {
                    if (!containerOuter.contains(e.target) && !containerOuter.classList.contains('is-open')) {
                        if (filterGroup) {
                            filterGroup.style.zIndex = '';
                        }
                    }
                });
            }
        }
    });

    // Initialize range sliders with noUiSlider
    if (typeof noUiSlider !== 'undefined') {
        initManualFeeSlider();
        initManualProjectValueSlider();
    }

    // Initialize date range pickers with Flatpickr
    if (typeof flatpickr !== 'undefined') {
        initManualDateRangePickers();
    }

    console.log('Manual filter inputs initialized');
}

/**
 * Initialize consultancy fee range slider
 */
function initManualFeeSlider() {
    const slider = document.getElementById('manualFeeSlider');
    if (!slider) return;

    const min = manualFilterOptions.consultancy_fee_range?.min || 0;
    const max = manualFilterOptions.consultancy_fee_range?.max || 100000000;

    if (min === max) return; // Don't create slider if no range

    // Store default range
    manualDefaultRanges.consultancy_fee = { min, max };

    manualSliderInstances.fee = noUiSlider.create(slider, {
        start: [min, max],
        connect: true,
        range: {
            'min': min,
            'max': max
        },
        format: {
            to: value => Math.round(value),
            from: value => Math.round(value)
        }
    });

    manualSliderInstances.fee.on('update', (values) => {
        document.getElementById('manualFeeMin').textContent = '‚Çπ' + formatCurrency(values[0]);
        document.getElementById('manualFeeMax').textContent = '‚Çπ' + formatCurrency(values[1]);
    });
}

/**
 * Initialize project value range slider
 */
function initManualProjectValueSlider() {
    const slider = document.getElementById('manualProjectValueSlider');
    if (!slider) return;

    const min = manualFilterOptions.project_value_range?.min || 0;
    const max = manualFilterOptions.project_value_range?.max || 1000000000;

    if (min === max) return; // Don't create slider if no range

    // Store default range
    manualDefaultRanges.project_value = { min, max };

    manualSliderInstances.projectValue = noUiSlider.create(slider, {
        start: [min, max],
        connect: true,
        range: {
            'min': min,
            'max': max
        },
        format: {
            to: value => Math.round(value),
            from: value => Math.round(value)
        }
    });

    manualSliderInstances.projectValue.on('update', (values) => {
        document.getElementById('manualProjectValueMin').textContent = '‚Çπ' + formatCurrency(values[0]);
        document.getElementById('manualProjectValueMax').textContent = '‚Çπ' + formatCurrency(values[1]);
    });
}

/**
 * Initialize date range pickers with validation
 */
function initManualDateRangePickers() {
    const startInput = document.getElementById('manualCompletionStartDate');
    const endInput = document.getElementById('manualCompletionEndDate');

    if (startInput) {
        manualDatePickers.start = flatpickr(startInput, {
            dateFormat: 'Y-m-d',
            maxDate: 'today',
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    // Set minDate for end date picker
                    if (manualDatePickers.end) {
                        manualDatePickers.end.set('minDate', dateStr);
                    }

                    // Validate date range
                    validateManualDateRange();
                }
            },
            onClose: function() {
                validateManualDateRange();
            }
        });
    }

    if (endInput) {
        manualDatePickers.end = flatpickr(endInput, {
            dateFormat: 'Y-m-d',
            maxDate: 'today',
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    // Set maxDate for start date picker
                    if (manualDatePickers.start) {
                        manualDatePickers.start.set('maxDate', dateStr);
                    }

                    // Validate date range
                    validateManualDateRange();
                }
            },
            onClose: function() {
                validateManualDateRange();
            }
        });
    }
}

/**
 * Validate manual clause date range
 */
function validateManualDateRange() {
    const startDate = manualDatePickers.start?.selectedDates[0];
    const endDate = manualDatePickers.end?.selectedDates[0];

    const startWrapper = document.querySelector('#manualCompletionStartDate').closest('.date-input-wrapper');
    const endWrapper = document.querySelector('#manualCompletionEndDate').closest('.date-input-wrapper');

    // Clear previous states
    startWrapper?.classList.remove('has-error', 'has-success');
    endWrapper?.classList.remove('has-error', 'has-success');

    // If both dates are selected, validate
    if (startDate && endDate) {
        if (endDate < startDate) {
            // Invalid range - end date is before start date
            endWrapper?.classList.add('has-error');
            console.warn('Invalid date range: end date cannot be before start date');
            return false;
        } else {
            // Valid range
            startWrapper?.classList.add('has-success');
            endWrapper?.classList.add('has-success');
            return true;
        }
    } else if (startDate || endDate) {
        // Only one date selected - add success state to the selected one
        if (startDate) startWrapper?.classList.add('has-success');
        if (endDate) endWrapper?.classList.add('has-success');
    }

    return true;
}

/**
 * Collect filter values from all inputs
 */
function collectManualFilterValues() {
    const filters = {};

    // Multi-select filters - collect both selected values AND any typed input
    Object.keys(manualChoicesInstances).forEach(key => {
        const choicesInstance = manualChoicesInstances[key];
        let values = choicesInstance.getValue(true); // Get selected values
        
        // Also check if there's any text in the input field that hasn't been added yet
        if (choicesInstance.input && choicesInstance.input.element) {
            const inputValue = choicesInstance.input.element.value.trim();
            if (inputValue) {
                // Check if it's comma-separated
                if (inputValue.includes(',')) {
                    const commaValues = inputValue.split(',')
                        .map(v => v.trim())
                        .filter(v => v.length > 0);
                    // Add comma-separated values to the list
                    values = [...(values || []), ...commaValues];
                } else {
                    // Single value in input - add it
                    if (!values.includes(inputValue)) {
                        values.push(inputValue);
                    }
                }
            }
        }
        
        const filterKey = key.replace('manualFilter', '').toLowerCase();

        // Map UI keys to API keys
        const keyMapping = {
            'clients': 'clients',
            'locations': 'locations',
            'services': 'services',
            'sectors': 'sectors',
            'subsectors': 'sub_sectors',
            'fundingagencies': 'funding_agencies',
            'roles': 'roles',
            'durations': 'durations',
            'certnumbers': 'certificate_numbers'
        };

        const apiKey = keyMapping[filterKey] || filterKey;
        if (values && values.length > 0) {
            // Remove duplicates and filter out empty strings
            const uniqueValues = [...new Set(values.filter(v => v && v.trim().length > 0))];
            if (uniqueValues.length > 0) {
                filters[apiKey] = uniqueValues;
                console.log(`‚úÖ Collected ${apiKey}:`, uniqueValues);
            }
        }
    });

    // Consultancy fee range (only if modified from default)
    if (manualSliderInstances.fee && manualDefaultRanges.consultancy_fee) {
        const values = manualSliderInstances.fee.get();
        const min = parseFloat(values[0]);
        const max = parseFloat(values[1]);
        const defaultMin = manualDefaultRanges.consultancy_fee.min;
        const defaultMax = manualDefaultRanges.consultancy_fee.max;

        // Only add if values differ from defaults
        if (min !== defaultMin || max !== defaultMax) {
            filters.consultancy_fee_range = { min, max };
            console.log(`‚úÖ Including consultancy_fee_range (modified): ‚Çπ${min.toLocaleString()} - ‚Çπ${max.toLocaleString()}`);
        } else {
            console.log(`‚è≠Ô∏è Skipping consultancy_fee_range (default): ‚Çπ${min.toLocaleString()} - ‚Çπ${max.toLocaleString()}`);
        }
    }

    // Project value range (only if modified from default)
    if (manualSliderInstances.projectValue && manualDefaultRanges.project_value) {
        const values = manualSliderInstances.projectValue.get();
        const min = parseFloat(values[0]);
        const max = parseFloat(values[1]);
        const defaultMin = manualDefaultRanges.project_value.min;
        const defaultMax = manualDefaultRanges.project_value.max;

        // Only add if values differ from defaults
        if (min !== defaultMin || max !== defaultMax) {
            filters.project_value_range = { min, max };
            console.log(`‚úÖ Including project_value_range (modified): ‚Çπ${min.toLocaleString()} - ‚Çπ${max.toLocaleString()}`);
        } else {
            console.log(`‚è≠Ô∏è Skipping project_value_range (default): ‚Çπ${min.toLocaleString()} - ‚Çπ${max.toLocaleString()}`);
        }
    }

    // Date range
    const startDate = document.getElementById('manualCompletionStartDate')?.value;
    const endDate = document.getElementById('manualCompletionEndDate')?.value;

    if (startDate || endDate) {
        filters.completion_date_range = {};
        if (startDate) filters.completion_date_range.start = startDate;
        if (endDate) filters.completion_date_range.end = endDate;
    }

    return filters;
}

/**
 * Perform manual clause search
 */
async function performManualSearch() {
    console.log('Performing manual search...');

    // Validate date range first
    if (!validateManualDateRange()) {
        alert('Please correct the date range. End date cannot be before start date.');
        return;
    }

    // Collect filter values
    const filters = collectManualFilterValues();
    console.log('Collected filters:', filters);

    // Count active filters
    const activeFilters = countActiveManualFilters(filters);
    console.log('Active filters count:', activeFilters);

    if (activeFilters === 0) {
        alert('Please apply at least one filter before searching');
        return;
    }

    // Show loading state
    showManualLoading();

    try {
        const response = await fetch('/api/certificates/manual-clause/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filters })
        });

        if (!response.ok) throw new Error('Search failed');

        const data = await response.json();
        console.log('Search results:', data);

        // Store results
        manualResults = data.results || [];
        manualCurrentFilters = filters;

        // Display results
        displayManualResults(data.results || [], data.compliance_summary);

        // Update summary
        document.getElementById('manualResultCount').textContent = data.results?.length || 0;
        document.getElementById('manualFiltersApplied').textContent = activeFilters;

        // Hide loading, show results
        hideManualLoading();
        document.getElementById('manualResultsSection').style.display = 'block';

        // Hide no results message if we have results
        if (data.results && data.results.length > 0) {
            document.getElementById('manualNoResults').style.display = 'none';
        } else {
            document.getElementById('manualNoResults').style.display = 'block';
        }

    } catch (error) {
        console.error('Search error:', error);
        hideManualLoading();
        alert('Search failed. Please try again.');
    }
}

/**
 * Count active filters
 * Note: Range filters (fee, value) are only included if modified from default position
 */
function countActiveManualFilters(filters) {
    let count = 0;

    // Multi-select filters
    const multiSelectKeys = ['clients', 'locations', 'services', 'sectors', 'sub_sectors',
                             'funding_agencies', 'roles', 'durations', 'certificate_numbers'];

    multiSelectKeys.forEach(key => {
        if (filters[key] && filters[key].length > 0) count++;
    });

    // Range filters (only present in filters object if modified from defaults)
    if (filters.consultancy_fee_range) count++;
    if (filters.project_value_range) count++;
    if (filters.completion_date_range) count++;

    return count;
}

/**
 * Display manual search results with keyword match counts
 */
function displayManualResults(results, summary, filterKeyword = null) {
    const grid = document.getElementById('manualResultsGrid');
    grid.innerHTML = '';

    if (!results || results.length === 0) {
        document.getElementById('manualNoResults').style.display = 'block';
        document.getElementById('manualResultsSection').style.display = 'none';
        return;
    }

    // Filter results by keyword if specified
    let filteredResults = results;
    if (filterKeyword === 'combined') {
        // Combined: Show only certificates that match ALL keywords
        filteredResults = results.filter(result => {
            const matchCount = result.match_count || 0;
            const totalKeywords = result.total_keywords || 0;
            return matchCount === totalKeywords && totalKeywords > 0;
        });
    } else if (filterKeyword) {
        // Individual keyword: Show certificates that match this specific keyword
        filteredResults = results.filter(result => {
            const matchedKeywords = result.matched_keywords || [];
            return matchedKeywords.includes(filterKeyword);
        });
    }

    if (filteredResults.length === 0) {
        const message = filterKeyword === 'combined' 
            ? 'No certificates match all keywords. Try individual keyword filters.'
            : 'No certificates match this keyword filter.';
        grid.innerHTML = `<div class="no-results-message">${message}</div>`;
        return;
    }

    // Render each certificate card
    filteredResults.forEach(result => {
        const card = createManualCertCard(result.certificate, result);
        grid.appendChild(card);
    });
}

/**
 * Create certificate card with keyword match badge
 */
function createManualCertCard(cert, result) {
    const card = document.createElement('div');
    card.className = 'manual-cert-card';
    
    // Extract match information
    const matchCount = result.match_count || 0;
    const totalKeywords = result.total_keywords || 0;
    const matchedKeywords = result.matched_keywords || [];
    
    // Determine badge style based on match percentage
    const percentage = totalKeywords > 0 ? (matchCount / totalKeywords) * 100 : 0;
    let badgeClass = 'compliance-badge--low';
    if (percentage === 100) badgeClass = 'compliance-badge--perfect';
    else if (percentage >= 75) badgeClass = 'compliance-badge--high';
    else if (percentage >= 50) badgeClass = 'compliance-badge--medium';

    const icon = percentage === 100 ? '‚úì' : percentage >= 50 ? '‚ö†' : '‚úó';

    // Build services, sectors display
    const servicesHtml = cert.services_rendered && cert.services_rendered.length > 0
        ? `<span class="cert-detail">üîß ${escapeHtml(Array.isArray(cert.services_rendered) ? cert.services_rendered.join(', ') : cert.services_rendered)}</span>`
        : '';

    const sectorsHtml = cert.sectors && cert.sectors.length > 0
        ? `<span class="cert-detail">üíº ${escapeHtml(Array.isArray(cert.sectors) ? cert.sectors.join(', ') : cert.sectors)}</span>`
        : '';

    // Build matched keywords display
    const matchedKeywordsHtml = matchedKeywords.length > 0
        ? `<div class="cert-matched-keywords">
            <span class="matched-label">Matched Keywords:</span>
            ${matchedKeywords.map(kw => `<span class="matched-keyword-chip">${escapeHtml(kw)}</span>`).join('')}
        </div>`
        : '';

    card.innerHTML = `
        <div class="compliance-badge ${badgeClass}">
            <span class="compliance-icon">${icon}</span>
            <span class="compliance-text">${matchCount}/${totalKeywords} Keywords</span>
        </div>

        <div class="cert-card-content">
            <h3 class="cert-card-title">${escapeHtml(cert.project_name || 'Unnamed Project')}</h3>
            <p class="cert-card-client">Client: ${escapeHtml(cert.client_name || 'N/A')}</p>

            <div class="cert-card-details">
                ${cert.location ? `<span class="cert-detail">üìç ${escapeHtml(cert.location)}</span>` : ''}
                ${servicesHtml}
                ${sectorsHtml}
            </div>

            <div class="cert-card-metrics">
                ${cert.consultancy_fee_inr ? `<span class="cert-metric">üí∞ ${escapeHtml(cert.consultancy_fee_inr)}</span>` : ''}
                ${cert.completion_date ? `<span class="cert-metric">üìÖ ${formatDate(cert.completion_date)}</span>` : ''}
            </div>

            ${matchedKeywordsHtml}
        </div>

        <div class="cert-card-actions">
            <button type="button" class="btn btn-sm btn-outline" onclick="viewCertificateDetails('${cert.id}')">
                View Details ‚Üí
            </button>
        </div>
    `;

    return card;
}

/**
 * Format filter name for display
 */
function formatFilterName(filterKey) {
    const names = {
        'clients': 'Client',
        'locations': 'Location',
        'services': 'Services',
        'sectors': 'Sectors',
        'sub_sectors': 'Sub-Sectors',
        'funding_agencies': 'Funding Agency',
        'roles': 'Role',
        'durations': 'Duration',
        'certificate_numbers': 'Cert Number',
        'consultancy_fee_range': 'Fee Range',
        'project_value_range': 'Value Range',
        'completion_date_range': 'Date Range'
    };
    return names[filterKey] || filterKey;
}

/**
 * Format date for display
 */
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
    } catch (e) {
        return dateString;
    }
}

/**
 * Format currency (simple version)
 */
function formatCurrency(value) {
    if (value >= 10000000) return (value / 10000000).toFixed(1) + 'Cr';
    if (value >= 100000) return (value / 100000).toFixed(1) + 'L';
    if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
    return value.toString();
}

/**
 * Escape HTML to prevent XSS
 */
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

/**
 * Clear all manual filters
 */
function clearAllManualFilters() {
    console.log('Clearing all filters...');

    // Clear all Choices.js instances
    Object.values(manualChoicesInstances).forEach(instance => {
        instance.removeActiveItems();
    });

    // Reset sliders
    if (manualSliderInstances.fee) {
        const min = manualFilterOptions.consultancy_fee_range?.min || 0;
        const max = manualFilterOptions.consultancy_fee_range?.max || 100000000;
        manualSliderInstances.fee.set([min, max]);
    }

    if (manualSliderInstances.projectValue) {
        const min = manualFilterOptions.project_value_range?.min || 0;
        const max = manualFilterOptions.project_value_range?.max || 1000000000;
        manualSliderInstances.projectValue.set([min, max]);
    }

    // Clear date pickers and validation states
    if (manualDatePickers.start) {
        manualDatePickers.start.clear();
        manualDatePickers.start.set('maxDate', 'today');
    }
    if (manualDatePickers.end) {
        manualDatePickers.end.clear();
        manualDatePickers.end.set('minDate', null);
    }

    // Clear date validation states
    const startWrapper = document.querySelector('#manualCompletionStartDate')?.closest('.date-input-wrapper');
    const endWrapper = document.querySelector('#manualCompletionEndDate')?.closest('.date-input-wrapper');
    startWrapper?.classList.remove('has-error', 'has-success');
    endWrapper?.classList.remove('has-error', 'has-success');

    // Hide results
    document.getElementById('manualResultsSection').style.display = 'none';
    document.getElementById('manualNoResults').style.display = 'none';

    console.log('All filters cleared');
}

// ============ AI Filter Functions ============

/**
 * Initialize AI filter section with event listeners
 */
function initAIFilterSection() {
    console.log('Initializing AI filter section...');

    const uploadBtn = document.getElementById('aiUploadBtn');
    const fileInput = document.getElementById('aiClauseImages');
    const extractBtn = document.getElementById('aiExtractBtn');
    const applyBtn = document.getElementById('aiApplyFiltersBtn');
    const cancelBtn = document.getElementById('aiCancelFiltersBtn');

    if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleAIImageUpload);
    }

    if (extractBtn) {
        extractBtn.addEventListener('click', performKeywordBasedSearch);
    }

    if (applyBtn) {
        applyBtn.addEventListener('click', applyAIFilters);
    }

    if (cancelBtn) {
        cancelBtn.addEventListener('click', closeAIPreview);
    }

    console.log('AI filter section initialized');
}

/**
 * Handle image upload and create previews
 */
async function handleAIImageUpload(event) {
    const files = Array.from(event.target.files);
    const previewGrid = document.getElementById('aiImagePreview');

    if (!previewGrid) return;

    previewGrid.innerHTML = '';
    aiUploadedImages = [];

    // Limit to 5 images
    const filesToProcess = files.slice(0, 5);

    for (const file of filesToProcess) {
        try {
            const base64 = await fileToBase64(file);
            aiUploadedImages.push(base64);

            // Create preview thumbnail
            const preview = createImagePreview(file, base64);
            previewGrid.appendChild(preview);
        } catch (error) {
            console.error('Error processing image:', error);
        }
    }

    if (files.length > 5) {
        showToast('‚ö†Ô∏è Only first 5 images will be used', 'warning');
    }

    console.log(`Loaded ${aiUploadedImages.length} images`);
}

/**
 * Convert file to base64 string
 */
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const base64 = reader.result.split(',')[1]; // Remove data:image/... prefix
            resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

/**
 * Create image preview element
 */
function createImagePreview(file, base64) {
    const container = document.createElement('div');
    container.className = 'image-preview-item';

    const img = document.createElement('img');
    img.src = `data:image/jpeg;base64,${base64}`;
    img.alt = file.name;

    const name = document.createElement('div');
    name.className = 'image-preview-name';
    name.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;

    container.appendChild(img);
    container.appendChild(name);

    return container;
}

/**
 * Main AI extraction workflow
 */
async function performKeywordBasedSearch() {
    const textInput = document.getElementById('aiClauseText');
    const text = textInput?.value?.trim();

    if (!text && aiUploadedImages.length === 0) {
        showToast('‚ö†Ô∏è Please provide text or upload images', 'warning');
        return;
    }

    try {
        // Step 1: Extract keywords
        updateAIProcessingText('Extracting keywords from clause...');
        showAIProcessing(true);
        hideKeywordDisplay();
        hideResults();

        console.log('üîç Step 1: Extracting keywords...');
        const extractResponse = await fetch('/api/certificates/extract-keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: text || null,
                images: aiUploadedImages.length > 0 ? aiUploadedImages : null
            })
        });

        if (!extractResponse.ok) {
            const error = await extractResponse.json();
            throw new Error(error.detail || 'Keyword extraction failed');
        }

        const extractData = await extractResponse.json();
        const keywords = extractData.keywords || [];
        
        if (keywords.length === 0) {
            showToast('‚ö†Ô∏è No keywords could be extracted from the clause. Please try a different clause or provide more details.', 'warning');
            showAIProcessing(false);
            hideKeywordDisplay();
            return;
        }
        
        // Limit keywords if too many
        if (keywords.length > 30) {
            showToast(`‚ö†Ô∏è Too many keywords (${keywords.length}). Using first 30 keywords.`, 'warning');
            keywords.splice(30);
        }

        console.log(`‚úÖ Extracted ${keywords.length} keywords:`, keywords);
        displayKeywords(keywords);

        // Step 2: Expand keywords
        updateAIProcessingText('Expanding keywords with AI...');
        console.log('üîç Step 2: Expanding keywords...');
        
        const expandResponse = await fetch('/api/certificates/expand-keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ keywords })
        });

        if (!expandResponse.ok) {
            const error = await expandResponse.json();
            throw new Error(error.detail || 'Keyword expansion failed');
        }

        const expandData = await expandResponse.json();
        const expandedVariants = expandData.expanded || {};
        
        console.log('‚úÖ Expanded keywords:', expandedVariants);
        
        // Check if expansion was successful
        if (Object.keys(expandedVariants).length === 0) {
            console.warn('‚ö†Ô∏è No keyword expansions received, using original keywords only');
            // Create default expansions (just the keyword itself)
            keywords.forEach(kw => {
                if (!expandedVariants[kw]) {
                    expandedVariants[kw] = [kw];
                }
            });
        }
        
        displayExpandedKeywords(expandedVariants);

        // Step 3: Search certificates
        updateAIProcessingText('Searching certificates...');
        console.log('üîç Step 3: Searching certificates...');
        
        const searchResponse = await fetch('/api/certificates/search-by-keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                keywords: keywords,
                expanded_variants: expandedVariants
            })
        });

        if (!searchResponse.ok) {
            const error = await searchResponse.json();
            throw new Error(error.detail || 'Search failed');
        }

        const searchData = await searchResponse.json();
        console.log('‚úÖ Search complete:', searchData);

        // Store results and keywords for filtering
        allKeywordResults = searchData.results || [];
        allKeywords = keywords;
        currentKeywordFilter = 'combined';

        // Create keyword filter buttons
        createKeywordFilterButtons(keywords);
        
        // Display results (Combined shows only certificates matching ALL keywords)
        displayManualResults(allKeywordResults, searchData.summary || {}, 'combined');
        
        // Update summary - count only certificates matching all keywords for Combined
        const combinedCount = allKeywordResults.filter(result => {
            const matchCount = result.match_count || 0;
            const totalKeywords = result.total_keywords || 0;
            return matchCount === totalKeywords && totalKeywords > 0;
        }).length;
        document.getElementById('manualResultCount').textContent = combinedCount;
        document.getElementById('keywordCount').textContent = keywords.length;

        // Show results section
        document.getElementById('manualResultsSection').style.display = 'block';
        
        if (searchData.results && searchData.results.length > 0) {
            document.getElementById('manualNoResults').style.display = 'none';
        } else {
            document.getElementById('manualNoResults').style.display = 'block';
            document.getElementById('manualNoResults').querySelector('p').textContent = 
                'No certificates match the extracted keywords. Try a different clause.';
        }

        showAIProcessing(false);
        showToast(`‚úÖ Found ${searchData.results?.length || 0} matching certificates`, 'success');

    } catch (error) {
        console.error('‚ùå Keyword-based search error:', error);
        
        // Handle specific error cases
        let errorMessage = error.message || 'Search failed';
        
        if (error.message.includes('rate limit') || error.message.includes('RateLimit')) {
            errorMessage = 'API rate limit reached. Please wait a moment and try again.';
        } else if (error.message.includes('timeout')) {
            errorMessage = 'Request timed out. Please try again with fewer keywords.';
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
            errorMessage = 'Network error. Please check your connection and try again.';
        }
        
        showToast(`‚ùå ${errorMessage}`, 'error');
        showAIProcessing(false);
        hideKeywordDisplay();
        hideResults();
    }
}

/**
 * Show/hide AI processing status
 */
function showAIProcessing(show) {
    const status = document.getElementById('aiProcessingStatus');
    const btn = document.getElementById('aiExtractBtn');

    if (status) {
        status.style.display = show ? 'flex' : 'none';
    }

    if (btn) {
        btn.disabled = show;
        btn.style.opacity = show ? '0.6' : '1';
    }
}

/**
 * Update AI processing text
 */
function updateAIProcessingText(text) {
    const textElement = document.getElementById('aiProcessingText');
    if (textElement) {
        textElement.textContent = text;
    }
}

/**
 * Display extracted keywords with remove buttons
 */
function displayKeywords(keywords) {
    const section = document.getElementById('keywordDisplaySection');
    const container = document.getElementById('keywordChipsContainer');
    
    if (!section || !container) return;
    
    // Store original keywords and initialize modified keywords
    originalKeywords = [...keywords];
    modifiedKeywords = [...keywords];
    keywordsModified = false;
    
    renderKeywordChips();
    
    // Hide update button initially
    document.getElementById('updateResultsContainer').style.display = 'none';
    
    section.style.display = 'block';
}

/**
 * Render keyword chips with remove buttons
 */
function renderKeywordChips() {
    const container = document.getElementById('keywordChipsContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    modifiedKeywords.forEach((keyword, index) => {
        const chip = document.createElement('div');
        chip.className = 'keyword-chip';
        chip.dataset.keywordIndex = index;
        
        const keywordText = document.createElement('span');
        keywordText.className = 'keyword-chip-text';
        keywordText.textContent = keyword;
        
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'keyword-chip-remove';
        removeBtn.innerHTML = '√ó';
        removeBtn.onclick = () => removeKeyword(index);
        removeBtn.title = 'Remove keyword';
        
        chip.appendChild(keywordText);
        chip.appendChild(removeBtn);
        container.appendChild(chip);
    });
}

/**
 * Remove a keyword
 */
function removeKeyword(index) {
    if (modifiedKeywords.length <= 1) {
        showToast('‚ö†Ô∏è At least one keyword is required', 'warning');
        return;
    }
    
    modifiedKeywords.splice(index, 1);
    keywordsModified = true;
    
    renderKeywordChips();
    showUpdateResultsButton();
}

/**
 * Show add keyword input
 */
function showAddKeywordInput() {
    const container = document.getElementById('addKeywordInputContainer');
    const input = document.getElementById('newKeywordInput');
    if (container && input) {
        container.style.display = 'flex';
        input.focus();
    }
}

/**
 * Hide add keyword input
 */
function hideAddKeywordInput() {
    const container = document.getElementById('addKeywordInputContainer');
    const input = document.getElementById('newKeywordInput');
    if (container && input) {
        container.style.display = 'none';
        input.value = '';
    }
}

/**
 * Handle Enter key in new keyword input
 */
function handleNewKeywordKeydown(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        addNewKeyword();
    } else if (event.key === 'Escape') {
        hideAddKeywordInput();
    }
}

/**
 * Add a new keyword
 */
function addNewKeyword() {
    const input = document.getElementById('newKeywordInput');
    if (!input) return;
    
    const newKeyword = input.value.trim();
    if (!newKeyword) {
        showToast('‚ö†Ô∏è Please enter a keyword', 'warning');
        return;
    }
    
    if (modifiedKeywords.includes(newKeyword)) {
        showToast('‚ö†Ô∏è This keyword already exists', 'warning');
        return;
    }
    
    modifiedKeywords.push(newKeyword);
    keywordsModified = true;
    
    renderKeywordChips();
    hideAddKeywordInput();
    showUpdateResultsButton();
}

/**
 * Show update results button
 */
function showUpdateResultsButton() {
    const container = document.getElementById('updateResultsContainer');
    if (container) {
        container.style.display = 'flex';
    }
}

/**
 * Update results with modified keywords
 */
async function updateResultsWithModifiedKeywords() {
    if (modifiedKeywords.length === 0) {
        showToast('‚ö†Ô∏è At least one keyword is required', 'warning');
        return;
    }
    
    try {
        updateAIProcessingText('Updating results with modified keywords...');
        showAIProcessing(true);
        
        // Step 1: Expand modified keywords
        console.log('üîÑ Expanding modified keywords...');
        const expandResponse = await fetch('/api/certificates/expand-keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ keywords: modifiedKeywords })
        });

        if (!expandResponse.ok) {
            const error = await expandResponse.json();
            throw new Error(error.detail || 'Keyword expansion failed');
        }

        const expandData = await expandResponse.json();
        const expandedVariants = expandData.expanded || {};
        
        // Create default expansions if needed
        modifiedKeywords.forEach(kw => {
            if (!expandedVariants[kw]) {
                expandedVariants[kw] = [kw];
            }
        });
        
        console.log('‚úÖ Expanded modified keywords:', expandedVariants);
        displayExpandedKeywords(expandedVariants);

        // Step 2: Search certificates with modified keywords
        updateAIProcessingText('Searching certificates...');
        console.log('üîÑ Searching with modified keywords...');
        
        const searchResponse = await fetch('/api/certificates/search-by-keywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                keywords: modifiedKeywords,
                expanded_variants: expandedVariants
            })
        });

        if (!searchResponse.ok) {
            const error = await searchResponse.json();
            throw new Error(error.detail || 'Search failed');
        }

        const searchData = await searchResponse.json();
        console.log('‚úÖ Search complete with modified keywords:', searchData);

        // Update stored data
        allKeywordResults = searchData.results || [];
        allKeywords = modifiedKeywords;
        currentKeywordFilter = 'combined';
        keywordsModified = false;

        // Create keyword filter buttons with modified keywords
        createKeywordFilterButtons(modifiedKeywords);
        
        // Display results
        displayManualResults(allKeywordResults, searchData.summary || {}, 'combined');
        
        // Update summary
        const combinedCount = allKeywordResults.filter(result => {
            const matchCount = result.match_count || 0;
            const totalKeywords = result.total_keywords || 0;
            return matchCount === totalKeywords && totalKeywords > 0;
        }).length;
        document.getElementById('manualResultCount').textContent = combinedCount;
        document.getElementById('keywordCount').textContent = modifiedKeywords.length;

        // Show results section
        document.getElementById('manualResultsSection').style.display = 'block';
        
        if (searchData.results && searchData.results.length > 0) {
            document.getElementById('manualNoResults').style.display = 'none';
        } else {
            document.getElementById('manualNoResults').style.display = 'block';
            document.getElementById('manualNoResults').querySelector('p').textContent = 
                'No certificates match the modified keywords. Try different keywords.';
        }

        // Hide update button
        document.getElementById('updateResultsContainer').style.display = 'none';

        showAIProcessing(false);
        showToast(`‚úÖ Updated results with ${modifiedKeywords.length} keywords. Found ${searchData.results?.length || 0} certificates.`, 'success');

    } catch (error) {
        console.error('‚ùå Error updating results:', error);
        showToast(`‚ùå Failed to update results: ${error.message}`, 'error');
        showAIProcessing(false);
    }
}

/**
 * Display expanded keyword variants
 */
function displayExpandedKeywords(expandedVariants) {
    const section = document.getElementById('keywordExpansionSection');
    const container = document.getElementById('keywordExpansionContainer');
    
    if (!section || !container) return;
    
    container.innerHTML = '';
    
    Object.entries(expandedVariants).forEach(([keyword, variants]) => {
        if (!variants || variants.length === 0) return;
        
        const item = document.createElement('div');
        item.className = 'keyword-expansion-item';
        
        const header = document.createElement('div');
        header.className = 'keyword-expansion-header';
        
        const keywordSpan = document.createElement('span');
        keywordSpan.className = 'keyword-expansion-keyword';
        keywordSpan.textContent = keyword;
        
        const toggle = document.createElement('button');
        toggle.className = 'keyword-expansion-toggle';
        toggle.textContent = 'Show variants';
        toggle.onclick = () => {
            const variantsDiv = item.querySelector('.keyword-variants');
            const isExpanded = variantsDiv.classList.contains('expanded');
            variantsDiv.classList.toggle('expanded');
            toggle.textContent = isExpanded ? 'Show variants' : 'Hide variants';
        };
        
        header.appendChild(keywordSpan);
        header.appendChild(toggle);
        
        const variantsDiv = document.createElement('div');
        variantsDiv.className = 'keyword-variants';
        
        variants.forEach(variant => {
            const variantChip = document.createElement('span');
            variantChip.className = 'keyword-variant-chip';
            variantChip.textContent = variant;
            variantsDiv.appendChild(variantChip);
        });
        
        item.appendChild(header);
        item.appendChild(variantsDiv);
        container.appendChild(item);
    });
    
    section.style.display = 'block';
}

/**
 * Hide keyword display section
 */
function hideKeywordDisplay() {
    const section = document.getElementById('keywordDisplaySection');
    if (section) {
        section.style.display = 'none';
    }
}

/**
 * Hide results section
 */
function hideResults() {
    const section = document.getElementById('manualResultsSection');
    if (section) {
        section.style.display = 'none';
    }
}

/**
 * Create keyword filter buttons
 */
function createKeywordFilterButtons(keywords) {
    const container = document.getElementById('keywordFilterButtons');
    if (!container) return;
    
    // Clear existing buttons (except Combined)
    const combinedBtn = container.querySelector('[data-keyword="combined"]');
    container.innerHTML = '';
    
    // Add Combined button
    if (combinedBtn) {
        container.appendChild(combinedBtn);
    } else {
        const combined = document.createElement('button');
        combined.type = 'button';
        combined.className = 'keyword-filter-btn keyword-filter-btn--active';
        combined.dataset.keyword = 'combined';
        combined.textContent = 'Combined';
        combined.onclick = () => filterResultsByKeyword('combined');
        container.appendChild(combined);
    }
    
    // Add buttons for each keyword
    keywords.forEach(keyword => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'keyword-filter-btn';
        btn.dataset.keyword = keyword;
        btn.textContent = keyword;
        btn.onclick = () => filterResultsByKeyword(keyword);
        container.appendChild(btn);
    });
    
    // Show the container
    container.style.display = 'flex';
}

/**
 * Filter results by keyword
 */
function filterResultsByKeyword(keyword) {
    // Update active button
    const buttons = document.querySelectorAll('.keyword-filter-btn');
    buttons.forEach(btn => {
        if (btn.dataset.keyword === keyword) {
            btn.classList.add('keyword-filter-btn--active');
        } else {
            btn.classList.remove('keyword-filter-btn--active');
        }
    });
    
    // Update current filter
    currentKeywordFilter = keyword;
    
    // Filter and display results
    displayManualResults(allKeywordResults, {}, keyword);
    
    // Update result count
    let filteredCount;
    if (keyword === 'combined') {
        // Combined: Count only certificates that match ALL keywords
        filteredCount = allKeywordResults.filter(result => {
            const matchCount = result.match_count || 0;
            const totalKeywords = result.total_keywords || 0;
            return matchCount === totalKeywords && totalKeywords > 0;
        }).length;
    } else {
        // Individual keyword: Count certificates that match this keyword
        filteredCount = allKeywordResults.filter(result => {
            const matchedKeywords = result.matched_keywords || [];
            return matchedKeywords.includes(keyword);
        }).length;
    }
    document.getElementById('manualResultCount').textContent = filteredCount;
}

/**
 * Show AI filter preview modal with matched filters
 */
function showAIFilterPreview(filters, scores) {
    const modal = document.getElementById('aiFilterPreviewModal');
    const grid = document.getElementById('aiFilterPreviewGrid');

    if (!modal || !grid) return;

    grid.innerHTML = '';

    // Define filter types with labels
    const filterTypes = [
        { key: 'clients', label: 'üè¢ Client Types', icon: 'üè¢' },
        { key: 'locations', label: 'üìç Locations', icon: 'üìç' },
        { key: 'services', label: 'üîß Services', icon: 'üîß' },
        { key: 'sectors', label: 'üíº Sectors', icon: 'üíº' },
        { key: 'sub_sectors', label: 'üèóÔ∏è Sub-Sectors', icon: 'üèóÔ∏è' },
        { key: 'funding_agencies', label: 'üí∞ Funding Agencies', icon: 'üí∞' },
        { key: 'roles', label: 'üë• Roles', icon: 'üë•' },
        { key: 'durations', label: '‚è±Ô∏è Durations', icon: '‚è±Ô∏è' },
        { key: 'consultancy_fee_range', label: 'üíµ Consultancy Fee Range', icon: 'üíµ' },
        { key: 'project_value_range', label: 'üíé Project Value Range', icon: 'üíé' },
        { key: 'completion_date_range', label: 'üìÖ Completion Date Range', icon: 'üìÖ' }
    ];

    let hasFilters = false;

    filterTypes.forEach(type => {
        const value = filters[type.key];
        if (value && ((Array.isArray(value) && value.length > 0) || (typeof value === 'object' && !Array.isArray(value)))) {
            hasFilters = true;
            const section = createFilterPreviewSection(
                type.label,
                value,
                scores[type.key] || 0
            );
            grid.appendChild(section);
        }
    });

    if (!hasFilters) {
        grid.innerHTML = '<div class="no-filters-message">No filters could be extracted from the provided text/images. Try providing more specific information.</div>';
    }

    // Show modal
    modal.style.display = 'flex';

    console.log('Preview modal displayed with filters:', Object.keys(filters));
}

/**
 * Create filter preview section
 */
function createFilterPreviewSection(label, values, confidence) {
    const section = document.createElement('div');
    section.className = 'filter-preview-section';

    const header = document.createElement('div');
    header.className = 'filter-preview-header';

    const title = document.createElement('span');
    title.className = 'filter-preview-title';
    title.textContent = label;

    const badge = document.createElement('span');
    badge.className = 'confidence-badge';
    const confidencePercent = Math.round(confidence * 100);
    badge.textContent = `${confidencePercent}% match`;

    if (confidencePercent >= 80) badge.style.backgroundColor = '#dcfce7';
    else if (confidencePercent >= 60) badge.style.backgroundColor = '#fef3c7';
    else badge.style.backgroundColor = '#fee2e2';

    header.appendChild(title);
    if (confidence > 0) header.appendChild(badge);

    section.appendChild(header);

    // Render values
    const chipsContainer = document.createElement('div');
    chipsContainer.className = 'filter-chips';

    if (Array.isArray(values)) {
        values.forEach(val => {
            const chip = document.createElement('span');
            chip.className = 'filter-chip';
            chip.textContent = val;
            chipsContainer.appendChild(chip);
        });
    } else if (typeof values === 'object') {
        // Range filter
        const chip = document.createElement('span');
        chip.className = 'filter-chip filter-chip-range';
        if (values.min !== null && values.min !== undefined && values.max !== null && values.max !== undefined) {
            chip.textContent = `‚Çπ${formatCurrency(values.min)} - ‚Çπ${formatCurrency(values.max)}`;
        } else if (values.min !== null && values.min !== undefined) {
            chip.textContent = `Min: ‚Çπ${formatCurrency(values.min)}`;
        } else if (values.max !== null && values.max !== undefined) {
            chip.textContent = `Max: ‚Çπ${formatCurrency(values.max)}`;
        } else if (values.start && values.end) {
            chip.textContent = `${values.start} to ${values.end}`;
        } else if (values.start) {
            chip.textContent = `From: ${values.start}`;
        } else if (values.end) {
            chip.textContent = `Until: ${values.end}`;
        }
        chipsContainer.appendChild(chip);
    }

    section.appendChild(chipsContainer);

    return section;
}

/**
 * Show AI filter preview with EDITABLE chips (new chip-based UI)
 */
function showAIFilterPreviewChips(filters) {
    const modal = document.getElementById('aiFilterPreviewModal');
    const grid = document.getElementById('aiFilterPreviewGrid');

    if (!modal || !grid) return;

    grid.innerHTML = '';

    // Define filter types with labels (using backend field names)
    const filterTypes = [
        { key: 'client_type', label: 'üè¢ Client Types', icon: 'üè¢', type: 'array' },
        { key: 'location', label: 'üìç Locations', icon: 'üìç', type: 'array' },
        { key: 'services', label: 'üîß Services Rendered', icon: 'üîß', type: 'array' },
        { key: 'sectors', label: 'üíº Sectors', icon: 'üíº', type: 'array' },
        { key: 'sub_sectors', label: 'üèóÔ∏è Sub-Sectors', icon: 'üèóÔ∏è', type: 'array' },
        { key: 'funding_agency', label: 'üí∞ Funding Agencies', icon: 'üí∞', type: 'array' },
        { key: 'role', label: 'üë• Roles', icon: 'üë•', type: 'array' },
        { key: 'duration', label: '‚è±Ô∏è Duration', icon: '‚è±Ô∏è', type: 'array' },
        { key: 'consultancy_fee_range', label: 'üíµ Consultancy Fee Range', icon: 'üíµ', type: 'range' },
        { key: 'project_value_range', label: 'üíé Project Value Range', icon: 'üíé', type: 'range' },
        { key: 'completion_date', label: 'üìÖ Completion Date Range', icon: 'üìÖ', type: 'daterange' },
        { key: 'certificate_date', label: 'üìú Certificate Date', icon: 'üìú', type: 'daterange' }
    ];

    let hasFilters = false;

    filterTypes.forEach(filterDef => {
        const value = filters[filterDef.key];

        // Skip if field doesn't exist or is empty
        if (!value) return;

        // Skip empty arrays
        if (Array.isArray(value) && value.length === 0) return;

        // Skip range/date objects with all null values
        if (typeof value === 'object' && !Array.isArray(value)) {
            const hasNonNullValue = Object.values(value).some(v => v !== null && v !== undefined);
            if (!hasNonNullValue) return;
        }

        // Valid filter found - render it
        if ((Array.isArray(value) && value.length > 0) || (typeof value === 'object' && !Array.isArray(value))) {
            hasFilters = true;
            const section = createEditableFilterSection(filterDef, value);
            grid.appendChild(section);
        }
    });

    if (!hasFilters) {
        grid.innerHTML = '<div class="no-filters-message">No tender requirements could be extracted. Try providing more specific eligibility criteria or requirements from the tender document.</div>';
    }

    // Show modal
    modal.style.display = 'flex';

    console.log('‚úÖ Editable chip preview displayed with filters:', Object.keys(filters));
}

/**
 * Create editable filter section with chip UI
 */
function createEditableFilterSection(filterDef, values) {
    const section = document.createElement('div');
    section.className = 'filter-preview-section';

    const header = document.createElement('div');
    header.className = 'filter-preview-header';

    const title = document.createElement('span');
    title.className = 'filter-preview-title';
    title.textContent = filterDef.label;

    header.appendChild(title);
    section.appendChild(header);

    // Render chips container
    const chipsContainer = document.createElement('div');
    chipsContainer.className = 'filter-chips editable-chips-container';
    chipsContainer.dataset.filterKey = filterDef.key;

    if (filterDef.type === 'array' && Array.isArray(values)) {
        // Array filters: render editable chips
        values.forEach((val, index) => {
            const chip = createEditableChip(val, filterDef.key, index);
            chipsContainer.appendChild(chip);
        });

        // Add "+" button to add new values
        const addBtn = document.createElement('button');
        addBtn.className = 'add-chip-btn';
        addBtn.innerHTML = '‚ûï Add';
        addBtn.onclick = () => addNewChipValue(filterDef.key, chipsContainer);
        chipsContainer.appendChild(addBtn);

    } else if (filterDef.type === 'range') {
        // Range filters: render range chip
        const rangeChip = createRangeChip(values, filterDef.key);
        chipsContainer.appendChild(rangeChip);

    } else if (filterDef.type === 'daterange') {
        // Date range filters
        const dateChip = createDateRangeChip(values, filterDef.key);
        chipsContainer.appendChild(dateChip);
    }

    section.appendChild(chipsContainer);

    return section;
}

/**
 * Create an editable chip for array values
 */
function createEditableChip(value, filterKey, index) {
    const chip = document.createElement('div');
    chip.className = 'editable-chip';
    chip.dataset.filterKey = filterKey;
    chip.dataset.chipIndex = index;
    chip.dataset.originalValue = value;

    const valueSpan = document.createElement('span');
    valueSpan.className = 'chip-value';
    valueSpan.textContent = value;

    const editBtn = document.createElement('button');
    editBtn.className = 'chip-edit-btn';
    editBtn.innerHTML = '‚úèÔ∏è';
    editBtn.title = 'Edit';
    editBtn.onclick = (e) => {
        e.stopPropagation();
        editChipValue(chip, valueSpan);
    };

    const removeBtn = document.createElement('button');
    removeBtn.className = 'chip-remove-btn';
    removeBtn.innerHTML = '‚ùå';
    removeBtn.title = 'Remove';
    removeBtn.onclick = (e) => {
        e.stopPropagation();
        removeChipValue(chip, filterKey);
    };

    chip.appendChild(valueSpan);
    chip.appendChild(editBtn);
    chip.appendChild(removeBtn);

    return chip;
}

/**
 * Create a range chip (for fee/value ranges)
 */
function createRangeChip(rangeValues, filterKey) {
    const chip = document.createElement('div');
    chip.className = 'editable-chip range-chip';
    chip.dataset.filterKey = filterKey;

    let displayText = '';
    if (rangeValues.min !== null && rangeValues.min !== undefined && rangeValues.max !== null && rangeValues.max !== undefined) {
        displayText = `‚Çπ${formatCurrency(rangeValues.min)} - ‚Çπ${formatCurrency(rangeValues.max)}`;
    } else if (rangeValues.min !== null && rangeValues.min !== undefined) {
        displayText = `Min: ‚Çπ${formatCurrency(rangeValues.min)}`;
    } else if (rangeValues.max !== null && rangeValues.max !== undefined) {
        displayText = `Max: ‚Çπ${formatCurrency(rangeValues.max)}`;
    }

    const valueSpan = document.createElement('span');
    valueSpan.className = 'chip-value';
    valueSpan.textContent = displayText;

    const editBtn = document.createElement('button');
    editBtn.className = 'chip-edit-btn';
    editBtn.innerHTML = '‚úèÔ∏è';
    editBtn.title = 'Edit Range';
    editBtn.onclick = (e) => {
        e.stopPropagation();
        editRangeChip(chip, rangeValues, filterKey);
    };

    chip.appendChild(valueSpan);
    chip.appendChild(editBtn);

    return chip;
}

/**
 * Create a date range chip (backend uses "after" and "before" keys)
 */
function createDateRangeChip(dateValues, filterKey) {
    const chip = document.createElement('div');
    chip.className = 'editable-chip date-chip';
    chip.dataset.filterKey = filterKey;

    let displayText = '';
    if (dateValues.after && dateValues.before) {
        displayText = `${dateValues.after} to ${dateValues.before}`;
    } else if (dateValues.after) {
        displayText = `After: ${dateValues.after}`;
    } else if (dateValues.before) {
        displayText = `Before: ${dateValues.before}`;
    }

    const valueSpan = document.createElement('span');
    valueSpan.className = 'chip-value';
    valueSpan.textContent = displayText;

    const editBtn = document.createElement('button');
    editBtn.className = 'chip-edit-btn';
    editBtn.innerHTML = '‚úèÔ∏è';
    editBtn.title = 'Edit Dates';
    editBtn.onclick = (e) => {
        e.stopPropagation();
        editDateRangeChip(chip, dateValues, filterKey);
    };

    chip.appendChild(valueSpan);
    chip.appendChild(editBtn);

    return chip;
}

/**
 * Edit chip value inline
 */
function editChipValue(chipElement, valueSpan) {
    const currentValue = valueSpan.textContent;
    const filterKey = chipElement.dataset.filterKey;

    // Create input field
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'chip-edit-input';
    input.value = currentValue;

    // Replace value span with input
    chipElement.replaceChild(input, valueSpan);
    input.focus();
    input.select();

    // Handle save on Enter or blur
    const saveEdit = () => {
        const newValue = input.value.trim();
        if (newValue && newValue !== currentValue) {
            valueSpan.textContent = newValue;
            chipElement.dataset.originalValue = newValue;

            // Update aiExtractedFilters
            updateFilterValue(filterKey, chipElement.dataset.chipIndex, newValue);
        } else {
            valueSpan.textContent = currentValue;
        }
        chipElement.replaceChild(valueSpan, input);
    };

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
        } else if (e.key === 'Escape') {
            valueSpan.textContent = currentValue;
            chipElement.replaceChild(valueSpan, input);
        }
    });

    input.addEventListener('blur', saveEdit);
}

/**
 * Remove chip value
 */
function removeChipValue(chipElement, filterKey) {
    const chipIndex = parseInt(chipElement.dataset.chipIndex);

    // Remove from aiExtractedFilters
    if (aiExtractedFilters && aiExtractedFilters[filterKey] && Array.isArray(aiExtractedFilters[filterKey])) {
        aiExtractedFilters[filterKey].splice(chipIndex, 1);

        // Re-render the entire section to update indices
        const container = chipElement.closest('.editable-chips-container');
        if (container) {
            reRenderChipsContainer(filterKey, container);
        }

        console.log(`Removed chip from ${filterKey}. Updated:`, aiExtractedFilters[filterKey]);
    }
}

/**
 * Add new chip value
 */
function addNewChipValue(filterKey, container) {
    // Create input for new value
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'chip-edit-input';
    input.placeholder = 'Enter value...';
    input.style.marginRight = '8px';

    // Insert before the "+" button
    const addBtn = container.querySelector('.add-chip-btn');
    container.insertBefore(input, addBtn);
    input.focus();

    const saveNew = () => {
        const newValue = input.value.trim();
        if (newValue) {
            // Add to aiExtractedFilters
            if (!aiExtractedFilters[filterKey]) {
                aiExtractedFilters[filterKey] = [];
            }
            aiExtractedFilters[filterKey].push(newValue);

            // Re-render chips
            reRenderChipsContainer(filterKey, container);

            console.log(`Added new value to ${filterKey}:`, newValue);
        } else {
            input.remove();
        }
    };

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveNew();
        } else if (e.key === 'Escape') {
            input.remove();
        }
    });

    input.addEventListener('blur', () => {
        setTimeout(saveNew, 100); // Delay to allow clicking other elements
    });
}

/**
 * Update filter value in aiExtractedFilters
 */
function updateFilterValue(filterKey, chipIndex, newValue) {
    if (aiExtractedFilters && aiExtractedFilters[filterKey] && Array.isArray(aiExtractedFilters[filterKey])) {
        aiExtractedFilters[filterKey][chipIndex] = newValue;
        console.log(`Updated ${filterKey}[${chipIndex}] to:`, newValue);
    }
}

/**
 * Re-render chips container after add/remove
 */
function reRenderChipsContainer(filterKey, container) {
    const values = aiExtractedFilters[filterKey];
    if (!values || !Array.isArray(values)) return;

    // Clear existing chips (keep add button)
    const addBtn = container.querySelector('.add-chip-btn');
    container.innerHTML = '';

    // Re-create chips with updated indices
    values.forEach((val, index) => {
        const chip = createEditableChip(val, filterKey, index);
        container.appendChild(chip);
    });

    // Re-add the "+" button
    if (addBtn) {
        container.appendChild(addBtn);
    }
}

/**
 * Edit range chip (for fee/value ranges)
 */
function editRangeChip(chipElement, rangeValues, filterKey) {
    const valueSpan = chipElement.querySelector('.chip-value');
    const currentMin = rangeValues.min !== null && rangeValues.min !== undefined ? rangeValues.min : '';
    const currentMax = rangeValues.max !== null && rangeValues.max !== undefined ? rangeValues.max : '';

    // Create inline edit UI
    const editContainer = document.createElement('div');
    editContainer.style.display = 'flex';
    editContainer.style.gap = '8px';
    editContainer.style.alignItems = 'center';

    const minInput = document.createElement('input');
    minInput.type = 'number';
    minInput.className = 'chip-edit-input';
    minInput.placeholder = 'Min';
    minInput.value = currentMin;
    minInput.style.width = '100px';

    const maxInput = document.createElement('input');
    maxInput.type = 'number';
    maxInput.className = 'chip-edit-input';
    maxInput.placeholder = 'Max';
    maxInput.value = currentMax;
    maxInput.style.width = '100px';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = '‚úì';
    saveBtn.className = 'chip-edit-btn';
    saveBtn.style.background = 'rgba(34, 197, 94, 0.3)';

    editContainer.appendChild(minInput);
    editContainer.appendChild(document.createTextNode('‚Äî'));
    editContainer.appendChild(maxInput);
    editContainer.appendChild(saveBtn);

    // Replace value span with edit UI
    chipElement.replaceChild(editContainer, valueSpan);
    minInput.focus();

    const saveEdit = () => {
        const newMin = minInput.value.trim() ? parseFloat(minInput.value) : null;
        const newMax = maxInput.value.trim() ? parseFloat(maxInput.value) : null;

        // Update aiExtractedFilters
        aiExtractedFilters[filterKey] = {
            min: newMin,
            max: newMax
        };

        // Update display
        let displayText = '';
        if (newMin !== null && newMax !== null) {
            displayText = `‚Çπ${formatCurrency(newMin)} - ‚Çπ${formatCurrency(newMax)}`;
        } else if (newMin !== null) {
            displayText = `Min: ‚Çπ${formatCurrency(newMin)}`;
        } else if (newMax !== null) {
            displayText = `Max: ‚Çπ${formatCurrency(newMax)}`;
        }

        valueSpan.textContent = displayText;
        chipElement.replaceChild(valueSpan, editContainer);

        console.log(`Updated ${filterKey}:`, aiExtractedFilters[filterKey]);
    };

    saveBtn.onclick = saveEdit;

    minInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
        } else if (e.key === 'Escape') {
            chipElement.replaceChild(valueSpan, editContainer);
        }
    });

    maxInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
        } else if (e.key === 'Escape') {
            chipElement.replaceChild(valueSpan, editContainer);
        }
    });
}

/**
 * Edit date range chip (backend uses "after" and "before" keys)
 */
function editDateRangeChip(chipElement, dateValues, filterKey) {
    const valueSpan = chipElement.querySelector('.chip-value');
    const currentAfter = dateValues.after || '';
    const currentBefore = dateValues.before || '';

    // Create inline edit UI
    const editContainer = document.createElement('div');
    editContainer.style.display = 'flex';
    editContainer.style.gap = '8px';
    editContainer.style.alignItems = 'center';

    const afterInput = document.createElement('input');
    afterInput.type = 'date';
    afterInput.className = 'chip-edit-input';
    afterInput.value = currentAfter;
    afterInput.style.width = '140px';
    afterInput.placeholder = 'After';

    const beforeInput = document.createElement('input');
    beforeInput.type = 'date';
    beforeInput.className = 'chip-edit-input';
    beforeInput.value = currentBefore;
    beforeInput.style.width = '140px';
    beforeInput.placeholder = 'Before';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = '‚úì';
    saveBtn.className = 'chip-edit-btn';
    saveBtn.style.background = 'rgba(34, 197, 94, 0.3)';

    editContainer.appendChild(afterInput);
    editContainer.appendChild(document.createTextNode('to'));
    editContainer.appendChild(beforeInput);
    editContainer.appendChild(saveBtn);

    // Replace value span with edit UI
    chipElement.replaceChild(editContainer, valueSpan);
    afterInput.focus();

    const saveEdit = () => {
        const newAfter = afterInput.value.trim() || null;
        const newBefore = beforeInput.value.trim() || null;

        // Update aiExtractedFilters
        aiExtractedFilters[filterKey] = {
            after: newAfter,
            before: newBefore
        };

        // Update display
        let displayText = '';
        if (newAfter && newBefore) {
            displayText = `${newAfter} to ${newBefore}`;
        } else if (newAfter) {
            displayText = `After: ${newAfter}`;
        } else if (newBefore) {
            displayText = `Before: ${newBefore}`;
        }

        valueSpan.textContent = displayText;
        chipElement.replaceChild(valueSpan, editContainer);

        console.log(`Updated ${filterKey}:`, aiExtractedFilters[filterKey]);
    };

    saveBtn.onclick = saveEdit;

    [afterInput, beforeInput].forEach(input => {
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveEdit();
            } else if (e.key === 'Escape') {
                chipElement.replaceChild(valueSpan, editContainer);
            }
        });
    });
}

/**
 * Apply AI-extracted filters to manual filters
 */
function applyAIFilters() {
    if (!aiExtractedFilters) {
        console.error('No AI filters to apply');
        return;
    }

    console.log('Applying AI filters...', aiExtractedFilters);

    // Clear existing filters first (as per user preference: replace all)
    clearAllManualFilters();

    // Map backend filter keys to UI element IDs
    const elementMap = {
        'client_type': 'manualFilterClients',        // Backend: client_type ‚Üí Frontend: manualFilterClients
        'location': 'manualFilterLocations',         // Backend: location ‚Üí Frontend: manualFilterLocations
        'services': 'manualFilterServices',
        'sectors': 'manualFilterSectors',
        'sub_sectors': 'manualFilterSubSectors',
        'funding_agency': 'manualFilterFundingAgencies',  // Backend: funding_agency ‚Üí Frontend: manualFilterFundingAgencies
        'role': 'manualFilterRoles',                 // Backend: role ‚Üí Frontend: manualFilterRoles
        'duration': 'manualFilterDurations',         // Backend: duration ‚Üí Frontend: manualFilterDurations
        'certificate_numbers': 'manualFilterCertNumbers'
    };

    // Apply multi-select filters (with support for custom values)
    Object.keys(aiExtractedFilters).forEach(key => {
        const values = aiExtractedFilters[key];

        if (Array.isArray(values) && values.length > 0) {
            const elementId = elementMap[key];
            if (elementId && manualChoicesInstances[elementId]) {
                const choicesInstance = manualChoicesInstances[elementId];

                // Get existing choices
                const existingChoices = choicesInstance._store.choices.map(c => c.value);

                // Find which values are custom (not in dropdown)
                const customValues = values.filter(val => !existingChoices.includes(val));

                if (customValues.length > 0) {
                    // Add custom values to the dropdown first
                    const newChoices = customValues.map(val => ({
                        value: val,
                        label: val,
                        selected: false,
                        customProperties: { isCustom: true } // Mark as custom for styling
                    }));

                    choicesInstance.setChoices(newChoices, 'value', 'label', false);
                    console.log(`Added ${customValues.length} custom values to ${key}:`, customValues);
                }

                // Now select all values (both existing and custom)
                choicesInstance.setChoiceByValue(values);
                console.log(`Applied ${key}:`, values);
            }
        }
    });

    // Apply range filters (STRICT: Only if min > 0, don't apply if min=0 even with max set)
    if (aiExtractedFilters.consultancy_fee_range) {
        const range = aiExtractedFilters.consultancy_fee_range;

        // STRICT: Only apply if min > 0 (don't apply if min=0 even if max is set)
        if (manualSliderInstances.fee && range.min !== null && range.min > 0 && range.max !== null) {
            manualSliderInstances.fee.set([range.min, range.max]);
            console.log(`‚úÖ Applied consultancy fee range: ‚Çπ${range.min.toLocaleString()} - ‚Çπ${range.max.toLocaleString()}`);
        } else {
            console.warn(`‚ö†Ô∏è Skipped consultancy fee range (min=0 or incomplete): min=${range.min}, max=${range.max}`);
        }
    }

    if (aiExtractedFilters.project_value_range) {
        const range = aiExtractedFilters.project_value_range;

        // STRICT: Only apply if min > 0 (don't apply if min=0 even if max is set)
        if (manualSliderInstances.projectValue && range.min !== null && range.min > 0 && range.max !== null) {
            manualSliderInstances.projectValue.set([range.min, range.max]);
            console.log(`‚úÖ Applied project value range: ‚Çπ${range.min.toLocaleString()} - ‚Çπ${range.max.toLocaleString()}`);
        } else {
            console.warn(`‚ö†Ô∏è Skipped project value range (min=0 or incomplete): min=${range.min}, max=${range.max}`);
        }
    }

    // Apply completion date filters (backend returns "completion_date" with "after"/"before" keys)
    if (aiExtractedFilters.completion_date) {
        const dateRange = aiExtractedFilters.completion_date;
        // Only apply if at least one date is specified
        if (dateRange.after || dateRange.before) {
            if (manualDatePickers.start && dateRange.after) {
                manualDatePickers.start.setDate(dateRange.after);
                console.log(`‚úÖ Applied completion date start: ${dateRange.after}`);
            }
            if (manualDatePickers.end && dateRange.before) {
                manualDatePickers.end.setDate(dateRange.before);
                console.log(`‚úÖ Applied completion date end: ${dateRange.before}`);
            }
        }
    }

    // ========================================
    // üìä FILTER APPLICATION SUMMARY (Console Log)
    // ========================================
    console.log('\n' + '='.repeat(80));
    console.log('üìä AI FILTER APPLICATION SUMMARY');
    console.log('='.repeat(80));

    let appliedCount = 0;
    let skippedCount = 0;

    // Log array filters
    Object.keys(elementMap).forEach(backendKey => {
        const values = aiExtractedFilters[backendKey];
        const elementId = elementMap[backendKey];

        if (Array.isArray(values) && values.length > 0) {
            appliedCount++;
            console.log(`‚úÖ ${backendKey.toUpperCase()}: [${values.join(', ')}]`);
        }
    });

    // Log range filters
    if (aiExtractedFilters.consultancy_fee_range) {
        const range = aiExtractedFilters.consultancy_fee_range;
        if (range.min !== null && range.max !== null) {
            appliedCount++;
            console.log(`‚úÖ CONSULTANCY_FEE_RANGE: ‚Çπ${range.min.toLocaleString()} - ‚Çπ${range.max.toLocaleString()}`);
        } else {
            skippedCount++;
            console.log(`‚ö†Ô∏è CONSULTANCY_FEE_RANGE: Skipped (partial range: min=${range.min}, max=${range.max})`);
        }
    }

    if (aiExtractedFilters.project_value_range) {
        const range = aiExtractedFilters.project_value_range;
        if (range.min !== null && range.max !== null) {
            appliedCount++;
            console.log(`‚úÖ PROJECT_VALUE_RANGE: ‚Çπ${range.min.toLocaleString()} - ‚Çπ${range.max.toLocaleString()}`);
        } else {
            skippedCount++;
            console.log(`‚ö†Ô∏è PROJECT_VALUE_RANGE: Skipped (partial range: min=${range.min}, max=${range.max})`);
        }
    }

    // Log date filters
    if (aiExtractedFilters.completion_date) {
        const dateRange = aiExtractedFilters.completion_date;
        if (dateRange.after || dateRange.before) {
            appliedCount++;
            console.log(`‚úÖ COMPLETION_DATE: ${dateRange.after ? 'After ' + dateRange.after : ''} ${dateRange.before ? 'Before ' + dateRange.before : ''}`);
        }
    }

    if (aiExtractedFilters.certificate_date) {
        const dateRange = aiExtractedFilters.certificate_date;
        if (dateRange.after || dateRange.before) {
            appliedCount++;
            console.log(`‚úÖ CERTIFICATE_DATE: ${dateRange.after ? 'After ' + dateRange.after : ''} ${dateRange.before ? 'Before ' + dateRange.before : ''}`);
        }
    }

    console.log('='.repeat(80));
    console.log(`üìà Total Filters Applied: ${appliedCount} | Skipped: ${skippedCount}`);
    console.log('='.repeat(80) + '\n');

    // Close modal
    closeAIPreview();

    // Clear AI input for next use
    const textArea = document.getElementById('aiClauseText');
    const fileInput = document.getElementById('aiClauseImages');
    const previewGrid = document.getElementById('aiImagePreview');

    if (textArea) textArea.value = '';
    if (fileInput) fileInput.value = '';
    if (previewGrid) previewGrid.innerHTML = '';
    aiUploadedImages = [];

    // Show success message with count
    showToast(`‚úÖ ${appliedCount} AI filter(s) applied successfully! Review and click Search.`, 'success');
}

/**
 * Close AI preview modal
 */
function closeAIPreview() {
    const modal = document.getElementById('aiFilterPreviewModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

/**
 * Show toast notification
 */
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#6366f1'};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10001;
        font-size: 14px;
        font-weight: 600;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;

    document.body.appendChild(toast);

    // Remove after 4 seconds
    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

/**
 * Toggle filters panel visibility
 */
function toggleManualFilters() {
    const content = document.getElementById('manualFiltersContent');
    const icon = document.getElementById('manualToggleIcon');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}

/**
 * Show loading state
 */
function showManualLoading() {
    document.getElementById('manualLoadingSpinner').style.display = 'flex';
    document.getElementById('manualResultsSection').style.display = 'none';
    document.getElementById('manualNoResults').style.display = 'none';
}

/**
 * Hide loading state
 */
function hideManualLoading() {
    document.getElementById('manualLoadingSpinner').style.display = 'none';
}

/**
 * View certificate details (placeholder)
 */
function viewCertificateDetails(certId) {
    // TODO: Implement certificate details modal or redirect
    console.log('View certificate:', certId);
    alert('Certificate details view coming soon!');
}

// ============ End Manual Clause Filtering Functionality ============

/**
 * Initialize certificate tab functionality (lazy loaded)
 */
function initializeCertificateTab() {
    console.log('Initializing Certificate tab...');

    // Initialize all certificate search components
    initCertSearch();
    initCertFilters();

    certTabInitialized = true;
}

// ============ Certificate Search Functionality ============

// Certificate search state
let certFilterOptions = null;
let certChoicesInstances = {};
let certSliderInstances = {};
let certStartDatePicker = null;
let certEndDatePicker = null;
let certCurrentFilters = {};

/**
 * Initialize certificate search functionality
 */
function initCertSearch() {
    const searchInput = document.getElementById('certSearchInput');
    const searchButton = document.getElementById('certSearchButton');
    const showAllButton = document.getElementById('certShowAllButton');

    if (!searchInput || !searchButton || !showAllButton) {
        console.error('Certificate search elements not found');
        return;
    }

    // Restore previous search query from localStorage
    const savedQuery = localStorage.getItem('certificateSearchQuery');
    if (savedQuery) {
        searchInput.value = savedQuery;
    }

    // Search button click handler
    searchButton.addEventListener('click', async function() {
        const query = searchInput.value.trim();
        if (query) {
            localStorage.setItem('certificateSearchQuery', query);
            const filters = certSyncFiltersFromUI();
            await certPerformSearch(query, filters);
        }
    });

    // Show all button click handler
    showAllButton.addEventListener('click', async function() {
        searchInput.value = '';
        localStorage.removeItem('certificateSearchQuery');
        await certClearAllFilters(false);
        await certPerformSearch('', {});
    });

    // Enter key handler
    searchInput.addEventListener('keypress', async function(e) {
        if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
                localStorage.setItem('certificateSearchQuery', query);
                const filters = certSyncFiltersFromUI();
                await certPerformSearch(query, filters);
            }
        }
    });
}

/**
 * Initialize certificate filters
 */
async function initCertFilters() {
    try {
        // Fetch filter options from backend
        const response = await fetch('/api/certificates/filter-options');
        if (!response.ok) throw new Error('Failed to fetch filter options');

        const data = await response.json();
        certFilterOptions = data;

        // Initialize all filter components
        certInitializeChoicesJS();
        certInitializeSliders();
        certInitializeDatePicker();
        certInitializeFilterToggle();
        certInitializeFilterActions();

        // Load saved filters from localStorage
        certLoadSavedFilters();

        console.log('‚úÖ Certificate filters initialized successfully');
    } catch (error) {
        console.error('‚ùå Error initializing certificate filters:', error);
    }
}

/**
 * Initialize Choices.js for multi-select dropdowns
 */
function certInitializeChoicesJS() {
    const selectConfigs = [
        { id: 'certFilterClients', data: certFilterOptions.clients || [] },
        { id: 'certFilterLocations', data: certFilterOptions.locations || [] },
        { id: 'certFilterServices', data: certFilterOptions.services || [] },
        { id: 'certFilterSectors', data: certFilterOptions.sectors || [] },
        { id: 'certFilterSubSectors', data: certFilterOptions.sub_sectors || [] },
        { id: 'certFilterFundingAgencies', data: certFilterOptions.funding_agencies || [] }
    ];

    selectConfigs.forEach(config => {
        const element = document.getElementById(config.id);
        if (!element) return;

        // Clear existing options
        element.innerHTML = '';

        // Add options
        config.data.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.text = item;
            element.appendChild(option);
        });

        // Initialize Choices.js
        certChoicesInstances[config.id] = new Choices(element, {
            removeItemButton: true,
            searchEnabled: true,
            searchPlaceholderValue: 'Search...',
            noResultsText: 'No results found',
            itemSelectText: 'Click to select',
            allowHTML: false
        });
    });
}

/**
 * Initialize noUiSlider for range sliders
 */
function certInitializeSliders() {
    // Consultancy Fee Range Slider
    const feeRanges = certFilterOptions.ranges?.consultancy_fee || [];
    let feeMin, feeMax;

    if (feeRanges.length > 0) {
        feeMin = feeRanges[0].min;
        feeMax = feeRanges[feeRanges.length - 1].max;
    } else {
        feeMin = 0;
        feeMax = 100000000; // 10 Crore default max
    }

    const feeSlider = document.getElementById('certFeeRangeSlider');
    if (!feeSlider) return;

    try {
        certSliderInstances.feeRange = noUiSlider.create(feeSlider, {
            start: [feeMin, feeMax],
            connect: true,
            range: {
                'min': feeMin,
                'max': feeMax
            },
            step: Math.max(1, (feeMax - feeMin) / 100),
            tooltips: false
        });

        certSliderInstances.feeRange.on('update', function (values) {
            document.getElementById('certFeeRangeMin').textContent = certFormatCurrency(parseFloat(values[0]));
            document.getElementById('certFeeRangeMax').textContent = certFormatCurrency(parseFloat(values[1]));
        });
    } catch (error) {
        console.error('‚ùå Error creating fee range slider:', error);
    }

    // Project Value Range Slider
    const pvRange = certFilterOptions.ranges?.project_value || { min: 0, max: 1000000000 };
    const pvSlider = document.getElementById('certProjectValueSlider');
    if (!pvSlider) return;

    certSliderInstances.projectValue = noUiSlider.create(pvSlider, {
        start: [pvRange.min, pvRange.max],
        connect: true,
        range: {
            'min': pvRange.min,
            'max': pvRange.max
        },
        step: (pvRange.max - pvRange.min) / 100,
        tooltips: false
    });

    certSliderInstances.projectValue.on('update', function (values) {
        document.getElementById('certProjectValueMin').textContent = certFormatCurrency(parseFloat(values[0]));
        document.getElementById('certProjectValueMax').textContent = certFormatCurrency(parseFloat(values[1]));
    });
}

/**
 * Initialize Flatpickr for date pickers
 */
function certInitializeDatePicker() {
    const dateRange = certFilterOptions.ranges?.completion_date || {};
    const startInput = document.getElementById('certCompletionStartDate');
    const endInput = document.getElementById('certCompletionEndDate');

    if (!startInput || !endInput) return;

    try {
        // Destroy existing instances if any
        if (certStartDatePicker) certStartDatePicker.destroy();
        if (certEndDatePicker) certEndDatePicker.destroy();

        // Initialize Start Date Picker
        certStartDatePicker = flatpickr(startInput, {
            dateFormat: 'Y-m-d',
            clickOpens: true,
            allowInput: false,
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    if (certEndDatePicker) {
                        certEndDatePicker.set('minDate', dateStr);
                    }
                    setTimeout(() => instance.close(), 100);
                }
            }
        });

        // Initialize End Date Picker
        certEndDatePicker = flatpickr(endInput, {
            dateFormat: 'Y-m-d',
            clickOpens: true,
            allowInput: false,
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    if (certStartDatePicker) {
                        certStartDatePicker.set('maxDate', dateStr);
                    }
                    setTimeout(() => instance.close(), 100);
                }
            }
        });
    } catch (error) {
        console.error('‚ùå Error initializing date pickers:', error);
    }
}

/**
 * Initialize filter toggle functionality
 */
function certInitializeFilterToggle() {
    const toggleBtn = document.getElementById('certToggleFiltersBtn');
    const filtersContent = document.getElementById('certFiltersContent');

    if (!toggleBtn || !filtersContent) return;

    toggleBtn.addEventListener('click', function() {
        filtersContent.classList.toggle('collapsed');
        toggleBtn.classList.toggle('collapsed');

        const isCollapsed = filtersContent.classList.contains('collapsed');
        localStorage.setItem('certFiltersCollapsed', isCollapsed);
    });

    // Restore collapse state
    const wasCollapsed = localStorage.getItem('certFiltersCollapsed') === 'true';
    if (wasCollapsed) {
        filtersContent.classList.add('collapsed');
        toggleBtn.classList.add('collapsed');
    }
}

/**
 * Initialize filter action buttons
 */
function certInitializeFilterActions() {
    const applyBtn = document.getElementById('certApplyFiltersBtn');
    const clearBtn = document.getElementById('certClearFiltersBtn');

    if (applyBtn) applyBtn.addEventListener('click', certApplyFilters);
    if (clearBtn) clearBtn.addEventListener('click', () => certClearAllFilters(true));
}

/**
 * Collect current filter values
 */
function certCollectFilterValues() {
    const filters = {};

    // Multi-select filters
    const clients = certChoicesInstances.certFilterClients?.getValue(true) || [];
    const locations = certChoicesInstances.certFilterLocations?.getValue(true) || [];
    const services = certChoicesInstances.certFilterServices?.getValue(true) || [];
    const sectors = certChoicesInstances.certFilterSectors?.getValue(true) || [];
    const subSectors = certChoicesInstances.certFilterSubSectors?.getValue(true) || [];
    const fundingAgencies = certChoicesInstances.certFilterFundingAgencies?.getValue(true) || [];

    if (clients.length > 0) filters.clients = clients;
    if (locations.length > 0) filters.locations = locations;
    if (services.length > 0) filters.services = services;
    if (sectors.length > 0) filters.sectors = sectors;
    if (subSectors.length > 0) filters.sub_sectors = subSectors;
    if (fundingAgencies.length > 0) filters.funding_agencies = fundingAgencies;

    // Range filters
    if (certSliderInstances.feeRange) {
        const feeValues = certSliderInstances.feeRange.get();
        const feeRanges = certFilterOptions.ranges?.consultancy_fee || [];
        if (feeRanges.length > 0) {
            const feeMin = feeRanges[0].min;
            const feeMax = feeRanges[feeRanges.length - 1].max;
            if (parseFloat(feeValues[0]) !== feeMin || parseFloat(feeValues[1]) !== feeMax) {
                filters.consultancy_fee_range = {
                    min: parseFloat(feeValues[0]),
                    max: parseFloat(feeValues[1])
                };
            }
        }
    }

    if (certSliderInstances.projectValue) {
        const pvValues = certSliderInstances.projectValue.get();
        const pvRange = certFilterOptions.ranges?.project_value || { min: 0, max: 1000000000 };
        if (parseFloat(pvValues[0]) !== pvRange.min || parseFloat(pvValues[1]) !== pvRange.max) {
            filters.project_value_range = {
                min: parseFloat(pvValues[0]),
                max: parseFloat(pvValues[1])
            };
        }
    }

    // Date range filter
    const startDate = certStartDatePicker && certStartDatePicker.selectedDates.length > 0
        ? certFormatDateForAPI(certStartDatePicker.selectedDates[0])
        : null;
    const endDate = certEndDatePicker && certEndDatePicker.selectedDates.length > 0
        ? certFormatDateForAPI(certEndDatePicker.selectedDates[0])
        : null;

    if (startDate && endDate) {
        filters.completion_date_range = { start: startDate, end: endDate };
    } else if (startDate) {
        filters.completion_date_range = { start: startDate, end: null };
    } else if (endDate) {
        filters.completion_date_range = { start: null, end: endDate };
    }

    return filters;
}

/**
 * Sync filters from UI
 */
function certSyncFiltersFromUI(save = true) {
    certCurrentFilters = certCollectFilterValues();
    if (save) {
        localStorage.setItem('certificateFilters', JSON.stringify(certCurrentFilters));
    }
    return certCurrentFilters;
}

/**
 * Apply filters
 */
async function certApplyFilters() {
    const query = document.getElementById('certSearchInput').value.trim();
    const filters = certSyncFiltersFromUI();
    await certPerformSearch(query, filters);
}

/**
 * Clear all filters
 */
async function certClearAllFilters(triggerSearch = true) {
    // Reset Choices.js instances
    Object.values(certChoicesInstances).forEach(instance => {
        instance.removeActiveItems();
    });

    // Reset sliders
    if (certSliderInstances.feeRange) {
        const feeRanges = certFilterOptions.ranges?.consultancy_fee || [];
        if (feeRanges.length > 0) {
            certSliderInstances.feeRange.set([feeRanges[0].min, feeRanges[feeRanges.length - 1].max]);
        }
    }

    if (certSliderInstances.projectValue) {
        const pvRange = certFilterOptions.ranges?.project_value || { min: 0, max: 1000000000 };
        certSliderInstances.projectValue.set([pvRange.min, pvRange.max]);
    }

    // Reset date pickers
    if (certStartDatePicker) certStartDatePicker.clear();
    if (certEndDatePicker) certEndDatePicker.clear();

    // Clear stored filters
    certCurrentFilters = {};
    localStorage.removeItem('certificateFilters');

    if (triggerSearch) {
        const query = document.getElementById('certSearchInput').value.trim();
        await certPerformSearch(query, {});
    }
}

/**
 * Load saved filters from localStorage
 */
function certLoadSavedFilters() {
    try {
        const saved = localStorage.getItem('certificateFilters');
        if (!saved) return;

        const filters = JSON.parse(saved);

        // Restore Choices.js values
        if (filters.clients) certChoicesInstances.certFilterClients?.setChoiceByValue(filters.clients);
        if (filters.locations) certChoicesInstances.certFilterLocations?.setChoiceByValue(filters.locations);
        if (filters.services) certChoicesInstances.certFilterServices?.setChoiceByValue(filters.services);
        if (filters.sectors) certChoicesInstances.certFilterSectors?.setChoiceByValue(filters.sectors);
        if (filters.sub_sectors) certChoicesInstances.certFilterSubSectors?.setChoiceByValue(filters.sub_sectors);
        if (filters.funding_agencies) certChoicesInstances.certFilterFundingAgencies?.setChoiceByValue(filters.funding_agencies);

        // Restore sliders
        if (filters.consultancy_fee_range && certSliderInstances.feeRange) {
            certSliderInstances.feeRange.set([filters.consultancy_fee_range.min, filters.consultancy_fee_range.max]);
        }
        if (filters.project_value_range && certSliderInstances.projectValue) {
            certSliderInstances.projectValue.set([filters.project_value_range.min, filters.project_value_range.max]);
        }

        // Restore date range
        if (filters.completion_date_range) {
            if (filters.completion_date_range.start && certStartDatePicker) {
                certStartDatePicker.setDate(filters.completion_date_range.start);
            }
            if (filters.completion_date_range.end && certEndDatePicker) {
                certEndDatePicker.setDate(filters.completion_date_range.end);
            }
        }

        certCurrentFilters = filters;
    } catch (error) {
        console.error('Error loading saved filters:', error);
    }
}

/**
 * Pagination state for certificate search
 */
let certCurrentPage = 1;
const certPerPage = 30;
let certTotalPages = 1;
let certTotalCount = 0;
let certLastQuery = '';
let certLastFilters = {};

/**
 * Perform certificate search with pagination
 */
async function certPerformSearch(query, filters = {}, page = 1) {
    certClearResults();
    document.getElementById('certLoadingSpinner').style.display = 'block';
    
    // Store last search params for pagination navigation
    certLastQuery = query;
    certLastFilters = filters;
    certCurrentPage = page;

    try {
        const response = await fetch('/api/certificates/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query: query,
                filters: filters,
                page: page,
                per_page: certPerPage
            })
        });

        if (!response.ok) throw new Error('Search failed');

        const data = await response.json();
        document.getElementById('certLoadingSpinner').style.display = 'none';

        // Update pagination state
        certTotalCount = data.total || 0;
        certTotalPages = data.total_pages || 1;
        certCurrentPage = data.page || 1;

        if (data.certificates && data.certificates.length > 0) {
            certDisplayResults(data.certificates, query);
            certUpdateSearchStats(data.total);
            certUpdatePagination(data);

            // Show filters panel after search
            document.getElementById('certFiltersPanel').style.display = 'block';
        } else {
            certShowNoResults();
            certHidePagination();
        }
    } catch (error) {
        console.error('Search error:', error);
        document.getElementById('certLoadingSpinner').style.display = 'none';
        certHidePagination();
        alert('Search failed. Please try again.');
    }
}

/**
 * Navigate to a specific page
 */
function certGoToPage(page) {
    if (page < 1 || page > certTotalPages) return;
    certPerformSearch(certLastQuery, certLastFilters, page);
    
    // Scroll to top of results
    const resultsGrid = document.getElementById('certResultsGrid');
    if (resultsGrid) {
        resultsGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

/**
 * Update pagination controls
 */
function certUpdatePagination(data) {
    const container = document.getElementById('certPaginationContainer');
    if (!container) return;
    
    if (!data.total || data.total === 0 || data.total_pages <= 1) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    
    // Update info text
    const start = (data.page - 1) * data.per_page + 1;
    const end = Math.min(data.page * data.per_page, data.total);
    document.getElementById('certPaginationInfo').textContent = 
        `Showing ${start}-${end} of ${data.total} certificates`;
    
    // Enable/disable navigation buttons
    document.getElementById('certFirstPageBtn').disabled = !data.has_prev;
    document.getElementById('certPrevPageBtn').disabled = !data.has_prev;
    document.getElementById('certNextPageBtn').disabled = !data.has_next;
    document.getElementById('certLastPageBtn').disabled = !data.has_next;
    
    // Render page numbers
    certRenderPageNumbers(data.page, data.total_pages);
}

/**
 * Render page number buttons
 */
function certRenderPageNumbers(currentPage, totalPages) {
    const pagesContainer = document.getElementById('certPaginationPages');
    if (!pagesContainer) return;
    
    let html = '';
    
    // Show max 5 page numbers at a time
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);
    
    // Adjust if near start or end
    if (currentPage <= 3) {
        endPage = Math.min(5, totalPages);
    }
    if (currentPage >= totalPages - 2) {
        startPage = Math.max(1, totalPages - 4);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentPage;
        html += `
            <button class="cert-pagination-page ${isActive ? 'active' : ''}" 
                    onclick="certGoToPage(${i})"
                    ${isActive ? 'disabled' : ''}>
                ${i}
            </button>
        `;
    }
    
    pagesContainer.innerHTML = html;
}

/**
 * Hide pagination controls
 */
function certHidePagination() {
    const container = document.getElementById('certPaginationContainer');
    if (container) {
        container.style.display = 'none';
    }
}

/**
 * Display certificate search results
 */
function certDisplayResults(certificates, query) {
    const resultsGrid = document.getElementById('certResultsGrid');

    resultsGrid.innerHTML = certificates.map(cert => {
        const projectName = cert.project_name || 'Untitled Project';
        const clientName = cert.client_name || 'Unknown Client';
        const location = cert.location || 'Not specified';
        const completionDate = cert.completion_date
            ? new Date(cert.completion_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
            : 'Date not specified';
        const projectValue = cert.project_value
            ? `‚Çπ${cert.project_value.toLocaleString('en-IN')}`
            : 'Not specified';

        // Ensure services is always an array
        let services = [];
        if (cert.services_rendered) {
            if (Array.isArray(cert.services_rendered)) {
                services = cert.services_rendered;
            } else if (typeof cert.services_rendered === 'string') {
                try {
                    services = JSON.parse(cert.services_rendered);
                } catch (e) {
                    services = [];
                }
            }
        }

        const filename = cert.original_filename || 'Unknown file';

        const highlightedTitle = certHighlightText(projectName, query);
        const highlightedClient = certHighlightText(clientName, query);
        const highlightedLocation = certHighlightText(location, query);

        return `
            <article class="cert-material-card" onclick="certViewDetails('${cert.id}')">
                <!-- Header: Title + Client/Location + Completion Date -->
                <div class="cert-card-header">
                    <div class="cert-card-title-block">
                        <h2 class="cert-card-title">${highlightedTitle}</h2>
                        <p class="cert-card-subtitle">
                            ${highlightedClient}${location !== 'Not specified' ? ' ¬∑ ' + highlightedLocation : ''}
                        </p>
                    </div>
                    <span class="cert-card-status">üìÖ ${completionDate}</span>
                </div>

                <!-- Divider -->
                <div class="cert-card-divider"></div>

                <!-- Info Grid: Pills with key data -->
                <div class="cert-card-grid">
                    <div class="cert-pill">
                        <span class="cert-pill-label">Location</span>
                        <strong class="cert-pill-value">${highlightedLocation}</strong>
                    </div>
                    <div class="cert-pill">
                        <span class="cert-pill-label">Project Value</span>
                        <strong class="cert-pill-value">${projectValue}</strong>
                    </div>
                    <div class="cert-pill">
                        <span class="cert-pill-label">Certificate File</span>
                        <strong class="cert-pill-value" title="${filename}">${certTruncateText(filename, 25)}</strong>
                    </div>
                </div>

                <!-- Services Section -->
                ${services.length > 0 ? `
                <div class="cert-services">
                    <div class="cert-services-title">Services Rendered</div>
                    <div class="cert-services-tags">
                        ${services.map(service => `
                            <span class="cert-service-tag">${certHighlightText(service, query)}</span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Attachment Section -->
                <div class="cert-attachment-section">
                    <div class="cert-attachment-header">
                        <span class="cert-attachment-icon">üîó</span>
                        <span class="cert-attachment-title">Attach to Tender</span>
                    </div>

                    ${cert.attached_tenders_count > 0 ? `
                        <div class="cert-attached-info">
                            <span class="cert-attached-badge">‚úì Attached to ${cert.attached_tenders_count} tender(s)</span>
                            <button type="button"
                                    class="cert-view-attachments-btn"
                                    onclick="event.stopPropagation(); certViewAttachments('${cert.id}')">
                                View
                            </button>
                        </div>
                    ` : ''}

                    <div class="cert-attachment-controls">
                        <select class="cert-tender-dropdown"
                                id="tender-dropdown-${cert.id}"
                                onclick="event.stopPropagation()">
                            <option value="">Select a tender...</option>
                        </select>
                        <button type="button"
                                class="cert-attach-btn"
                                onclick="event.stopPropagation(); certAttachToTender('${cert.id}')"
                                disabled>
                            Attach
                        </button>
                    </div>
                </div>

                <!-- Footer: Actions -->
                <div class="cert-card-footer">
                    <div class="cert-card-chips">
                        <!-- Additional chips can go here if needed -->
                    </div>
                    <div class="cert-card-actions">
                        <button type="button" class="cert-action-btn" onclick="event.stopPropagation(); certViewDetails('${cert.id}')">
                            View Details ‚Üí
                        </button>
                    </div>
                </div>
            </article>
        `;
    }).join('');
}

/**
 * Highlight text matching search query
 */
function certHighlightText(text, query) {
    if (!query || !text) return text;
    const regex = new RegExp(`(${certEscapeRegExp(query)})`, 'gi');
    return text.replace(regex, '<span class="cert-highlight">$1</span>');
}

/**
 * Escape regex special characters
 */
function certEscapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/**
 * Truncate text to max length
 */
function certTruncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

/**
 * Update search stats
 */
function certUpdateSearchStats(count) {
    const searchStats = document.getElementById('certSearchStats');
    const resultCount = document.getElementById('certResultCount');
    resultCount.textContent = count;
    searchStats.style.display = 'block';
}

/**
 * Show no results message
 */
function certShowNoResults() {
    document.getElementById('certNoResults').style.display = 'block';
}

/**
 * Clear results
 */
function certClearResults() {
    document.getElementById('certResultsGrid').innerHTML = '';
    document.getElementById('certSearchStats').style.display = 'none';
    document.getElementById('certNoResults').style.display = 'none';
    document.getElementById('certLoadingSpinner').style.display = 'none';
}

/**
 * View certificate details
 */
function certViewDetails(certificateId) {
    window.location.href = `/certificate/${certificateId}`;
}

/**
 * Format currency helper
 */
function certFormatCurrency(value) {
    if (value >= 10000000) {
        return '‚Çπ' + (value / 10000000).toFixed(2) + ' Cr';
    } else if (value >= 100000) {
        return '‚Çπ' + (value / 100000).toFixed(2) + ' L';
    } else {
        return '‚Çπ' + value.toLocaleString('en-IN');
    }
}

/**
 * Format date for API
 */
function certFormatDateForAPI(date) {
    if (!(date instanceof Date) || isNaN(date.getTime())) return null;
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// ============================================================================
// CERTIFICATE-TENDER ATTACHMENT FUNCTIONS
// ============================================================================

let cachedFavoriteTenders = null;

/**
 * Load favorite tenders into all dropdowns
 */
async function certLoadFavoriteTendersIntoDropdowns() {
    try {
        // Fetch favorites if not cached
        if (!cachedFavoriteTenders) {
            const response = await fetch('/api/favorites/list-for-attachment', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                throw new Error('Failed to load favorites');
            }

            const data = await response.json();
            cachedFavoriteTenders = data.favorites || [];
        }

        // Populate all dropdowns on the page
        const dropdowns = document.querySelectorAll('.cert-tender-dropdown');
        dropdowns.forEach(dropdown => {
            // Clear existing options except first
            dropdown.innerHTML = '<option value="">Select a tender...</option>';

            // Add favorite tenders
            if (cachedFavoriteTenders.length === 0) {
                dropdown.innerHTML = '<option value="">No favorited tenders available</option>';
                dropdown.disabled = true;
                return;
            }

            cachedFavoriteTenders.forEach(tender => {
                const option = document.createElement('option');
                option.value = tender.tender_id;

                // Format title (truncate if too long)
                let title = tender.title;
                if (title.length > 60) {
                    title = title.substring(0, 57) + '...';
                }

                // Add authority and deadline info
                const authority = tender.authority || 'Unknown Authority';
                const deadline = tender.deadline ? new Date(tender.deadline).toLocaleDateString() : 'No deadline';

                option.textContent = `${title} | ${authority} | ${deadline}`;
                dropdown.appendChild(option);
            });

            // Enable attach button when tender is selected
            dropdown.addEventListener('change', function() {
                const certId = dropdown.id.replace('tender-dropdown-', '');
                const attachBtn = dropdown.parentElement.querySelector('.cert-attach-btn');
                attachBtn.disabled = !dropdown.value;
            });
        });

    } catch (error) {
        console.error('[CERT ATTACH] Error loading favorites:', error);
        certShowNotification('Failed to load favorited tenders', 'error');
    }
}

/**
 * Attach certificate to selected tender
 */
async function certAttachToTender(certificateId) {
    const dropdown = document.getElementById(`tender-dropdown-${certificateId}`);
    const tenderId = dropdown.value;

    if (!tenderId) {
        certShowNotification('Please select a tender first', 'warning');
        return;
    }

    try {
        // Show loading state
        const attachBtn = dropdown.parentElement.querySelector('.cert-attach-btn');
        const originalText = attachBtn.textContent;
        attachBtn.textContent = 'Attaching...';
        attachBtn.disabled = true;

        // Make API call
        const formData = new FormData();
        formData.append('tender_id', tenderId);

        const response = await fetch(`/api/certificates/${certificateId}/attach-to-tender`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Attachment failed');
        }

        // Success
        certShowNotification(`‚úì Certificate attached to "${data.tender_title}"`, 'success');

        // Reset dropdown
        dropdown.value = '';
        attachBtn.textContent = originalText;
        attachBtn.disabled = true;

        // Refresh the certificate search to show updated attachment status
        const searchInput = document.getElementById('certSearchInput');
        if (searchInput && typeof certPerformSearch === 'function') {
            certPerformSearch();
        }

    } catch (error) {
        console.error('[CERT ATTACH] Error attaching certificate:', error);
        certShowNotification(error.message || 'Failed to attach certificate', 'error');

        // Reset button
        const attachBtn = dropdown.parentElement.querySelector('.cert-attach-btn');
        attachBtn.textContent = 'Attach';
        attachBtn.disabled = false;
    }
}

/**
 * View all attachments for a certificate
 */
async function certViewAttachments(certificateId) {
    try {
        const response = await fetch(`/api/certificates/${certificateId}/attached-tenders`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error('Failed to load attachments');
        }

        // Show modal with attachments
        certShowAttachmentsModal(certificateId, data.attachments);

    } catch (error) {
        console.error('[CERT ATTACH] Error loading attachments:', error);
        certShowNotification('Failed to load attachments', 'error');
    }
}

/**
 * Show modal with certificate attachments
 */
function certShowAttachmentsModal(certificateId, attachments) {
    const modalHTML = `
        <div class="cert-attachments-modal-overlay" onclick="certCloseAttachmentsModal()">
            <div class="cert-attachments-modal-content" onclick="event.stopPropagation()">
                <div class="cert-attachments-modal-header">
                    <h3>Attached Tenders</h3>
                    <button onclick="certCloseAttachmentsModal()">√ó</button>
                </div>
                <div class="cert-attachments-modal-body">
                    ${attachments.length === 0 ? `
                        <p class="cert-no-attachments">No tenders attached</p>
                    ` : `
                        <div class="cert-attachments-list">
                            ${attachments.map(att => `
                                <div class="cert-attachment-item">
                                    <div class="cert-attachment-item-header">
                                        <h4>${att.tender_title}</h4>
                                        <button class="cert-detach-btn"
                                                onclick="certDetachFromTender('${certificateId}', '${att.tender_id}')">
                                            Detach
                                        </button>
                                    </div>
                                    <p class="cert-attachment-item-authority">${att.tender_authority || 'Unknown Authority'}</p>
                                    <p class="cert-attachment-item-meta">
                                        Attached on ${new Date(att.attached_at).toLocaleDateString()}
                                        ${att.tender_deadline ? ` | Deadline: ${new Date(att.tender_deadline).toLocaleDateString()}` : ''}
                                    </p>
                                    ${att.notes ? `<p class="cert-attachment-item-notes">${att.notes}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function certCloseAttachmentsModal() {
    const modal = document.querySelector('.cert-attachments-modal-overlay');
    if (modal) {
        modal.remove();
    }
}

/**
 * Detach certificate from tender
 */
async function certDetachFromTender(certificateId, tenderId) {
    if (!confirm('Are you sure you want to detach this certificate from the tender?')) {
        return;
    }

    try {
        const response = await fetch(`/api/certificates/${certificateId}/detach-from-tender/${tenderId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Detachment failed');
        }

        certShowNotification('Certificate detached successfully', 'success');
        certCloseAttachmentsModal();

        // Refresh the certificate search
        const searchInput = document.getElementById('certSearchInput');
        if (searchInput && typeof certPerformSearch === 'function') {
            certPerformSearch();
        }

    } catch (error) {
        console.error('[CERT DETACH] Error:', error);
        certShowNotification(error.message || 'Failed to detach certificate', 'error');
    }
}

/**
 * Show notification toast
 */
function certShowNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `cert-notification cert-notification-${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('cert-notification-show');
    }, 10);

    setTimeout(() => {
        notification.classList.remove('cert-notification-show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Load favorites after certificate search results are displayed
const originalCertDisplayResults = certDisplayResults;
certDisplayResults = function(...args) {
    originalCertDisplayResults.apply(this, args);
    // Load favorites into dropdowns after results are displayed
    setTimeout(certLoadFavoriteTendersIntoDropdowns, 100);
};

// ============ End Certificate-Tender Attachment Functions ============

// ============ End Certificate Search Functionality ============

// Restore last active tab on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedTab = localStorage.getItem('activeVaultTab') || 'project';
    console.log('Switching to tab:', savedTab);
    switchVaultTab(savedTab);
});

// ============ End Vault Tab Switching Functionality ============

// Upload modal state
let selectedExcelFile = null;

// Open upload modal
function openUploadModal() {
    const modal = document.getElementById('uploadModal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        // Reset state
        selectedExcelFile = null;
        updateFileDisplay();
    }
}

// Close upload modal
function closeUploadModal() {
    const modal = document.getElementById('uploadModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        // Clear file inputs
        document.getElementById('uploadExcelInput').value = '';
        // Reset state
        selectedExcelFile = null;
        updateFileDisplay();
        // Hide error
        document.getElementById('uploadError').style.display = 'none';
    }
}

// Handle Excel file selection
function handleExcelFileSelected(event) {
    const input = event.target;
    if (input && input.files && input.files.length > 0) {
        const file = input.files[0];

        // Validate file extension
        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            showUploadError('Please select a valid Excel file (.xlsx)');
            input.value = '';
            selectedExcelFile = null;
        } else {
            selectedExcelFile = file;
            hideUploadError();
        }

        updateFileDisplay();
    }
}

// Update file display and enable/disable submit button
function updateFileDisplay() {
    const excelNameEl = document.getElementById('excelFileName');
    const submitBtn = document.getElementById('uploadSubmitBtn');

    // Update Excel display
    if (selectedExcelFile) {
        excelNameEl.textContent = selectedExcelFile.name;
        excelNameEl.classList.add('has-file');
    } else {
        excelNameEl.textContent = 'No file selected';
        excelNameEl.classList.remove('has-file');
    }

    // Enable submit button only if Excel file is selected
    if (submitBtn) {
        submitBtn.disabled = !selectedExcelFile;
    }
}

// Clear file selections
function clearFileSelections() {
    document.getElementById('uploadExcelInput').value = '';
    selectedExcelFile = null;
    updateFileDisplay();
    hideUploadError();
}

// Show upload error
function showUploadError(message) {
    const errorEl = document.getElementById('uploadError');
    if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
    }
}

// Hide upload error
function hideUploadError() {
    const errorEl = document.getElementById('uploadError');
    if (errorEl) {
        errorEl.style.display = 'none';
    }
}

// Submit project upload
function submitProjectUpload() {
    if (!selectedExcelFile) {
        showUploadError('Please select an Excel file before uploading.');
        return;
    }

    // Validate file sizes (optional, add limits as needed)
    const MAX_EXCEL_SIZE = 10 * 1024 * 1024; // 10 MB

    if (selectedExcelFile.size > MAX_EXCEL_SIZE) {
        showUploadError('Excel file is too large. Maximum size is 10 MB.');
        return;
    }

    // Submit the form
    const form = document.getElementById('uploadProjectsForm');
    if (form) {
        // Disable submit button to prevent double submission
        const submitBtn = document.getElementById('uploadSubmitBtn');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';
        }

        form.submit();
    }
}

// ============ Delete All Projects Modal Functions ============

// Open delete all modal
function openDeleteAllModal() {
    const modal = document.getElementById('deleteAllModal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        // Reset state
        document.getElementById('deleteConfirmationInput').value = '';
        document.getElementById('deleteAllSubmitBtn').disabled = true;
        document.getElementById('deleteConfirmationError').style.display = 'none';
        document.getElementById('deleteError').style.display = 'none';
    }
}

// Close delete all modal
function closeDeleteAllModal() {
    const modal = document.getElementById('deleteAllModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        // Reset state
        document.getElementById('deleteConfirmationInput').value = '';
        document.getElementById('deleteAllSubmitBtn').disabled = true;
        document.getElementById('deleteConfirmationError').style.display = 'none';
        document.getElementById('deleteError').style.display = 'none';
    }
}

// Validate delete confirmation input
function validateDeleteConfirmation() {
    const input = document.getElementById('deleteConfirmationInput');
    const submitBtn = document.getElementById('deleteAllSubmitBtn');
    const errorEl = document.getElementById('deleteConfirmationError');

    const value = input.value;

    if (value === 'DELETE') {
        // Exact match - enable button
        submitBtn.disabled = false;
        errorEl.style.display = 'none';
        input.style.borderColor = '#10b981'; // Green border
    } else if (value.length > 0) {
        // User is typing but hasn't matched yet
        submitBtn.disabled = true;
        errorEl.style.display = 'block';
        input.style.borderColor = '#ef4444'; // Red border
    } else {
        // Empty input
        submitBtn.disabled = true;
        errorEl.style.display = 'none';
        input.style.borderColor = ''; // Default border
    }
}

// Confirm and execute delete all projects
async function confirmDeleteAllProjects() {
    const input = document.getElementById('deleteConfirmationInput');
    const submitBtn = document.getElementById('deleteAllSubmitBtn');
    const btnText = document.getElementById('deleteAllBtnText');
    const btnSpinner = document.getElementById('deleteAllBtnSpinner');
    const errorEl = document.getElementById('deleteError');

    // Final validation
    if (input.value !== 'DELETE') {
        errorEl.textContent = 'Please type DELETE exactly as shown (all capital letters)';
        errorEl.style.display = 'block';
        return;
    }

    // Disable button and show loading state
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnSpinner.style.display = 'inline-block';

    try {
        const response = await fetch('/api/projects/delete-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                confirmation_text: input.value
            })
        });

        const data = await response.json();

        if (data.success) {
            // Success - close modal and reload page
            closeDeleteAllModal();

            // Show success message
            alert(`‚úÖ Successfully deleted ${data.deleted_count} project(s). The page will now reload.`);

            // Reload page to reflect changes
            const reloadURL = IS_TEST_MODE
                ? `${TEST_BASE_URL}?test_token=${TEST_TOKEN}&show_all=true`
                : '/projects?show_all=true';
            window.location.href = reloadURL;
        } else {
            // Error from server
            errorEl.textContent = data.error || 'Failed to delete projects. Please try again.';
            errorEl.style.display = 'block';

            // Re-enable button
            submitBtn.disabled = false;
            btnText.style.display = 'inline-block';
            btnSpinner.style.display = 'none';
        }
    } catch (error) {
        console.error('Error deleting projects:', error);
        errorEl.textContent = 'Network error. Please check your connection and try again.';
        errorEl.style.display = 'block';

        // Re-enable button
        submitBtn.disabled = false;
        btnText.style.display = 'inline-block';
        btnSpinner.style.display = 'none';
    }
}

// Load sector counts
async function loadSectorCounts() {
    const sectorCards = document.querySelectorAll('.project-overview-card--sector[data-sector]');

    for (let card of sectorCards) {
        const sector = card.getAttribute('data-sector');
        const countElement = card.querySelector('.project-overview-card__number');

        try {
            const apiURL = IS_TEST_MODE
                ? `${TEST_BASE_URL}/api/sector-count?test_token=${TEST_TOKEN}&sector=${encodeURIComponent(sector)}`
                : `/api/projects/sector-count?sector=${encodeURIComponent(sector)}`;
            const response = await fetch(apiURL);
            const data = await response.json();
            countElement.innerHTML = data.count || 0;
        } catch (error) {
            console.error('Error loading sector count:', error);
            countElement.innerHTML = '0';
        }
    }
}

// Toggle project detail sections (description and scope of work)
function toggleProjectDetail(contentId) {
    const contentDiv = document.getElementById(contentId);
    if (!contentDiv) return;

    const previewDiv = contentDiv.querySelector('.project-detail-text--preview');
    const fullDiv = contentDiv.querySelector('.project-detail-text--full');
    const toggleBtn = contentDiv.querySelector('.project-detail-toggle');

    if (!previewDiv || !fullDiv || !toggleBtn) return;

    const moreText = toggleBtn.querySelector('.toggle-text-more');
    const lessText = toggleBtn.querySelector('.toggle-text-less');

    // Toggle visibility
    if (fullDiv.style.display === 'none') {
        // Show full text
        previewDiv.style.display = 'none';
        fullDiv.style.display = 'block';
        moreText.style.display = 'none';
        lessText.style.display = 'inline';
    } else {
        // Show preview text
        previewDiv.style.display = 'block';
        fullDiv.style.display = 'none';
        moreText.style.display = 'inline';
        lessText.style.display = 'none';
    }
}

// Handle sector card clicks
function handleSectorCardClick(event) {
    const sectorCard = event.target.closest('[data-sector]');
    if (sectorCard) {
        const sector = sectorCard.getAttribute('data-sector');
        // Set the sector filter and submit the form
        document.getElementById('sector_filter').value = sector;
        const form = document.querySelector('form.advanced-search-form');
        if (form) {
            form.submit();
        }
    }
}

// Handle "All Projects" card click
function handleAllProjectsClick() {
    // Clear the sector filter and set a flag to show all projects
    const form = document.querySelector('form.advanced-search-form');
    document.getElementById('sector_filter').value = '';
    // Add a hidden input to indicate we want to show all projects
    let showAllInput = document.getElementById('show_all');
    if (!showAllInput) {
        showAllInput = document.createElement('input');
        showAllInput.type = 'hidden';
        showAllInput.name = 'show_all';
        showAllInput.id = 'show_all';
        showAllInput.value = 'true';
        form.appendChild(showAllInput);
    } else {
        showAllInput.value = 'true';
    }
    form.submit();
}

// Navigate to project detail page with return URL
function navigateToProject(projectId) {
    // Capture current URL with all query parameters as return URL
    const currentUrl = window.location.href;
    const returnUrl = encodeURIComponent(currentUrl);
    
    // Build project detail URL with return_url parameter
    if (IS_TEST_MODE) {
        const url = `${TEST_BASE_URL}/project/${projectId}?test_token=${TEST_TOKEN}&return_url=${returnUrl}`;
        window.location.href = url;
    } else {
        const url = `/project/${projectId}?return_url=${returnUrl}`;
        window.location.href = url;
    }
}

// Project card click handler
function downloadProjectPDF(projectId) {
    if (IS_TEST_MODE) {
        window.open(`${TEST_BASE_URL}/project/${projectId}/download/pdf?test_token=${TEST_TOKEN}`, '_blank');
    } else {
        window.open('/api/project/' + projectId + '/download/pdf', '_blank');
    }
}

// Dynamic sub-sector update based on sector selection
const sectorsSubsectorsMap = {{ sectors_subsectors_map|safe }};

function updateSubSectorOptions() {
    const sectorSelect = document.getElementById('sector_filter');
    const subSectorSelect = document.getElementById('sub_sector');
    const selectedSector = sectorSelect.value;
    const currentSubSector = subSectorSelect.value;

    // Clear current options except "All sub sectors"
    subSectorSelect.innerHTML = '<option value="">All sub sectors</option>';

    if (selectedSector && sectorsSubsectorsMap[selectedSector]) {
        // Add subsectors for the selected sector
        const subsectors = sectorsSubsectorsMap[selectedSector];
        subsectors.sort().forEach(subsector => {
            const option = document.createElement('option');
            option.value = subsector;
            option.textContent = subsector;
            if (subsector === currentSubSector) {
                option.selected = true;
            }
            subSectorSelect.appendChild(option);
        });
    } else if (!selectedSector) {
        // Show all subsectors from all sectors
        const allSubsectors = new Set();
        Object.values(sectorsSubsectorsMap).forEach(subsectors => {
            subsectors.forEach(subsector => allSubsectors.add(subsector));
        });
        Array.from(allSubsectors).sort().forEach(subsector => {
            const option = document.createElement('option');
            option.value = subsector;
            option.textContent = subsector;
            if (subsector === currentSubSector) {
                option.selected = true;
            }
            subSectorSelect.appendChild(option);
        });
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadSectorCounts();

    // Add click handler to "All Projects" card
    const allProjectsCard = document.getElementById('allProjectsCard');
    if (allProjectsCard) {
        allProjectsCard.addEventListener('click', handleAllProjectsClick);
    }

    // Add click handlers to sector cards
    document.querySelectorAll('.project-overview-card--sector[data-sector]').forEach(card => {
        card.addEventListener('click', handleSectorCardClick);
    });

    // Project card click handlers (works with both old and new card styles)
    document.querySelectorAll('.surface-card--clickable, .project-card-new').forEach(card => {
        card.addEventListener('click', (event) => {
            // Don't navigate if clicking on interactive elements
            if (event.target.closest('button') ||
                event.target.closest('a') ||
                event.target.closest('input') ||
                event.target.closest('select') ||
                event.target.closest('textarea')) {
                return;
            }
            const projectId = card.getAttribute('data-project-id');
            if (projectId) {
                navigateToProject(projectId);
            }
        });
    });

    // Add sector change listener for dynamic subsector update
    const sectorSelect = document.getElementById('sector_filter');
    if (sectorSelect) {
        sectorSelect.addEventListener('change', updateSubSectorOptions);
        // Initialize subsector options on page load
        updateSubSectorOptions();
    }
});

// ============================================================
// NAVIGATION BLOCKING FOR TEST MODE
// ============================================================
{% if is_test_mode %}
(function() {
    console.log('üîí Test mode activated - Navigation restricted');

    const TEST_REDIRECT_URL = '{{ test_redirect_url }}';

    // Block all navigation links in header/sidebar
    document.addEventListener('DOMContentLoaded', function() {
        // Find all navigation links that might take user away
        const navSelectors = [
            'a[href="/home"]',
            'a[href="/analytics"]',
            'a[href="/dashboard"]',
            'a[href="/profile"]',
            'a[href="/tender-search"]',
            'a[href="/tender-management"]',
            'a[href="/employee"]',
            'a[href="/bd/home"]',
            'header a:not([href^="/add_project"]):not([href^="/edit_project"]):not([href^="/project/"]):not([href^="/api/"]):not([href*="public-projects"])',
            'nav a:not([href^="/add_project"]):not([href^="/edit_project"]):not([href^="/project/"]):not([href^="/api/"]):not([href*="public-projects"])',
            '.sidebar a:not([href^="/add_project"]):not([href^="/edit_project"]):not([href^="/project/"]):not([href^="/api/"]):not([href*="public-projects"])'
        ];

        const navLinks = document.querySelectorAll(navSelectors.join(', '));

        navLinks.forEach(link => {
            const href = link.getAttribute('href');

            // Only block if it's not already whitelisted
            if (href && !href.includes('public-projects/nkbpl.pratyaksh') &&
                !href.startsWith('/add_project') &&
                !href.startsWith('/edit_project') &&
                !href.startsWith('/project/') &&
                !href.startsWith('#') &&
                !href.startsWith('/api/')) {

                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Show a notification
                    showTestModeNotification();

                    // Redirect back to test URL
                    setTimeout(function() {
                        window.location.href = TEST_REDIRECT_URL;
                    }, 1500);
                });
            }
        });

        // Override logo click
        const logo = document.querySelector('.logo, .header-logo, [class*="logo"]');
        if (logo) {
            logo.addEventListener('click', function(e) {
                e.preventDefault();
                showTestModeNotification();
                setTimeout(function() {
                    window.location.href = TEST_REDIRECT_URL;
                }, 1500);
            });
        }

        // Block form submissions that navigate away
        document.querySelectorAll('form').forEach(form => {
            const action = form.getAttribute('action');
            if (action && !action.includes('/add_project') && !action.includes('/edit_project') && !action.startsWith('/api/')) {
                form.addEventListener('submit', function(e) {
                    // Check if it's a search form (those are OK)
                    if (!form.querySelector('[name="search"]') && !form.querySelector('[name="show_all"]')) {
                        e.preventDefault();
                        showTestModeNotification();
                    }
                });
            }
        });
    });

    // Show notification function
    function showTestModeNotification() {
        const message = document.createElement('div');
        message.textContent = 'üîí Navigation blocked in test mode';
        message.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff6b6b;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 10000;
            font-size: 15px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        `;

        // Add animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        document.body.appendChild(message);

        setTimeout(() => {
            message.style.transition = 'opacity 0.3s, transform 0.3s';
            message.style.opacity = '0';
            message.style.transform = 'translateX(400px)';
            setTimeout(() => message.remove(), 300);
        }, 2000);
    }

    // Intercept window.location assignments
    const originalLocationSetter = Object.getOwnPropertyDescriptor(window, 'location').set;
    Object.defineProperty(window, 'location', {
        set: function(value) {
            // Check if it's an allowed URL
            if (typeof value === 'string' &&
                (value.includes('public-projects/nkbpl.pratyaksh') ||
                 value.startsWith('/add_project') ||
                 value.startsWith('/edit_project') ||
                 value.startsWith('/project/') ||
                 value.startsWith('/api/'))) {
                originalLocationSetter.call(window, value);
            } else {
                console.warn('üîí Blocked navigation to:', value);
                showTestModeNotification();
                setTimeout(function() {
                    originalLocationSetter.call(window, TEST_REDIRECT_URL);
                }, 1500);
            }
        },
        get: function() {
            return window.location;
        }
    });

    console.log('‚úÖ Test mode navigation blocking initialized');
})();
{% endif %}
// ============================================================
</script>
{% endblock %}
